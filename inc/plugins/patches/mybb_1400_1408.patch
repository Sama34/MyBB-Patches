diff -rub mybb_1400/admin/inc/class_form.php mybb_1408/admin/inc/class_form.php
--- mybb_1400/admin/inc/class_form.php	2008-06-15 21:08:32.000000000 +0200
+++ mybb_1408/admin/inc/class_form.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_form.php 3917 2008-06-15 19:08:32Z Tikitiki $
+ * $Id: class_form.php 4314 2009-01-31 00:43:26Z Tikitiki $
  */
 
 /**
@@ -359,7 +359,7 @@
 		foreach($option_list as $value => $option)
 		{
 			$select_add = '';
-			if(!empty($selected) && ((string)$value == (string)$selected || (is_array($selected) && in_array($value, $selected))))
+			if(!empty($selected) && ((string)$value == (string)$selected || (is_array($selected) && in_array((string)$value, $selected))))
 			{
 				$select_add = " selected=\"selected\"";
 			}
diff -rub mybb_1400/admin/inc/class_page.php mybb_1408/admin/inc/class_page.php
--- mybb_1400/admin/inc/class_page.php	2008-06-24 01:43:05.000000000 +0200
+++ mybb_1408/admin/inc/class_page.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_page.php 3947 2008-06-23 23:43:05Z Tikitiki $
+ * $Id: class_page.php 4308 2009-01-14 03:58:30Z Tikitiki $
  */
 
 /*
@@ -311,7 +311,7 @@
 	 */
 	function show_login($message="", $class="success")
 	{
-		global $lang;
+		global $lang, $cp_style;
 
 		$copy_year = COPY_YEAR;
 		
@@ -332,7 +332,7 @@
 <title>{$lang->mybb_admin_login}</title>
 <meta name="author" content="MyBB Group" />
 <meta name="copyright" content="Copyright {$copy_year} MyBB Group." />
-<link rel="stylesheet" href="./styles/default/login.css" type="text/css" />
+<link rel="stylesheet" href="./styles/{$cp_style}/login.css" type="text/css" />
 <script type="text/javascript" src="../jscripts/prototype.js"></script>
 <script type="text/javascript" src="../jscripts/general.js"></script>
 <script type="text/javascript" src="./jscripts/admincp.js"></script>
@@ -367,7 +367,7 @@
 			$query_string = str_replace('?&', '?', $query_string);
 			$query_string = htmlspecialchars_uni($query_string);
 		}
-       	
+       	$_SERVER['PHP_SELF'] = htmlspecialchars_uni($_SERVER['PHP_SELF']);
 print <<<EOF
 		<p>{$lang->enter_username_and_password}</p>
 		<form method="post" action="{$_SERVER['PHP_SELF']}{$query_string}">
diff -rub mybb_1400/admin/inc/class_table.php mybb_1408/admin/inc/class_table.php
--- mybb_1400/admin/inc/class_table.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/inc/class_table.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_table.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: class_table.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/admin/inc/functions.php mybb_1408/admin/inc/functions.php
--- mybb_1400/admin/inc/functions.php	2008-07-06 03:01:20.000000000 +0200
+++ mybb_1408/admin/inc/functions.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions.php 3990 2008-07-06 01:01:20Z Tikitiki $
+ * $Id: functions.php 4314 2009-01-31 00:43:26Z Tikitiki $
  */
 
 /**
@@ -234,6 +234,15 @@
 	$query = $db->simple_select("usergroups", "gid");
 	while($usergroup = $db->fetch_array($query))
 	{
+		$query2 = $db->simple_select("forumpermissions", "canviewthreads,candlattachments,canratethreads,caneditposts,candeleteposts,candeletethreads,caneditattachments,canvotepolls,cansearch", "fid='{$fid}' AND gid='{$usergroup['gid']}'", array('limit' => 1));
+		$existing_permissions = $db->fetch_array($query2);
+		
+		if(!$existing_permissions)
+		{
+			$query2 = $db->simple_select("usergroups", "canviewthreads,candlattachments,canratethreads,caneditposts,candeleteposts,candeletethreads,caneditattachments,canvotepolls,cansearch", "gid='{$usergroup['gid']}'", array('limit' => 1));
+			$existing_permissions = $db->fetch_array($query2);
+		}
+		
 		// Delete existing permissions
 		$db->delete_query("forumpermissions", "fid='{$fid}' AND gid='{$usergroup['gid']}'");
 
@@ -295,22 +304,22 @@
 			}
 
 			$insertquery = array(
-				"fid" => $fid,
-				"gid" => $usergroup['gid'],
-				"canview" => $pview,
-				"canviewthreads" => $pview,
-				"candlattachments" => $pview,
-				"canpostthreads" => $pthreads,
-				"canpostreplys" => $preplies,
-				"canpostattachments" => $pattachments,
-				"canratethreads" => $pview,
-				"caneditposts" => $ppost,
-				"candeleteposts" => $ppost,
-				"candeletethreads" => $pthreads,
-				"caneditattachments" => $pattachments,
-				"canpostpolls" => $ppolls,
-				"canvotepolls" => $pview,
-				"cansearch" => $pview
+				"fid" => intval($fid),
+				"gid" => intval($usergroup['gid']),
+				"canview" => intval($pview),
+				"canviewthreads" => intval($existing_permissions['canviewthreads']),
+				"candlattachments" => intval($existing_permissions['candlattachments']),
+				"canpostthreads" => intval($pthreads),
+				"canpostreplys" => intval($preplies),
+				"canpostattachments" => intval($pattachments),
+				"canratethreads" => intval($existing_permissions['canratethreads']),
+				"caneditposts" => intval($existing_permissions['caneditposts']),
+				"candeleteposts" => intval($existing_permissions['candeleteposts']),
+				"candeletethreads" => intval($existing_permissions['candeletethreads']),
+				"caneditattachments" => intval($existing_permissions['caneditattachments']),
+				"canpostpolls" => intval($ppolls),
+				"canvotepolls" => intval($existing_permissions['canvotepolls']),
+				"cansearch" => intval($existing_permissions['cansearch'])
 			);
 			
 			$db->insert_query("forumpermissions", $insertquery);
diff -rub mybb_1400/admin/inc/functions_themes.php mybb_1408/admin/inc/functions_themes.php
--- mybb_1400/admin/inc/functions_themes.php	2008-08-02 05:19:04.000000000 +0200
+++ mybb_1408/admin/inc/functions_themes.php	2009-06-26 06:22:11.000000000 +0200
@@ -810,7 +810,10 @@
 	// Do we have any children themes that need updating too?
 	if(count($child_list) > 0)
 	{
-		update_theme_stylesheet_list($child_list[0]);
+		foreach($child_list as $id)
+		{
+			update_theme_stylesheet_list($id);
+		}
 	}
 	
 	return true;
@@ -949,8 +952,16 @@
 			{
 				$user_themes['style'] = $themes['default'];
 			}
+			
+			if($themes[$user_themes['style']]['users'] > 0)
+			{
+				$themes[$user_themes['style']]['users'] += intval($user_themes['users']);
+			}
+			else
+			{
 			$themes[$user_themes['style']]['users'] = intval($user_themes['users']);
 		}
+		}
 
 		// Restrucure the theme array to something we can "loop-de-loop" with
 		foreach($themes as $key => $theme)
@@ -987,8 +998,8 @@
 			
 			if($theme['def'] != 1)
 			{
-				$popup->add_item($lang->set_as_default, "index.php?module=style/themes&amp;action=set_default&amp;tid={$theme['tid']}");
-				$set_default = "<a href=\"index.php?module=style/themes&amp;action=set_default&amp;tid={$theme['tid']}\"><img src=\"styles/{$page->style}/images/icons/make_default.gif\" alt=\"{$lang->set_as_default}\" style=\"vertical-align: middle;\" title=\"{$lang->set_as_default}\" /></a>";
+				$popup->add_item($lang->set_as_default, "index.php?module=style/themes&amp;action=set_default&amp;tid={$theme['tid']}&amp;my_post_key={$mybb->post_code}");
+				$set_default = "<a href=\"index.php?module=style/themes&amp;action=set_default&amp;tid={$theme['tid']}&amp;my_post_key={$mybb->post_code}\"><img src=\"styles/{$page->style}/images/icons/make_default.gif\" alt=\"{$lang->set_as_default}\" style=\"vertical-align: middle;\" title=\"{$lang->set_as_default}\" /></a>";
 			}
 			else
 			{
diff -rub mybb_1400/admin/inc/functions_view_manager.php mybb_1408/admin/inc/functions_view_manager.php
--- mybb_1400/admin/inc/functions_view_manager.php	2008-07-10 19:53:25.000000000 +0200
+++ mybb_1408/admin/inc/functions_view_manager.php	2009-06-26 07:26:39.000000000 +0200
@@ -1,12 +1,12 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_view_manager.php 4005 2008-07-10 17:53:25Z Tikitiki $
+ * $Id: functions_view_manager.php 4384 2009-06-19 11:49:42Z Tomm $
  */
 
 /**
@@ -635,6 +635,8 @@
 	if($create == true)
 	{
 		$updated_admin['uid'] = $mybb->user['uid'];
+		$updated_admin['notes'] = '';
+		$updated_admin['permissions'] = '';
 		$db->insert_query("adminoptions", $updated_admin);
 	}
 	else
diff -rub mybb_1400/admin/index.php mybb_1408/admin/index.php
--- mybb_1400/admin/index.php	2008-07-26 05:27:58.000000000 +0200
+++ mybb_1408/admin/index.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: index.php 4048 2008-07-26 03:27:58Z Tikitiki $
+ * $Id: index.php 4339 2009-04-04 18:26:37Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
@@ -43,6 +43,11 @@
 // Load global language phrases
 $lang->load("global");
 
+if(function_exists('mb_internal_encoding') && !empty($lang->settings['charset']))
+{
+	@mb_internal_encoding($lang->settings['charset']);
+}
+
 header("Content-type: text/html; charset={$lang->settings['charset']}");
 
 $time = TIME_NOW;
@@ -56,6 +61,19 @@
 $ip_address = get_ip();
 unset($user);
 
+// Load Admin CP style
+if(!$cp_style)
+{
+	if(!empty($mybb->settings['cpstyle']) && file_exists(MYBB_ADMIN_DIR."/styles/".$mybb->settings['cpstyle']."/main.css"))
+	{
+		$cp_style = $mybb->settings['cpstyle'];
+	}
+	else
+	{
+		$cp_style = "default";
+	}
+}
+
 $logged_out = false;
 $fail_check = 0;
 $post_verify = true;
@@ -63,7 +81,7 @@
 if($mybb->input['action'] == "logout")
 {
 	// Delete session from the database
-	$db->delete_query("adminsessions", "sid='".$db->escape_string($mybb->input['adminsid'])."'");
+	$db->delete_query("adminsessions", "sid='".$db->escape_string($mybb->cookies['adminsid'])."'");
 	my_setcookie("adminsid", "");
 	$logged_out = true;
 }
@@ -95,6 +113,8 @@
 		$db->insert_query("adminsessions", $admin_session);
 		my_setcookie("adminsid", $sid);
 		$post_verify = false;
+		
+		$mybb->request_method = "get";
 	}
 	else
 	{
@@ -165,6 +185,7 @@
 					if(!$valid_ip)
 					{
 						$login_message = $lang->error_invalid_ip;
+						unset($mybb->user);
 					}
 				}
 			}
@@ -184,7 +205,9 @@
 
 if($mybb->usergroup['cancp'] != 1 || !$mybb->user['uid'])
 {
+	$db->delete_query("adminsessions", "uid='".intval($mybb->user['uid'])."'");
 	unset($mybb->user);
+	my_setcookie("adminsid", "");
 }
 
 if($mybb->user['uid'])
@@ -200,26 +223,13 @@
 	// Update the session information in the DB
 	if($admin_session['sid'])
 	{
-		$db->update_query("adminsessions", array('lastactive' => TIME_NOW, 'ip' => $db->escape_string($session->ipaddress)), "sid='".$db->escape_string($admin_session['sid'])."'");
+		$db->update_query("adminsessions", array('lastactive' => TIME_NOW, 'ip' => $db->escape_string(get_ip())), "sid='".$db->escape_string($admin_session['sid'])."'");
 	}
 
 	// Fetch administrator permissions
 	$mybb->admin['permissions'] = get_admin_permissions($mybb->user['uid']);
 }
 
-// Load Admin CP style
-if(!$cp_style)
-{
-	if(!empty($mybb->settings['cpstyle']) && file_exists(MYBB_ADMIN_DIR."/styles/".$mybb->settings['cpstyle']."/main.css"))
-	{
-		$cp_style = $mybb->settings['cpstyle'];
-	}
-	else
-	{
-		$cp_style = "default";
-	}
-}
-
 // Include the layout generation class overrides for this style
 if(file_exists(MYBB_ADMIN_DIR."/styles/{$cp_style}/style.php"))
 {
diff -rub mybb_1400/admin/jscripts/codepress/codepress.js mybb_1408/admin/jscripts/codepress/codepress.js
--- mybb_1400/admin/jscripts/codepress/codepress.js	2008-08-03 12:57:46.000000000 +0200
+++ mybb_1408/admin/jscripts/codepress/codepress.js	2009-06-26 06:22:11.000000000 +0200
@@ -10,7 +10,7 @@
  */
 
 CodePress = function(obj) {
-	if(MyBB.browser == "opera" || MyBB.browser == "safari")
+	if(MyBB.browser == "opera" || MyBB.browser == "safari" || MyBB.browser == "chrome")
 	{
 		return;
 	}
@@ -105,7 +105,6 @@
 	}
 
 	self.edit();
-	//self.textarea.disabled = false;
 	return self;
 }
 
diff -rub mybb_1400/admin/modules/config/attachment_types.php mybb_1408/admin/modules/config/attachment_types.php
--- mybb_1400/admin/modules/config/attachment_types.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/attachment_types.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: attachment_types.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: attachment_types.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/badwords.php mybb_1408/admin/modules/config/badwords.php
--- mybb_1400/admin/modules/config/badwords.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/badwords.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: badwords.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: badwords.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/banning.php mybb_1408/admin/modules/config/banning.php
--- mybb_1400/admin/modules/config/banning.php	2008-06-21 08:45:45.000000000 +0200
+++ mybb_1408/admin/modules/config/banning.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: banning.php 3934 2008-06-21 06:45:45Z Tikitiki $
+ * $Id: banning.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/calendars.php mybb_1408/admin/modules/config/calendars.php
--- mybb_1400/admin/modules/config/calendars.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/calendars.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: calendars.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: calendars.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/help_documents.php mybb_1408/admin/modules/config/help_documents.php
--- mybb_1400/admin/modules/config/help_documents.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/help_documents.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: help_documents.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: help_documents.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/languages.php mybb_1408/admin/modules/config/languages.php
--- mybb_1400/admin/modules/config/languages.php	2008-07-25 22:13:08.000000000 +0200
+++ mybb_1408/admin/modules/config/languages.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: languages.php 4041 2008-07-25 20:13:08Z Tikitiki $
+ * $Id: languages.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/mod_tools.php mybb_1408/admin/modules/config/mod_tools.php
--- mybb_1400/admin/modules/config/mod_tools.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/mod_tools.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: mod_tools.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: mod_tools.php 4341 2009-04-06 21:49:53Z Tikitiki $
  */
 
 
@@ -561,6 +561,7 @@
 			$new_tool['name'] = $db->escape_string($mybb->input['title']);
 			$new_tool['description'] = $db->escape_string($mybb->input['description']);
 			$new_tool['forums'] = '';
+			$new_tool['postoptions'] = '';
 			
 			if($mybb->input['forum_type'] == 2)
 			{
@@ -575,7 +576,7 @@
 			}
 			else
 			{
-				$new_tools['forums'] = "-1";
+				$new_tool['forums'] = "-1";
 			}
 		
 			$tid = $db->insert_query("modtools", $new_tool);
diff -rub mybb_1400/admin/modules/config/module_meta.php mybb_1408/admin/modules/config/module_meta.php
--- mybb_1400/admin/modules/config/module_meta.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/module_meta.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: module_meta.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: module_meta.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/mycode.php mybb_1408/admin/modules/config/mycode.php
--- mybb_1400/admin/modules/config/mycode.php	2008-07-26 05:27:58.000000000 +0200
+++ mybb_1408/admin/modules/config/mycode.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: mycode.php 4048 2008-07-26 03:27:58Z Tikitiki $
+ * $Id: mycode.php 4292 2008-12-13 01:58:07Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -21,6 +21,12 @@
 
 if($mybb->input['action'] == "toggle_status")
 {
+	if(!verify_post_check($mybb->input['my_post_key']))
+	{
+		flash_message($lang->invalid_post_verify_key2, 'error');
+		admin_redirect("index.php?module=config/mycode");
+	}
+	
 	$plugins->run_hooks("admin_config_mycode_toggle_status");
 	
 	$query = $db->simple_select("mycode", "*", "cid='".intval($mybb->input['cid'])."'");
@@ -65,7 +71,7 @@
 	
 	// Send no cache headers
 	header("Expires: Sat, 1 Jan 2000 01:00:00 GMT");
-	header("Last-Modified: " . gmdate("D, d M Y H:i:s") . "GMT");
+	header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
 	header("Cache-Control: no-cache, must-revalidate");
 	header("Pragma: no-cache");
 	header("Content-type: text/html");
@@ -404,7 +410,7 @@
 
 		$popup = new PopupMenu("mycode_{$mycode['cid']}", $lang->options);
 		$popup->add_item($lang->edit_mycode, "index.php?module=config/mycode&amp;action=edit&amp;cid={$mycode['cid']}");
-		$popup->add_item($phrase, "index.php?module=config/mycode&amp;action=toggle_status&amp;cid={$mycode['cid']}");
+		$popup->add_item($phrase, "index.php?module=config/mycode&amp;action=toggle_status&amp;cid={$mycode['cid']}&amp;my_post_key={$mybb->post_code}");
 		$popup->add_item($lang->delete_mycode, "index.php?module=config/mycode&amp;action=delete&amp;cid={$mycode['cid']}&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_mycode_deletion}')");
 		$table->construct_cell($popup->fetch(), array('class' => 'align_center'));
 		$table->construct_row();
diff -rub mybb_1400/admin/modules/config/plugins.php mybb_1408/admin/modules/config/plugins.php
--- mybb_1400/admin/modules/config/plugins.php	2008-06-01 00:20:03.000000000 +0200
+++ mybb_1408/admin/modules/config/plugins.php	2009-06-26 07:26:39.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: plugins.php 3870 2008-05-31 22:20:03Z Tikitiki $
+ * $Id: plugins.php 4386 2009-06-25 07:30:06Z RyanGordon $
  */
 
 // Disallow direct access to this file for security reasons
@@ -29,6 +29,7 @@
 	
 	if($plugins_list)
 	{
+		$active_hooks = $plugins->hooks;
 		foreach($plugins_list as $plugin_file)
 		{
 			require_once MYBB_ROOT."inc/plugins/".$plugin_file;
@@ -39,13 +40,15 @@
 				continue;
 			}
 			$plugininfo = $infofunc();
+			$plugininfo['guid'] = trim($plugininfo['guid']);
 			
-			if(trim($plugininfo['guid']) != "")
+			if($plugininfo['guid'] != "")
 			{
 				$info[] = $plugininfo['guid'];
 				$names[$plugininfo['guid']] = array('name' => $plugininfo['name'], 'version' => $plugininfo['version']);
 			}
 		}
+		$plugins->hooks = $active_hooks;
 	}
 	
 	if(empty($info))
@@ -127,7 +130,7 @@
 	
 	$sub_tabs['update_plugins'] = array(
 		'title' => $lang->plugin_updates,
-		'link' => "index.php?module=config/plugin&amp;action=check",
+		'link' => "index.php?module=config/plugins&amp;action=check",
 		'description' => $lang->plugin_updates_desc
 	);
 	
@@ -141,6 +144,12 @@
 // Activates or deactivates a specific plugin
 if($mybb->input['action'] == "activate" || $mybb->input['action'] == "deactivate")
 {
+	if(!verify_post_check($mybb->input['my_post_key']))
+	{
+		flash_message($lang->invalid_post_verify_key2, 'error');
+		admin_redirect("index.php?module=config/plugins");
+	}
+	
 	if($mybb->input['action'] == "activate")
 	{
 		$plugins->run_hooks("admin_config_plugins_activate");
@@ -296,6 +305,10 @@
 			{
 				$compatibility_warning = "<span style=\"color: red;\">".$lang->sprintf($lang->plugin_incompatible, $mybb->version)."</span>";
 			}
+			else
+			{
+				$compatibility_warning = "";
+			}
 
 			$installed_func = "{$codename}_is_installed";
 			$install_func = "{$codename}_install";
@@ -331,16 +344,16 @@
 				}
 				else
 				{
-					$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=activate&amp;plugin={$codename}\">{$lang->install_and_activate}</a>", array("class" => "align_center", "colspan" => 2));
+					$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=activate&amp;plugin={$codename}&amp;my_post_key={$mybb->post_code}\">{$lang->install_and_activate}</a>", array("class" => "align_center", "colspan" => 2));
 				}
 			}
 			// Plugin is activated and installed
 			else if($active_plugins[$codename])
 			{
-				$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=deactivate&amp;plugin={$codename}\">{$lang->deactivate}</a>", array("class" => "align_center", "width" => 150));
+				$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=deactivate&amp;plugin={$codename}&amp;my_post_key={$mybb->post_code}\">{$lang->deactivate}</a>", array("class" => "align_center", "width" => 150));
 				if($uninstall_button)
 				{
-					$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=deactivate&amp;uninstall=1&amp;plugin={$codename}\">{$lang->uninstall}</a>", array("class" => "align_center", "width" => 150));
+					$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=deactivate&amp;uninstall=1&amp;plugin={$codename}&amp;my_post_key={$mybb->post_code}\">{$lang->uninstall}</a>", array("class" => "align_center", "width" => 150));
 				}
 				else
 				{
@@ -350,10 +363,10 @@
 			// Plugin is installed but not active
 			else if($installed == true)
 			{
-				$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=activate&amp;plugin={$codename}\">{$lang->activate}</a>", array("class" => "align_center", "width" => 150));
+				$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=activate&amp;plugin={$codename}&amp;my_post_key={$mybb->post_code}\">{$lang->activate}</a>", array("class" => "align_center", "width" => 150));
 				if($uninstall_button)
 				{
-					$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=deactivate&amp;uninstall=1&amp;plugin={$codename}\">{$lang->uninstall}</a>", array("class" => "align_center", "width" => 150));
+					$table->construct_cell("<a href=\"index.php?module=config/plugins&amp;action=deactivate&amp;uninstall=1&amp;plugin={$codename}&amp;my_post_key={$mybb->post_code}\">{$lang->uninstall}</a>", array("class" => "align_center", "width" => 150));
 				}
 				else
 				{
@@ -366,7 +379,7 @@
 	
 	if($table->num_rows() == 0)
 	{
-		$table->contruct_cell($lang->no_plugins, array('colspan' => 2));
+		$table->construct_cell($lang->no_plugins, array('colspan' => 3));
 		$table->construct_row();
 	}
 	$table->output($lang->plugins);
diff -rub mybb_1400/admin/modules/config/post_icons.php mybb_1408/admin/modules/config/post_icons.php
--- mybb_1400/admin/modules/config/post_icons.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/post_icons.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: post_icons.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: post_icons.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/profile_fields.php mybb_1408/admin/modules/config/profile_fields.php
--- mybb_1400/admin/modules/config/profile_fields.php	2008-05-10 18:49:24.000000000 +0200
+++ mybb_1408/admin/modules/config/profile_fields.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: profile_fields.php 3826 2008-05-10 16:49:24Z Tikitiki $
+ * $Id: profile_fields.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/config/settings.php mybb_1408/admin/modules/config/settings.php
--- mybb_1400/admin/modules/config/settings.php	2008-07-20 22:56:39.000000000 +0200
+++ mybb_1408/admin/modules/config/settings.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: settings.php 4031 2008-07-20 20:56:39Z Tikitiki $
+ * $Id: settings.php 4311 2009-01-22 04:55:38Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -19,18 +19,19 @@
 
 $plugins->run_hooks("admin_config_settings_begin");
 
+/*
 // Delete all duplicate settings and setting groups
 if($mybb->input['action'] == "delete_duplicates")
 {
 	$query = $db->query("
 		DELETE s1
 		FROM ".TABLE_PREFIX."settings s1
-		INNER JOIN ".TABLE_PREFIX."settings s2 ON (s2.name=s1.name AND s2.sid!=s1.sid)
+		INNER JOIN ".TABLE_PREFIX."settings s2 ON (s2.name=s1.name AND s2.sid!=s1.sid AND s2.sid < s1.sid)
 	");
 	$query = $db->query("
 		DELETE g1
 		FROM ".TABLE_PREFIX."settinggroups g1
-		INNER JOIN ".TABLE_PREFIX."settinggroups g2 ON (g2.title=g1.title AND g2.gid!=g1.gid)
+		INNER JOIN ".TABLE_PREFIX."settinggroups g2 ON (g2.title=g1.title AND g2.gid!=g1.gid AND g2.gid < g1.gid)
 	");
 	rebuild_settings();
 	
@@ -41,7 +42,8 @@
 
 	flash_message($lang->success_duplicate_settings_deleted, 'success');
 	admin_redirect("index.php?module=config/settings&action=manage");
-}
+}*/
+// ^^  Code, Please go away. Forever.
 
 // Creating a new setting group
 if($mybb->input['action'] == "addgroup")
@@ -422,7 +424,7 @@
 		"select" => $lang->select,
 		"radio" => $lang->radio,
 		"checkbox" => $lang->checkbox,
-		"language" => $lang->language,
+		"language" => $lang->language_selection_box,
 		"adminlanguage" => $lang->adminlanguage,
 		"cpstyle" => $lang->cpstyle,
 		//"php" => $lang->php // Internal Use Only
@@ -608,7 +610,7 @@
 		"select" => $lang->select,
 		"radio" => $lang->radio,
 		"checkbox" => $lang->checkbox,
-		"language" => $lang->language,
+		"language" => $lang->language_selection_box,
 		"adminlanguage" => $lang->adminlanguage,
 		"cpstyle" => $lang->cpstyle,
 		//"php" => $lang->php // Internal Use Only
@@ -831,7 +833,7 @@
 	$form->output_submit_wrapper($buttons);
 	$form->end();
 	
-	echo '<script type="text/javascript" src="./jscripts/config_settings.js"></script><script type="text/javascript">Event.observe(window, "load", ManageSettings.init);</script>';
+	/*echo '<script type="text/javascript" src="./jscripts/config_settings.js"></script><script type="text/javascript">Event.observe(window, "load", ManageSettings.init);</script>';*/
 	
 	$page->output_footer();
 }
@@ -1095,6 +1097,10 @@
 				$languages = $lang->get_languages(1);
 				$setting_code = $form->generate_select_box($element_name, $languages, $setting['value'], array('id' => $element_id));
 			}
+			else if($type[0] == "passwordbox")
+			{
+				$setting_code = $form->generate_password_box($element_name, $setting['value'], array('id' => $element_id));
+			}
 			else if($type[0] == "php")
 			{
 				$setting['optionscode'] = substr($setting['optionscode'], 3);
@@ -1134,11 +1140,11 @@
 					{
 						if($setting['value'] == $optionsexp[0])
 						{
-							$option_list[$i] = $form->generate_checkbox_input($element_name, $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, "checked" => 1, 'class' => $element_id));
+							$option_list[$i] = $form->generate_check_box($element_name, $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, "checked" => 1, 'class' => $element_id));
 						}
 						else
 						{
-							$option_list[$i] = $form->generate_checkbox_input($element_name, $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, 'class' => $element_id));
+							$option_list[$i] = $form->generate_check_box($element_name, $optionsexp[0], htmlspecialchars_uni($optionsexp[1]), array('id' => $element_id.'_'.$i, 'class' => $element_id));
 						}
 					}
 				}
@@ -1391,11 +1397,10 @@
 			new Peeker($$(".setting_enablewarningsystem"), $("row_setting_canviewownwarning"), /1/, true);
 			new Peeker($$(".setting_enablewarningsystem"), $("row_setting_maxwarningpoints"), /1/, true);
 			new Peeker($$(".setting_enablepms"), $("row_setting_pmsallowhtml"), /1/, true);
+
 			new Peeker($$(".setting_enablepms"), $("row_setting_pmsallowmycode"), /1/, true);
 			new Peeker($$(".setting_enablepms"), $("row_setting_pmsallowsmilies"), /1/, true);
 			new Peeker($$(".setting_enablepms"), $("row_setting_pmsallowimgcode"), /1/, true);
-			new Peeker($$(".setting_enablecalendar"), $("row_setting_publiceventcolor"), /1/, true);
-			new Peeker($$(".setting_enablecalendar"), $("row_setting_privateeventcolor"), /1/, true);
 			new Peeker($$(".setting_smilieinserter"), $("row_setting_smilieinsertertot"), /1/, true);
 			new Peeker($$(".setting_smilieinserter"), $("row_setting_smilieinsertercols"), /1/, true);
 			new Peeker($("setting_mail_handler"), $("row_setting_smtp_host"), /smtp/, false);
diff -rub mybb_1400/admin/modules/config/smilies.php mybb_1408/admin/modules/config/smilies.php
--- mybb_1400/admin/modules/config/smilies.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/smilies.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: smilies.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: smilies.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 
diff -rub mybb_1400/admin/modules/config/spiders.php mybb_1408/admin/modules/config/spiders.php
--- mybb_1400/admin/modules/config/spiders.php	2008-05-04 00:06:41.000000000 +0200
+++ mybb_1408/admin/modules/config/spiders.php	2009-06-26 07:26:39.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: spiders.php 3814 2008-05-03 22:06:41Z Tikitiki $
+ * $Id: spiders.php 4365 2009-05-04 02:59:54Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -87,7 +87,7 @@
 	
 	$languages = array('' => $lang->use_board_default);
 	$languages = array_merge($languages, $lang->get_languages());
-	$form_container->output_row($lang->language, $lang->language_desc, $form->generate_select_box("language", $languages, $mybb->input['language'], array("id" => "language")), 'language');
+	$form_container->output_row($lang->language_str, $lang->language_desc, $form->generate_select_box("language", $languages, $mybb->input['language'], array("id" => "language")), 'language');
 	
 	$form_container->output_row($lang->theme, $lang->theme_desc, build_theme_select("theme", $mybb->input['theme'], 0, "", 1));
 
@@ -230,7 +230,7 @@
 	
 	$languages = array('' => $lang->use_board_default);
 	$languages = array_merge($languages, $lang->get_languages());
-	$form_container->output_row($lang->language, $lang->language_desc, $form->generate_select_box("language", $languages, $spider_data['language'], array("id" => "language")), 'language');
+	$form_container->output_row($lang->language_str, $lang->language_desc, $form->generate_select_box("language", $languages, $spider_data['language'], array("id" => "language")), 'language');
 
 	$form_container->output_row($lang->theme, $lang->theme_desc, build_theme_select("theme", $spider_data['theme'], 0, "", 1));
 
diff -rub mybb_1400/admin/modules/config/warning.php mybb_1408/admin/modules/config/warning.php
--- mybb_1400/admin/modules/config/warning.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/config/warning.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: warning.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: warning.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -127,7 +127,7 @@
 		"days" => $lang->expiration_days,
 		"weeks" => $lang->expiration_weeks,
 		"months" => $lang->expiration_months,
-		"never" => $lang->expiration_never
+		"never" => $lang->permanent
 	);
 
 	$actions = "<script type=\"text/javascript\">
@@ -321,7 +321,7 @@
 		"days" => $lang->expiration_days,
 		"weeks" => $lang->expiration_weeks,
 		"months" => $lang->expiration_months,
-		"never" => $lang->expiration_never
+		"never" => $lang->permanent
 	);
 
 	$actions = "<script type=\"text/javascript\">
@@ -495,7 +495,7 @@
 		"days" => $lang->expiration_days,
 		"weeks" => $lang->expiration_weeks,
 		"months" => $lang->expiration_months,
-		"never" => $lang->never
+		"never" => $lang->expiration_never
 	);
 	$form_container->output_row($lang->warning_expiry, $lang->warning_expiry_desc, $form->generate_text_box('expire_time', $mybb->input['expire_time'], array('id' => 'expire_time'))." ".$form->generate_select_box('expire_period', $expiration_periods, $mybb->input['expire_period'], array('id' => 'expire_period')), 'expire_time');
 	$form_container->end();
@@ -693,7 +693,7 @@
 		$no_results = true;
 	}
 	
-	$table->output($lang->warning_types);
+	$table->output($lang->warning_levels);
 
 	$page->output_footer();
 }
diff -rub mybb_1400/admin/modules/forum/announcements.php mybb_1408/admin/modules/forum/announcements.php
--- mybb_1400/admin/modules/forum/announcements.php	2008-07-09 00:34:00.000000000 +0200
+++ mybb_1408/admin/modules/forum/announcements.php	2009-06-26 06:22:11.000000000 +0200
@@ -684,7 +684,7 @@
 				$icon = "<img src=\"styles/{$page->style}/images/icons/bullet_on.gif\" alt=\"(Active)\" title=\"Active Announcement\"  style=\"vertical-align: middle;\" /> ";
 			}
 			
-			$table->construct_cell($icon."<a href=\"index.php?module=forum/announcements&amp;action=edit&amp;aid={$aid}\">{$announcement['subject']}</a>");
+			$table->construct_cell($icon."<a href=\"index.php?module=forum/announcements&amp;action=edit&amp;aid={$aid}\">".htmlspecialchars_uni($announcement['subject'])."</a>");
 			$table->construct_cell("<a href=\"index.php?module=forum/announcements&amp;action=edit&amp;aid={$aid}\">{$lang->edit}</a>", array("class" => "align_center", "width" => 75));
 			$table->construct_cell("<a href=\"index.php?module=forum/announcements&amp;action=delete&amp;aid={$aid}&amp;my_post_key={$mybb->post_code}\" onclick=\"return AdminCP.deleteConfirmation(this, '{$lang->confirm_announcement_deletion}')\">{$lang->delete}</a>", array("class" => "align_center", "width" => 75));
 			$table->construct_row();
@@ -721,7 +721,7 @@
 
 		foreach($forum_cache as $forum)
 		{
-			$forums_by_parent[$forum['pid']][$val['disporder']][$forum['fid']] = $forum;
+			$forums_by_parent[$forum['pid']][$forum['disporder']][$forum['fid']] = $forum;
 		}
 	}
 
@@ -762,7 +762,7 @@
 						$icon = "<img src=\"styles/{$page->style}/images/icons/bullet_on.gif\" alt=\"(Active)\" title=\"Active Announcement\"  style=\"vertical-align: middle;\" /> ";
 					}
 							
-					$table->construct_cell("<div style=\"padding-left: ".(40*$depth)."px;\">{$icon}<a href=\"index.php?module=forum/announcements&amp;action=edit&amp;aid={$aid}\">{$announcement['subject']}</a></div>");
+					$table->construct_cell("<div style=\"padding-left: ".(40*$depth)."px;\">{$icon}<a href=\"index.php?module=forum/announcements&amp;action=edit&amp;aid={$aid}\">".htmlspecialchars_uni($announcement['subject'])."</a></div>");
 					$table->construct_cell("<a href=\"index.php?module=forum/announcements&amp;action=edit&amp;aid={$aid}\">{$lang->edit}</a>", array("class" => "align_center"));
 					$table->construct_cell("<a href=\"index.php?module=forum/announcements&amp;action=delete&amp;aid={$aid}&amp;my_post_key={$mybb->post_code}\" onclick=\"return AdminCP.deleteConfirmation(this, '{$lang->confirm_announcement_deletion}')\">{$lang->delete}</a>", array("class" => "align_center"));
 					$table->construct_row();
diff -rub mybb_1400/admin/modules/forum/attachments.php mybb_1408/admin/modules/forum/attachments.php
--- mybb_1400/admin/modules/forum/attachments.php	2008-07-26 05:04:54.000000000 +0200
+++ mybb_1408/admin/modules/forum/attachments.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: attachments.php 4046 2008-07-26 03:04:54Z ZiNgaBuRgA $
+ * $Id: attachments.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -50,7 +50,7 @@
 	}
 	else
 	{
-		array_walk($mybb->input['aids'], "intval");
+		$mybb->input['aids'] = array_map("intval", $mybb->input['aids']);
 	}
 
 	if(count($mybb->input['aids']) < 1)
@@ -183,17 +183,35 @@
 	$table->construct_header($lang->username);
 	$table->construct_header($lang->total_size, array('width' => '20%', 'class' => 'align_center'));
 
+	switch($db->type)
+	{
+		case "pgsql":
+			$query = $db->query("
+				SELECT a.*, u.uid AS useruid, u.username, SUM(a.filesize) as totalsize
+				FROM ".TABLE_PREFIX."attachments a  
+				LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=a.uid)
+				GROUP BY ".$db->build_fields_string("attachments", "a.").",u.uid,u.username
+				ORDER BY totalsize DESC
+				LIMIT 5
+			");
+			break;
+		default:
 	$query = $db->query("
-		SELECT a.*, u.uid, u.username, SUM(a.filesize) as totalsize
+				SELECT a.*, u.uid AS useruid, u.username, SUM(a.filesize) as totalsize
 		FROM ".TABLE_PREFIX."attachments a  
 		LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=a.uid)
 		GROUP BY a.uid
 		ORDER BY totalsize DESC
 		LIMIT 5
 	");
+	}
 	while($user = $db->fetch_array($query))
 	{
-		$table->construct_cell(build_profile_link($user['username'], $user['uid']));
+		if(!$user['useruid'])
+		{
+			$user['username'] = $lang->na;
+		}
+		$table->construct_cell(build_profile_link($user['username'], $user['useruid']));
 		$table->construct_cell("<a href=\"index.php?module=forum/attachments&amp;results=1&amp;username=".urlencode($user['username'])."\">".get_friendly_size($user['totalsize'])."</a>", array('class' => 'align_center'));
 		$table->construct_row();
 	}
@@ -213,7 +231,7 @@
 		{
 			return str_replace(array(".."), "", $string);
 		}
-		array_walk($mybb->input['orphaned_files'], "clean_filename");
+		$mybb->input['orphaned_files'] = array_map("clean_filename", $mybb->input['orphaned_files']);
 		foreach($mybb->input['orphaned_files'] as $file)
 		{
 			if(!@unlink(MYBB_ROOT.$mybb->settings['uploadspath']."/".$file))
@@ -226,7 +244,7 @@
 	// Deleting physical attachments which exist in database
 	if(is_array($mybb->input['orphaned_attachments']))
 	{
-		array_walk($mybb->input['orphaned_attachments'], "intval");
+		$mybb->input['orphaned_attachments'] = array_map("intval", $mybb->input['orphaned_attachments']);
 		require_once MYBB_ROOT."inc/functions_upload.php";
 
 		$query = $db->simple_select("attachments", "aid,pid,posthash", "aid IN (".implode(",", $mybb->input['orphaned_attachments']).")");
@@ -302,6 +320,12 @@
 			$incomplete_attachments = unserialize($mybb->input['incomplete_attachments']);
 			$aids = array_merge($aids, $incomplete_attachments);
 		}
+		
+		foreach($aids as $key => $aid)
+		{
+			$aids[$key] = intval($aid);
+		}
+		
 		$results += count($aids);
 
 		if($results == 0)
@@ -489,7 +513,7 @@
 						// In allotments of 20, query the database for these attachments
 						if(count($attachments_to_check) >= 20)
 						{
-							array_walk($attachments_to_check, array($db, "escape_string"));
+							$attachments_to_check = array_map(array($db, "escape_string"), $attachments_to_check);
 							$attachment_names = "'".implode("','", $attachments_to_check)."'";
 							$query = $db->simple_select("attachments", "aid, attachname", "attachname IN ($attachment_names)");
 							while($attachment = $db->fetch_array($query))
@@ -517,7 +541,7 @@
 				// Any reamining to check?
 				if(count($attachments_to_check) > 0)
 				{
-					array_walk($attachments_to_check, array($db, "escape_string"));
+					$attachments_to_check = array_map(array($db, "escape_string"), $attachments_to_check);
 					$attachment_names = "'".implode("','", $attachments_to_check)."'";
 					$query = $db->simple_select("attachments", "aid, attachname", "attachname IN ($attachment_names)");
 					while($attachment = $db->fetch_array($query))
@@ -586,7 +610,7 @@
 		// Build the search SQL for users
 
 		// List of valid LIKE search fields
-		$user_like_fields = array("filename", "mimetype");
+		$user_like_fields = array("filename", "filetype");
 		foreach($user_like_fields as $search_field)
 		{
 			if($mybb->input[$search_field])
@@ -767,7 +791,7 @@
 			if($num_results > $mybb->input['perpage'])
 			{
 				$pagination_url = "index.php?module=forum/attachments&amp;results=1";
-				$pagination_vars = array('filename', 'mimetype', 'username', 'fid', 'downloads', 'downloads_dir', 'dateuploaded', 'dateuploaded_dir', 'filesize', 'filesize_dir');
+				$pagination_vars = array('filename', 'filetype', 'username', 'fid', 'downloads', 'downloads_dir', 'dateuploaded', 'dateuploaded_dir', 'filesize', 'filesize_dir');
 				foreach($pagination_vars as $var)
 				{
 					if($mybb->input[$var])
@@ -805,7 +829,7 @@
 
 	$form_container = new FormContainer($lang->find_where);
 	$form_container->output_row($lang->name_contains, $lang->name_contains_desc, $form->generate_text_box('filename', $mybb->input['filename'], array('id' => 'filename')), 'filename');
-	$form_container->output_row($lang->type_contains, "", $form->generate_text_box('mimetype', $mybb->input['mimetype'], array('id' => 'mimetype')), 'mimetype');
+	$form_container->output_row($lang->type_contains, "", $form->generate_text_box('filetype', $mybb->input['filetype'], array('id' => 'filetype')), 'filetype');
 	$form_container->output_row($lang->forum_is, "", $form->generate_forum_select('forum[]', $mybb->input['forum'], array('multiple' => true, 'size' => 5, 'id' => 'forum')), 'forum');
 	$form_container->output_row($lang->username_is, "", $form->generate_text_box('username', $mybb->input['username'], array('id' => 'username')), 'username');
 
diff -rub mybb_1400/admin/modules/forum/management.php mybb_1408/admin/modules/forum/management.php
--- mybb_1400/admin/modules/forum/management.php	2008-07-27 00:11:03.000000000 +0200
+++ mybb_1408/admin/modules/forum/management.php	2009-06-26 07:26:44.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: management.php 4049 2008-07-26 22:11:03Z Tikitiki $
+ * $Id: management.php 4376 2009-06-03 21:56:15Z RyanGordon $
  */
 
 // Disallow direct access to this file for security reasons
@@ -618,6 +618,10 @@
 		
 		if(!$errors)
 		{
+			if($pid < 0)
+			{
+				$pid = 0;
+			}
 			$insert_array = array(
 				"name" => $db->escape_string($mybb->input['title']),
 				"description" => $db->escape_string($mybb->input['description']),
@@ -641,7 +645,7 @@
 				"modthreads" => intval($mybb->input['modthreads']),
 				"mod_edit_posts" => intval($mybb->input['mod_edit_posts']),
 				"modattachments" => intval($mybb->input['modattachments']),
-				"style" => intval($mybb->input['fstyle']),
+				"style" => intval($mybb->input['style']),
 				"overridestyle" => intval($mybb->input['overridestyle']),
 				"rulestype" => intval($mybb->input['rulestype']),
 				"rulestitle" => $db->escape_string($mybb->input['rulestitle']),
@@ -886,6 +890,7 @@
 		$usergroups[$usergroup['gid']] = $usergroup;
 	}
 	
+	$cached_forum_perms = $cache->read("forumpermissions");
 	$field_list = array('canview', 'canpostthreads', 'canpostreplys', 'canpostpolls', 'canpostattachments');
 	
 	$form_container = new FormContainer($lang->forum_permissions);
@@ -941,6 +946,7 @@
 			}
 		}
 		
+		$all_check = "";
 		$perm_check = "";
 		$all_checked = true;
 		foreach($field_list as $forum_permission)
@@ -1068,6 +1074,10 @@
 		
 		if(!$errors)
 		{
+			if($pid < 0)
+			{
+				$pid = 0;
+			}
 			$update_array = array(
 				"name" => $db->escape_string($mybb->input['title']),
 				"description" => $db->escape_string($mybb->input['description']),
@@ -1090,7 +1100,7 @@
 				"modthreads" => intval($mybb->input['modthreads']),
 				"mod_edit_posts" => intval($mybb->input['mod_edit_posts']),
 				"modattachments" => intval($mybb->input['modattachments']),
-				"style" => intval($mybb->input['fstyle']),
+				"style" => intval($mybb->input['style']),
 				"overridestyle" => intval($mybb->input['overridestyle']),
 				"rulestype" => intval($mybb->input['rulestype']),
 				"rulestitle" => $db->escape_string($mybb->input['rulestitle']),
@@ -1143,7 +1153,6 @@
 			
 			$canview = $permissions['canview'];
 			$canpostthreads = $permissions['canpostthreads'];
-			$canpostreplies = $permissions['canpostreplies'];
 			$canpostpolls = $permissions['canpostpolls'];
 			$canpostattachments = $permissions['canpostattachments'];
 			$canpostreplies = $permissions['canpostreplys'];
@@ -1389,6 +1398,7 @@
 				$default_checked = true;
 			}
 		}
+		$all_check = "";
 		$perm_check = "";
 		$all_checked = true;
 		foreach($field_list as $forum_permission)
@@ -1503,7 +1513,7 @@
 		
 		$db->delete_query("moderators", "mid='{$mid}'");
 		$query = $db->simple_select("moderators", "*", "uid='{$mod['uid']}'");
-		if($db->fetch_array($query))
+		if($db->num_rows($query) == 0)
 		{
 			$updatequery = array(
 				"usergroup" => "2"
@@ -1618,6 +1628,7 @@
 		$db->delete_query("threads", "fid='{$fid}' {$delquery}");
 		$db->delete_query("posts", "fid='{$fid}' {$delquery}");
 		$db->delete_query("moderators", "fid='{$fid}' {$delquery}");
+		$db->delete_query("forumsubscriptions", "fid='{$fid}' {$delquery}");
 
 		$cache->update_forums();
 		$cache->update_moderators();
@@ -1651,6 +1662,11 @@
 		{
 			$inherit = $mybb->input['default_permissions'];
 			
+			if(empty($mybb->input['permissions']))
+			{
+    			$mybb->input['permissions'] = array();
+			}
+			
 			foreach($mybb->input['permissions'] as $gid => $permission)
 			{
 				foreach(array('canview','canpostthreads','canpostreplys','canpostpolls','canpostattachments') as $name)
@@ -1911,6 +1927,8 @@
 					$default_checked = true;
 				}
 			}
+			
+			$all_check = "";
 			$perm_check = "";
 			$all_checked = true;
 			foreach($field_list as $forum_permission)
@@ -2035,7 +2053,7 @@
 
 		foreach($forum_cache as $forum)
 		{
-			$forums_by_parent[$forum['pid']][$val['disporder']][$forum['fid']] = $forum;
+			$forums_by_parent[$forum['pid']][$forum['disporder']][$forum['fid']] = $forum;
 		}
 	}
 
@@ -2094,6 +2112,7 @@
 			{
 				if($forum['description'])
 				{
+					$forum['description'] = preg_replace("#&(?!\#[0-9]+;)#si", "&amp;", $forum['description']);
            			$forum['description'] = "<br /><small>".$forum['description']."</small>";
        			}
 			
@@ -2141,9 +2160,9 @@
 				++$donecount;
 				if($donecount == $mybb->settings['subforumsindex'])
 				{
-					if(count($children) > $donecount)
+					if(subforums_count($forums_by_parent[$pid]) > $donecount)
 					{
-						$sub_forums .= $comma.$lang->sprintf($lang->more_subforums, (count($children) - $donecount));
+						$sub_forums .= $comma.$lang->sprintf($lang->more_subforums, (subforums_count($forums_by_parent[$pid]) - $donecount));
 						return;
 					}
 				}
diff -rub mybb_1400/admin/modules/forum/moderation_queue.php mybb_1408/admin/modules/forum/moderation_queue.php
--- mybb_1400/admin/modules/forum/moderation_queue.php	2008-06-15 22:40:36.000000000 +0200
+++ mybb_1408/admin/modules/forum/moderation_queue.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: moderation_queue.php 3918 2008-06-15 20:40:36Z Tikitiki $
+ * $Id: moderation_queue.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/forum/module_meta.php mybb_1408/admin/modules/forum/module_meta.php
--- mybb_1400/admin/modules/forum/module_meta.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/forum/module_meta.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: module_meta.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: module_meta.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/home/credits.php mybb_1408/admin/modules/home/credits.php
--- mybb_1400/admin/modules/home/credits.php	2008-06-22 04:03:53.000000000 +0200
+++ mybb_1408/admin/modules/home/credits.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: credits.php 3939 2008-06-22 02:03:53Z Tikitiki $
+ * $Id: credits.php 4355 2009-04-19 02:10:09Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -40,32 +40,51 @@
 	$page->output_nav_tabs($sub_tabs, 'credits');
 	
 	$table = new Table;
-	$table->construct_header($lang->product_managers, array('width' => '33%'));
-	$table->construct_header($lang->developers, array('width' => '33%'));
-	$table->construct_header($lang->graphics_and_style, array('width' => '33%'));
+	$table->construct_header($lang->product_managers, array('width' => '20%'));
+	$table->construct_header($lang->developers, array('width' => '20%'));
+	$table->construct_header($lang->graphics_and_style, array('width' => '20%'));
+	$table->construct_header($lang->software_quality_assurance, array('width' => '20%'));
+	$table->construct_header($lang->support_representative, array('width' => '20%'));
 	
 	$table->construct_cell("<a href=\"http://community.mybboard.net/user-1.html\" target=\"_blank\">Chris Boulton</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-2165.html\" target=\"_blank\">Ryan Gordon</a>");	
 	$table->construct_cell("<a href=\"http://community.mybboard.net/user-1.html\" target=\"_blank\">Chris Boulton</a>");	
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-1.html\" target=\"_blank\">Chris Boulton</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-895.html\" target=\"_blank\">Michael Schlechtinger</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-3971.html\" target=\"_blank\">Ryan Loos</a>");
 	$table->construct_row();
 	
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-14.html\" target=\"_blank\">Musicalmidget</a>");
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-81.html\" target=\"_blank\">DennisTT</a>");
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-5.html\" target=\"_blank\">Scott Hough</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-14.html\" target=\"_blank\">Alan Crisp</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-81.html\" target=\"_blank\">Dennis Tsang</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-1830.html\" target=\"_blank\">Justin S.</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-1331.html\" target=\"_blank\">Chris</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-2249.html\" target=\"_blank\">Kevin Camps</a>");
 	$table->construct_row();	
 	
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-27.html\" target=\"_blank\">Tochjo</a>");
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-2165.html\" target=\"_blank\">Tikitiki</a>");
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-1830.html\" target=\"_blank\">Justin S.</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-27.html\" target=\"_blank\">Tom Huls</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-14621.html\" target=\"_blank\">Tom Moore</a>");
+	$table->construct_cell("&nbsp;");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-2824.html\" target=\"_blank\">Stefan T.</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-13556.html\" target=\"_blank\">Matt Rogowski</a>");
 	$table->construct_row();
 	
 	$table->construct_cell("<a href=\"http://community.mybboard.net/user-81.html\" target=\"_blank\">DennisTT</a>");
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-1653.html\" target=\"_blank\">DrPoodle</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-1923.html\" target=\"_blank\">Sergio Montoya</a>");
+	$table->construct_cell("&nbsp;");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-8242.html\" target=\"_blank\">dvb</a>");
 	$table->construct_cell("&nbsp;");
 	$table->construct_row();
 	
 	$table->construct_cell("&nbsp;");
-	$table->construct_cell("<a href=\"http://community.mybboard.net/user-7473.html\" target=\"_blank\">ZiNgA BuRgA</a>");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-6391.html\" target=\"_blank\">Jason Martin</a>");
+	$table->construct_cell("&nbsp;");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-6928.html\" target=\"_blank\">Imad Jomaa</a>");
+	$table->construct_cell("&nbsp;");
+	$table->construct_row();
+	
+	$table->construct_cell("&nbsp;");
+	$table->construct_cell("&nbsp;");
+	$table->construct_cell("&nbsp;");
+	$table->construct_cell("<a href=\"http://community.mybboard.net/user-9138.html\" target=\"_blank\">Max Marze</a>");
 	$table->construct_cell("&nbsp;");
 	$table->construct_row();
 	
diff -rub mybb_1400/admin/modules/home/index.php mybb_1408/admin/modules/home/index.php
--- mybb_1400/admin/modules/home/index.php	2008-07-04 01:07:21.000000000 +0200
+++ mybb_1408/admin/modules/home/index.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: index.php 3975 2008-07-03 23:07:21Z Tikitiki $
+ * $Id: index.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -86,7 +86,6 @@
 	$posts = my_number_format($stats['numposts']);
 
 	// Get the number of unapproved posts
-	$stats['numunapprovedposts'] -= $stats['numunapprovedthreads'];
 	if($stats['numunapprovedposts'] < 0)
 	{
 		$status['numunapprovedposts'] = 0;
@@ -145,7 +144,7 @@
 	$table->construct_cell("<strong>{$lang->sql_engine}</strong>", array('width' => '25%'));
 	$table->construct_cell($db->short_title." ".$db->get_version(), array('width' => '25%'));
 	$table->construct_cell("<strong>{$lang->users}</strong>", array('width' => '25%'));
-	$table->construct_cell("<a href=\"index.php?module=user/users\"><strong>{$users}</strong> {$lang->registered_users}</a><br /><strong>{$activeusers}</strong> {$lang->active_users}<br /><strong>{$newusers}</strong> {$lang->registrations_today}<br /><a href=\"index.php?module=user/users&amp;action=search&amp;results=1&amp;conditions=".urlencode(serialize(array('usergroup' => '5')))."\"><strong>{$awaitingusers}</strong> {$lang->awaiting_activation}</a>", array('width' => '25%'));
+	$table->construct_cell("<a href=\"index.php?module=user/users\"><strong>{$users}</strong> {$lang->registered_users}</a><br /><strong>{$activeusers}</strong> {$lang->active_users}<br /><strong>{$newusers}</strong> {$lang->registrations_today}<br /><a href=\"index.php?module=user/users&amp;action=search&amp;results=1&amp;conditions=".urlencode(serialize(array('usergroup' => '5')))."&amp;from=home\"><strong>{$awaitingusers}</strong> {$lang->awaiting_activation}</a>", array('width' => '25%'));
 	$table->construct_row();
 	
 	$table->construct_cell("<strong>{$lang->server_load}</strong>", array('width' => '25%'));
diff -rub mybb_1400/admin/modules/home/module_meta.php mybb_1408/admin/modules/home/module_meta.php
--- mybb_1400/admin/modules/home/module_meta.php	2008-04-30 07:24:53.000000000 +0200
+++ mybb_1408/admin/modules/home/module_meta.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: module_meta.php 3806 2008-04-30 05:24:53Z Tikitiki $
+ * $Id: module_meta.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -75,16 +75,50 @@
 
 		// Online Administrators in the last 30 minutes
 		$timecut = TIME_NOW-60*30;
-		$query = $db->query("
-			SELECT u.uid, u.username, s.ip
-			FROM ".TABLE_PREFIX."adminsessions s
-			LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=s.uid)
-			WHERE s.lastactive > {$timecut}
-			ORDER BY u.username
-		");
+		$query = $db->simple_select("adminsessions", "uid, ip", "lastactive > {$timecut}");
 		$online_users = "<ul class=\"menu online_admins\">";
+		$online_admins = array();
+		
+		// If there's only 1 user online, it has to be us.
+		if($db->num_rows($query) == 1)
+		{
+			global $mybb;
+			
+			$online_admins[$mybb->user['username']] = array(
+				"uid" => $mybb->user['uid'],
+				"username" => $mybb->user['username'],
+				"ip" => $db->fetch_field($query, "ip")
+			);
+		}
+		else
+		{
+			$uid_in = array();
+			while($user = $db->fetch_array($query))
+			{
+				$uid_in[] = $user['uid'];
+				$online_admins[$user['uid']] = array(
+					"uid" => $user['uid'],
+					"username" => "",
+					"ip" => $user['ip']
+				);
+			}
+			
+			$query = $db->simple_select("users", "uid, username", "uid IN(".implode(',', $uid_in).")", array('order_by' => 'username'));
 		while($user = $db->fetch_array($query))
 		{
+				$online_admins[$user['username']] = array(
+					"uid" => $user['uid'],
+					"username" => $user['username'],
+					"ip" => $online_admins[$user['uid']]['ip']
+				);
+				unset($online_admins[$user['uid']]);
+			}
+		}
+		
+		asort($online_admins);
+		
+		foreach($online_admins as $user)
+		{
 			if(!$done_users["{$user['uid']}.{$user['ip']}"])
 			{
 				if($user['type'] == "mobile")
diff -rub mybb_1400/admin/modules/home/preferences.php mybb_1408/admin/modules/home/preferences.php
--- mybb_1400/admin/modules/home/preferences.php	2008-06-06 01:54:22.000000000 +0200
+++ mybb_1408/admin/modules/home/preferences.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: preferences.php 3886 2008-06-05 23:54:22Z Tikitiki $
+ * $Id: preferences.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -33,7 +33,8 @@
 			"cpstyle" => $db->escape_string($mybb->input['cpstyle']),
 			"permissions" => $db->escape_string($adminopts['permissions']),
 			"defaultviews" => $db->escape_string($adminopts['defaultviews']),
-			"uid" => $mybb->user['uid']
+			"uid" => $mybb->user['uid'],
+			"codepress" => intval($mybb->input['codepress']),
 		);
 
 		$db->replace_query("adminoptions", $sqlarray, "uid");
@@ -54,7 +55,7 @@
 
 	$page->output_nav_tabs($sub_tabs, 'preferences');	
 	
-	$query = $db->simple_select("adminoptions", "notes, cpstyle", "uid='".$mybb->user['uid']."'", array('limit' => 1));
+	$query = $db->simple_select("adminoptions", "notes, cpstyle, codepress", "uid='".$mybb->user['uid']."'", array('limit' => 1));
 	$admin_options = $db->fetch_array($query);
 	
 	$form = new Form("index.php?module=home/preferences", "post");
@@ -71,9 +72,12 @@
 	$setting_code = $form->generate_select_box("cpstyle", $folders, $admin_options['cpstyle']);
 	
 	$table = new Table;
-	$table->construct_header($lang->acp_theme);
+	$table->construct_header($lang->global_preferences);
 	
-	$table->construct_cell($lang->select_acp_theme."<br />{$setting_code}");
+	$table->construct_cell("<strong>{$lang->acp_theme}</strong><br /><small>{$lang->select_acp_theme}</small><br /><br />{$setting_code}");
+	$table->construct_row();
+	
+	$table->construct_cell("<strong>{$lang->codepress}</strong><br /><small>{$lang->use_codepress_desc}</small><br /><br />".$form->generate_yes_no_radio('codepress', $admin_options['codepress']));
 	$table->construct_row();
 	
 	$table->output($lang->preferences);
diff -rub mybb_1400/admin/modules/home/version_check.php mybb_1408/admin/modules/home/version_check.php
--- mybb_1400/admin/modules/home/version_check.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/home/version_check.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: version_check.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: version_check.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -59,6 +59,19 @@
 		exit;
 	}
 
+	// We do this because there is some weird symbols that show up in the xml file for unknown reasons
+	$pos = strpos($contents, "<");
+	if($pos > 1)
+	{
+		$contents = substr($contents, $pos);
+	}
+	
+	$pos = strpos(strrev($contents), ">");
+	if($pos > 1)
+	{
+		$contents = substr($contents, 0, (-1) * ($pos-1));
+	}
+
 	$parser = new XMLParser($contents);
 	$tree = $parser->get_tree();
 
diff -rub mybb_1400/admin/modules/style/module_meta.php mybb_1408/admin/modules/style/module_meta.php
--- mybb_1400/admin/modules/style/module_meta.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/style/module_meta.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: module_meta.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: module_meta.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/style/templates.php mybb_1408/admin/modules/style/templates.php
--- mybb_1400/admin/modules/style/templates.php	2008-07-20 22:56:39.000000000 +0200
+++ mybb_1408/admin/modules/style/templates.php	2009-06-26 07:26:49.000000000 +0200
@@ -25,7 +25,7 @@
 if(isset($mybb->input['expand']))
 {
 	$expand_array = explode("|", $mybb->input['expand']);
-	array_map("intval", $expand_array);
+	$expand_array = array_map("intval", $expand_array);
 	$expand_str = "&amp;expand=".implode("|", $expand_array);
 	$expand_str2 = "&expand=".implode("|", $expand_array);
 }
@@ -164,7 +164,7 @@
 	{
 		if(empty($mybb->input['title']))
 		{
-			$errors[] = $lang->error_missing_title;
+			$errors[] = $lang->error_missing_set_title;
 		}
 		else
 		{	
@@ -202,7 +202,7 @@
 			
 			if($mybb->input['continue'])
 			{
-				admin_redirect("index.php?module=style/templates&action=edit_template&tid=".intval($tid)."&sid=".$sid.$expand_str2);
+				admin_redirect("index.php?module=style/templates&action=edit_template&title=".urlencode($mybb->input['title'])."&sid=".$sid.$expand_str2);
 			}
 			else
 			{
@@ -231,12 +231,15 @@
 		$page->add_breadcrumb_item($template_sets[$sid], "index.php?module=style/templates&amp;sid={$sid}{$expand_str}");
 	}
 	
+	if($admin_options['codepress'] != 0)
+	{
 	$page->extra_header .= '
 	<link type="text/css" href="./jscripts/codepress/languages/codepress-mybb.css" rel="stylesheet" id="cp-lang-style" />
 	<script type="text/javascript" src="./jscripts/codepress/codepress.js"></script>
 	<script type="text/javascript">
 		CodePress.language = \'mybb\';
 	</script>';
+	}
 	
 	$page->add_breadcrumb_item($lang->add_template);
 	
@@ -271,7 +274,9 @@
 	
 	$form->end();
 	
-	echo "<script language=\"Javascript\" type=\"text/javascript\">
+	if($admin_options['codepress'] != 0)
+	{
+		echo "<script type=\"text/javascript\">
 	Event.observe('add_template', 'submit', function()
 	{
 		if($('template_cp')) {
@@ -282,6 +287,7 @@
 		}
 	});
 </script>";
+	}
 
 	$page->output_footer();
 }
@@ -367,7 +373,7 @@
 {
 	$plugins->run_hooks("admin_style_templates_edit_template");
 	
-	if(!$mybb->input['tid'] || !$sid)
+	if(!$mybb->input['title'] || !$sid)
 	{
 		flash_message($lang->error_missing_input, 'error');
 		admin_redirect("index.php?module=style/templates");
@@ -433,7 +439,20 @@
 			
 			if($mybb->input['continue'])
 			{
-				admin_redirect("index.php?module=style/templates&action=edit_template&tid=".intval($mybb->input['tid'])."&sid=".$sid.$expand_str2);
+				if($mybb->input['from'] == "diff_report")
+				{
+					admin_redirect("index.php?module=style/templates&action=edit_template&title=".urlencode($mybb->input['title'])."&sid=".$sid.$expand_str2."&amp;from=diff_report");
+				}
+				else
+				{
+					admin_redirect("index.php?module=style/templates&action=edit_template&title=".urlencode($mybb->input['title'])."&sid=".$sid.$expand_str2);
+				}
+			}
+			else
+			{
+				if($mybb->input['from'] == "diff_report")
+				{
+					admin_redirect("index.php?module=style/templates&amp;action=find_updated");
 			}
 			else
 			{
@@ -441,6 +460,7 @@
 			}
 		}
 	}
+	}
 	
 	if($errors)
 	{
@@ -449,37 +469,61 @@
 	}
 	else
 	{
-		$query = $db->simple_select("templates", "title", "tid='".intval($mybb->input['tid'])."' AND (sid='-2' OR sid='{$sid}')", array('order_by' => 'sid', 'order_dir' => 'ASC', 'limit' => 1));
-		$title = $db->fetch_field($query, "title");
-		
-		$query = $db->simple_select("templates", "*", "title='".$db->escape_string($title)."' AND (sid='-2' OR sid='{$sid}')", array('order_by' => 'sid', 'order_dir' => 'DESC', 'limit' => 1));
+		$query = $db->simple_select("templates", "*", "title='".$db->escape_string($mybb->input['title'])."' AND (sid='-2' OR sid='{$sid}')", array('order_by' => 'sid', 'order_dir' => 'DESC', 'limit' => 1));
 		$template = $db->fetch_array($query);
 	}
 	
+	if($admin_options['codepress'] != 0)
+	{
 	$page->extra_header .= '
 	<link type="text/css" href="./jscripts/codepress/languages/codepress-mybb.css" rel="stylesheet" id="cp-lang-style" />
 	<script type="text/javascript" src="./jscripts/codepress/codepress.js"></script>
 	<script type="text/javascript">
 		CodePress.language = \'mybb\';
 	</script>';
+	}
 	
 	$page->add_breadcrumb_item($template_sets[$sid], "index.php?module=style/templates&amp;sid={$sid}{$expand_str}");
 	
+	if($mybb->input['from'] == "diff_report")
+	{
+		$page->add_breadcrumb_item($lang->find_updated, "index.php?module=style/templates&amp;action=find_updated");
+	}
+	
 	$page->add_breadcrumb_item($lang->edit_template_breadcrumb.$template['title'], "index.php?module=style/templates&amp;sid={$sid}");
 	
 	$page->output_header($lang->edit_template);
 	
 	$sub_tabs = array();
+	
+	if($mybb->input['from'] == "diff_report")
+	{
+		$sub_tabs['find_updated'] = array(
+			'title' => $lang->find_updated,
+			'link' => "index.php?module=style/templates&amp;action=find_updated"
+		);
+		
+		$sub_tabs['diff_report'] = array(
+			'title' => $lang->diff_report,
+			'link' => "index.php?module=style/templates&amp;action=diff_report&amp;title=".$db->escape_string($template['title'])."&amp;sid1=".intval($template['sid'])."&amp;sid2=-2",
+		);
+	}
+	
 	$sub_tabs['edit_template'] = array(
 		'title' => $lang->edit_template,
-		'link' => "index.php?module=style/templates&amp;action=edit_template&amp;tid=".$mybb->input['tid'].$expand_str,
+		'link' => "index.php?module=style/templates&amp;action=edit_template&amp;title=".htmlspecialchars_uni($template['title']).$expand_str,
 		'description' => $lang->edit_template_desc
 	);
 	
 	$page->output_nav_tabs($sub_tabs, 'edit_template');
 	
 	$form = new Form("index.php?module=style/templates&amp;action=edit_template{$expand_str}", "post", "edit_template");
-	echo $form->generate_hidden_field('tid', $template['tid']);
+	echo $form->generate_hidden_field('tid', $template['tid'])."\n";
+	
+	if($mybb->input['from'] == "diff_report")
+	{
+		echo $form->generate_hidden_field('from', "diff_report");
+	}
 		
 	$form_container = new FormContainer($lang->edit_template_breadcrumb.$template['title']);
 	$form_container->output_row($lang->template_name, $lang->template_name_desc, $form->generate_text_box('title', $template['title'], array('id' => 'title')), 'title');
@@ -494,7 +538,9 @@
 	
 	$form->end();
 	
-	echo "<script language=\"Javascript\" type=\"text/javascript\">
+	if($admin_options['codepress'] != 0)
+	{
+		echo "<script type=\"text/javascript\">
 	Event.observe('edit_template', 'submit', function()
 	{
 		if($('template_cp')) {
@@ -505,6 +551,7 @@
 		}
 	});
 </script>";
+	}
 
 	$page->output_footer();
 }
@@ -526,6 +573,8 @@
 			}
 			else
 			{				
+				$page->add_breadcrumb_item($lang->search_replace);
+				
 				$page->output_header($lang->search_replace);
 	
 				$page->output_nav_tabs($sub_tabs, 'search_replace');
@@ -574,7 +623,7 @@
 						foreach($templates as $title => $template)
 						{
 							// Do replacement
-							$newtemplate = str_replace($mybb->input['find'], $mybb->input['replace'], $template['template']);
+							$newtemplate = str_ireplace($mybb->input['find'], $mybb->input['replace'], $template['template']);
 							if($newtemplate != $template['template'])
 							{
 								// If the template is different, that means the search term has been found.
@@ -593,7 +642,7 @@
 										);
 										$new_tid = $db->insert_query("templates", $new_template);
 										$label = $lang->sprintf($lang->search_created_custom, $template['title']);
-										$url = "index.php?module=style/templates&amp;action=edit_template&amp;tid={$new_tid}&amp;sid=1";
+										$url = "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid=1";
 									}
 									else
 									{
@@ -604,7 +653,7 @@
 										);
 										$db->update_query("templates", $updatedtemplate, "tid='".$template['tid']."'");
 										$label = $lang->sprintf($lang->search_updated, $template['title']);
-										$url = "index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$template['sid']}";
+										$url = "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$template['sid']}";
 									}
 								}
 								else
@@ -617,9 +666,22 @@
 									else
 									{
 										$label = $lang->sprintf($lang->search_found, $template['title']);
-										$url = "index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$template['sid']}";
+										$url = "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$template['sid']}";
+									}
 									}
 								}
+							else
+							{
+								// Just show that the term was found
+								if($template['sid'] == -2)
+								{
+									$label = $lang->sprintf($lang->search_found, $template['title']);
+								}
+								else
+								{
+									$label = $lang->sprintf($lang->search_found, $template['title']);
+									$url = "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$template['sid']}";
+								}
 							}
 						
 							$table->construct_cell($label, array("width" => "85%"));
@@ -632,7 +694,7 @@
 								{
 									if($set_sid > 0)
 									{									
-										$popup->add_item($lang->edit_in." ".htmlspecialchars_uni($title), "index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$set_sid}");
+										$popup->add_item($lang->edit_in." ".htmlspecialchars_uni($title), "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$set_sid}");
 									}
 								}
 								
@@ -722,6 +784,8 @@
 					$templatessets[$template['sid']][$template['title']] = $template;
 				}
 				
+				$page->add_breadcrumb_item($lang->search_replace);
+				
 				$page->output_header($lang->search_replace);
 	
 				$page->output_nav_tabs($sub_tabs, 'search_replace');
@@ -745,6 +809,8 @@
 					
 					foreach($templates as $template)
 					{
+						$template['pretty_title'] = $template['title'];
+						
 						$popup = new PopupMenu("template_{$template['tid']}", $lang->options);
 						
 						if($sid == -2)
@@ -753,12 +819,12 @@
 							{
 								if($set_sid < 0) continue;
 								
-								$popup->add_item($lang->edit_in." ".htmlspecialchars_uni($title), "index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$set_sid}");
+								$popup->add_item($lang->edit_in." ".htmlspecialchars_uni($title), "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$set_sid}");
 							}
 						}
 						else
 						{
-							$popup->add_item($lang->full_edit, "index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$sid}");
+							$popup->add_item($lang->full_edit, "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$sid}");
 						}
 						
 						if(isset($template['modified']) && $template['modified'] == true)
@@ -767,20 +833,20 @@
 							{
 								$popup->add_item($lang->diff_report, "index.php?module=style/templates&amp;action=diff_report&amp;title=".urlencode($template['title'])."&amp;sid2={$sid}");
 							
-								$popup->add_item($lang->revert_to_orig, "index.php?module=style/templates&amp;action=revert&amp;tid={$template['tid']}&amp;sid={$sid}&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_revertion}')");
+								$popup->add_item($lang->revert_to_orig, "index.php?module=style/templates&amp;action=revert&amp;title=".urlencode($template['title'])."&amp;sid={$sid}&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_revertion}')");
 							}
 							
-							$template['title'] = "<span style=\"color: green;\">{$template['title']}</span>";
+							$template['pretty_title'] = "<span style=\"color: green;\">{$template['title']}</span>";
 						}				
 						// This template does not exist in the master list
 						else if(!isset($template['original']) || $template['original'] == false)
 						{
-							$popup->add_item($lang->delete_template, "index.php?module=style/templates&amp;action=delete_template&amp;tid={$template['tid']}&amp;sid={$sid}&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_deletion}')");
+							$popup->add_item($lang->delete_template, "index.php?module=style/templates&amp;action=delete_template&amp;title=".urlencode($template['title'])."&amp;sid={$sid}&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_deletion}')");
 							
-							$template['title'] = "<span style=\"color: blue;\">{$template['title']}</span>";
+							$template['pretty_title'] = "<span style=\"color: blue;\">{$template['title']}</span>";
 						}
 											
-						$table->construct_cell("<span style=\"padding: 20px;\"><a href=\"index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$sid}\">{$template['title']}</a></span>", array("width" => "85%"));
+						$table->construct_cell("<span style=\"padding: 20px;\">{$template['pretty_title']}</span>", array("width" => "85%"));
 						$table->construct_cell($popup->fetch(), array("class" => "align_center"));
 						
 						$table->construct_row();
@@ -802,12 +868,17 @@
 		}
 	}
 	
+	if($admin_options['codepress'] != 0)
+	{
 	$page->extra_header .= '
 	<link type="text/css" href="./jscripts/codepress/languages/codepress-php.css" rel="stylesheet" id="cp-lang-style" />
 	<script type="text/javascript" src="./jscripts/codepress/codepress.js"></script>
 	<script type="text/javascript">
 		CodePress.language = \'php\';
 	</script>';
+	}
+	
+	$page->add_breadcrumb_item($lang->search_replace);
 	
 	$page->output_header($lang->search_replace);
 	
@@ -848,7 +919,9 @@
 	
 	$form->end();
 	
-	echo "<script language=\"Javascript\" type=\"text/javascript\">
+	if($admin_options['codepress'] != 0)
+	{
+		echo "<script type=\"text/javascript\">
 	Event.observe('do_template', 'submit', function()
 	{
 		if($('find_cp')) {
@@ -866,6 +939,7 @@
 		}
 	});
 </script>";
+	}
 
 	$page->output_footer();
 }
@@ -890,6 +964,8 @@
 		admin_redirect("index.php?module=style/templates");
 	}
 	
+	$page->add_breadcrumb_item($lang->find_updated, "index.php?module=style/templates&amp;action=find_updated");
+	
 	$page->output_header($lang->find_updated);
 	
 	$page->output_nav_tabs($sub_tabs, 'find_updated');
@@ -943,12 +1019,11 @@
 		foreach($templates as $template)
 		{		
 			$popup = new PopupMenu("template_{$template['tid']}", $lang->options);
-			//$popup->add_item($lang->inline_edit, "javascript:;");
-			$popup->add_item($lang->full_edit, "index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid=".$sid);
+			$popup->add_item($lang->full_edit, "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$sid}&amp;from=diff_report");
 			$popup->add_item($lang->diff_report, "index.php?module=style/templates&amp;action=diff_report&amp;title=".urlencode($template['title'])."&amp;sid1=".$template['sid']."&amp;sid2=-2");
-			$popup->add_item($lang->revert_to_orig, "index.php?module=style/templates&amp;action=revert&amp;tid={$template['tid']}&amp;sid={$sid}&amp;find_updated=1&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_revertion}')");
+			$popup->add_item($lang->revert_to_orig, "index.php?module=style/templates&amp;action=revert&amp;title=".urlencode($template['title'])."&amp;sid={$sid}&amp;from=diff_report&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_revertion}')");
 				
-			$table->construct_cell("<a href=\"index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$sid}\">{$template['title']}</a>", array('width' => '80%')); // onclick=\"Templates.quick_edit('{$template['tid']}'); return false;\"
+			$table->construct_cell("<a href=\"index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$sid}&amp;from=diff_report\">{$template['title']}</a>", array('width' => '80%'));
 			$table->construct_cell($popup->fetch(), array("class" => "align_center"));
 			
 			$table->construct_row();
@@ -1034,7 +1109,7 @@
 		SELECT t.*, s.title as set_title
 		FROM ".TABLE_PREFIX."templates t
 		LEFT JOIN ".TABLE_PREFIX."templatesets s ON(t.sid=s.sid)
-		WHERE t.tid='".intval($mybb->input['tid'])."' AND t.sid > '-2' AND t.sid = '{$sid}'
+		WHERE t.title='".$db->escape_string($mybb->input['title'])."' AND t.sid > '-2' AND t.sid = '{$sid}'
 	");
 	$template = $db->fetch_array($query);
 	
@@ -1100,6 +1175,14 @@
 	$query = $db->simple_select("templates", "*", "title='".$db->escape_string($mybb->input['title'])."' AND sid='".intval($mybb->input['sid2'])."'");
 	$template2 = $db->fetch_array($query);
 
+	if($mybb->input['sid2'] == -2)
+	{
+		$sub_tabs['full_edit'] = array(
+			'title' => $lang->full_edit,
+			'link' => "index.php?module=style/templates&action=edit_template&title=".urlencode($template1['title'])."&sid=".intval($mybb->input['sid1'])."&amp;from=diff_report",
+		);
+	}
+
 	if($template1['template'] == $template2['template'])
 	{
 		flash_message($lang->templates_the_same, 'error');
@@ -1121,6 +1204,13 @@
 		$page->add_breadcrumb_item($template_sets[$sid], "index.php?module=style/templates&amp;sid={$sid}{$expand_str}");
 	}
 	
+	if($mybb->input['sid2'] == -2)
+	{
+		$page->add_breadcrumb_item($lang->find_updated, "index.php?module=style/templates&amp;action=find_updated");
+	}
+	
+	$page->add_breadcrumb_item($lang->diff_report.": ".$template1['title'], "index.php?module=style/templates&amp;action=diff_report&amp;title=".$db->escape_string($mybb->input['title'])."&amp;sid1=".intval($mybb->input['sid1'])."&amp;sid2=".intval($mybb->input['sid2']));
+	
 	$page->output_header($lang->template_sets);
 	
 	$page->output_nav_tabs($sub_tabs, 'diff_report');
@@ -1129,10 +1219,10 @@
 	
 	$table->construct_header("<ins>".$lang->master_updated_ins."</ins><br /><del>".$lang->master_updated_del."</del>");
 	
-	$table->construct_cell("<pre>".$renderer->render($diff)."</pre>");
+	$table->construct_cell("<pre class=\"differential\">".$renderer->render($diff)."</pre>");
 	$table->construct_row();
 	
-	$table->output($lang->template_diff_analysis);
+	$table->output($lang->template_diff_analysis.": ".$template1['title']);
 	
 	$page->output_footer();
 }
@@ -1145,7 +1235,7 @@
 		SELECT t.*, s.title as set_title
 		FROM ".TABLE_PREFIX."templates t
 		LEFT JOIN ".TABLE_PREFIX."templatesets s ON(s.sid=t.sid)
-		WHERE t.tid='".intval($mybb->input['tid'])."' AND t.sid > 0 AND t.sid = '".intval($mybb->input['sid'])."'
+		WHERE t.title='".$db->escape_string($mybb->input['title'])."' AND t.sid > 0 AND t.sid = '".intval($mybb->input['sid'])."'
 	");
 	$template = $db->fetch_array($query);
 	
@@ -1174,7 +1264,7 @@
 
 		flash_message($lang->success_template_reverted, 'success');
 		
-		if($mybb->input['find_updated'] == 1)
+		if($mybb->input['from'] == "diff_report")
 		{
 			admin_redirect("index.php?module=style/templates&action=find_updated");
 		}
@@ -1211,10 +1301,10 @@
 		while($template = $db->fetch_array($query))
 		{
 			$popup = new PopupMenu("template_{$template['tid']}", $lang->options);
-			$popup->add_item($lang->full_edit, "index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid=-1");
-			$popup->add_item($lang->delete_template, "index.php?module=style/templates&amp;action=delete_template&amp;tid={$template['tid']}&amp;sid=-1&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_deletion}')");
+			$popup->add_item($lang->full_edit, "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid=-1");
+			$popup->add_item($lang->delete_template, "index.php?module=style/templates&amp;action=delete_template&amp;title=".urlencode($template['title'])."&amp;sid=-1&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_deletion}')");
 				
-			$table->construct_cell("<a href=\"index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid=-1\">{$template['title']}</a>");
+			$table->construct_cell("<a href=\"index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid=-1\">{$template['title']}</a>");
 			$table->construct_cell($popup->fetch(), array("class" => "align_center"));
 			
 			$table->construct_row();
@@ -1348,8 +1438,13 @@
 			$group['expand_str'] .= $group['gid'];
 		}
 		
-		$table->construct_cell("<strong><a href=\"index.php?module=style/templates&amp;sid={$sid}&amp;expand={$group['expand_str']}#group_{$group['gid']}\">{$group['title']}</a></strong>");
-		$table->construct_cell("<a href=\"index.php?module=style/templates&amp;sid={$sid}&amp;expand={$group['expand_str']}#group_{$group['gid']}\">{$expand}</a>", array("class" => "align_center"));
+		if($group['expand_str'])
+		{
+			$group['expand_str'] = "&amp;expand={$group['expand_str']}";
+		}
+		
+		$table->construct_cell("<strong><a href=\"index.php?module=style/templates&amp;sid={$sid}{$group['expand_str']}#group_{$group['gid']}\">{$group['title']}</a></strong>");
+		$table->construct_cell("<a href=\"index.php?module=style/templates&amp;sid={$sid}{$group['expand_str']}#group_{$group['gid']}\">{$expand}</a>", array("class" => "align_center"));
 		$table->construct_row(array("class" => "alt_row", "id" => "group_".$group['gid'], "name" => "group_".$group['gid']));
 		
 		if($expanded == true && isset($group['templates']) && count($group['templates']) > 0)
@@ -1359,8 +1454,10 @@
 			
 			foreach($templates as $template)
 			{
+				$template['pretty_title'] = $template['title'];
+				
 				$popup = new PopupMenu("template_{$template['tid']}", $lang->options);
-				$popup->add_item($lang->full_edit, "index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$sid}{$expand_str}");
+				$popup->add_item($lang->full_edit, "index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$sid}{$expand_str}");
 				
 				if(isset($template['modified']) && $template['modified'] == true)
 				{					
@@ -1368,20 +1465,20 @@
 					{
 						$popup->add_item($lang->diff_report, "index.php?module=style/templates&amp;action=diff_report&amp;title=".urlencode($template['title'])."&amp;sid2={$sid}");
 					
-						$popup->add_item($lang->revert_to_orig, "index.php?module=style/templates&amp;action=revert&amp;tid={$template['tid']}&amp;sid={$sid}&amp;my_post_key={$mybb->post_code}{$expand_str}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_revertion}')");
+						$popup->add_item($lang->revert_to_orig, "index.php?module=style/templates&amp;action=revert&amp;title=".urlencode($template['title'])."&amp;sid={$sid}&amp;my_post_key={$mybb->post_code}{$expand_str}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_revertion}')");
 					}
 					
-					$template['title'] = "<span style=\"color: green;\">{$template['title']}</span>";
+					$template['pretty_title'] = "<span style=\"color: green;\">{$template['title']}</span>";
 				}				
 				// This template does not exist in the master list
 				else if(isset($template['original']) && $template['original'] == false)
 				{
-					$popup->add_item($lang->delete_template, "index.php?module=style/templates&amp;action=delete_template&amp;tid={$template['tid']}&amp;sid={$sid}&amp;my_post_key={$mybb->post_code}{$expand_str}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_deletion}')");
+					$popup->add_item($lang->delete_template, "index.php?module=style/templates&amp;action=delete_template&amp;title=".urlencode($template['title'])."&amp;sid={$sid}&amp;my_post_key={$mybb->post_code}{$expand_str}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_template_deletion}')");
 					
-					$template['title'] = "<span style=\"color: blue;\">{$template['title']}</span>";
+					$template['pretty_title'] = "<span style=\"color: blue;\">{$template['title']}</span>";
 				}
 									
-				$table->construct_cell("<span style=\"padding: 20px;\"><a href=\"index.php?module=style/templates&amp;action=edit_template&amp;tid={$template['tid']}&amp;sid={$sid}{$expand_str}\" >{$template['title']}</a></span>");
+				$table->construct_cell("<span style=\"padding: 20px;\"><a href=\"index.php?module=style/templates&amp;action=edit_template&amp;title=".urlencode($template['title'])."&amp;sid={$sid}{$expand_str}\" >{$template['pretty_title']}</a></span>");
 				$table->construct_cell($popup->fetch(), array("class" => "align_center"));
 				
 				$table->construct_row();
diff -rub mybb_1400/admin/modules/style/themes.php mybb_1408/admin/modules/style/themes.php
--- mybb_1400/admin/modules/style/themes.php	2008-07-16 11:32:40.000000000 +0200
+++ mybb_1408/admin/modules/style/themes.php	2009-06-26 06:22:11.000000000 +0200
@@ -18,7 +18,7 @@
 require_once MYBB_ADMIN_DIR."inc/functions_themes.php";
 
 $page->extra_header .= "
-<script language=\"Javascript\" type=\"text/javascript\">
+<script type=\"text/javascript\">
 //<![CDATA[
 var save_changes_lang_string = '{$lang->save_changes_js}';
 var delete_lang_string = '{$lang->delete}';
@@ -340,7 +340,7 @@
 		$properties = unserialize($theme['properties']);
 	
 		$xml = "<?xml version=\"1.0\" encoding=\"{$lang->settings['charset']}\"?".">\r\n";
-		$xml .= "<theme name=\"".$theme['name']."\" version=\"".$mybb->version_code."\">\r\n";
+		$xml .= "<theme name=\"".htmlspecialchars_uni($theme['name'])."\" version=\"".$mybb->version_code."\">\r\n";
 		$xml .= "\t<properties>\r\n";
 		foreach($properties as $property => $value)
 		{
@@ -467,8 +467,8 @@
 		
 		$theme['name'] = rawurlencode($theme['name']);
 		header("Content-disposition: attachment; filename=".$theme['name']."-theme.xml");
-		header("Content-Length: ".my_strlen($xml));
 		header("Content-type: application/octet-stream");
+		header("Content-Length: ".my_strlen($xml));
 		header("Pragma: no-cache");
 		header("Expires: 0");
 		echo $xml;
@@ -1103,6 +1103,11 @@
 		$stylesheets[basename($file)] = $stylesheet2;
 	}
 	
+	if(!array_key_exists($stylesheet['cachefile'], $stylesheets) && array_key_exists("css.php?stylesheet=".$stylesheet['tid'], $stylesheets))
+	{
+		$stylesheet['cachefile'] = "css.php?stylesheet=".$stylesheet['tid'];
+	}
+	
 	$this_stylesheet = $stylesheets[$stylesheet['cachefile']];	
 	unset($stylesheets);
 	
@@ -1155,8 +1160,7 @@
 			// Update Stylesheet			
 			$update_array = array(
 				'name' => $db->escape_string($mybb->input['name']),
-				'attachedto' => $db->escape_string(implode('|', $attached)),
-				'lastmodified' => TIME_NOW
+				'attachedto' => $db->escape_string(implode('|', $attached))
 			);
 			
 			if($stylesheet['name'] != $mybb->input['name'])
@@ -1169,6 +1173,7 @@
 			// If the name changed, re-cache our stylesheet
 			if($stylesheet['name'] != $mybb->input['name'])
 			{
+				$db->update_query("themestylesheets", array('lastmodified' => TIME_NOW), "sid='{$stylesheet['sid']}'", 1);
 				if(!cache_stylesheet($theme['tid'], str_replace('/', '', $mybb->input['name']), $theme['stylesheet']))
 				{
 					$db->update_query("themestylesheets", array('cachefile' => "css.php?stylesheet={$stylesheet['sid']}"), "sid='{$stylesheet['sid']}'", 1);
@@ -1777,12 +1782,15 @@
 	$this_stylesheet = $stylesheets[$stylesheet['name']];	
 	unset($stylesheets);
 	
+	if($admin_options['codepress'] != 0)
+	{
 	$page->extra_header .= '
 	<link type="text/css" href="./jscripts/codepress/languages/codepress-css.css" rel="stylesheet" id="cp-lang-style" />
 	<script type="text/javascript" src="./jscripts/codepress/codepress.js"></script>
 	<script type="text/javascript">
 		CodePress.language = \'css\';
 	</script>';
+	}
 	
 	$page->add_breadcrumb_item(htmlspecialchars_uni($theme['name']), "index.php?module=style/themes&amp;action=edit&amp;tid={$mybb->input['tid']}");
 	$page->add_breadcrumb_item("{$lang->editing} ".htmlspecialchars_uni($stylesheet['name']), "index.php?module=style/themes&amp;action=edit_stylesheet&amp;tid={$mybb->input['tid']}&amp;file=".htmlspecialchars_uni($mybb->input['file'])."&amp;mode=advanced");
@@ -1844,7 +1852,9 @@
 
 	$form->end();
 	
-	echo "<script language=\"Javascript\" type=\"text/javascript\">
+	if($admin_options['codepress'] != 0)
+	{
+		echo "<script type=\"text/javascript\">
 	Event.observe('edit_stylesheet', 'submit', function()
 	{
 		if($('stylesheet_cp')) {
@@ -1855,6 +1865,7 @@
 		}
 	});
 </script>";
+	}
 	
 	$page->output_footer();
 }
@@ -2055,15 +2066,18 @@
 		}
 	}
 	
+	if($admin_options['codepress'] != 0)
+	{
 	$page->extra_header .= '
 	<link type="text/css" href="./jscripts/codepress/languages/codepress-css.css" rel="stylesheet" id="cp-lang-style" />
 	<script type="text/javascript" src="./jscripts/codepress/codepress.js"></script>
 	<script type="text/javascript">
 		CodePress.language = \'css\';
 	</script>';
+	}
 	
 	$page->add_breadcrumb_item(htmlspecialchars_uni($theme['name']), "index.php?module=style/themes&amp;action=edit&amp;tid={$mybb->input['tid']}");
-	$page->add_breadcrumb_item("Add Stylesheet");
+	$page->add_breadcrumb_item($lang->add_stylesheet);
 	
 	$page->output_header("{$lang->themes} - {$lang->add_stylesheet}");
 	
@@ -2252,7 +2266,9 @@
 
 	$form->output_submit_wrapper($buttons);
 	
-	echo "<script language=\"Javascript\" type=\"text/javascript\">
+	if($admin_options['codepress'] != 0)
+	{
+		echo "<script type=\"text/javascript\">
 	Event.observe('add_stylesheet', 'submit', function()
 	{
 		if($('stylesheet_cp')) {
@@ -2263,6 +2279,7 @@
 		}
 	});
 </script>\n";
+	}
 
 	echo '<script type="text/javascript" src="./jscripts/themes.js"></script>';
 	echo '<script type="text/javascript">
@@ -2281,6 +2298,12 @@
 
 if($mybb->input['action'] == "set_default")
 {
+	if(!verify_post_check($mybb->input['my_post_key']))
+	{
+		flash_message($lang->invalid_post_verify_key2, 'error');
+		admin_redirect("index.php?module=style/themes");
+	}
+	
 	$query = $db->simple_select("themes", "*", "tid='".intval($mybb->input['tid'])."'");
 	$theme = $db->fetch_array($query);
 
diff -rub mybb_1400/admin/modules/tools/adminlog.php mybb_1408/admin/modules/tools/adminlog.php
--- mybb_1400/admin/modules/tools/adminlog.php	2008-07-26 01:46:54.000000000 +0200
+++ mybb_1408/admin/modules/tools/adminlog.php	2009-06-26 07:26:47.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: adminlog.php 4042 2008-07-25 23:46:54Z Tikitiki $
+ * $Id: adminlog.php 4376 2009-06-03 21:56:15Z RyanGordon $
  */
 
 // Disallow direct access to this file for security reasons
@@ -139,6 +139,12 @@
 		$where .= " AND l.uid='".intval($mybb->input['uid'])."'";
 	}
 
+	// Searching for entries in a specific module
+	if($mybb->input['filter_module'])
+	{
+		$where .= " AND module='".$db->escape_string($mybb->input['filter_module'])."'";
+	}
+
 	// Order?
 	switch($mybb->input['sortby'])
 	{
@@ -236,7 +242,7 @@
 	// Do we need to construct the pagination?
 	if($rescount > $perpage)
 	{
-		echo draw_admin_pagination($pagecnt, $perpage, $rescount, "index.php?module=tools/adminlog&amp;perpage=$perpage&amp;uid={$mybb->input['uid']}&amp;fid={$mybb->input['fid']}&amp;sortby={$mybb->input['sortby']}&amp;order={$order}")."<br />";
+		echo draw_admin_pagination($pagecnt, $perpage, $rescount, "index.php?module=tools/adminlog&amp;perpage=$perpage&amp;uid={$mybb->input['uid']}&amp;fid={$mybb->input['fid']}&amp;sortby={$mybb->input['sortby']}&amp;order={$order}&amp;filter_module=".htmlspecialchars_uni($mybb->input['filter_module']))."<br />";
 	}
 	
 	// Fetch filter options
diff -rub mybb_1400/admin/modules/tools/backupdb.php mybb_1408/admin/modules/tools/backupdb.php
--- mybb_1400/admin/modules/tools/backupdb.php	2008-06-24 20:58:41.000000000 +0200
+++ mybb_1408/admin/modules/tools/backupdb.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: backupdb.php 3948 2008-06-24 18:58:41Z nickman $
+ * $Id: backupdb.php 4337 2009-03-30 01:21:51Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -141,7 +141,7 @@
 		
 		if($mybb->input['method'] == 'disk')
 		{
-			$file = MYBB_ADMIN_DIR.'backups/backup_'.substr(md5($mybb->user['uid'].TIME_NOW.random_str()), 0, 10);
+			$file = MYBB_ADMIN_DIR.'backups/backup_'.substr(md5($mybb->user['uid'].TIME_NOW), 0, 10).random_str(54);
 			
 			if($mybb->input['filetype'] == 'gzip')
 			{
@@ -160,7 +160,7 @@
 		}
 		else
 		{
-			$file = 'backup_'.substr(md5($mybb->user['uid'].TIME_NOW.random_str()), 0, 10);
+			$file = 'backup_'.substr(md5($mybb->user['uid'].TIME_NOW), 0, 10).random_str(54);
 			if($mybb->input['filetype'] == 'gzip')
 			{
 				if(!function_exists('gzopen')) // check zlib-ness
@@ -169,8 +169,8 @@
 					admin_redirect("index.php?module=tools/backupdb&action=backup");
 				}
 
-				// Send headers for gzip file (do ob_start too)
-				header('Content-Encoding: x-gzip');
+				// Send headers for gzip file
+				header('Content-Encoding: gzip');
 				header('Content-Type: application/x-gzip');
 				header('Content-Disposition: attachment; filename="'.$file.'.sql.gz"');
 			}
@@ -252,7 +252,7 @@
 			
 			if($mybb->input['filetype'] == 'gzip')
 			{
-				$ext = '.gz';
+				$ext = '.sql.gz';
 			}
 			else
 			{
@@ -288,7 +288,7 @@
 		exit;
 	}
 	
-	$page->extra_header = "	<script type=\"text/javascript\" language=\"Javascript\">
+	$page->extra_header = "	<script type=\"text/javascript\">
 	function changeSelection(action, prefix)
 	{
 		var select_box = document.getElementById('table_select');
diff -rub mybb_1400/admin/modules/tools/cache.php mybb_1408/admin/modules/tools/cache.php
--- mybb_1400/admin/modules/tools/cache.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/tools/cache.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: cache.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: cache.php 4292 2008-12-13 01:58:07Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -64,6 +64,12 @@
 
 if($mybb->input['action'] == "rebuild")
 {
+	if(!verify_post_check($mybb->input['my_post_key']))
+	{
+		flash_message($lang->invalid_post_verify_key2, 'error');
+		admin_redirect("index.php?module=tools/cache");
+	}
+	
 	$plugins->run_hooks("admin_tools_cache_rebuild");
 	
 	if(method_exists($cache, "update_{$mybb->input['title']}"))
@@ -113,7 +119,7 @@
 		
 		if(method_exists($cache, "update_".$cacheitem['title']))
 		{
-			$table->construct_cell("<a href=\"index.php?module=tools/cache&amp;action=rebuild&amp;title=".urlencode($cacheitem['title'])."\">".$lang->rebuild_cache."</a>", array("class" => "align_center"));
+			$table->construct_cell("<a href=\"index.php?module=tools/cache&amp;action=rebuild&amp;title=".urlencode($cacheitem['title'])."&amp;my_post_key={$mybb->post_code}\">".$lang->rebuild_cache."</a>", array("class" => "align_center"));
 		}
 		else
 		{
diff -rub mybb_1400/admin/modules/tools/mailerrors.php mybb_1408/admin/modules/tools/mailerrors.php
--- mybb_1400/admin/modules/tools/mailerrors.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/tools/mailerrors.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: mailerrors.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: mailerrors.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/tools/maillogs.php mybb_1408/admin/modules/tools/maillogs.php
--- mybb_1400/admin/modules/tools/maillogs.php	2008-07-25 22:13:08.000000000 +0200
+++ mybb_1408/admin/modules/tools/maillogs.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: maillogs.php 4041 2008-07-25 20:13:08Z Tikitiki $
+ * $Id: maillogs.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -311,7 +311,7 @@
 			{
 				$table->construct_cell("{$find_from}<div><a href=\"../".get_profile_link($log['fromuid'])."\">{$log['from_username']}</a></div>");
 			}
-			$find_to = "<div class=\"float_right\"><a href=\"index.php?module=tools/maillogs&amp;fromuid={$log['fromuid']}\"><img src=\"styles/{$page->style}/images/icons/find.gif\" title=\"{$lang->find_emails_by_user}\" alt=\"{$lang->find}\" /></a></div>";
+			$find_to = "<div class=\"float_right\"><a href=\"index.php?module=tools/maillogs&amp;touid={$log['touid']}\"><img src=\"styles/{$page->style}/images/icons/find.gif\" title=\"{$lang->find_emails_to_user}\" alt=\"{$lang->find}\" /></a></div>"; 
 			if(!$log['to_username'])
 			{
 				$table->construct_cell("{$find_to}<div>{$lang->deleted_user}</div>");
diff -rub mybb_1400/admin/modules/tools/module_meta.php mybb_1408/admin/modules/tools/module_meta.php
--- mybb_1400/admin/modules/tools/module_meta.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/tools/module_meta.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: module_meta.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: module_meta.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/tools/optimizedb.php mybb_1408/admin/modules/tools/optimizedb.php
--- mybb_1400/admin/modules/tools/optimizedb.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/tools/optimizedb.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: optimizedb.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: optimizedb.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -52,7 +52,7 @@
 		admin_redirect("index.php?module=tools/optimizedb");
 	}
 	
-	$page->extra_header = "	<script type=\"text/javascript\" language=\"Javascript\">
+	$page->extra_header = "	<script type=\"text/javascript\">
 	function changeSelection(action, prefix)
 	{
 		var select_box = document.getElementById('table_select');
diff -rub mybb_1400/admin/modules/tools/php_info.php mybb_1408/admin/modules/tools/php_info.php
--- mybb_1400/admin/modules/tools/php_info.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/tools/php_info.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: php_info.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: php_info.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/tools/recount_rebuild.php mybb_1408/admin/modules/tools/recount_rebuild.php
--- mybb_1400/admin/modules/tools/recount_rebuild.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/tools/recount_rebuild.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: recount_rebuild.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: recount_rebuild.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -126,7 +126,7 @@
 		if($ext == "gif" || $ext == "png" || $ext == "jpg" || $ext == "jpeg" || $ext == "jpe")
 		{
 			$thumbname = str_replace(".attach", "_thumb.$ext", $attachment['attachname']);
-			$thumbnail = generate_thumbnail(MYBB_ROOT."uploads/".$attachment['attachname'], MYBB_ROOT."uploads", $thumbname, $mybb->settings['attachthumbh'], $mybb->settings['attachthumbw']);
+			$thumbnail = generate_thumbnail(MYBB_ROOT."uploads/".$attachment['attachname'], MYBB_ROOT."uploads/", $thumbname, $mybb->settings['attachthumbh'], $mybb->settings['attachthumbw']);
 			if($thumbnail['code'] == 4)
 			{
 				$thumbnail['filename'] = "SMALL";
@@ -135,7 +135,7 @@
 		}
 	}
 	
-	check_proceed($num_users, $end, ++$page, $per_page, "attachmentthumbs", "do_rebuildattachmentthumbs", $lang->success_rebuilt_attachment_thumbnails);
+	check_proceed($num_attachments, $end, ++$page, $per_page, "attachmentthumbs", "do_rebuildattachmentthumbs", $lang->success_rebuilt_attachment_thumbnails);
 }
 
 function check_proceed($current, $finish, $next_page, $per_page, $name, $name2, $message)
diff -rub mybb_1400/admin/modules/tools/tasks.php mybb_1408/admin/modules/tools/tasks.php
--- mybb_1400/admin/modules/tools/tasks.php	2008-07-26 01:46:54.000000000 +0200
+++ mybb_1408/admin/modules/tools/tasks.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: tasks.php 4042 2008-07-25 23:46:54Z Tikitiki $
+ * $Id: tasks.php 4309 2009-01-17 18:36:01Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -555,6 +555,12 @@
 
 if($mybb->input['action'] == "run")
 {
+	if(!verify_post_check($mybb->input['my_post_key']))
+	{
+		flash_message($lang->invalid_post_verify_key2, 'error');
+		admin_redirect("index.php?module=tools/tasks");
+	}
+	
 	ignore_user_abort(true);
 	@set_time_limit(0);
 	$plugins->run_hooks("admin_tools_tasks_run");
@@ -644,7 +650,7 @@
 	while($log_entry = $db->fetch_array($query))
 	{
 		$log_entry['title'] = htmlspecialchars_uni($log_entry['title']);
-		$log_entry['data'] = htmlspecialchars_uni($log_entry['data']);
+		$log_entry['data'] = nl2br(htmlspecialchars_uni($log_entry['data']));
 		$date = my_date($mybb->settings['dateformat'], $log_entry['dateline']).", ".my_date($mybb->settings['timeformat'], $log_entry['dateline']);
 		$table->construct_cell("<a href=\"index.php?module=tools/tasks&amp;action=edit&amp;tid={$log_entry['tid']}\">{$log_entry['title']}</a>");
 		$table->construct_cell($date, array("class" => "align_center"));
@@ -706,18 +712,18 @@
 		{
 			$icon = "<img src=\"styles/{$page->style}/images/icons/bullet_off.gif\" alt=\"({$lang->alt_disabled})\" title=\"{$lang->alt_disabled}\"  style=\"vertical-align: middle;\" /> ";
 		}
-		$table->construct_cell("<div class=\"float_right\"><a href=\"index.php?module=tools/tasks&amp;action=run&amp;tid={$task['tid']}\"><img src=\"styles/{$page->style}/images/icons/run_task.gif\" title=\"{$lang->run_task_now}\" alt=\"{$lang->run_task}\" /></a></div><div>{$icon}<strong><a href=\"index.php?module=tools/tasks&amp;action=edit&amp;tid={$task['tid']}\">{$task['title']}</a></strong><br /><small>{$task['description']}</small></div>");
+		$table->construct_cell("<div class=\"float_right\"><a href=\"index.php?module=tools/tasks&amp;action=run&amp;tid={$task['tid']}&amp;my_post_key={$mybb->post_code}\"><img src=\"styles/{$page->style}/images/icons/run_task.gif\" title=\"{$lang->run_task_now}\" alt=\"{$lang->run_task}\" /></a></div><div>{$icon}<strong><a href=\"index.php?module=tools/tasks&amp;action=edit&amp;tid={$task['tid']}\">{$task['title']}</a></strong><br /><small>{$task['description']}</small></div>");
 		$table->construct_cell($next_run, array("class" => "align_center"));
 
 		$popup = new PopupMenu("task_{$task['tid']}", $lang->options);
 		$popup->add_item($lang->edit_task, "index.php?module=tools/tasks&amp;action=edit&amp;tid={$task['tid']}");
 		if($task['enabled'] == 1)
 		{
-			$popup->add_item($lang->disable_task, "index.php?module=tools/tasks&amp;action=disable&amp;tid={$task['tid']}");
+			$popup->add_item($lang->disable_task, "index.php?module=tools/tasks&amp;action=disable&amp;tid={$task['tid']}&amp;my_post_key={$mybb->post_code}");
 		}
 		else
 		{
-			$popup->add_item($lang->enable_task, "index.php?module=tools/tasks&amp;action=enable&amp;tid={$task['tid']}");
+			$popup->add_item($lang->enable_task, "index.php?module=tools/tasks&amp;action=enable&amp;tid={$task['tid']}&amp;my_post_key={$mybb->post_code}");
 		}
 		$popup->add_item($lang->delete_task, "index.php?module=tools/tasks&amp;action=delete&amp;tid={$task['tid']}&amp;my_post_key={$mybb->post_code}", "return AdminCP.deleteConfirmation(this, '{$lang->confirm_task_deletion}')");
 		$table->construct_cell($popup->fetch(), array("class" => "align_center"));
diff -rub mybb_1400/admin/modules/tools/warninglog.php mybb_1408/admin/modules/tools/warninglog.php
--- mybb_1400/admin/modules/tools/warninglog.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/tools/warninglog.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: warninglog.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: warninglog.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/admin/modules/user/admin_permissions.php mybb_1408/admin/modules/user/admin_permissions.php
--- mybb_1400/admin/modules/user/admin_permissions.php	2008-07-04 04:30:42.000000000 +0200
+++ mybb_1408/admin/modules/user/admin_permissions.php	2009-06-26 07:26:48.000000000 +0200
@@ -1,12 +1,12 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: admin_permissions.php 3977 2008-07-04 02:30:42Z Tikitiki $
+ * $Id: admin_permissions.php 4384 2009-06-19 11:49:42Z Tomm $
  */
 
 // Disallow direct access to this file for security reasons
@@ -79,9 +79,24 @@
 		
 		$plugins->run_hooks("admin_user_admin_permissions_delete_commit");
 
-		$user = get_user($uid);
 		// Log admin action
+		if($uid < 0)
+		{
+			$query = $db->simple_select("usergroups", "title", "gid='$gid'");
+			$group = $db->fetch_array($query);
+			log_admin_action($uid, $group['title']);
+			
+		}
+		elseif($uid == 0)
+		{
+			// Default
+			log_admin_action(0, $lang->default);
+		}
+		else
+		{
+			$user = get_user($uid);
 		log_admin_action($uid, $user['username']);
+		}
 
 		flash_message($lang->success_perms_deleted, 'success');
 		admin_redirect("index.php?module=user/admin_permissions");
@@ -124,7 +139,13 @@
 		}
 		else
 		{
-			$db->insert_query("adminoptions", array('uid' => intval($mybb->input['uid']), 'permissions' => $db->escape_string(serialize($mybb->input['permissions']))));
+			$insert_array = array(
+				"uid" => intval($mybb->input['uid']),
+				"permissions" => $db->escape_string(serialize($mybb->input['permissions'])),
+				"notes" => '',
+				"defaultviews" => ''
+			);
+			$db->insert_query("adminoptions", $insert_array);
 		}
 		
 		$plugins->run_hooks("admin_user_admin_permissions_edit_commit");
diff -rub mybb_1400/admin/modules/user/banning.php mybb_1408/admin/modules/user/banning.php
--- mybb_1400/admin/modules/user/banning.php	2008-07-26 01:46:54.000000000 +0200
+++ mybb_1408/admin/modules/user/banning.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: banning.php 4042 2008-07-25 23:46:54Z Tikitiki $
+ * $Id: banning.php 4340 2009-04-05 17:10:22Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -211,6 +211,13 @@
 	{
 		$form_container->output_row($lang->ban_group, $lang->ban_group_desc, $form->generate_select_box('usergroup', $banned_groups, $mybb->input['usergroup'], array('id' => 'usergroup')), 'usergroup');
 	}
+	
+	if($mybb->input['bantime'] == 'perm' || $mybb->input['bantime'] == '' || $mybb->input['lifted'] == 'perm' ||$mybb->input['lifted'] == '')
+	{
+		$mybb->input['bantime'] = '---';
+		$mybb->input['lifted'] = '---';
+	}
+	
 	foreach($ban_times as $time => $period)
 	{
 		if($time != "---")
@@ -245,7 +252,7 @@
 			$errors[] = $lang->error_invalid_username;
 		}
 		// Is the user we're trying to ban a super admin and we're not?
-		else if(is_super_admin($user['uid']) && !is_super_admin($user['uid']))
+		else if(is_super_admin($user['uid']) && !is_super_admin($mybb->user['uid']))
 		{
 			$errors[] = $lang->error_no_perm_to_ban;
 		}
@@ -372,7 +379,7 @@
 		if($ban['lifted'] == 'perm' || $ban['lifted'] == '' || $ban['bantime'] == 'perm' || $ban['bantime'] == '---')
 		{
 			$ban_period = $lang->permenantly;
-			$time_remaning = $lifts_on = $lang->na;
+			$time_remaining = $lifts_on = $lang->na;
 		}
 		else
 		{
@@ -400,7 +407,19 @@
 			$lifts_on = my_date($mybb->settings['dateformat'], $ban['lifted']);
 		}
 
-		$table->construct_cell($lang->sprintf($lang->bannedby_x_on_x, $profile_link, $ban['adminuser'], $ban_date, $ban_period));
+		if(!$ban['adminuser'])
+		{
+			if($ban['admin'] == 0)
+			{
+				$ban['adminuser'] = "MyBB System";
+			}
+			else
+			{
+				$ban['adminuser'] = $ban['admin'];
+			}
+		}
+
+		$table->construct_cell($lang->sprintf($lang->bannedby_x_on_x, $profile_link, htmlspecialchars_uni($ban['adminuser']), $ban_date, $ban_period));
 		$table->construct_cell($lifts_on, array("class" => "align_center"));
 		$table->construct_cell($time_remaining, array("class" => "align_center"));
 		$table->construct_cell("<a href=\"index.php?module=user/banning&amp;action=edit&amp;uid={$ban['uid']}\">{$lang->edit}</a>", array("class" => "align_center"));
diff -rub mybb_1400/admin/modules/user/group_promotions.php mybb_1408/admin/modules/user/group_promotions.php
--- mybb_1400/admin/modules/user/group_promotions.php	2008-07-04 23:24:03.000000000 +0200
+++ mybb_1408/admin/modules/user/group_promotions.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: group_promotions.php 3981 2008-07-04 21:24:03Z Tikitiki $
+ * $Id: group_promotions.php 4338 2009-04-03 23:26:21Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -292,10 +292,10 @@
 		"<" => $lang->less_than
 	);
 	
-	$form_container->output_row($lang->reputation_count, $lang->reputation_count_desc, $form->generate_text_box('reputationcount', $mybb->input['reputationcount'], array('id' => 'reputationcount'))." ".$form->generate_select_box("reputationtype", $options_type, $mybb->input['reputationtype'], array('id' => 'reputationtype')), 'reputationcount');
-	
 	$form_container->output_row($lang->post_count, $lang->post_count_desc, $form->generate_text_box('postcount', $mybb->input['postcount'], array('id' => 'postcount'))." ".$form->generate_select_box("posttype", $options_type, $mybb->input['posttype'], array('id' => 'posttype')), 'postcount');
 	
+	$form_container->output_row($lang->reputation_count, $lang->reputation_count_desc, $form->generate_text_box('reputationcount', $mybb->input['reputationcount'], array('id' => 'reputationcount'))." ".$form->generate_select_box("reputationtype", $options_type, $mybb->input['reputationtype'], array('id' => 'reputationtype')), 'reputationcount');
+	
 	$options = array(
 		"hours" => $lang->hours,
 		"days" => $lang->days,
@@ -309,7 +309,6 @@
 	$options = array();
 	
 	$query = $db->simple_select("usergroups", "gid, title", "gid != '1'", array('order_by' => 'title'));
-	$options['*'] = $lang->all_user_groups;
 	while($usergroup = $db->fetch_array($query))
 	{
 		$options[(int)$usergroup['gid']] = $usergroup['title'];
@@ -471,10 +470,10 @@
 		"<" => $lang->less_than
 	);
 	
-	$form_container->output_row($lang->reputation_count, $lang->reputation_count_desc, $form->generate_text_box('reputationcount', $mybb->input['reputationcount'], array('id' => 'reputationcount'))." ".$form->generate_select_box("reputationtype", $options_type, $mybb->input['reputationtype'], array('id' => 'reputationtype')), 'reputationcount');
-	
 	$form_container->output_row($lang->post_count, $lang->post_count_desc, $form->generate_text_box('postcount', $mybb->input['postcount'], array('id' => 'postcount'))." ".$form->generate_select_box("posttype", $options_type, $mybb->input['posttype'], array('id' => 'posttype')), 'postcount');
 	
+	$form_container->output_row($lang->reputation_count, $lang->reputation_count_desc, $form->generate_text_box('reputationcount', $mybb->input['reputationcount'], array('id' => 'reputationcount'))." ".$form->generate_select_box("reputationtype", $options_type, $mybb->input['reputationtype'], array('id' => 'reputationtype')), 'reputationcount');
+	
 	$options = array(
 		"hours" => $lang->hours,
 		"days" => $lang->days,
@@ -487,7 +486,6 @@
 	$options = array();
 	
 	$query = $db->simple_select("usergroups", "gid, title", "gid != '1'", array('order_by' => 'title'));
-	$options['*'] = $lang->all_user_groups;
 	while($usergroup = $db->fetch_array($query))
 	{
 		$options[(int)$usergroup['gid']] = $usergroup['title'];
@@ -593,8 +591,8 @@
 	
 	$table->output($lang->promotion_logs);
 	
-	$query = $db->simple_select("promotions", "COUNT(pid) as promotions");
-	$total_rows = $db->fetch_field($query, "promotions");
+	$query = $db->simple_select("promotionlogs", "COUNT(plid) as promotionlogs");
+	$total_rows = $db->fetch_field($query, "promotionlogs");
 	
 	echo "<br />".draw_admin_pagination($mybb->input['page'], "20", $total_rows, "index.php?module=user/group_promotions&amp;action=logs&amp;page={page}");
 	
diff -rub mybb_1400/admin/modules/user/groups.php mybb_1408/admin/modules/user/groups.php
--- mybb_1400/admin/modules/user/groups.php	2008-07-24 13:35:12.000000000 +0200
+++ mybb_1408/admin/modules/user/groups.php	2009-06-26 06:22:11.000000000 +0200
@@ -1,4 +1,3 @@
-
 <?php
 /**
  * MyBB 1.4
@@ -7,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: groups.php 4036 2008-07-24 11:35:12Z ZiNgaBuRgA $
+ * $Id: groups.php 4324 2009-03-05 21:23:18Z Tikitiki $
  */
  
 // Array of usergroup permission fields and their default values.
@@ -187,7 +186,7 @@
 	
 	if($mybb->request_method == "post" && is_array($mybb->input['users']))
 	{		
-		$uid_in = implode(",", array_map('trim', $mybb->input['users']));
+		$uid_in = implode(",", array_map('intval', $mybb->input['users']));
 		
 		if(isset($mybb->input['approve']))
 		{
@@ -547,7 +546,9 @@
 	}
 	
 	if(!$errors)
+	{
 		$mybb->input = $leader;
+	}
 	
 	$page->add_breadcrumb_item($lang->group_leaders_for." {$group['title']}", "index.php?module=user/groups&action=leaders&gid={$group['gid']}");
 	$page->add_breadcrumb_item($lang->edit_leader." {$leader['username']}");
@@ -808,7 +809,7 @@
 				"attachquota" => intval($mybb->input['attachquota']),
 				"cancustomtitle" => intval($mybb->input['cancustomtitle']),
 				"canwarnusers" => intval($mybb->input['canwarnusers']),
-				"canreceivewarnings" =>intval($mybb->input['canreceivewarnings']),
+				"canreceivewarnings" => intval($mybb->input['canreceivewarnings']),
 				"maxwarningsday" => intval($mybb->input['maxwarningsday']),
 				"canmodcp" => intval($mybb->input['canmodcp'])
 			);
@@ -816,7 +817,7 @@
 			// Only update the candisplaygroup setting if not a default user group
 			if($usergroup['type'] != 1)
 			{
-				$updated_group['candisplaygroup'] = $db->escape_string($mybb->input['candisplaygroup']);
+				$updated_group['candisplaygroup'] = intval($mybb->input['candisplaygroup']);
 			}
 			
 			$plugins->run_hooks("admin_user_groups_edit_commit");
@@ -1033,7 +1034,7 @@
 	$form_container->output_row($lang->whos_online, "", "<div class=\"group_settings_bit\">".implode("</div><div class=\"group_settings_bit\">", $wol_options)."</div>");
 
 	$misc_options = array(
-		$form->generate_check_box("canviewmemberlist", 1, $lang->can_view_member_list, array("checked" => $mybb->input['canviewonline'])),
+		$form->generate_check_box("canviewmemberlist", 1, $lang->can_view_member_list, array("checked" => $mybb->input['canviewmemberlist'])),
 		$form->generate_check_box("cansendemail", 1, $lang->can_email_users, array("checked" => $mybb->input['cansendemail'])),
 		"{$lang->max_emails_per_day}<br /><small class=\"input\">{$lang->max_emails_per_day_desc}</small><br />".$form->generate_text_box('maxemails', $mybb->input['maxemails'], array('id' => 'maxemails', 'class' => 'field50'))
 	);
@@ -1081,11 +1082,27 @@
 		
 		$db->update_query("users", $updated_users, "displaygroup='{$usergroup['gid']}'", "", false); // No quotes = displaygroup=usergroup
 
+		switch($db->type)
+		{
+			case "pgsql":
+			case "sqlite3":
+			case "sqlite2":
+				$query = $db->simple_select("users", "uid", "','||additionalgroups||',' LIKE '%,{$usergroup['gid']},%'");
+				break;
+			default:
+				$query = $db->simple_select("users", "uid", "CONCAT(',',additionalgroups,',') LIKE '%,{$usergroup['gid']},%'");
+		}
+		while($user = $db->fetch_array($query))
+		{
+			leave_usergroup($user['uid'], $usergroup['gid']);
+		}
+
 		$db->delete_query("groupleaders", "gid='{$usergroup['gid']}'");
 		$db->delete_query("usergroups", "gid='{$usergroup['gid']}'");
 		
 		$cache->update_moderators();
-		
+		$cache->update_usergroups();
+		$cache->update_forumpermissions();
 
 		// Log admin action
 		log_admin_action($usergroup['gid'], $usergroup['title']);
@@ -1172,7 +1189,7 @@
 				SELECT g.gid, COUNT(u.uid) AS users
 				FROM ".TABLE_PREFIX."users u
 				LEFT JOIN ".TABLE_PREFIX."usergroups g ON (','|| u.additionalgroups|| ',' LIKE '%,'|| g.gid|| ',%')
-				WHERE g.gid != '' GROUP BY g.gid
+				WHERE g.gid != '0' AND g.gid != NULL GROUP BY g.gid
 			");
 			break;
 		default:
@@ -1180,7 +1197,7 @@
 				SELECT g.gid, COUNT(u.uid) AS users
 				FROM ".TABLE_PREFIX."users u
 				LEFT JOIN ".TABLE_PREFIX."usergroups g ON (CONCAT(',', u.additionalgroups, ',') LIKE CONCAT('%,', g.gid, ',%'))
-				WHERE g.gid != '' GROUP BY g.gid
+				WHERE g.gid != '0' AND g.gid != NULL GROUP BY g.gid
 			");
 	}
 	while($groupcount = $db->fetch_array($query))
@@ -1253,7 +1270,7 @@
 			$primaryusers[$usergroup['gid']] = 0;
 		}
 		$numusers = $primaryusers[$usergroup['gid']];
-		$numusers += $secondaryusers[$usergroups['gid']];
+		$numusers += $secondaryusers[$usergroup['gid']];
 
 		$form_container->output_cell(my_number_format($numusers), array("class" => "align_center"));
 		
diff -rub mybb_1400/admin/modules/user/mass_mail.php mybb_1408/admin/modules/user/mass_mail.php
--- mybb_1400/admin/modules/user/mass_mail.php	2008-07-26 01:46:54.000000000 +0200
+++ mybb_1408/admin/modules/user/mass_mail.php	2009-06-26 06:22:11.000000000 +0200
@@ -73,8 +73,8 @@
 	$html_personalisation = $text_personalisation = "<script type=\"text/javascript\">\n<!--\ndocument.write('{$lang->personalize_message} ";
 	foreach($replacement_fields as $value => $name)
 	{
-		$html_personalisation .= " [<a href=\"#\" onclick=\"$(\'htmlmessage\').value += \'{$value}\'; return false;\">{$name}</a>], ";
-		$text_personalisation .= " [<a href=\"#\" onclick=\"$(\'message\').value += \'{$value}\'; return false;\">{$name}</a>], ";
+		$html_personalisation .= " [<a href=\"#\" onclick=\"insertText(\'{$value}\', \$(\'htmlmessage\')); return false;\">{$name}</a>], ";
+		$text_personalisation .= " [<a href=\"#\" onclick=\"insertText(\'{$value}\', \$(\'message\')); return false;\">{$name}</a>], ";
 	}
 	$html_personalisation = substr($html_personalisation, 0, -2)."');\n</script>\n";
 	$text_personalisation = substr($text_personalisation, 0, -2)."');\n</script>\n";
@@ -516,6 +516,28 @@
 
 	Event.observe($('automatic_text'), 'click', ToggleAutomatic);
 	
+	function insertText(value, textarea)
+	{
+		// Internet Explorer
+		if(document.selection)
+		{
+			textarea.focus();
+			var selection = document.selection.createRange();
+			selection.text = value;
+		}
+		// Firefox
+		else if(textarea.selectionStart || textarea.selectionStart == '0')
+		{
+			var start = textarea.selectionStart;
+			var end = textarea.selectionEnd;
+			textarea.value = textarea.value.substring(0, start)	+ value	+ textarea.value.substring(end, textarea.value.length);
+		}
+		else
+		{
+			textarea.value += value;
+		}
+	}
+	
 	</script>";
 
 	$form_container = new FormContainer("{$lang->edit_mass_mail}: {$lang->define_the_recipients}");
@@ -575,8 +597,8 @@
 	$html_personalisation = $text_personalisation = "<script type=\"text/javascript\">\n<!--\ndocument.write('{$lang->personalize_message}: ";
 	foreach($replacement_fields as $value => $name)
 	{
-		$html_personalisation .= " [<a href=\"#\" onclick=\"$(\'htmlmessage\').value += \'{$value}\'; return false;\">{$name}</a>], ";
-		$text_personalisation .= " [<a href=\"#\" onclick=\"$(\'message\').value += \'{$value}\'; return false;\">{$name}</a>], ";
+		$html_personalisation .= " [<a href=\"#\" onclick=\"insertText(\'{$value}\', \$(\'htmlmessage\')); return false;\">{$name}</a>], ";
+		$text_personalisation .= " [<a href=\"#\" onclick=\"insertText(\'{$value}\', \$(\'message\')); return false;\">{$name}</a>], ";
 	}
 	$html_personalisation = substr($html_personalisation, 0, -2)."');\n</script>\n";
 	$text_personalisation = substr($text_personalisation, 0, -2)."');\n</script>\n";
@@ -1255,6 +1277,28 @@
 
 		Event.observe($('automatic_text'), 'click', ToggleAutomatic);
 		
+		function insertText(value, textarea)
+		{
+			// Internet Explorer
+			if(document.selection)
+			{
+				textarea.focus();
+				var selection = document.selection.createRange();
+				selection.text = value;
+			}
+			// Firefox
+			else if(textarea.selectionStart || textarea.selectionStart == '0')
+			{
+				var start = textarea.selectionStart;
+				var end = textarea.selectionEnd;
+				textarea.value = textarea.value.substring(0, start)	+ value	+ textarea.value.substring(end, textarea.value.length);
+			}
+			else
+			{
+				textarea.value += value;
+			}
+		}
+		
 		</script>";
 
 		$buttons[] = $form->generate_submit_button($lang->next_step);
@@ -1291,13 +1335,28 @@
 		// Log admin action
 		log_admin_action($mass_email['mid'], $mass_email['subject']);
 
+		if($mybb->input['archive'] == 1)
+		{
+			flash_message($lang->success_mass_mail_deleted, 'success');
+			admin_redirect("index.php?module=user/mass_mail&action=archive");
+		}
+		else
+		{
 		flash_message($lang->success_mass_mail_deleted, 'success');
 		admin_redirect("index.php?module=user/mass_mail");
 	}
+	}
+	else
+	{
+		if($mybb->input['archive'] == 1)
+		{
+			$page->output_confirm_action("index.php?module=user/mass_mail&amp;action=delete&amp;mid={$mass_email['mid']}&amp;archive=1", $lang->mass_mail_deletion_confirmation);
+		}
 	else
 	{
 		$page->output_confirm_action("index.php?module=user/mass_mail&amp;action=delete&amp;mid={$mass_email['mid']}", $lang->mass_mail_deletion_confirmation);
 	}
+	}
 }
 
 if($mybb->input['action'] == "preview")
@@ -1329,13 +1388,11 @@
 	{
 		// Show preview of the text version
 		echo nl2br($mass_email['message']);
-		exit;
 	}
 	else
 	{
 		// Preview the HTML version
 		echo $mass_email['htmlmessage'];
-		exit;
 	}
 	
 		?>
@@ -1344,7 +1401,9 @@
 	</body>
 	</html>
 	<?php
+	exit;
 }
+
 if($mybb->input['action'] == "resend")
 {
 	// Copy and resend an email
@@ -1368,6 +1427,7 @@
 		"subject" => $db->escape_string($mass_email['subject']),
 		"message" => $db->escape_string($mass_email['message']),
 		"htmlmessage" => $db->escape_string($mass_email['htmlmessage']),
+		"type" => $db->escape_string($mass_email['type']),
 		"format" => $db->escape_string($mass_email['format']),
 		"dateline" => TIME_NOW,
 		"senddate" => '0',
@@ -1445,7 +1505,7 @@
 		$table->construct_cell(my_number_format($email['totalcount']), array("class" => "align_center"));
 
 		$table->construct_cell("<a href=\"index.php?module=user/mass_mail&amp;action=resend&amp;mid={$email['mid']}\">{$lang->resend}</a>", array("width" => 100, "class" => "align_center"));
-		$table->construct_cell("<a href=\"index.php?module=user/mass_mail&amp;action=delete&amp;mid={$email['mid']}&amp;my_post_key={$mybb->post_code}\" onclick=\"return AdminCP.deleteConfirmation(this, '{$lang->mass_mail_deletion_confirmation}')\">{$lang->delete}</a>", array("width" => 100, "class" => "align_center"));
+		$table->construct_cell("<a href=\"index.php?module=user/mass_mail&amp;action=delete&amp;mid={$email['mid']}&amp;my_post_key={$mybb->post_code}&amp;archive=1\" onclick=\"return AdminCP.deleteConfirmation(this, '{$lang->mass_mail_deletion_confirmation}')\">{$lang->delete}</a>", array("width" => 100, "class" => "align_center"));
 
 		$table->construct_row();
 	}
diff -rub mybb_1400/admin/modules/user/module_meta.php mybb_1408/admin/modules/user/module_meta.php
--- mybb_1400/admin/modules/user/module_meta.php	2008-06-01 00:20:03.000000000 +0200
+++ mybb_1408/admin/modules/user/module_meta.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: module_meta.php 3870 2008-05-31 22:20:03Z Tikitiki $
+ * $Id: module_meta.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -50,7 +50,7 @@
 		'users' => array('active' => 'users', 'file' => 'users.php')
 	);
 	
-	$plugins->run_hooks_by_ref("admin_user_action_handler", $action);
+	$plugins->run_hooks_by_ref("admin_user_action_handler", $actions);
 	
 	if(isset($actions[$action]))
 	{
diff -rub mybb_1400/admin/modules/user/titles.php mybb_1408/admin/modules/user/titles.php
--- mybb_1400/admin/modules/user/titles.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/admin/modules/user/titles.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: titles.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: titles.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -60,6 +60,8 @@
 			
 			$utid = $db->insert_query("usertitles", $new_title);
 			
+			$cache->update_usertitles();
+			
 			$plugins->run_hooks("admin_user_titles_add_commit");
 
 			// Log admin action
@@ -72,8 +74,8 @@
 	else
 	{
 		$mybb->input = array(
-			"stars" => "1",
-			"starimage" => "star.gif",
+			'stars' => '1',
+			'starimage' => '{theme}/star.gif',
 		);
 	}
 	
@@ -140,6 +142,8 @@
 			
 			$db->update_query("usertitles", $updated_title, "utid='{$usertitle['utid']}'");
 			
+			$cache->update_usertitles();
+			
 			$plugins->run_hooks("admin_user_titles_edit_commit");
 
 			// Log admin action
@@ -214,7 +218,7 @@
 		$plugins->run_hooks("admin_user_titles_delete_commit");
 
 		// Log admin action
-		log_admin_action($usertitle['utid'], $usertitle['title'], $mybb->input['posts']);
+		log_admin_action($usertitle['utid'], $usertitle['title'], $usertitle['posts']);
 
 		flash_message($lang->success_user_title_deleted, 'success');
 		admin_redirect("index.php?module=user/titles");
diff -rub mybb_1400/admin/modules/user/users.php mybb_1408/admin/modules/user/users.php
--- mybb_1400/admin/modules/user/users.php	2008-07-31 07:19:05.000000000 +0200
+++ mybb_1408/admin/modules/user/users.php	2009-06-26 07:26:53.000000000 +0200
@@ -1,12 +1,12 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: users.php 4054 2008-07-31 05:19:05Z Tikitiki $
+ * $Id: users.php 4389 2009-06-26 04:29:32Z RyanGordon $
  */
 
 // Disallow direct access to this file for security reasons
@@ -165,6 +165,7 @@
 			$updated_avatar = array(
 				"avatar" => $db->escape_string($mybb->settings['avatardir']."/".$mybb->input['avatar']),
 				"avatardimensions" => "{$dimensions[0]}|{$dimensions[1]}",
+
 				"avatartype" => "gallery"
 			);
 
@@ -175,7 +176,7 @@
 			// Log admin action
 			log_admin_action($user['uid'], $user['username']);
 		}
-		remove_avatars($mybb->user['uid']);
+		remove_avatars($user['uid']);
 		// Now a tad of javascript to submit the parent window form
 		echo "<script type=\"text/javascript\">window.parent.submitUserForm();</script>";
 		exit;
@@ -199,12 +200,17 @@
 
 	$mybb->settings['avatardir'] = "../".$mybb->settings['avatardir'];
 
+	if(!is_dir($mybb->settings['avatardir']) && is_dir(MYBB_ROOT."/images/avatars/"))
+	{
+		$mybb->settings['avatardir'] = "../images/avatars/";
+	}
+	
 	// Within a gallery
-	if($gallery)
+	if(!empty($gallery))
 	{
 		$path = $gallery."/";
 		$real_path = $mybb->settings['avatardir']."/".$path;
-		if(is_dir($path))
+		if(is_dir($real_path))
 		{
 			// Build friendly gallery breadcrumb
 			$gallery_path = explode("/", $gallery);
@@ -374,6 +380,21 @@
 	// Log admin action
 	log_admin_action($user['uid'], $user['username']);
 
+	if($mybb->input['from'] == "home")
+	{
+		if($user['coppauser'])
+		{
+			$message = $lang->success_coppa_activated;
+		}
+		else
+		{
+			$message = $lang->success_activated;
+		}
+		
+		update_admin_session('flash_message2', array('message' => $message, 'type' => 'success'));
+	}
+	else
+	{
 	if($user['coppauser'])
 	{
 		flash_message($lang->success_coppa_activated, 'success');
@@ -382,16 +403,23 @@
 	{
 		flash_message($lang->success_activated, 'success');
 	}
+	}
 
 	if($admin_session['data']['last_users_url'])
 	{
 		$url = $admin_session['data']['last_users_url'];
 		update_admin_session('last_users_url', '');
+		
+		if($mybb->input['from'] == "home")
+		{
+			update_admin_session('from', 'home');
+		}
 	}
 	else
 	{
-		$url = "index.php?module=user/users&amp;action=edit&amp;uid={$user['uid']}";
+		$url = "index.php?module=user/users&action=edit&uid={$user['uid']}";
 	}
+	
 	admin_redirect($url);
 }
 
@@ -569,7 +597,7 @@
 			"displaygroup" => $mybb->input['displaygroup'],
 			"postnum" => $mybb->input['postnum'],
 			"usertitle" => $mybb->input['usertitle'],
-			"timezone" => $mybb->input['timezoneoffset'],
+			"timezone" => $mybb->input['timezone'],
 			"language" => $mybb->input['language'],
 			"profile_fields" => $mybb->input['profile_fields'],
 			"profile_fields_editable" => true,
@@ -598,12 +626,6 @@
 			$updated_user['password2'] = $mybb->input['confirm_new_password'];
 		}
 
-		$updated_user['birthday'] = array(
-			"day" => $mybb->input['birthday_day'],
-			"month" => $mybb->input['birthday_month'],
-			"year" => $mybb->input['birthday_year']
-		);
-
 		$updated_user['options'] = array(
 			"allownotices" => $mybb->input['allownotices'],
 			"hideemail" => $mybb->input['hideemail'],
@@ -652,7 +674,7 @@
 					"avatardimensions" => "",
 					"avatartype" => ""
 				);
-				remove_avatars($mybb->user['uid']);
+				remove_avatars($user['uid']);
 			}
 
 
@@ -716,7 +738,7 @@
 				{
 					if($width && $height && $mybb->settings['maxavatardims'] != "")
 					{
-						list($maxwidth, $maxheight) = explode("x", $mybb->settings['maxavatardims']);
+						list($maxwidth, $maxheight) = explode("x", my_strtolower($mybb->settings['maxavatardims']));
 						if(($maxwidth && $width > $maxwidth) || ($maxheight && $height > $maxheight))
 						{
 							$lang->error_avatartoobig = $lang->sprintf($lang->error_avatartoobig, $maxwidth, $maxheight);
@@ -902,7 +924,7 @@
 	}
 	else
 	{
-		$percent_posts = round($memprofile['postnum']*100/$posts, 2);;
+		$percent_posts = round($user['postnum']*100/$posts, 2);
 	}
 
 	$user_permissions = user_permissions($user['uid']);
@@ -932,12 +954,13 @@
 	{
 		$age = get_age($user['birthday']);
 	}
+
 	else
 	{
 		$age = '';
 	}
 
-	$table->construct_cell("<div style=\"width: 126px; height: 126px;\" class=\"user_avatar\"><img src=\"{$user['avatar']}\" style=\"margin-top: {$avatar_top}px\" width=\"{$scaled_dimensions['width']}\" height=\"{$scaled_dimensions['height']}\" alt=\"\" /></div>", array('rowspan' => 6, 'width' => 1));
+	$table->construct_cell("<div style=\"width: 126px; height: 126px;\" class=\"user_avatar\"><img src=\"".htmlspecialchars_uni($user['avatar'])."\" style=\"margin-top: {$avatar_top}px\" width=\"{$scaled_dimensions['width']}\" height=\"{$scaled_dimensions['height']}\" alt=\"\" /></div>", array('rowspan' => 6, 'width' => 1));
 	$table->construct_cell("<strong>{$lang->email_address}:</strong> <a href=\"mailto:".htmlspecialchars_uni($user['email'])."\">".htmlspecialchars_uni($user['email'])."</a>");
 	$table->construct_cell("<strong>{$lang->last_active}:</strong> {$last_active}");
 	$table->construct_row();
@@ -979,6 +1002,11 @@
 		$display_group_options[$usergroup['gid']] = $usergroup['title'];
 	}
 
+	if(!is_array($mybb->input['additionalgroups']))
+	{
+		$mybb->input['additionalgroups'] = explode(',', $mybb->input['additionalgroups']);
+	}
+
 	$form_container->output_row($lang->primary_user_group." <em>*</em>", "", $form->generate_select_box('usergroup', $options, $mybb->input['usergroup'], array('id' => 'usergroup')), 'usergroup');
 	$form_container->output_row($lang->additional_user_groups, $lang->additional_user_groups_desc, $form->generate_select_box('additionalgroups[]', $options, $mybb->input['additionalgroups'], array('id' => 'additionalgroups', 'multiple' => true, 'size' => 5)), 'additionalgroups');
 	$form_container->output_row($lang->display_user_group." <em>*</em>", "", $form->generate_select_box('displaygroup', $display_group_options, $mybb->input['displaygroup'], array('id' => 'displaygroup')), 'displaygroup');
@@ -1018,6 +1046,11 @@
 	);
 	$form_container->output_row($lang->login_cookies_privacy, "", "<div class=\"user_settings_bit\">".implode("</div><div class=\"user_settings_bit\">", $login_options)."</div>");
 
+	if($mybb->input['pmnotice'] > 1)
+	{
+		$mybb->input['pmnotice'] = 1;
+	}
+	
 	$messaging_options = array(
 		$form->generate_check_box("allownotices", 1, $lang->recieve_admin_emails, array("checked" => $mybb->input['allownotices'])),
 		$form->generate_check_box("hideemail", 1, $lang->hide_email_from_others, array("checked" => $mybb->input['hideemail'])),
@@ -1043,7 +1076,7 @@
 	$date_options = array(
 		"<label for=\"dateformat\">{$lang->date_format}:</label><br />".$form->generate_select_box("dateformat", $date_format_options, $mybb->input['dateformat'], array('id' => 'dateformat')),
 		"<label for=\"dateformat\">{$lang->time_format}:</label><br />".$form->generate_select_box("timeformat", $time_format_options, $mybb->input['timeformat'], array('id' => 'timeformat')),
-		"<label for=\"timezone\">{$lang->time_zone}:</label><br />".build_timezone_select("timezone", $mybb->user['timezone']),
+		"<label for=\"timezone\">{$lang->time_zone}:</label><br />".build_timezone_select("timezone", $mybb->input['timezone']),
 		"<label for=\"dstcorrection\">{$lang->daylight_savings_time_correction}:</label><br />".$form->generate_select_box("dstcorrection", array(2 => $lang->automatically_detect, 1 => $lang->always_use_dst_correction, 0 => $lang->never_use_dst_correction), $mybb->input['dstcorrection'], array('id' => 'dstcorrection'))
 	);
 	$form_container->output_row($lang->date_and_time_options, "", "<div class=\"user_settings_bit\">".implode("</div><div class=\"user_settings_bit\">", $date_options)."</div>");
@@ -1105,11 +1138,13 @@
 	);
 	$form_container->output_row($lang->thread_view_options, "", "<div class=\"user_settings_bit\">".implode("</div><div class=\"user_settings_bit\">", $thread_options)."</div>");
 
+	$languages = array_merge(array('' => $lang->use_default), $lang->get_languages());
+
 	$other_options = array(
 		$form->generate_check_box("showredirect", 1, $lang->show_redirect, array("checked" => $mybb->input['showredirect'])),
 		$form->generate_check_box("showcodebuttons", "1", $lang->show_code_buttons, array("checked" => $mybb->input['showcodebuttons'])),
 		"<label for=\"style\">{$lang->theme}:</label><br />".build_theme_select("style", $mybb->input['style'], 0, "", 1),
-		"<label for=\"language\">{$lang->board_language}:</label><br />".$form->generate_select_box("language", $lang->get_languages(), $mybb->input['language'], array('id' => 'language'))
+		"<label for=\"language\">{$lang->board_language}:</label><br />".$form->generate_select_box("language", $languages, $mybb->input['language'], array('id' => 'language'))
 	);
 	$form_container->output_row($lang->other_options, "", "<div class=\"user_settings_bit\">".implode("</div><div class=\"user_settings_bit\">", $other_options)."</div>");
 
@@ -1120,26 +1155,26 @@
 	// SIGNATURE EDITOR
 	//
 	$signature_editor = $form->generate_text_area("signature", $mybb->input['signature'], array('id' => 'signature', 'rows' => 15, 'cols' => '70', 'style' => 'width: 95%'));
-	$sig_smilies = "off";
+	$sig_smilies = $lang->off;
 	if($mybb->settings['sigsmilies'] == 1)
 	{
-		$sig_smilies = "on";
+		$sig_smilies = $lang->on;
 	}
-	$sig_mycode = "off";
+	$sig_mycode = $lang->off;
 	if($mybb->settings['sigmycode'] == 1)
 	{
-		$sig_mycode = "on";
+		$sig_mycode = $lang->on;
 		$signature_editor .= build_mycode_inserter("signature");
 	}
-	$sig_html = "off";
+	$sig_html = $lang->off;
 	if($mybb->settings['sightml'] == 1)
 	{
-		$sig_html = "on";
+		$sig_html = $lang->on;
 	}
-	$sig_imcode = "on";
+	$sig_imgcode = $lang->off;
 	if($mybb->settings['sigimgcode'] == 1)
 	{
-		$sig_imgcode = "off";
+		$sig_imgcode = $lang->on;
 	}
 	echo "<div id=\"tab_signature\">\n";
 	$form_container = new FormContainer("{$lang->signature}: {$user['username']}");
@@ -1163,7 +1198,7 @@
 	$table = new Table;
 	$table->construct_header($lang->current_avatar, array('colspan' => 2));
 
-	$table->construct_cell("<div style=\"width: 126px; height: 126px;\" class=\"user_avatar\"><img src=\"{$user['avatar']}\" width=\"{$scaled_dimensions['width']}\" style=\"margin-top: {$avatar_top}px\" height=\"{$scaled_dimensions['height']}\" alt=\"\" /></div>", array('width' => 1));
+	$table->construct_cell("<div style=\"width: 126px; height: 126px;\" class=\"user_avatar\"><img src=\"".htmlspecialchars_uni($user['avatar'])."\" width=\"{$scaled_dimensions['width']}\" style=\"margin-top: {$avatar_top}px\" height=\"{$scaled_dimensions['height']}\" alt=\"\" /></div>", array('width' => 1));
 
 	if($user['avatartype'] == "upload" || stristr($user['avatar'], $mybb->settings['avataruploadpath']))
 	{
@@ -1186,7 +1221,7 @@
 
 	if($mybb->settings['maxavatardims'] != "")
 	{
-		list($max_width, $max_height) = explode("x", $mybb->settings['maxavatardims']);
+		list($max_width, $max_height) = explode("x", my_strtolower($mybb->settings['maxavatardims']));
 		$max_size = "<br />{$lang->max_dimensions_are} {$max_width}x{$max_height}";
 	}
 
@@ -1265,7 +1300,6 @@
 	{
 		// Delete the user
 		$db->update_query("posts", array('uid' => 0), "uid='{$user['uid']}'");
-		$db->delete_query("users", "uid='{$user['uid']}'");
 		$db->delete_query("userfields", "ufid='{$user['uid']}'");
 		$db->delete_query("privatemessages", "uid='{$user['uid']}'");
 		$db->delete_query("events", "uid='{$user['uid']}'");
@@ -1275,6 +1309,9 @@
 		$db->delete_query("sessions", "uid='{$user['uid']}'");
 		$db->delete_query("banned", "uid='{$user['uid']}'");
 		$db->delete_query("threadratings", "uid='{$user['uid']}'");
+		$db->delete_query("users", "uid='{$user['uid']}'");
+		$db->delete_query("joinrequests", "uid='{$user['uid']}'");
+		$db->delete_query("warnings", "uid='{$user['uid']}'");
 
 		// Update forum stats
 		update_stats(array('numusers' => '-1'));
@@ -1311,6 +1348,10 @@
 	
 	// Fetch default admin view
 	$default_view = fetch_default_view("user");
+	if(!$default_view)
+	{
+		$default_view = "0";
+	}
 	$query = $db->simple_select("adminviews", "*", "type='user' AND (vid='{$default_view}' OR uid=0)", array("order_by" => "uid", "order_dir" => "desc"));
 	$admin_view = $db->fetch_array($query);
 
@@ -1361,8 +1402,9 @@
 	else
 	{
 		$popup = new PopupMenu("user_last", $lang->options);
-		$popup->add_item($lang->show_users_regged_with_ip, "index.php?module=user/users&amp;action=search&amp;regip={$user['lastip']}");
-		$popup->add_item($lang->show_users_posted_with_ip, "index.php?module=user/users&amp;action=search&amp;postip={$user['lastip']}");
+		$popup->add_item($lang->show_users_regged_with_ip, 
+"index.php?module=user/users&amp;action=search&amp;results=1&amp;conditions=".urlencode(serialize(array("regip" => $user['lastip']))));
+		$popup->add_item($lang->show_users_posted_with_ip, "index.php?module=user/users&amp;results=1&amp;action=search&amp;conditions=".urlencode(serialize(array("postip" => $user['lastip']))));
 		$popup->add_item($lang->ban_ip, "index.php?module=config/banning&amp;filter={$user['lastip']}");
 		$controls = $popup->fetch();
 	}
@@ -1378,8 +1420,8 @@
 	else
 	{
 		$popup = new PopupMenu("user_reg", $lang->options);
-		$popup->add_item($lang->show_users_regged_with_ip, "index.php?module=user/users&amp;action=search&amp;regip={$user['regip']}");
-		$popup->add_item($lang->show_users_posted_with_ip, "index.php?module=user/users&amp;action=search&amp;postip={$user['regip']}");
+		$popup->add_item($lang->show_users_regged_with_ip, "index.php?module=user/users&amp;results=1&amp;action=search&amp;conditions=".urlencode(serialize(array("regip" => $user['regip']))));
+		$popup->add_item($lang->show_users_posted_with_ip, "index.php?module=user/users&amp;results=1&amp;action=search&amp;conditions=".urlencode(serialize(array("postip" => $user['regip']))));
 		$popup->add_item($lang->ban_ip, "index.php?module=config/banning&amp;filter={$user['regip']}");
 		$controls = $popup->fetch();
 	}
@@ -1387,22 +1429,21 @@
 	$table->construct_cell($controls, array('class' => "align_center"));
 	$table->construct_row();
 	
-	$query = $db->simple_select("posts", "DISTINCT ipaddress, pid", "uid='{$mybb->input['uid']}'");
+	$counter = 0;
+	
+	$query = $db->simple_select("posts", "DISTINCT ipaddress", "uid='{$mybb->input['uid']}'");
 	while($ip = $db->fetch_array($query))
 	{
-		if(!$done_ip[$ip['ipaddress']])
-		{
-			$popup = new PopupMenu("post_{$ip['pid']}", $lang->options);
-			$popup->add_item($lang->show_users_regged_with_ip, "index.php?module=user/users&amp;action=search&amp;regip={$ip['ipaddress']}");
-			$popup->add_item($lang->show_users_posted_with_ip, "index.php?module=user/users&amp;action=search&amp;postip={$ip['ipaddress']}");
+		++$counter;
+		$popup = new PopupMenu("id_{$counter}", $lang->options);
+		$popup->add_item($lang->show_users_regged_with_ip, "index.php?module=user/users&amp;results=1&amp;action=search&amp;conditions=".urlencode(serialize(array("regip" => $ip['ipaddress']))));
+		$popup->add_item($lang->show_users_posted_with_ip, "index.php?module=user/users&amp;results=1&amp;action=search&amp;conditions=".urlencode(serialize(array("postip" => $ip['ipaddress']))));
 			$popup->add_item($lang->ban_ip, "index.php?module=config/banning&amp;filter={$ip['ipaddress']}");
 			$controls = $popup->fetch();
 		
 			$table->construct_cell($ip['ipaddress']);
 			$table->construct_cell($controls, array('class' => "align_center"));
 			$table->construct_row();
-			$done_ip[$ip['ipaddres']] = 1;
-		}
 	}
 	
 	$table->output($lang->ip_address_for." {$user['username']}");
@@ -1459,10 +1500,31 @@
 			$db->update_query("pollvotes", $uid_update, "uid='{$source_user['uid']}'");
 			$db->update_query("posts", $uid_update, "uid='{$source_user['uid']}'");
 			$db->update_query("privatemessages", $uid_update, "uid='{$source_user['uid']}'");
-			$db->update_query("reputation", $uid_update, "uid='{$source_user['uid']}'");
-			$db->update_query("reputation", array('adduid' => $destination_user['uid']), "adduid='{$source_user['uid']}'");
 			$db->update_query("threadratings", $uid_update, "uid='{$source_user['uid']}'");
 			$db->update_query("threads", $uid_update, "uid='{$source_user['uid']}'");
+			$db->delete_query("sessions", "uid='{$source_user['uid']}'");
+			
+			// Merging Reputation
+			$query = $db->simple_select("reputation", "rid, uid", "adduid = '{$source_user['uid']}' OR adduid = '{$uid_update['uid']}'", array("order_by" => "dateline", "order_dir" => "DESC"));
+			while($result = $db->fetch_array($query))
+			{
+				// Let's try and remove old one if it's the same uid
+				if($result['uid'] == $last['uid'])
+				{
+					$db->delete_query("reputation", "rid = '".$result['rid']."'");
+					$db->update_query("reputation", array("adduid" => $uid_update['uid']), "rid = '".$last['rid']."'");
+				}
+				$last = array(
+					"rid" => $result['rid'],
+					"uid" => $result['uid']
+				);
+			}
+			
+			// Calculate new reputation
+			$query = $db->simple_select("reputation", "SUM(reputation) as total_rep", "uid='{$destination_user['uid']}'");
+			$total_reputation = $db->fetch_field($query, "total_rep");
+			
+			$db->update_query("users", array('reputation' => $total_reputation), "uid='{$destination_user['uid']}'");
 
 			// Additional updates for non-uid fields
 			$last_poster = array(
@@ -1575,6 +1637,10 @@
 			if(!$admin_view['vid'])
 			{
 				$default_view = fetch_default_view("user");
+				if(!$default_view)
+				{
+					$default_view = "0";
+				}
 				$query = $db->simple_select("adminviews", "*", "type='user' AND (vid='{$default_view}' OR uid=0)", array("order_by" => "uid", "order_dir" => "desc"));
 				$admin_view = $db->fetch_array($query);
 			}
@@ -1625,9 +1691,18 @@
 		}
 		else
 		{
+			if($mybb->input['from'] == "home")
+			{
+				flash_message($lang->error_no_users_found, 'error');
+				admin_redirect("index.php");
+				exit;
+			}
+			else
+			{
 			$errors[] = $lang->error_no_users_found;
 		}
 	}
+	}
 
 	$page->add_breadcrumb_item($lang->find_users);
 	$page->output_header($lang->find_users);
@@ -1675,7 +1750,7 @@
 	
 	$page->output_nav_tabs($sub_tabs, 'browse_users');
 	
-	if($mybb->input['search_id'] && $admin_session['user_views'][$mybb->input['search_id']])
+	if($mybb->input['search_id'] && $admin_session['data']['user_views'][$mybb->input['search_id']])
 	{
 		$admin_view = $admin_session['data']['user_views'][$mybb->input['search_id']];
 		unset($admin_view['extra_sql']);
@@ -1698,6 +1773,10 @@
 		if(!$admin_view)
 		{
 			$default_view = fetch_default_view("user");
+			if(!$default_view)
+			{
+				$default_view = "0";
+			}
 			$query = $db->simple_select("adminviews", "*", "type='user' AND (vid='{$default_view}' OR uid=0)", array("order_by" => "uid", "order_dir" => "desc"));
 			$admin_view = $db->fetch_array($query);
 		}
@@ -1723,12 +1802,25 @@
 
 	if(!$results)
 	{
+		// If we came from the home page and clicked on the "Activate Users" link, send them back to here
+		if($admin_session['data']['from'] == "home")
+		{
+			flash_message($admin_session['data']['flash_message2']['message'], $admin_session['data']['flash_message2']['type']);
+			update_admin_session('flash_message2', '');
+			update_admin_session('from', '');
+			admin_redirect("index.php");
+			exit;
+		}
+		else
+		{
 			$errors[] = $lang->error_no_users_found;
 	}
+	}
 
 	// If we have any error messages, show them
 	if($errors)
 	{
+		echo "<div style=\"display: inline; float: right;\">{$admin_view['popup']}</div><br />\n";
 		$page->output_inline_error($errors);
 	}
 
@@ -1798,6 +1890,12 @@
 		update_admin_session('last_users_url', str_replace("&amp;", "&", $view['url']));
 	}
 
+	// Do we not have any views?
+	if(empty($view))
+	{
+		return false;
+	}
+
 	$table = new Table;
 
 	// Build header for table based view
@@ -1853,7 +1951,7 @@
 	foreach($direction_fields as $search_field)
 	{
 		$direction_field = $search_field."_dir";
-		if($view['conditions'][$search_field] && $view['conditions'][$direction_field])
+		if(($view['conditions'][$search_field] || $view['conditions'][$search_field] === '0') && $view['conditions'][$direction_field])
 		{
 			switch($view['conditions'][$direction_field])
 			{
@@ -1876,11 +1974,10 @@
 	{
 		if($view['conditions'][$search_field])
 		{
-			$view['conditions'][$search_field] = str_replace("*", "%", $view['conditions'][$search_field]);
-			
 			// IPv6 IP
 			if(strpos($view['conditions'][$search_field], ":") !== false)
 			{
+				$view['conditions'][$search_field] = str_replace("*", "%", $view['conditions'][$search_field]);
 				$ip_sql = "{$search_field} LIKE '".$db->escape_string($view['conditions'][$search_field])."'";
 			}
 			else
@@ -1899,6 +1996,37 @@
 		}
 	}
 
+	// Post IP searching
+	if($view['conditions']['postip'])
+	{
+		// IPv6 IP
+		if(strpos($view['conditions']['postip'], ":") !== false)
+		{
+			$view['conditions']['postip'] = str_replace("*", "%", $view['conditions']['postip']);
+			$ip_sql = "ipaddress LIKE '".$db->escape_string($view['conditions']['postip'])."'";
+		}
+		else
+		{
+			$ip_range = fetch_longipv4_range($view['conditions']['postip']);
+			if(!is_array($ip_range))
+			{
+				$ip_sql = "longipaddress='{$ip_range}'";
+			}
+			else
+			{
+				$ip_sql = "longipaddress > '{$ip_range[0]}' AND longipaddress < '{$ip_range[1]}'";
+			}
+		}
+		$ip_uids = array(0);
+		$query = $db->simple_select("posts", "uid", $ip_sql);
+		while($uid = $db->fetch_field($query, "uid"))
+		{
+			$ip_uids[] = $uid;
+		}
+		$search_sql .= " AND u.uid IN(".implode(',', $ip_uids).")";
+		unset($ip_uids);
+	}
+
 	// Usergroup based searching
 	if($view['conditions']['usergroup'])
 	{
@@ -1915,6 +2043,7 @@
 				case "sqlite3":
 				case "sqlite2":
 					$additional_sql .= " OR ','||additionalgroups||',' LIKE '%,{$usergroup},%'";
+					break;
 				default:
 					$additional_sql .= "OR CONCAT(',',additionalgroups,',') LIKE '%,{$usergroup},%'";
 			}
@@ -1968,6 +2097,12 @@
 			$mybb->input['page'] = 1;
 		}
 		
+		$from_bit = "";
+		if($mybb->input['from'] == "home")
+		{
+			$from_bit = "&amp;from=home";
+		}
+		
 		switch($view['sortby'])
 		{
 			case "numposts":
@@ -2024,11 +2159,11 @@
 			{
 				if($user['coppauser'])
 				{
-					$popup->add_item($lang->approve_coppa_user, "index.php?module=user/users&amp;action=activate_user&amp;uid={$user['uid']}");
+					$popup->add_item($lang->approve_coppa_user, "index.php?module=user/users&amp;action=activate_user&amp;uid={$user['uid']}{$from_bit}");
 				}
 				else
 				{
-					$popup->add_item($lang->approve_user, "index.php?module=user/users&amp;action=activate_user&amp;uid={$user['uid']}");
+					$popup->add_item($lang->approve_user, "index.php?module=user/users&amp;action=activate_user&amp;uid={$user['uid']}{$from_bit}");
 				}
 			}
 
@@ -2074,7 +2209,7 @@
 			{
 				$user['avatar'] = "styles/{$page->style}/images/default_avatar.gif";
 			}
-			$user['view']['avatar'] = "<img src=\"{$user['avatar']}\" alt=\"\" width=\"{$scaled_avatar['width']}\" height=\"{$scaled_avatar['height']}\" />";
+			$user['view']['avatar'] = "<img src=\"".htmlspecialchars_uni($user['avatar'])."\" alt=\"\" width=\"{$scaled_avatar['width']}\" height=\"{$scaled_avatar['height']}\" />";
 
 			if($view['view_type'] == "card")
 			{
diff -rub mybb_1400/admin/styles/default/main.css mybb_1408/admin/styles/default/main.css
--- mybb_1400/admin/styles/default/main.css	2008-06-29 11:36:14.000000000 +0200
+++ mybb_1408/admin/styles/default/main.css	2009-06-26 06:22:11.000000000 +0200
@@ -608,7 +608,7 @@
 
 #flash_message.error {
 	border: 1px solid #FC6;
-	background: #FFC url('images/icons/error.gif') no-repeat 4px 9px;;
+	background: #FFC url('images/icons/error.gif') no-repeat 4px 9px;
 	color: #C00;
 }
 
@@ -958,3 +958,14 @@
 	font-weight: bold;
 	height: 30px;
 }
\ No newline at end of file
+
+/* Templates Differential page */
+.differential {
+	background: #FFF;
+	margin: 10px auto;
+	padding: 10px;
+	overflow: scroll;
+	height: 400px;
+	width: 980px;
+	border: 1px solid #ccc;
+}
\ No newline at end of file
diff -rub mybb_1400/admin/styles/sharepoint/main.css mybb_1408/admin/styles/sharepoint/main.css
--- mybb_1400/admin/styles/sharepoint/main.css	2008-07-08 00:08:37.000000000 +0200
+++ mybb_1408/admin/styles/sharepoint/main.css	2009-06-26 06:22:11.000000000 +0200
@@ -607,7 +607,7 @@
 
 #flash_message.error {
 	border: 1px solid #FC6;
-	background: #FFC url('images/icons/error.gif') no-repeat 4px 9px;;
+	background: #FFC url('images/icons/error.gif') no-repeat 4px 9px;
 	color: #C00;
 }
 
@@ -919,3 +919,14 @@
 	font-weight: bold;
 	height: 30px;
 }
\ No newline at end of file
+
+/* Templates Differential page */
+.differential {
+	background: #FFF;
+	margin: 10px auto;
+	padding: 10px;
+	overflow: scroll;
+	height: 400px;
+	width: 980px;
+	border: 1px solid #ccc;
+}
\ No newline at end of file
diff -rub mybb_1400/announcements.php mybb_1408/announcements.php
--- mybb_1400/announcements.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/announcements.php	2009-06-26 07:26:32.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: announcements.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: announcements.php 4365 2009-05-04 02:59:54Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'announcement.php');
 
 $templatelist = "announcement";
 require_once "./global.php";
@@ -52,6 +53,9 @@
 	{
 		error_no_permission();
 	}
+	
+	// Check if this forum is password protected and we have a valid password
+	check_forum_password($forum['fid']);
 }
 add_breadcrumb($lang->nav_announcements);
 
@@ -78,7 +82,7 @@
 $announcementarray['dateline'] = $announcementarray['startdate'];
 $announcementarray['userusername'] = $announcementarray['username'];
 $announcement = build_postbit($announcementarray, 3);
-$lang->forum_announcement = $lang->sprintf($lang->forum_announcement, $announcementarray['subject']);
+$lang->forum_announcement = $lang->sprintf($lang->forum_announcement, htmlspecialchars_uni($announcementarray['subject']));
 
 $plugins->run_hooks("announcements_end");
 
diff -rub mybb_1400/archive/global.php mybb_1408/archive/global.php
--- mybb_1400/archive/global.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/archive/global.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: global.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: global.php 4324 2009-03-05 21:23:18Z Tikitiki $
  */
 
 // If archive mode does not work, uncomment the line below and try again
@@ -83,7 +83,7 @@
 	{
 		$action = $todo[0];
 	}
-	$page = $todo[2];
+	$page = intval($todo[2]);
 	$id = intval($todo[1]);
 
 	// Get the thread, announcement or forum information.
diff -rub mybb_1400/archive/index.php mybb_1408/archive/index.php
--- mybb_1400/archive/index.php	2008-06-05 12:42:44.000000000 +0200
+++ mybb_1408/archive/index.php	2009-06-26 07:26:56.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: index.php 3884 2008-06-05 10:42:44Z ZiNgaBuRgA $
+ * $Id: index.php 4384 2009-06-19 11:49:42Z Tomm $
  */
 
 define("IN_MYBB", 1);
@@ -134,12 +134,15 @@
 
 		$pids = implode(",", $pids);
 
+		if($pids)
+		{
 		// Build attachments cache
 		$query = $db->simple_select("attachments", "*", "pid IN ({$pids})");
 		while($attachment = $db->fetch_array($query))
 		{
 			$acache[$attachment['pid']][$attachment['aid']] = $attachment;
 		}
+		}
 
 		// Start fetching the posts
 		$query = $db->query("
@@ -316,6 +319,7 @@
 				echo "<ol>\n";
 				while($sticky = $db->fetch_array($query))
 				{
+					$sticky['subject'] = htmlspecialchars_uni($parser->parse_badwords($sticky['subject']));
 					if($sticky['replies'] != 1)
 					{
 						$lang_reply_text = $lang->archive_replies;
diff -rub mybb_1400/attachment.php mybb_1408/attachment.php
--- mybb_1400/attachment.php	2008-07-09 00:36:04.000000000 +0200
+++ mybb_1408/attachment.php	2009-06-26 17:29:56.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: attachment.php 4002 2008-07-08 22:36:04Z Tikitiki $
+ * $Id: attachment.php 4388 2009-06-26 03:46:33Z RyanGordon $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'attachment.php');
 
 require_once "./global.php";
 
@@ -54,8 +55,7 @@
 // Permissions
 $forumpermissions = forum_permissions($fid);
 
-// No Permission page if user cannot view or download attachments in this forum (if not calling the thumbnail)
-if(($forumpermissions['canview'] == 0 || $forumpermissions['candlattachments'] == 0) && !$mybb->input['thumbnail'])
+if($forumpermissions['canview'] == 0 || $forumpermissions['canviewthreads'] == 0 || ($forumpermissions['candlattachments'] == 0 && !$mybb->input['thumbnail']))
 {
 	error_no_permission();
 }
@@ -113,16 +113,38 @@
 {
 	$ext = get_extension($attachment['filename']);
 	
-	if($ext == "txt" || $ext == "htm" || $ext == "html" || $ext == "pdf")
+	switch($attachment['filetype'])
+	{
+		case "application/pdf":
+		case "image/bmp":
+		case "image/gif":
+		case "image/jpeg":
+		case "image/pjpeg":
+		case "image/png":
+		case "text/plain":
+			header("Content-type: {$attachment['filetype']}");
+			$disposition = "inline";
+			break;
+
+		default:
+			header("Content-type: application/force-download");
+			$disposition = "attachment";
+	}
+
+	if(strpos(strtolower($_SERVER['HTTP_USER_AGENT']), "msie") !== false)
 	{
 		header("Content-disposition: attachment; filename=\"{$attachment['filename']}\"");
 	}
 	else
 	{
-		header("Content-disposition: inline; filename=\"{$attachment['filename']}\"");
+		header("Content-disposition: {$disposition}; filename=\"{$attachment['filename']}\"");
+	}
+	
+	if(strpos(strtolower($_SERVER['HTTP_USER_AGENT']), "msie 6.0") !== false)
+	{
+		header("Expires: -1");
 	}	
 	
-	header("Content-type: {$attachment['filetype']}");
 	header("Content-length: {$attachment['filesize']}");
 	header("Content-range: bytes=0-".($attachment['filesize']-1)."/".$attachment['filesize']); 
 	echo file_get_contents($mybb->settings['uploadspath']."/".$attachment['attachname']);
diff -rub mybb_1400/calendar.php mybb_1408/calendar.php
--- mybb_1400/calendar.php	2008-07-24 13:56:23.000000000 +0200
+++ mybb_1408/calendar.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,14 +6,15 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: calendar.php 4037 2008-07-24 11:56:23Z ZiNgaBuRgA $
+ * $Id: calendar.php 4351 2009-04-17 02:37:21Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'calendar.php');
 
 $templatelist = "calendar_weekdayheader,calendar_weekrow_day,calendar_weekrow,calendar_eventbit_public,calendar_eventbit_private,calendar";
 $templatelist .= ",calendar_weekview_day,calendar_weekview_day_event,calendar_mini_weekdayheader,calendar_mini_weekrow_day,calendar_mini_weekrow,calendar_mini,calendar_weekview_month,calendar_weekview,calendar_eventbit,calendar_addeventlink";
-$templatelist .= ",calendar_event_editbutton,calendar_event_modoptions,calendar_event,calendar_dayview_event,calendar_dayview,codebuttons,smilieinsert,calendar_editevent";
+$templatelist .= ",calendar_event_editbutton,calendar_event_modoptions,calendar_event,calendar_dayview_event,calendar_dayview,codebuttons,smilieinsert,calendar_editevent,calendar_dayview_birthdays_bday,calendar_dayview_birthdays,calendar_dayview_noevents,calendar_dayview_noevents";
 
 require_once "./global.php";
 
@@ -118,7 +119,7 @@
 			"year" => $mybb->input['end_year'],
 			"time" => $mybb->input['end_time']
 		);
-		$event['timezone'] = $mybb->input['timezone'];
+		$event['timezone'] = intval($mybb->input['timezone']);
 		$event['ignoretimezone'] =	intval($mybb->input['ignoretimezone']);
 		$repeats = array();
 		switch($mybb->input['repeats'])
@@ -1728,11 +1729,8 @@
 	$yearsel = '';
 	for($i = my_date("Y"); $i < (my_date("Y") + 5); ++$i)
 	{
-		if($i == my_date("Y"))
-		{
 			$yearsel .= "<option value=\"$i\">$i</option>\n";
 		}
-	}
 
 	if($mybb->usergroup['canaddevents'] == 1)
 	{
@@ -1793,6 +1791,10 @@
 		$start_day = $day-$php_weekday;
 		$mybb->input['week'] = gmmktime(0, 0, 0, $month, $start_day, $year);
 	}
+	else
+	{
+		$mybb->input['week'] = (int)str_replace("n", "-", $mybb->input['week']);
+	}
 	
 	// This is where we've come from and where we're headed
 	$week_from = explode("-", gmdate("j-n-Y", $mybb->input['week']));
@@ -1803,7 +1805,7 @@
 
 	add_breadcrumb(htmlspecialchars_uni($calendar['name']), get_calendar_link($calendar['cid']));
 	add_breadcrumb("{$monthnames[$week_from[1]]} {$week_from[2]}", get_calendar_link($calendar['cid'], $week_from[2], $week_from[1]));
-	add_breadcrumb("Weekly Overview");
+	add_breadcrumb($lang->weekly_overview);
 
 	// Establish if we have a month ending in this week
 	if($week_from[1] != $week_to[1])
@@ -2059,7 +2061,7 @@
 	$month_start_weekday = gmdate("w", gmmktime(0, 0, 0, $month, $calendar['startofweek']+1, $year));
 	
 	// This is if we have days in the previous month to show
-	if($month_start_weekday != $weekdays[0])
+	if($month_start_weekday != $weekdays[0] || $calendar['startofweek'] != 0)
 	{
 		$day = gmdate("t", gmmktime(0, 0, 0, $prev_month['month'], 1, $prev_month['year']));
 		$day -= array_search(($month_start_weekday), $weekdays);
@@ -2101,6 +2103,18 @@
 		eval("\$weekday_headers .= \"".$templates->get("calendar_weekdayheader")."\";");
 	}
 
+	// Fix offset for Start Of Week being Saturday
+	if($calendar_month == $prev_month['month'] && $calendar['startofweek'] > 0)
+	{
+		$day -= 7;
+		
+		// Lets make sure we don't have a whole extra column for the last month
+		if($prev_month_days-7 >= ($day-1))
+		{
+			$day += 7;
+		}
+	}
+
 	for($row = 0; $row < 6; ++$row) // Iterate weeks (each week gets a row)
 	{
 		foreach($weekdays as $weekday_id => $weekday)
@@ -2162,12 +2176,12 @@
 					foreach($events_cache["$day-$calendar_month-$calendar_year"] as $event)
 					{
 						$event['eventlink'] = get_event_link($event['eid']);
-						$event['name'] = htmlspecialchars_uni($event['name']);
-						$event['fullname'] = $event['name'];
+						$event['fullname'] = htmlspecialchars_uni($event['name']);
 						if(my_strlen($event['name']) > 15)
 						{
 							$event['name'] = my_substr($event['name'], 0, 15) . "...";
 						}
+						$event['name'] = htmlspecialchars_uni($event['name']);
 						if($event['private'] == 1)
 						{
 							$event_class = " private_event";
diff -rub mybb_1400/captcha.php mybb_1408/captcha.php
--- mybb_1400/captcha.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/captcha.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,11 +6,12 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: captcha.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: captcha.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
 define("NO_ONLINE", 1);
+define('THIS_SCRIPT', 'captcha.php');
 
 require_once "./global.php";
 
@@ -325,6 +326,14 @@
 		return;
 	}
 	
+	if(function_exists("gd_info"))
+	{
+		$gd_info = gd_info();
+   		preg_match('/\d/', $gd_info['GD Version'], $gd);
+   		$gd_version = $gd[0];
+	}
+	else
+	{
 	ob_start();
 	phpinfo(8);
 	$info = ob_get_contents();
@@ -332,6 +341,7 @@
 	$info = stristr($info, 'gd version');
 	preg_match('/\d/', $info, $gd);
 	$gd_version = $gd[0];
+	}
 	
 	return $gd_version;
 }
diff -rub mybb_1400/css.php mybb_1408/css.php
--- mybb_1400/css.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/css.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,12 +6,12 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: css.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: css.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
-
 define("NO_ONLINE", 1);
+define('THIS_SCRIPT', 'css.php');
 
 require_once "./inc/init.php";
 
diff -rub mybb_1400/editpost.php mybb_1408/editpost.php
--- mybb_1400/editpost.php	2008-07-26 02:22:41.000000000 +0200
+++ mybb_1408/editpost.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: editpost.php 4044 2008-07-26 00:22:41Z Tikitiki $
+ * $Id: editpost.php 4280 2008-11-27 07:27:58Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'editpost.php');
 
 $templatelist = "editpost,previewpost,redirect_postedited,loginbox,posticons,changeuserbox,attachment,posticons,codebuttons,smilieinsert,post_attachments_attachment_postinsert,post_attachments_attachment_mod_approve,post_attachments_attachment_unapproved,post_attachments_attachment_mod_unapprove,post_attachments_attachment,post_attachments_new,post_attachments,newthread_postpoll,editpost_disablesmilies,post_subscription_method";
 
@@ -20,6 +21,8 @@
 // Load global language phrases
 $lang->load("editpost");
 
+$plugins->run_hooks("editpost_start");
+
 // No permission for guests
 if(!$mybb->user['uid'])
 {
@@ -144,8 +147,19 @@
 
 if(!$mybb->input['attachmentaid'] && ($mybb->input['newattachment'] || ($mybb->input['action'] == "do_editpost" && $mybb->input['submit'] && $_FILES['attachment'])))
 {
+	if($mybb->input['posthash'])
+	{
+		$posthash_query = "posthash='".$db->escape_string($mybb->input['posthash'])."' OR ";
+	}
+	else
+	{
+		$posthash_query = "";
+	}
+	$query = $db->simple_select("attachments", "COUNT(aid) as numattachs", "{$posthash_query}pid='{$pid}'");
+	$attachcount = $db->fetch_field($query, "numattachs");
+	
 	// If there's an attachment, check it and upload it
-	if($_FILES['attachment']['size'] > 0 && $forumpermissions['canpostattachments'] != 0)
+	if($_FILES['attachment']['size'] > 0 && $forumpermissions['canpostattachments'] != 0 && ($mybb->settings['maxattachments'] == 0 || $attachcount < $mybb->settings['maxattachments']))
 	{
 		$attachedfile = upload_attachment($_FILES['attachment']);
 	}
@@ -207,7 +221,7 @@
 		$modlogdata['tid'] = $tid;
 		if($firstpost)
 		{
-			if($forumpermissions['candeletethreads'] == 1)
+			if($forumpermissions['candeletethreads'] == 1 || is_moderator($fid, "candeleteposts"))
 			{
 				delete_thread($tid);
 				mark_reports($tid, "thread");
@@ -221,7 +235,7 @@
 		}
 		else
 		{
-			if($forumpermissions['candeleteposts'] == 1)
+			if($forumpermissions['candeleteposts'] == 1 || is_moderator($fid, "candeleteposts"))
 			{
 				// Select the first post before this
 				delete_post($pid, $tid);
@@ -303,7 +317,7 @@
 		// Did the user choose to post a poll? Redirect them to the poll posting page.
 		if($mybb->input['postpoll'] && $forumpermissions['canpostpolls'])
 		{
-			$url = "polls.php?action=newpoll&tid=$tid&polloptions=".$mybb->input['numpolloptions'];
+			$url = "polls.php?action=newpoll&tid=$tid&polloptions=".intval($mybb->input['numpolloptions']);
 			$lang->redirect_postedited = $lang->redirect_postedited_poll;
 		}
 		else if($visible == 0 && $first_post && !is_moderator($fid, "", $mybb->user['uid']))
diff -rub mybb_1400/forumdisplay.php mybb_1408/forumdisplay.php
--- mybb_1400/forumdisplay.php	2008-07-16 00:03:34.000000000 +0200
+++ mybb_1408/forumdisplay.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: forumdisplay.php 4020 2008-07-15 22:03:34Z Tikitiki $
+ * $Id: forumdisplay.php 4322 2009-02-21 23:00:49Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'forumdisplay.php');
 
 $templatelist = "forumdisplay,forumdisplay_thread,breadcrumb_bit,forumbit_depth1_cat,forumbit_depth1_forum,forumbit_depth2_cat,forumbit_depth2_forum,forumdisplay_subforums,forumdisplay_threadlist,forumdisplay_moderatedby_moderator,forumdisplay_moderatedby,forumdisplay_newthread,forumdisplay_searchforum,forumdisplay_orderarrow,forumdisplay_thread_rating,forumdisplay_announcement,forumdisplay_threadlist_rating,forumdisplay_threadlist_sortrating,forumdisplay_subforums_modcolumn,forumbit_moderators,forumbit_subforums,forumbit_depth2_forum_lastpost";
 $templatelist .= ",forumbit_depth1_forum_lastpost,forumdisplay_thread_multipage_page,forumdisplay_thread_multipage,forumdisplay_thread_multipage_more";
@@ -77,16 +78,38 @@
 	error_no_permission();
 }
 
-// Build a forum cache.
-$query = $db->query("
+if($mybb->user['uid'] == 0)
+{
+	// Build a forum cache.
+	$query = $db->query("
+		SELECT *
+		FROM ".TABLE_PREFIX."forums
+		WHERE active != 0
+		ORDER BY pid, disporder
+	");
+	
+	$forumsread = unserialize($mybb->cookies['mybb']['forumread']);
+}
+else
+{
+	// Build a forum cache.
+	$query = $db->query("
 	SELECT f.*, fr.dateline AS lastread
 	FROM ".TABLE_PREFIX."forums f
 	LEFT JOIN ".TABLE_PREFIX."forumsread fr ON (fr.fid=f.fid AND fr.uid='{$mybb->user['uid']}')
 	WHERE f.active != 0
 	ORDER BY pid, disporder
-");
+	");
+}
 while($forum = $db->fetch_array($query))
 {
+	if($mybb->user['uid'] == 0)
+	{
+		if($forumsread[$forum['fid']])
+		{
+			$forum['lastread'] = $forumsread[$forum['fid']];
+		}
+	}
 	$fcache[$forum['pid']][$forum['disporder']][$forum['fid']] = $forum;
 }
 
@@ -237,7 +260,7 @@
 		$invisonline = $lang->sprintf($lang->users_browsing_forum_invis, $inviscount);
 	}
 	
-	if($invisonline != '' && $guestcount)
+	if($invisonline != '' && ($guestcount || $onlinemembers))
 	{
 		$onlinesep2 = ", ";
 	}
@@ -418,14 +441,18 @@
 }
 eval("\$orderarrow['$sortby'] = \"".$templates->get("forumdisplay_orderarrow")."\";");
 
-// How many posts are there?
-if($datecut > 0)
+$threadcount = 0;
+
+if($fpermissions['canviewthreads'] != 0)
 {
+	// How many posts are there?
+	if($datecut > 0)
+	{
 	$query = $db->simple_select("threads", "COUNT(tid) AS threads", "fid = '$fid' $visibleonly $datecutsql");
 	$threadcount = $db->fetch_field($query, "threads");
-}
-else
-{
+	}
+	else
+	{
 	$query = $db->simple_select("forums", "threads, unapprovedthreads", "fid = '{$fid}'", array('limit' => 1));
 	$forum_threads = $db->fetch_array($query);
 	$threadcount = $forum_threads['threads'];
@@ -440,6 +467,7 @@
 		$query = $db->simple_select("threads", "COUNT(tid) AS threads", "fid = '$fid' $visibleonly", array('limit' => 1));
 		$threadcount = $db->fetch_field($query, "threads");
 	}
+	}
 }
 
 // How many pages are there?
@@ -518,7 +546,7 @@
 }
 $multipage = multipage($threadcount, $perpage, $page, $page_url);
 
-if($foruminfo['allowtratings'] != 0)
+if($foruminfo['allowtratings'] != 0 && $fpermissions['canviewthreads'] != 0)
 {
 	$lang->load("ratethread");
 	switch($db->type)
@@ -545,6 +573,8 @@
 
 				$avaragerating[$thread['tid']] = $rating;
 			}
+			$t = "t.";
+			$sortfield = "lastpost";
 			break;
 		default:
 			$ratingadd = "(t.totalratings/t.numratings) AS averagerating, ";
@@ -558,6 +588,11 @@
 }
 else
 {
+	if($sortfield == "averagerating")
+	{
+		$t = "t.";
+		$sortfield = "lastpost";
+	}
 	$ratingadd = '';
 	$lpbackground = "trow1";
 	$colspan = "6";
@@ -638,17 +673,19 @@
 
 $icon_cache = $cache->read("posticons");
 
-// Start Getting Threads
-$query = $db->query("
+if($fpermissions['canviewthreads'] != 0)
+{
+	// Start Getting Threads
+	$query = $db->query("
 	SELECT t.*, {$ratingadd}{$select_rating_user}t.username AS threadusername, u.username
 	FROM ".TABLE_PREFIX."threads t
 	LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid = t.uid){$select_voting}
 	WHERE t.fid='$fid' $tvisibleonly $datecutsql2
 	ORDER BY t.sticky DESC, {$t}{$sortfield} $sortordernow $sortfield2
 	LIMIT $start, $perpage
-");
-while($thread = $db->fetch_array($query))
-{
+	");
+	while($thread = $db->fetch_array($query))
+	{
 	if($db->type == "pgsql")
 	{
 		$thread['averagerating'] = $averagerating[$thread['tid']];
@@ -675,6 +712,11 @@
 			unset($moved_threads[$tid]);
 		}
 	}
+	}
+}
+else
+{
+	$tids = $threadcache = null;
 }
 
 if($tids)
@@ -806,8 +848,8 @@
 			}
 			else
 			{
-				$thread['averagerating'] = intval(round($thread['averagerating'], 2));
-				$thread['width'] = $thread['averagerating']*20;
+				$thread['averagerating'] = floatval(round($thread['averagerating'], 2));
+				$thread['width'] = intval(round($thread['averagerating']))*20;
 				$thread['numratings'] = intval($thread['numratings']);
 
 				$not_rated = '';
diff -rub mybb_1400/global.php mybb_1408/global.php
--- mybb_1400/global.php	2008-07-09 00:34:00.000000000 +0200
+++ mybb_1408/global.php	2009-06-26 07:26:27.000000000 +0200
@@ -6,11 +6,17 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: global.php 4001 2008-07-08 22:34:00Z Tikitiki $
+ * $Id: global.php 4369 2009-05-11 08:48:32Z Tomm $
  */
 
+$working_dir = dirname(__FILE__);
+if(!$working_dir)
+{
+	$working_dir = '.';
+}
+
 // Load main MyBB core file which begins all of the magic
-require_once "./inc/init.php";
+require_once $working_dir."/inc/init.php";
 
 $shutdown_queries = array();
 
@@ -24,7 +30,13 @@
 	$groupscache = $cache->read("usergroups");
 }
 
-$current_page = my_strtolower(basename($_SERVER['PHP_SELF']));
+if(!defined('THIS_SCRIPT'))
+{
+	define('THIS_SCRIPT', '');
+}
+
+$current_page = my_strtolower(basename(THIS_SCRIPT));
+
 
 // Send page headers - don't send no-cache headers for attachment.php
 if($current_page != "attachment.php")
@@ -114,7 +126,7 @@
 if(in_array($current_page, $valid))
 {
 	// If we're accessing a post, fetch the forum theme for it and if we're overriding it
-	if(isset($mybb->input['pid']))
+	if($mybb->input['pid'])
 	{
 		$query = $db->query("
 			SELECT f.style, f.overridestyle, p.*
@@ -129,7 +141,7 @@
 	}
 	
 	// We have a thread id and a forum id, we can easily fetch the theme for this forum
-	else if(isset($mybb->input['tid']))
+	else if($mybb->input['tid'])
 	{
 		$query = $db->query("
 			SELECT f.style, f.overridestyle, t.*
@@ -143,7 +155,7 @@
 	}
 	
 	// We have a forum id - simply load the theme from it
-	else if(isset($mybb->input['fid']))
+	else if($mybb->input['fid'])
 	{
 		cache_forums();
 		$style = $forum_cache[intval($mybb->input['fid'])];
@@ -397,13 +409,24 @@
 		LIMIT 1
 	");
 	$pm = $db->fetch_array($query);
+	
+	if($pm['fromuid'] == 0)
+	{
+		$pm['fromusername'] = 'MyBB Engine';
+		$user_text = $pm['fromusername'];
+	}
+	else
+	{
+		$user_text = build_profile_link($pm['fromusername'], $pm['fromuid']);
+	}
+
 	if($mybb->user['pms_unread'] == 1)
 	{
-		$privatemessage_text = $lang->sprintf($lang->newpm_notice_one, get_profile_link($pm['fromuid']), $pm['fromusername'], $pm['pmid'], $pm['subject']);
+		$privatemessage_text = $lang->sprintf($lang->newpm_notice_one, $user_text, $pm['pmid'], htmlspecialchars_uni($pm['subject']));
 	}
 	else
 	{
-		$privatemessage_text = $lang->sprintf($lang->newpm_notice_multiple, $mybb->user['pms_unread'], get_profile_link($pm['fromuid']), $pm['fromusername'], $pm['pmid'], $pm['subject']);
+		$privatemessage_text = $lang->sprintf($lang->newpm_notice_multiple, $mybb->user['pms_unread'], $user_text, $pm['pmid'], htmlspecialchars_uni($pm['subject']));
 	}
 	eval("\$pm_notice = \"".$templates->get("global_pm_alert")."\";");
 }
@@ -487,7 +510,14 @@
 // Check banned ip addresses
 if(is_banned_ip($session->ipaddress, true))
 {
+	if ($mybb->user['uid'])
+    {
 	$db->delete_query("sessions", "ip='".$db->escape_string($session->ipaddress)."' OR uid='{$mybb->user['uid']}'");
+    }
+    else
+    {
+        $db->delete_query("sessions", "ip='".$db->escape_string($session->ipaddress)."'");
+    }
 	error($lang->error_banned);
 }
 
diff -rub mybb_1400/htaccess.txt mybb_1408/htaccess.txt
--- mybb_1400/htaccess.txt	2008-07-16 00:03:34.000000000 +0200
+++ mybb_1408/htaccess.txt	2009-06-26 06:22:11.000000000 +0200
@@ -22,30 +22,30 @@
 #
 <IfModule mod_rewrite.c>
 	RewriteEngine on
-	RewriteRule ^forum-([0-9]+).html forumdisplay.php?fid=$1 [L,QSA]
-	RewriteRule ^forum-([0-9]+)-page-([0-9]+).html forumdisplay.php?fid=$1&page=$2 [L,QSA]
+	RewriteRule ^forum-([0-9]+)\.html$ forumdisplay.php?fid=$1 [L,QSA]
+	RewriteRule ^forum-([0-9]+)-page-([0-9]+)\.html$ forumdisplay.php?fid=$1&page=$2 [L,QSA]
 
-	RewriteRule ^thread-([0-9]+).html showthread.php?tid=$1 [L,QSA]
-	RewriteRule ^thread-([0-9]+)-page-([0-9]+).html showthread.php?tid=$1&page=$2 [L,QSA]
-	RewriteRule ^thread-([0-9]+)-lastpost.html showthread.php?tid=$1&action=lastpost [L,QSA]
-	RewriteRule ^thread-([0-9]+)-nextnewest.html showthread.php?tid=$1&action=nextnewest [L,QSA]
-	RewriteRule ^thread-([0-9]+)-nextoldest.html showthread.php?tid=$1&action=nextoldest [L,QSA]
-	RewriteRule ^thread-([0-9]+)-newpost.html showthread.php?tid=$1&action=newpost [L,QSA]
-	RewriteRule ^thread-([0-9]+)-post-([0-9]+).html showthread.php?tid=$1&pid=$2 [L,QSA]
-
-	RewriteRule ^post-([0-9]+).html showthread.php?pid=$1 [L,QSA]
-
-	RewriteRule ^announcement-([0-9]+).html announcements.php?aid=$1 [L,QSA]
-
-	RewriteRule ^user-([0-9]+).html member.php?action=profile&uid=$1 [L,QSA]
-
-	RewriteRule ^calendar-([0-9]+).html calendar.php?calendar=$1 [L,QSA]
-	RewriteRule ^calendar-([0-9]+)-year-([0-9]+).html calendar.php?action=yearview&calendar=$1&year=$2 [L,QSA]
-	RewriteRule ^calendar-([0-9]+)-year-([0-9]+)-month-([0-9]+).html calendar.php?calendar=$1&year=$2&month=$3 [L,QSA]
-	RewriteRule ^calendar-([0-9]+)-year-([0-9]+)-month-([0-9]+)-day-([0-9]+).html calendar.php?action=dayview&calendar=$1&year=$2&month=$3&day=$4 [L,QSA]
-	RewriteRule ^calendar-([0-9]+)-week-([0-9]+).html calendar.php?action=weekview&calendar=$1&week=$2 [L,QSA]
+	RewriteRule ^thread-([0-9]+)\.html$ showthread.php?tid=$1 [L,QSA]
+	RewriteRule ^thread-([0-9]+)-page-([0-9]+)\.html$ showthread.php?tid=$1&page=$2 [L,QSA]
+	RewriteRule ^thread-([0-9]+)-lastpost\.html$ showthread.php?tid=$1&action=lastpost [L,QSA]
+	RewriteRule ^thread-([0-9]+)-nextnewest\.html$ showthread.php?tid=$1&action=nextnewest [L,QSA]
+	RewriteRule ^thread-([0-9]+)-nextoldest\.html$ showthread.php?tid=$1&action=nextoldest [L,QSA]
+	RewriteRule ^thread-([0-9]+)-newpost\.html$ showthread.php?tid=$1&action=newpost [L,QSA]
+	RewriteRule ^thread-([0-9]+)-post-([0-9]+)\.html$ showthread.php?tid=$1&pid=$2 [L,QSA]
+
+	RewriteRule ^post-([0-9]+)\.html$ showthread.php?pid=$1 [L,QSA]
+
+	RewriteRule ^announcement-([0-9]+)\.html$ announcements.php?aid=$1 [L,QSA]
+
+	RewriteRule ^user-([0-9]+)\.html$ member.php?action=profile&uid=$1 [L,QSA]
+
+	RewriteRule ^calendar-([0-9]+)\.html$ calendar.php?calendar=$1 [L,QSA]
+	RewriteRule ^calendar-([0-9]+)-year-([0-9]+)\.html$ calendar.php?action=yearview&calendar=$1&year=$2 [L,QSA]
+	RewriteRule ^calendar-([0-9]+)-year-([0-9]+)-month-([0-9]+)\.html$ calendar.php?calendar=$1&year=$2&month=$3 [L,QSA]
+	RewriteRule ^calendar-([0-9]+)-year-([0-9]+)-month-([0-9]+)-day-([0-9]+)\.html$ calendar.php?action=dayview&calendar=$1&year=$2&month=$3&day=$4 [L,QSA]
+	RewriteRule ^calendar-([0-9]+)-week-(n?[0-9]+)\.html$ calendar.php?action=weekview&calendar=$1&week=$2 [L,QSA]
 
-	RewriteRule ^event-([0-9]+).html calendar.php?action=event&eid=$1 [L,QSA]
+	RewriteRule ^event-([0-9]+)\.html$ calendar.php?action=event&eid=$1 [L,QSA]
 
 	<IfModule mod_env.c>
 		SetEnv SEO_SUPPORT 1
diff -rub mybb_1400/inc/adminfunctions_templates.php mybb_1408/inc/adminfunctions_templates.php
--- mybb_1400/inc/adminfunctions_templates.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/adminfunctions_templates.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: adminfunctions_templates.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: adminfunctions_templates.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/inc/cachehandlers/disk.php mybb_1408/inc/cachehandlers/disk.php
--- mybb_1400/inc/cachehandlers/disk.php	2008-07-07 23:42:29.000000000 +0200
+++ mybb_1408/inc/cachehandlers/disk.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: disk.php 3998 2008-07-07 21:42:29Z Tikitiki $
+ * $Id: disk.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -19,7 +19,7 @@
 	 *
 	 * @return boolean True if successful, false on failure
 	 */
-	function connect()
+	function connect($silent=false)
 	{
 		if(!@is_writable(MYBB_ROOT."cache"))
 		{
diff -rub mybb_1400/inc/cachehandlers/eaccelerator.php mybb_1408/inc/cachehandlers/eaccelerator.php
--- mybb_1400/inc/cachehandlers/eaccelerator.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/inc/cachehandlers/eaccelerator.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: eaccelerator.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: eaccelerator.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -19,13 +19,34 @@
 	 */
 	var $unique_id;
 	
-	function eacceleratorCacheHandler()
+	function eacceleratorCacheHandler($silent=false)
 	{
 		if(!function_exists("eaccelerator_get"))
 		{
+			// Check if our DB engine is loaded
+			if(!extension_loaded("Eaccelerator"))
+			{
+				// Try and manually load it - DIRECTORY_SEPARATOR checks if running windows
+				if(DIRECTORY_SEPARATOR == '\\')
+				{
+					@dl('php_eaccelerator.dll');
+				} 
+				else 
+				{
+					@dl('eaccelerator.so');
+				}
+				
+				// Check again to see if we've been able to load it
+				if(!extension_loaded("Eaccelerator") && !$silent)
+				{
+					// Throw our super awesome cache loading error
 			die("eAccelerator needs to be configured with PHP to use the eAccelerator cache support");
+					$mybb->trigger_generic_error("sql_load_error");
+				}
 		}
 	}
+		return false;
+	}
 
 	/**
 	 * Connect and initialize this handler.
diff -rub mybb_1400/inc/cachehandlers/memcache.php mybb_1408/inc/cachehandlers/memcache.php
--- mybb_1400/inc/cachehandlers/memcache.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/inc/cachehandlers/memcache.php	2009-06-26 07:27:14.000000000 +0200
@@ -1,12 +1,12 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: memcache.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: memcache.php 4372 2009-05-15 16:13:13Z Tomm $
  */
 
 /**
@@ -24,11 +24,31 @@
 	 */
 	var $unique_id;
 	
-	function memcacheCacheHandler()
+	function memcacheCacheHandler($silent=false)
 	{
 		if(!function_exists("memcache_connect"))
 		{
+			// Check if our DB engine is loaded
+			if(!extension_loaded("Memcache"))
+			{
+				// Try and manually load it - DIRECTORY_SEPARATOR checks if running windows
+				if(DIRECTORY_SEPARATOR == '\\')
+				{
+					@dl('php_memcache.dll');
+				} 
+				else 
+				{
+					@dl('memcache.so');
+				}
+				
+				// Check again to see if we've been able to load it
+				if(!extension_loaded("Memcache") && !$silent)
+				{
+					// Throw our super awesome cache loading error
 			die("Your server does not have memcache support enabled.");
+					$mybb->trigger_generic_error("sql_load_error");
+				}
+			}
 		}
 	}
 
@@ -43,7 +63,7 @@
 
 		if(!$mybb->config['memcache_host'])
 		{
-			die("Plesse configure the memcache settings in inc/config.php before attempting to use this cache handler");
+			die("Please configure the memcache settings in inc/config.php before attempting to use this cache handler");
 		}
 
 		if(!$mybb->config['memcache_port'])
@@ -124,3 +144,4 @@
 		return $lang->na;
 	}
 }
\ No newline at end of file
+?>
\ No newline at end of file
diff -rub mybb_1400/inc/cachehandlers/xcache.php mybb_1408/inc/cachehandlers/xcache.php
--- mybb_1400/inc/cachehandlers/xcache.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/inc/cachehandlers/xcache.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: xcache.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: xcache.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -19,11 +19,31 @@
 	 */
 	var $unique_id;
 	
-	function xcacheCacheHandler()
+	function xcacheCacheHandler($silent=false)
 	{
 		if(!function_exists("xcache_get"))
 		{
+			// Check if our DB engine is loaded
+			if(!extension_loaded("XCache"))
+			{
+				// Try and manually load it - DIRECTORY_SEPARATOR checks if running windows
+				if(DIRECTORY_SEPARATOR == '\\')
+				{
+					@dl('php_xcache.dll');
+				} 
+				else 
+				{
+					@dl('xcache.so');
+				}
+				
+				// Check again to see if we've been able to load it
+				if(!extension_loaded("XCache") && !$silent)
+				{
+					// Throw our super awesome cache loading error
 			die("Xcache needs to be configured with PHP to use the Xcache cache support");
+					$mybb->trigger_generic_error("sql_load_error");
+				}
+			}
 		}
 	}
 
diff -rub mybb_1400/inc/class_bitwise.php mybb_1408/inc/class_bitwise.php
--- mybb_1400/inc/class_bitwise.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/class_bitwise.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_bitwise.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: class_bitwise.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class bitwise
diff -rub mybb_1400/inc/class_core.php mybb_1408/inc/class_core.php
--- mybb_1400/inc/class_core.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/inc/class_core.php	2009-06-26 07:27:04.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_core.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: class_core.php 4386 2009-06-25 07:30:06Z RyanGordon $
  */
 
 class MyBB {
@@ -15,14 +15,14 @@
 	 *
 	 * @var string
 	 */
-	var $version = "1.4";
+	var $version = "1.4.8";
 	
 	/**
 	 * The version code of MyBB we're running.
 	 *
 	 * @var integer
 	 */
-	var $version_code = 1400;
+	var $version_code = 1408;
 	
 	/**
 	 * The current working directory.
@@ -134,7 +134,7 @@
 		$protected = array("_GET", "_POST", "_SERVER", "_COOKIE", "_FILES", "_SERVER", "_ENV", "GLOBALS");
 		foreach($protected as $var)
 		{
-			if(isset($_REQUEST[$var]) || isset($_FILES[$var]) || isset($_COOKIE[$var]))
+			if(isset($_REQUEST[$var]) || isset($_FILES[$var]))
 			{
 				die("Hacking attempt");
 			}
@@ -199,11 +199,8 @@
 		}
 
 		// Old version of PHP, need to register_shutdown_function
-		if(phpversion() < '5.0.5')
-		{
 			$this->use_shutdown = true;
 			register_shutdown_function(array(&$this, "__destruct"));
-		}
 
 		if(isset($this->input['action']) && $this->input['action'] == "mybb_logo")
 		{
diff -rub mybb_1400/inc/class_custommoderation.php mybb_1408/inc/class_custommoderation.php
--- mybb_1400/inc/class_custommoderation.php	2008-06-11 04:21:37.000000000 +0200
+++ mybb_1408/inc/class_custommoderation.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_custommoderation.php 3902 2008-06-11 02:21:37Z Tikitiki $
+ * $Id: class_custommoderation.php 4340 2009-04-05 17:10:22Z Tikitiki $
  */
 
 /**
@@ -280,7 +280,6 @@
 
 			if($thread_options['openthread'] == 'open') // Open thread
 			{
-				echo "opening";
 				$this->open_threads($tids);
 			}
 			elseif($thread_options['openthread'] == 'close') // Close thread
@@ -299,8 +298,9 @@
 			if(!empty($thread_options['addreply'])) // Add reply to thread
 			{
 				$tid_list = implode(',', $tids);
-				$query = $db->simple_select("threads", 'fid, subject, tid, firstpost', "tid IN ($tid_list)");
+				$query = $db->simple_select("threads", 'fid, subject, tid, firstpost', "tid IN ($tid_list) AND closed NOT LIKE 'moved|%'");
 				require_once MYBB_ROOT."inc/datahandlers/post.php";
+				
 				// Loop threads adding a reply to each one
 				while($thread = $db->fetch_array($query))
 				{
@@ -308,12 +308,12 @@
 			
 					if(empty($thread_options['replysubject']))
 					{
-						$thread_options['replysubject'] = 'RE: '.$thread['subject'];
+                        $new_subject = 'RE: '.$thread['subject'];
 					}
 					else
 					{
-						$thread_options['replysubject'] = str_ireplace('{username}', $mybb->user['username'], $thread_options['replysubject']);
-						$thread_options['replysubject'] = str_ireplace('{subject}', $thread['subject'], $thread_options['replysubject']);
+                        $new_subject = str_ireplace('{username}', $mybb->user['username'], $thread_options['replysubject']);
+                        $new_subject = str_ireplace('{subject}', $thread['subject'], $new_subject);
 					}
 	
 					// Set the post data that came from the input to the $post array.
@@ -321,7 +321,7 @@
 						"tid" => $thread['tid'],
 						"replyto" => $thread['firstpost'],
 						"fid" => $thread['fid'],
-						"subject" => $thread_options['replysubject'],
+                        "subject" => $new_subject,
 						"uid" => $mybb->user['uid'],
 						"username" => $mybb->user['username'],
 						"message" => $thread_options['addreply'],
@@ -331,7 +331,7 @@
 					$post['options'] = array(
 						"signature" => 1,
 						"emailnotify" => 0,
-						"disablesmilies" => 1
+						"disablesmilies" => 0
 					);
 	
 					$posthandler->set_data($post);
diff -rub mybb_1400/inc/class_datacache.php mybb_1408/inc/class_datacache.php
--- mybb_1400/inc/class_datacache.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/inc/class_datacache.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_datacache.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: class_datacache.php 4305 2009-01-02 08:05:39Z Tikitiki $
  */
 
 class datacache
@@ -26,6 +26,13 @@
 	var $handler = null;
 
 	/**
+	 * Whether or not to exit the script if we cannot load the specified extension
+	 *
+	 * @var boolean
+	 */
+	var $silent = false;
+
+	/**
 	 * Build cache data.
 	 *
 	 */
@@ -38,22 +45,22 @@
 			// Disk cache
 			case "files":
 				require_once MYBB_ROOT."/inc/cachehandlers/disk.php";
-				$this->handler = new diskCacheHandler;
+				$this->handler = new diskCacheHandler($this->silent);
 				break;
 			// Memcache cache
 			case "memcache":
 				require_once MYBB_ROOT."/inc/cachehandlers/memcache.php";
-				$this->handler = new memcacheCacheHandler;
+				$this->handler = new memcacheCacheHandler($this->silent);
 				break;
 			// eAccelerator cache
 			case "eaccelerator":
 				require_once MYBB_ROOT."/inc/cachehandlers/eaccelerator.php";
-				$this->handler = new eacceleratorCacheHandler;
+				$this->handler = new eacceleratorCacheHandler($this->silent);
 				break;
 			// Xcache cache
 			case "xcache":
 				require_once MYBB_ROOT."/inc/cachehandlers/xcache.php";
-				$this->handler = new xcacheCacheHandler;
+				$this->handler = new xcacheCacheHandler($this->silent);
 				break;
 		}
 		if(is_object($this->handler))
@@ -163,7 +170,7 @@
 			"title" => $db->escape_string($name),
 			"cache" => $dbcontents
 		);		
-		$db->replace_query("datacache", $replace_array, "title");
+		$db->replace_query("datacache", $replace_array, "title", false);
 
 		// Do we have a cache handler we're using?
 		if(is_object($this->handler))
@@ -475,7 +482,7 @@
 		{
 			foreach(array_keys($this->moderators) as $fid)
 			{
-				usort($this->moderators[$fid], 'sort_moderators_by_usernames');
+				uasort($this->moderators[$fid], 'sort_moderators_by_usernames');
 			}
 		}
 
@@ -509,7 +516,7 @@
 					{
 						if(is_array($forum_mods))
 						{
-							$forum_mods = array_merge($forum_mods, $this->moderators[$forum['fid']]);
+							$forum_mods = $forum_mods + $this->moderators[$forum['fid']];
 						}
 						else
 						{
@@ -696,7 +703,7 @@
 	{
 		global $db;
 		$spiders = array();
-		$query = $db->simple_select("spiders", "sid,name,useragent", "", array("order_by" => "LENGTH(useragent)", "order_dir" => "DESC"));
+		$query = $db->simple_select("spiders", "sid, name, useragent, usergroup", "", array("order_by" => "LENGTH(useragent)", "order_dir" => "DESC")); 
 		while($spider = $db->fetch_array($query))
 		{
 			$spiders[$spider['sid']] = $spider;
@@ -743,7 +750,7 @@
 		$query = $db->simple_select("banned");
 		while($ban = $db->fetch_array($query))
 		{
-			$bans[] = $ban;
+			$bans[$ban['uid']] = $ban;
 		}
 		
 		$this->update("banned", $bans);
diff -rub mybb_1400/inc/class_error.php mybb_1408/inc/class_error.php
--- mybb_1400/inc/class_error.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/class_error.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_error.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: class_error.php 4271 2008-11-16 06:20:15Z Tikitiki $
  */
  
 // Set to 1 if recieving a blank page (template failure).
@@ -125,7 +125,14 @@
 
 		$this->has_errors = true;
 		
-		if(($mybb->settings['errortypemedium'] == "both" || !$mybb->settings['errortypemedium']) || my_strpos(my_strtolower($this->error_types[$type]), $mybb->settings['errortypemedium']))
+		// For some reason in the installer this setting is set to "<"
+		$accepted_error_types = array('both', 'error', 'warning');
+		if(!in_array($mybb->settings['errortypemedium'], $accepted_error_types))
+		{
+			$mybb->settings['errortypemedium'] = "both";
+		}
+		
+		if(($mybb->settings['errortypemedium'] == "both" || !$mybb->settings['errortypemedium']) || my_strpos(my_strtolower($this->error_types[$type]), $mybb->settings['errortypemedium']) || defined("IN_INSTALL") || defined("IN_UPGRADE"))
 		{
 			if(defined("IN_TASK"))
 			{
@@ -138,7 +145,7 @@
 					$filestr = " - Line: $line - File: $file";
 				}
 				
-				add_task_log($task['id'], "{$this->error_types[$type]} - [$type] ".var_export($message, true)."{$filestr}");
+				add_task_log($task, "{$this->error_types[$type]} - [$type] ".var_export($message, true)."{$filestr}");
 			}
 			
 			// Saving error to log file.
@@ -449,6 +456,7 @@
 		if(!headers_sent())
 		{
 			@header("Content-type: text/html; charset={$charset}");
+			$_SERVER['PHP_SELF'] = htmlspecialchars_uni($_SERVER['PHP_SELF']);
 
 		echo <<<EOF
 	<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
diff -rub mybb_1400/inc/class_feedgeneration.php mybb_1408/inc/class_feedgeneration.php
--- mybb_1400/inc/class_feedgeneration.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/class_feedgeneration.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_feedgeneration.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: class_feedgeneration.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class FeedGenerator
diff -rub mybb_1400/inc/class_feedparser.php mybb_1408/inc/class_feedparser.php
--- mybb_1400/inc/class_feedparser.php	2008-06-01 21:39:47.000000000 +0200
+++ mybb_1408/inc/class_feedparser.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/eula.html
  *
- * $Id: class_feedparser.php 3880 2008-06-01 19:39:47Z Tikitiki $
+ * $Id: class_feedparser.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class FeedParser
diff -rub mybb_1400/inc/class_language.php mybb_1408/inc/class_language.php
--- mybb_1400/inc/class_language.php	2008-07-26 05:21:29.000000000 +0200
+++ mybb_1408/inc/class_language.php	2009-06-26 07:27:01.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_language.php 4047 2008-07-26 03:21:29Z ZiNgaBuRgA $
+ * $Id: class_language.php 4365 2009-05-04 02:59:54Z Tikitiki $
  */
 
 class MyLanguage
@@ -91,7 +91,7 @@
 		$this->settings = $langinfo;
 
 		// Load the admin language files as well, if needed.
-		if($area == "admin" || $area == "admin.old") // temporary: "|| $area == "admin.old""
+		if($area == "admin")
 		{
 			if(!is_dir($this->path."/".$language."/{$area}"))
 			{
@@ -129,16 +129,17 @@
 		if($isdatahandler === true)
 		{
 			$this->language = str_replace('/admin', '', $this->language);
-			$lfile = $this->path."/".$this->language."/".$section.".lang.php";
 		}
-		else
-		{
 			$lfile = $this->path."/".$this->language."/".$section.".lang.php";
-		}
+		
 		if(file_exists($lfile))
 		{
 			require_once $lfile;
 		}
+		elseif(file_exists($this->path."/english/".$section.".lang.php"))
+		{
+			require_once $this->path."/english/".$section.".lang.php";
+		}
 		else
 		{
 			if($supress_error != true)
@@ -147,11 +148,14 @@
 			}
 		}
 		
+		// We must unite and protect our language variables!
+		$lang_keys_ignore = array('language', 'path', 'settings');
+		
 		if(is_array($l))
 		{
 			foreach($l as $key => $val)
 			{
-				if(empty($this->$key) || $this->$key != $val)
+				if((empty($this->$key) || $this->$key != $val) && !in_array($key, $lang_keys_ignore))
 				{
 					$this->$key = $val;
 				}
diff -rub mybb_1400/inc/class_mailhandler.php mybb_1408/inc/class_mailhandler.php
--- mybb_1400/inc/class_mailhandler.php	2008-05-20 16:08:16.000000000 +0200
+++ mybb_1408/inc/class_mailhandler.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_mailhandler.php 3855 2008-05-20 14:08:16Z Tikitiki $
+ * $Id: class_mailhandler.php 4324 2009-03-05 21:23:18Z Tikitiki $
  */
 
 /**
@@ -36,6 +36,13 @@
 	var $from;
 
 	/**
+	 * Who the email should return to.
+	 *
+	 * @var string
+	 */
+	var $return_email;
+
+	/**
 	 * The subject of mail.
 	 *
 	 * @var string
@@ -43,6 +50,13 @@
 	var $subject;
 
 	/**
+	 * The unaltered subject of mail.
+	 *
+	 * @var string
+	 */
+	var $orig_subject;
+
+	/**
 	 * The message of the mail.
 	 *
 	 * @var string
@@ -90,20 +104,32 @@
 	 * @param string headers of email.
 	 * @param string format of the email (HTML, plain text, or both?).
 	 * @param string plain text version of the email.
+	 * @param string the return email address.
 	 */
-	function build_message($to, $subject, $message, $from="", $charset="", $headers="", $format="text", $message_text="")
+	function build_message($to, $subject, $message, $from="", $charset="", $headers="", $format="text", $message_text="", $return_email="")
 	{
 		global $parser, $lang, $mybb;
 		
-		$this->headers = preg_replace("#(\r\n|\r|\n)#s", $this->delimiter, $this->headers);
-		$this->message = preg_replace("#(\r\n|\r|\n)#s", $this->delimiter, $this->message);
-
+		$this->message = '';
 		$this->headers = $headers;
 
 		if($from)
 		{
 			$this->from = $from;
 		}
+		else
+		{
+			$this->from = "";
+		}
+		
+		if($return_email)
+		{
+			$this->return_email = $return_email;
+		}
+		else
+		{
+			$this->return_email = "";
+		}
 
 		$this->set_to($to);
 		$this->set_subject($subject);
@@ -161,7 +187,8 @@
 	 */
 	function set_subject($subject)
 	{
-		$this->subject = $this->cleanup($subject);
+		$this->orig_subject = $this->cleanup($subject);
+		$this->subject = $this->utf8_encode($this->orig_subject);
 	}
 
 	/**
@@ -191,11 +218,13 @@
 	 */
 	function set_html_headers($message, $message_text="")
 	{
-		if(!$message_text)
+		if(!$message_text && $this->parse_format == 'both')
 		{
 			$message_text = strip_tags($message);
 		}
 		
+		if($this->parse_format == 'both')
+		{
 		$mime_boundary = "=_NextPart".md5(TIME_NOW);
 
 		$this->headers .= "Content-Type: multipart/alternative; boundary=\"{$mime_boundary}\"{$this->delimiter}";
@@ -206,13 +235,21 @@
 		$this->message .= "Content-Transfer-Encoding: 8bit{$this->delimiter}{$this->delimiter}";
 		$this->message .= $message_text."{$this->delimiter}{$this->delimiter}";
 		
-		$this->message .= "--{$mime_boundary}{$this->delimiter}{$this->delimiter}";
+			$this->message .= "--{$mime_boundary}{$this->delimiter}";
+
 		$this->message .= "Content-Type: text/html; charset=\"{$this->charset}\"{$this->delimiter}";
 		$this->message .= "Content-Transfer-Encoding: 8bit{$this->delimiter}{$this->delimiter}";
 		$this->message .= $message."{$this->delimiter}{$this->delimiter}";
 		
 		$this->message .= "--{$mime_boundary}--{$this->delimiter}{$this->delimiter}";
 	}
+		else
+		{
+			$this->headers .= "Content-Type: text/html; charset=\"{$this->charset}\"{$this->delimiter}";
+			$this->headers .= "Content-Transfer-Encoding: 8bit{$this->delimiter}{$this->delimiter}";
+			$this->message = $message."{$this->delimiter}{$this->delimiter}";
+		}
+	}
 
 	/**
 	 * Sets the common headers.
@@ -224,12 +261,25 @@
 		// Build mail headers
 		if(!trim($this->from))
 		{
-			$this->from = "\"{$mybb->settings['bbname']}\" <{$mybb->settings['adminemail']}>";
+			if($mybb->settings['mail_handler'] == 'smtp')
+			{
+				$this->from = $mybb->settings['adminemail'];
+			}
+			else
+			{
+				$this->from = '"'.$this->utf8_encode($mybb->settings['bbname']).'"';
+				$this->from .= " <{$mybb->settings['adminemail']}>";
+			}
 		}
 
 		$this->headers .= "From: {$this->from}{$this->delimiter}";
 		
-		if($mybb->settings['returnemail'])
+		if($this->return_email)
+		{
+			$this->headers .= "Return-Path: {$this->return_email}{$this->delimiter}";
+			$this->headers .= "Reply-To: {$this->return_email}{$this->delimiter}";
+		}
+		elseif($mybb->settings['returnemail'])
 		{
 			$this->headers .= "Return-Path: {$mybb->settings['returnemail']}{$this->delimiter}";
 			$this->headers .= "Reply-To: {$mybb->settings['adminemail']}{$this->delimiter}";
@@ -264,7 +314,7 @@
 		{
 			$_SERVER['PHP_SELF'] = str_replace($mybb->config['admin_dir']."/", "admin-", $_SERVER['PHP_SELF']);
 		}
-		$this->headers .= "X-MyBB-Script: {$http_host}{$_SERVER['PHP_SELF']}{$this->delimeter}";
+		$this->headers .= "X-MyBB-Script: {$http_host}{$_SERVER['PHP_SELF']}{$this->delimiter}";
 		$this->headers .= "MIME-Version: 1.0{$this->delimiter}";
 	}
 	
@@ -279,7 +329,7 @@
 		global $db;
 		
 		$mail_error = array(
-			"subject" => $db->escape_string($this->subject),
+			"subject" => $db->escape_string($this->orig_subject),
 			"message" => $db->escape_string($this->message),
 			"toaddress" => $db->escape_string($this->to),
 			"fromaddress" => $db->escape_string($this->from),
@@ -305,5 +355,42 @@
 		$string = trim($string);
 		return $string;
 	}
+	
+	/**
+	 * Encode a string based on the character set enabled. Used to encode subjects
+	 * and recipients in email messages going out so that they show up correctly
+	 * in email clients.
+	 *
+	 * @param string The string to be encoded.
+	 * @return string The encoded string.
+	 */
+	function utf8_encode($string)
+	{
+		if(strtolower($this->charset) == 'utf-8' && preg_match('/[^\x20-\x7E]/', $string))
+		{
+			$chunk_size = 47; // Derived from floor((75 - strlen("=?UTF-8?B??=")) * 0.75);
+			$len = strlen($string);
+			$output = '';
+			$pos = 0;
+
+            while($pos < $len)
+			{
+				$newpos = min($pos + $chunk_size, $len);
+
+				while(ord($string[$newpos]) >= 0x80 && ord($string[$newpos]) < 0xC0)
+				{
+					// Reduce len until it's safe to split UTF-8.
+					$newpos--;
+				}
+
+				$chunk = substr($string, $pos, $newpos - $pos);
+				$pos = $newpos;
+
+				$output .= " =?UTF-8?B?".base64_encode($chunk)."?=\n";
+			}
+			return trim($output);
+		}
+		return $string;
+	} 
 }
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/class_moderation.php mybb_1408/inc/class_moderation.php
--- mybb_1400/inc/class_moderation.php	2008-07-25 22:13:08.000000000 +0200
+++ mybb_1408/inc/class_moderation.php	2009-06-26 07:27:03.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_moderation.php 4041 2008-07-25 20:13:08Z Tikitiki $
+ * $Id: class_moderation.php 4368 2009-05-08 10:30:37Z Tomm $
  */
 
 class Moderation
@@ -27,7 +27,7 @@
 		}
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		$plugins->run_hooks("class_moderation_close_threads", $tids);
 
@@ -36,7 +36,7 @@
 		$openthread = array(
 			"closed" => 1,
 		);
-		$db->update_query("threads", $openthread, "tid IN ($tid_list)");
+		$db->update_query("threads", $openthread, "tid IN ($tid_list) AND closed NOT LIKE 'moved|%'");
 
 		return true;
 	}
@@ -58,7 +58,7 @@
 		}
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		$plugins->run_hooks("class_moderation_open_threads", $tids);
 
@@ -88,7 +88,7 @@
 		}
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		$plugins->run_hooks("class_moderation_stick_threads", $tids);
 
@@ -118,7 +118,7 @@
 		}
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		$plugins->run_hooks("class_moderation_unstick_threads", $tids);
 
@@ -311,7 +311,7 @@
 		}
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		foreach($tids as $tid)
 		{
@@ -342,11 +342,18 @@
 
 		if(is_array($tid_list))
 		{
+			$tid_moved_list = "";
+			$comma = "";
+			foreach($tid_list as $tid)
+			{
+				$tid_moved_list .= "{$comma}'moved|{$tid}'";
+				$comma = ",";
+			}
 			$tid_list = implode(',', $tid_list);
 			$approve = array(
 				"visible" => 1
 			);
-			$db->update_query("threads", $approve, "tid IN ($tid_list)");
+			$db->update_query("threads", $approve, "tid IN ($tid_list) OR closed IN ({$tid_moved_list})");
 			$db->update_query("posts", $approve, "pid IN (".implode(',', $posts_to_approve).")");
 
 			$plugins->run_hooks("class_moderation_approve_threads", $tids);
@@ -385,9 +392,16 @@
 		}
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		$tid_list = implode(',', $tids);
+		$tid_moved_list = "";
+		$comma = "";
+		foreach($tids as $tid)
+		{
+			$tid_moved_list .= "{$comma}'moved|{$tid}'";
+			$comma = ",";
+		}
 
 		foreach($tids as $tid)
 		{
@@ -415,7 +429,7 @@
 		$approve = array(
 			"visible" => 0
 		);
-		$db->update_query("threads", $approve, "tid IN ($tid_list)");
+		$db->update_query("threads", $approve, "tid IN ($tid_list) OR closed IN ({$tid_moved_list})");
 		$db->update_query("posts", $approve, "pid IN (".implode(',', $posts_to_unapprove).")");
 
 		$plugins->run_hooks("class_moderation_unapprove_threads", $tids);
@@ -474,7 +488,7 @@
 		// Update unapproved post count
 		if($post['visible'] == 0)
 		{
-			--$num_unaproved_posts;
+			++$num_unapproved_posts;
 		}
 		else
 		{
@@ -514,7 +528,7 @@
 		global $db, $plugins;
 
 		// Make sure we only have valid values
-		array_walk($pids, 'intval');
+		$pids = array_map('intval', $pids);
 		$tid = intval($tid);
 
 		$pidin = implode(',', $pids);
@@ -589,7 +603,7 @@
 		$query = $db->simple_select("posts", "pid", "tid = '{$post['tid']}'", array('order_by' => 'dateline', 'order_dir' => 'desc', 'limit' => '1'));
 		$lastpostpid = $db->fetch_field($query, 'pid');
 		
-		$query2 = $db->simple_select("attachments", "COUNT(aid) as count", "pid IN({$pidin}) AND pid != '{$masterpid}' AND visible='1'");
+		$query2 = $db->simple_select("attachments", "COUNT(aid) as count", "pid IN({$pidin}) AND visible='1'");
 		$attachment_count = $db->fetch_field($query2, "count");
 		
 		$db->update_query("threads", array("attachmentcount" => $attachment_count), "tid = '{$mastertid}'");
@@ -672,6 +686,7 @@
 				if($thread['visible'] == 1)
 				{
 					$num_threads++;
+					$num_posts = $thread['replies']+1;
 				}
 				else
 				{
@@ -680,7 +695,6 @@
  					$num_unapproved_posts = $thread['replies']+1;
 				}
 
-				$num_posts = $thread['replies']+1;
 				$num_unapproved_posts += $thread['unapprovedposts'];
 
 				$db->delete_query("threads", "closed='moved|$tid' AND fid='$new_fid'");
@@ -711,6 +725,13 @@
 				{
 					$this->expire_thread($redirect_tid, $redirect_expire);
 				}
+				
+				// If we're moving back to a forum where we left a redirect, delete the rediect
+				$query = $db->simple_select("threads", "tid", "closed LIKE 'moved|".intval($tid)."' AND fid='".intval($new_fid)."'");
+				while($movedthread = $db->fetch_array($query))
+				{
+					$db->delete_query("threads", "tid='".intval($movedthread['tid'])."'", 1);
+				}
  				break;
 			case "copy":// copy thread
 
@@ -850,6 +871,7 @@
 				if($thread['visible'] == 1)
 				{
 					$num_threads++;
+					$num_posts = $thread['replies']+1;
 				}
 				else
 				{
@@ -858,7 +880,6 @@
  					$num_unapproved_posts = $thread['replies']+1;
 				}
 
-				$num_posts = $thread['replies']+1;
 				$num_unapproved_posts = $thread['unapprovedposts'];
 
 				$sqlarray = array(
@@ -866,6 +887,13 @@
 				);
 				$db->update_query("threads", $sqlarray, "tid='$tid'");
 				$db->update_query("posts", $sqlarray, "tid='$tid'");
+				
+				// If we're moving back to a forum where we left a redirect, delete the rediect
+				$query = $db->simple_select("threads", "tid", "closed LIKE 'moved|".intval($tid)."' AND fid='".intval($new_fid)."'");
+				while($movedthread = $db->fetch_array($query))
+				{
+					$db->delete_query("threads", "tid='".intval($movedthread['tid'])."'", 1);
+				}
 				break;
 		}
 
@@ -998,14 +1026,15 @@
 		$db->update_query("threadsubscriptions", $sqlarray, "tid='{$mergetid}'");
 		update_first_post($tid);
 
-		$arguments = array("mergetid" => $tid, "tid" => $tid, "subject" => $subject);
+		$arguments = array("mergetid" => $mergetid, "tid" => $tid, "subject" => $subject);
 		$plugins->run_hooks("class_moderation_merge_threads", $arguments);
 
 		$this->delete_thread($mergetid);
 
 		$updated_stats = array(
 			"replies" => '+'.($mergethread['replies']+1),
-			"unapprovedposts" => "+{$mergethread['unapprovedposts']}"
+			"unapprovedposts" => "+{$mergethread['unapprovedposts']}",
+			"attachmentcount" => "+{$mergethread['attachmentcount']}",
 		);
 		update_thread_counters($tid, $updated_stats);
 
@@ -1059,7 +1088,7 @@
 		}
 
 		// Make sure we only have valid values
-		array_walk($pids, 'intval');
+		$pids = array_map('intval', $pids);
 
 		$pids_list = implode(',', $pids);
 
@@ -1303,7 +1332,7 @@
 		global $db, $plugins;
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		$tid_list = implode(',', $tids);
 
@@ -1419,7 +1448,7 @@
 		$num_posts = 0;
 
 		// Make sure we only have valid values
-		array_walk($pids, 'intval');
+		$pids = array_map('intval', $pids);
 
 		$pid_list = implode(',', $pids);
 		$pids = $threads_to_update = array();
@@ -1525,7 +1554,7 @@
 		global $db, $cache;
 
 		// Make sure we only have valid values
-		array_walk($pids, 'intval');
+		$pids = array_map('intval', $pids);
 
 		$pid_list = implode(',', $pids);
 		$pids = $threads_to_update = array();
@@ -1640,7 +1669,7 @@
 
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		$tid_list = implode(',', $tids);
 
@@ -1701,7 +1730,7 @@
 		global $db;
 
 		// Make sure we only have valid values
-		array_walk($pids, 'intval');
+		$pids = array_map('intval', $pids);
 
 		$pid_list = implode(',', $pids);
 		$query = $db->simple_select("posts", 'pid, visible', "pid IN ($pid_list)");
@@ -1739,7 +1768,7 @@
 		global $db;
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 		$fid = intval($fid);
 
 		$tid_list = implode(',', $tids);
@@ -1777,7 +1806,7 @@
 		global $db;
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 
 		$tid_list = implode(',', $tids);
 		$query = $db->simple_select("threads", 'tid, closed', "tid IN ($tid_list)");
@@ -1822,7 +1851,7 @@
 		}
 
 		// Make sure we only have valid values
-		array_walk($tids, 'intval');
+		$tids = array_map('intval', $tids);
 		$fid = intval($fid);
 
 		$tids_csv = implode(',', $tids);
diff -rub mybb_1400/inc/class_parser.php mybb_1408/inc/class_parser.php
--- mybb_1400/inc/class_parser.php	2008-07-29 17:45:49.000000000 +0200
+++ mybb_1408/inc/class_parser.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_parser.php 4052 2008-07-29 15:45:49Z Tikitiki $
+ * $Id: class_parser.php 4322 2009-02-21 23:00:49Z Tikitiki $
  */
 
 /*
@@ -232,16 +232,16 @@
 		$standard_mycode['reg']['regex'] = "#\(r\)#i";
 		$standard_mycode['reg']['replacement'] = "&reg;";
 
-		$standard_mycode['url_simple']['regex'] = "#\[url\]([a-z]+?://)([^\r\n\"\[<]+?)\[/url\]#sei";
+		$standard_mycode['url_simple']['regex'] = "#\[url\]([a-z]+?://)([^\r\n\"<]+?)\[/url\]#sei";
 		$standard_mycode['url_simple']['replacement'] = "\$this->mycode_parse_url(\"$1$2\")";
 
-		$standard_mycode['url_simple2']['regex'] = "#\[url\]([^\r\n\"\[<]+?)\[/url\]#ei";
+		$standard_mycode['url_simple2']['regex'] = "#\[url\]([^\r\n\"<]+?)\[/url\]#ei";
 		$standard_mycode['url_simple2']['replacement'] = "\$this->mycode_parse_url(\"$1\")";
 
-		$standard_mycode['url_complex']['regex'] = "#\[url=([a-z]+?://)([^\r\n\"\[<]+?)\](.+?)\[/url\]#esi";
+		$standard_mycode['url_complex']['regex'] = "#\[url=([a-z]+?://)([^\r\n\"<]+?)\](.+?)\[/url\]#esi";
 		$standard_mycode['url_complex']['replacement'] = "\$this->mycode_parse_url(\"$1$2\", \"$3\")";
 
-		$standard_mycode['url_complex2']['regex'] = "#\[url=([^\r\n\"\[<&\(\)]+?)\](.+?)\[/url\]#esi";
+		$standard_mycode['url_complex2']['regex'] = "#\[url=([^\r\n\"<&\(\)]+?)\](.+?)\[/url\]#esi";
 		$standard_mycode['url_complex2']['replacement'] = "\$this->mycode_parse_url(\"$1\", \"$2\")";
 
 		$standard_mycode['email_simple']['regex'] = "#\[email\](.*?)\[/email\]#ei";
@@ -275,6 +275,7 @@
 		{
 			foreach($custom_mycode as $key => $mycode)
 			{
+				$mycode['regex'] = str_replace("\x0", "", $mycode['regex']);
 				$custom_mycode[$key]['regex'] = "#".$mycode['regex']."#si";
 			}
 			$mycode = array_merge($standard_mycode, $custom_mycode);
@@ -392,9 +393,25 @@
 			foreach($this->smilies_cache as $find => $replace)
 			{
 				$find = $this->parse_html($find);
+				$find = preg_quote($find, "#");
+				
 				if(version_compare(PHP_VERSION, "5.1.0", ">="))
 				{
-					$message = preg_replace("#(?<=[^&;\"])".preg_quote($find,"#")."(?=.\W|\"|\W.|\W$)#si", $replace, $message, $remaining, $replacements);
+					$orig_message = $message;
+					$orig_find = $find;
+					// Fix issues for smileys starting with a ";"
+					if($find{0} == ";")
+					{
+						$find = "(?<!&gt|&lt|&amp)".$find;
+					}
+				
+					$message = @preg_replace("#(?<=[^\"])".$find."(?=.\W|\"|\W.|\W$)#si", $replace, $message, $remaining, $replacements);
+				
+					if($message == null)
+					{
+						$message = preg_replace("#(?<=[^&;\"])".$orig_find."(?=.\W|\"|\W.|\W$)#si", $replace, $orig_message, $remaining);
+					}
+					
 					$remaining -= $replacements;
 					if($remaining <= 0)
 					{
@@ -403,9 +420,10 @@
 				}
 				else
 				{
-					$message = preg_replace("#(?<=[^&;\"])".preg_quote($find,"#")."(?=.\W|\"|\W.|\W$)#si", $replace, $message, $remaining);
+					$message = preg_replace("#(?<=[^&;\"])".$find."(?=.\W|\"|\W.|\W$)#si", $replace, $message, $remaining);
 				}
 			}
+			unset($orig_message, $orig_find);
 		}
 
 		// If we matched any tags previously, swap them back in
@@ -491,7 +509,8 @@
 			"#(o)(nunload\s?=)#i",
 			"#(o)(nkeypress\s?=)#i"
 		);
-		$message = preg_replace($js_array, "$1<strong></strong>$2", $message);
+		
+		$message = preg_replace($js_array, "$1<strong></strong>$2$4", $message);
 
 		return $message;
 	}
@@ -810,6 +829,7 @@
 		$url = str_replace('&amp;', '&', $url);
 		$name = str_replace('&amp;', '&', $name);
 
+
 		if(!preg_match("#[a-z0-9]+://#i", $fullurl))
 		{
 			$fullurl = "http://".$fullurl;
@@ -831,6 +851,9 @@
 			}
 		}
 
+		// fix some entities in URLs
+		$fullurl = strtr($fullurl, array('$' => '%24', '^' => '%5E', '`' => '%60', '[' => '%5B', ']' => '%5D', '{' => '%7B', '}' => '%7D', '"' => '%22', '<' => '%3C', '>' => '%3E', ' ' => '%20'));
+
 		$name = preg_replace("#&amp;\#([0-9]+);#si", "&#$1;", $name); // Fix & but allow unicode
 		$link = "<a href=\"$fullurl\" target=\"_blank\">$name</a>";
 		return $link;
@@ -881,6 +904,8 @@
 	*/
 	function mycode_parse_email($email, $name="")
 	{
+		$name = str_replace("\\'", "'", $name);
+		$email = str_replace("\\'", "'", $email);
 		if(!$name)
 		{
 			$name = $email;
@@ -903,9 +928,24 @@
 	*/
 	function mycode_auto_url($message)
 	{
+		static $utf8_pcre_supported;
+	    if(!isset($utf8_pcre_supported))
+	    {
+	        $utf8_pcre_supported = @preg_match('#^.#u', 'a');
+	    }
+	        
+	    if($utf8_pcre_supported)
+	    {
+	        $utf8_regex_chr = "u";
+	    }
+	    else
+	    {
+	        $utf8_regex_chr = "";
+	    }
+	        
 		$message = " ".$message;
-		$message = preg_replace("#([\>\s\(\)])(https?|ftp|news){1}://([\w\-]+\.([\w\-]+\.)*[\w]+(:[0-9]+)?(/[^\"\s<\[]*)?)#i", "$1[url]$2://$3[/url]", $message);
-		$message = preg_replace("#([\>\s\(\)])(www|ftp)\.(([\w\-]+\.)*[\w]+(:[0-9]+)?(/[^\"\s<\[]*)?)#i", "$1[url]$2.$3[/url]", $message);
+	    $message = preg_replace("#([\>\s\(\)])(https?|ftp|news){1}://([\w\-]+\.([\w\-]+\.)*[\w]+(:[0-9]+)?(/[^\"\s<\[]*)?)#i".$utf8_regex_chr, "$1[url]$2://$3[/url]", $message);
+	    $message = preg_replace("#([\>\s\(\)])(www|ftp)\.(([\w\-]+\.)*[\w]+(:[0-9]+)?(/[^\"\s<\[]*)?)#i".$utf8_regex_chr, "$1[url]$2.$3[/url]", $message);
 		$message = my_substr($message, 1);
 		return $message;
 	}
diff -rub mybb_1400/inc/class_plugins.php mybb_1408/inc/class_plugins.php
--- mybb_1400/inc/class_plugins.php	2008-06-24 01:43:05.000000000 +0200
+++ mybb_1408/inc/class_plugins.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_plugins.php 3947 2008-06-23 23:43:05Z Tikitiki $
+ * $Id: class_plugins.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class pluginSystem
diff -rub mybb_1400/inc/class_session.php mybb_1408/inc/class_session.php
--- mybb_1400/inc/class_session.php	2008-07-23 09:30:14.000000000 +0200
+++ mybb_1408/inc/class_session.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_session.php 4035 2008-07-23 07:30:14Z chris $
+ * $Id: class_session.php 4346 2009-04-14 07:11:03Z Tikitiki $
  */
 
 class session
@@ -47,8 +47,6 @@
 			{
 				$this->sid = $session['sid'];
 				$this->uid = $session['uid'];
-				$this->logins = $session['loginattempts'];
-				$this->failedlogin = $session['failedlogin'];
 			}
 			else
 			{
@@ -139,6 +137,8 @@
 		");
 		$mybb->user = $db->fetch_array($query);
 		
+		$this->logins = $mybb->user['loginattempts'];
+		$this->failedlogin = $mybb->user['failedlogin'];
 		
 		if($bannedcache[$uid])
 		{
@@ -241,11 +241,15 @@
 			$mybb->settings['postsperpage'] = $mybb->user['ppp'];
 		}
 		
-		// DOes this user prefer posts in classic mode?
+		// Does this user prefer posts in classic mode?
 		if($mybb->user['classicpostbit'])
 		{
 			$mybb->settings['postlayout'] = 'classic';
 		}
+		else
+		{
+			$mybb->settings['postlayout'] = 'horizontal';
+		}
 
 		// Check if this user is currently banned and if we have to lift it.
 		if(!empty($mybb->user['bandate']) && (isset($mybb->user['banlifted']) && !empty($mybb->user['banlifted'])) && $mybb->user['banlifted'] < $time)  // hmmm...bad user... how did you get banned =/
@@ -487,18 +491,18 @@
 		// If there is a proper uid, delete by uid.
 		if($uid > 0)
 		{
-			$db->delete_query("sessions", "uid='{$uid}'", 1);
+			$db->delete_query("sessions", "uid='{$uid}'");
 			$onlinedata['uid'] = $uid;
 		}
 		// Is a spider - delete all other spider references
 		else if($this->is_spider == true)
 		{
-			$db->delete_query("sessions", "sid='{$this->sid}'", 1);
+			$db->delete_query("sessions", "sid='{$this->sid}'");
 		}
 		// Else delete by ip.
 		else
 		{
-			$db->delete_query("sessions", "ip='".$db->escape_string($this->ipaddress)."'", 1);
+			$db->delete_query("sessions", "ip='".$db->escape_string($this->ipaddress)."'");
 			$onlinedata['uid'] = 0;
 		}
 
@@ -518,7 +522,7 @@
 		$onlinedata['location1'] = intval($speciallocs['1']);
 		$onlinedata['location2'] = intval($speciallocs['2']);
 		$onlinedata['nopermission'] = 0;
-		$db->insert_query("sessions", $onlinedata);
+		$db->replace_query("sessions", $onlinedata, "sid", false);
 		$this->sid = $onlinedata['sid'];
 		$this->uid = $onlinedata['uid'];
 	}
diff -rub mybb_1400/inc/class_templates.php mybb_1408/inc/class_templates.php
--- mybb_1400/inc/class_templates.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/class_templates.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_templates.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: class_templates.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class templates
diff -rub mybb_1400/inc/class_timers.php mybb_1408/inc/class_timers.php
--- mybb_1400/inc/class_timers.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/class_timers.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_timers.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: class_timers.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class timer {
diff -rub mybb_1400/inc/class_xml.php mybb_1408/inc/class_xml.php
--- mybb_1400/inc/class_xml.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/class_xml.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: class_xml.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: class_xml.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/inc/datahandler.php mybb_1408/inc/datahandler.php
--- mybb_1400/inc/datahandler.php	2008-08-02 05:19:04.000000000 +0200
+++ mybb_1408/inc/datahandler.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: datahandler.php 4057 2008-08-02 03:19:04Z Tikitiki $
+ * $Id: datahandler.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/inc/datahandlers/event.php mybb_1408/inc/datahandlers/event.php
--- mybb_1400/inc/datahandlers/event.php	2008-07-24 13:56:23.000000000 +0200
+++ mybb_1408/inc/datahandlers/event.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: event.php 4037 2008-07-24 11:56:23Z ZiNgaBuRgA $
+ * $Id: event.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/inc/datahandlers/pm.php mybb_1408/inc/datahandlers/pm.php
--- mybb_1400/inc/datahandlers/pm.php	2008-06-01 17:48:47.000000000 +0200
+++ mybb_1408/inc/datahandlers/pm.php	2009-06-26 07:27:17.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: pm.php 3879 2008-06-01 15:48:47Z Tikitiki $
+ * $Id: pm.php 4372 2009-05-15 16:13:13Z Tomm $
  */
 
 // Disallow direct access to this file for security reasons
@@ -205,7 +205,7 @@
 						// Check that this recipient actually exists
 						$query = $db->simple_select("users", "*", "uid='".intval($uid)."'");
 						$user = $db->fetch_array($query);
-						if($recipient_type == "bcc")
+						if($recipient_type == "bccid")
 						{
 							$user['bcc'] = 1;
 						}
@@ -225,7 +225,7 @@
 		// If we have one or more invalid recipients and we're not saving a draft, error
 		if(count($invalid_recipients) > 0)
 		{
-			$invalid_recipients = implode(", ", $invalid_recipients);
+			$invalid_recipients = implode(", ", array_map("htmlspecialchars_uni", $invalid_recipients));
 			$this->set_error("invalid_recipients", array($invalid_recipients));
 			return false;
 		}
@@ -257,17 +257,17 @@
 						$this->set_error("recipient_is_ignoring", array($user['username']));
 					}
 				}
-			}
 	
 			// Can the recipient actually receive private messages based on their permissions or user setting?
-			if($user['receivepms'] == 0 || $recipient_permissions['canusepms'] == 0 && !$pm['saveasdraft'])
+				if(($user['receivepms'] == 0 || $recipient_permissions['canusepms'] == 0) && !$pm['saveasdraft'])
 			{
 				$this->set_error("recipient_pms_disabled", array($user['username']));
 				return false;
 			}
+			}
 	
 			// Check to see if the user has reached their private message quota - if they have, email them.
-			if($recipient_permissions['pmquota'] != "0" && $recipient['pms_total'] >= $recipient_permissions['pmquota'] && $recipient_permissions['cancp'] != 1 && $sender_permissions['cancp'] != 1 && !$pm['saveasdraft'] && !$this->admin_override)
+			if($recipient_permissions['pmquota'] != "0" && $user['totalpms'] >= $recipient_permissions['pmquota'] && $recipient_permissions['cancp'] != 1 && $sender_permissions['cancp'] != 1 && !$pm['saveasdraft'] && !$this->admin_override)
 			{
 				if(trim($user['language']) != '' && $lang->language_exists($user['language']))
 				{
@@ -326,6 +326,48 @@
 	}
 
 	/**
+	* Verify that the user is not flooding the system.
+	* Temporary fix until a better one can be made for 1.6
+	*
+	* @return boolean True
+	*/
+	function verify_pm_flooding()
+	{
+		global $mybb, $db;
+
+		$pm = &$this->data;
+		
+		// Check if post flooding is enabled within MyBB or if the admin override option is specified.
+		if($mybb->settings['postfloodcheck'] == 1 && $pm['fromid'] != 0 && $this->admin_override == false)
+		{
+			// Fetch the senders profile data.
+			$sender = get_user($pm['fromid']);
+			
+			// Calculate last post
+			$query = $db->simple_select("privatemessages", "dateline", "fromid='".$db->escape_string($pm['fromid'])."'", array('order_by' => 'dateline', 'order_dir' => 'desc', 'limit' => 1));
+			$sender['lastpm'] = $db->fetch_field($query, "dateline");
+
+			// A little bit of calculation magic and moderator status checking.
+			if(TIME_NOW-$sender['lastpm'] <= $mybb->settings['postfloodsecs'] && !is_moderator("", "", $pm['fromid']))
+			{
+				// Oops, user has been flooding - throw back error message.
+				$time_to_wait = ($mybb->settings['postfloodsecs'] - (TIME_NOW-$sender['lastpm'])) + 1;
+				if($time_to_wait == 1)
+				{
+					$this->set_error("pm_flooding_one_second");
+				}
+				else
+				{
+					$this->set_error("pm_flooding", array($time_to_wait));
+				}
+				return false;
+			}
+		}
+		// All is well that ends well - return true.
+		return true;
+	}
+
+	/**
 	 * Verifies if the various 'options' for sending PMs are valid.
 	 *
 	 * @return boolean True when valid, false when invalid.
@@ -427,10 +469,12 @@
 
 		$uid = 0;
 
-		if(!is_array($pm['recipients'])) {
+		if(!is_array($pm['recipients']))
+		{
 			$recipient_list = array();
 		}
-		else {
+		else
+		{
 			// Build recipient list
 			foreach($pm['recipients'] as $recipient)
 			{
@@ -448,7 +492,7 @@
 		$recipient_list = serialize($recipient_list);
 
 		$this->pm_insert_data = array(
-			'fromid' => $pm['sender']['uid'],
+			'fromid' => intval($pm['sender']['uid']),
 			'folder' => $pm['folder'],
 			'subject' => $db->escape_string($pm['subject']),
 			'icon' => intval($pm['icon']),
@@ -463,7 +507,7 @@
 		);
 
 		// Check if we're updating a draft or not.
-		$query = $db->simple_select("privatemessages", "pmid", "folder='3' AND uid='{$pm['sender']['uid']}' AND pmid='{$pm['pmid']}'");
+		$query = $db->simple_select("privatemessages", "pmid", "folder='3' AND uid='".intval($pm['sender']['uid'])."' AND pmid='{$pm['pmid']}'");
 		$draftcheck = $db->fetch_array($query);
 
 		// This PM was previously a draft
@@ -506,7 +550,7 @@
 				{
 					$uselang = "english";
 				}
-				if($uselang == $mybb->settings['bblanguage'])
+				if($uselang == $mybb->settings['bblanguage'] && !empty($lang->emailsubject_newpm))
 				{
 					$emailsubject = $lang->emailsubject_newpm;
 					$emailmessage = $lang->email_newpm;
@@ -514,12 +558,18 @@
 				else
 				{
 					$userlang = new MyLanguage;
-					$userlang->set_path("./inc/languages");
+					$userlang->set_path(MYBB_ROOT."inc/languages");
 					$userlang->set_language($uselang);
 					$userlang->load("messages");
 					$emailsubject = $userlang->emailsubject_newpm;
 					$emailmessage = $userlang->email_newpm;
 				}
+				
+				if(!$pm['sender']['username'])
+				{
+					$pm['sender']['username'] = 'MyBB Engine';
+				}
+				
 				$emailmessage = $lang->sprintf($emailmessage, $recipient['username'], $pm['sender']['username'], $mybb->settings['bbname'], $mybb->settings['bburl']);
 				$emailsubject = $lang->sprintf($emailsubject, $mybb->settings['bbname']);
 				my_mail($recipient['email'], $emailsubject, $emailmessage);
@@ -577,7 +627,7 @@
 			{
 				$this->pm_insert_data['toid'] = 0;
 			}
-			$this->pm_insert_data['uid'] = $pm['sender']['uid'];
+			$this->pm_insert_data['uid'] = intval($pm['sender']['uid']);
 			$this->pm_insert_data['folder'] = 2;
 			$this->pm_insert_data['status'] = 1;
 			$this->pm_insert_data['receipt'] = 0;
diff -rub mybb_1400/inc/datahandlers/post.php mybb_1408/inc/datahandlers/post.php
--- mybb_1400/inc/datahandlers/post.php	2008-07-24 13:35:12.000000000 +0200
+++ mybb_1408/inc/datahandlers/post.php	2009-06-26 07:27:19.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: post.php 4036 2008-07-24 11:35:12Z ZiNgaBuRgA $
+ * $Id: post.php 4372 2009-05-15 16:13:13Z Tomm $
  */
 
 // Disallow direct access to this file for security reasons
@@ -310,6 +310,12 @@
 		
 		$post = &$this->data;
 		
+		// Are we starting a new thread?
+		if(!$post['tid'])
+		{
+			return true;
+		}
+		
 		// Are we even turned on?
 		if(empty($mybb->settings['postmergemins']))
 		{
@@ -326,7 +332,7 @@
 		if(trim($mybb->settings['postmergeuignore']) != "")
 		{
 			$gids = explode(',', $mybb->settings['postmergeuignore']);
-			array_walk($gids, 'intval');
+			$gids = array_map('intval', $gids);
 			
 			
 			$user_usergroups = explode(',', $mybb->user['usergroup'].",".$mybb->user['additionalgroups']);
@@ -449,7 +455,7 @@
 		// Check if the post being replied to actually exists in this thread.
 		if($post['replyto'])
 		{
-			$query = $db->simple_select("posts", "pid", "pid='{$post['replyto']}'");
+			$query = $db->simple_select("posts", "pid", "pid='".intval($post['replyto'])."'");
 			$valid_post = $db->fetch_array($query);
 			if(!$valid_post['pid'])
 			{
@@ -854,9 +860,9 @@
 			// Fetch any users subscribed to this thread receiving instant notification and queue up their subscription notices
 			$query = $db->query("
 				SELECT u.username, u.email, u.uid, u.language, s.subscriptionkey
-				FROM ".TABLE_PREFIX."threadsubscriptions s, ".TABLE_PREFIX."users u
+				FROM ".TABLE_PREFIX."threadsubscriptions s
+				LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=s.uid)
 				WHERE s.notification='1' AND s.tid='{$post['tid']}'
-				AND u.uid=s.uid
 				AND s.uid != '{$post['uid']}'
 				AND u.lastactive>'{$thread['lastpost']}'
 			");
@@ -867,13 +873,20 @@
 					continue;
 				}
 				$done_users[$subscribedmember['uid']] = 1;
+				
+				$forumpermissions = forum_permissions($thread['fid'], $subscribedmember['uid']);
+				if($forumpermissions['canview'] == 0 || $forumpermissions['canviewthreads'] == 0)
+				{
+				    continue;
+				}
+				
 				if($subscribedmember['language'] != '' && $lang->language_exists($subscribedmember['language']))
 				{
 					$uselang = $subscribedmember['language'];
 				}
-				elseif($mybb->settings['bblanguage'])
+				elseif($mybb->settings['orig_bblanguage'])
 				{
-					$uselang = $mybb->settings['bblanguage'];
+					$uselang = $mybb->settings['orig_bblanguage'];
 				}
 				else
 				{
@@ -901,7 +914,7 @@
 					$emailmessage = $langcache[$uselang]['email_subscription'];
 				}
 				$emailsubject = $lang->sprintf($emailsubject, $subject);
-				$emailmessage = $lang->sprintf($emailmessage, $subscribedmember['username'], $post['username'], $mybb->settings['bbname'], $subject, $excerpt, $mybb->settings['bburl'], get_thread_link($thread['tid'], 0, "newpost"), $thread['tid'], $subscribedmember['subscriptionkey']);
+				$emailmessage = $lang->sprintf($emailmessage, $subscribedmember['username'], $post['username'], $mybb->settings['bbname'], $subject, $excerpt, $mybb->settings['bburl'], str_replace("&amp;", "&", get_thread_link($thread['tid'], 0, "newpost")), $thread['tid'], $subscribedmember['subscriptionkey']);
 				$new_email = array(
 					"mailto" => $db->escape_string($subscribedmember['email']),
 					"mailfrom" => '',
@@ -1239,6 +1252,8 @@
 					$forum['lastpost'] = 0;
 				}
 
+				$done_users = array();
+				
 				// Queue up any forum subscription notices to users who are subscribed to this forum.
 				$excerpt = my_substr($thread['message'], 0, $mybb->settings['subscribeexcerpt']).$lang->emailbit_viewthread;
 				
@@ -1264,6 +1279,13 @@
 						continue;
 					}
 					$done_users[$subscribedmember['uid']] = 1;
+					
+					$forumpermissions = forum_permissions($thread['fid'], $subscribedmember['uid']);
+					if($forumpermissions['canview'] == 0 || $forumpermissions['canviewthreads'] == 0)
+					{
+					    continue;
+					}
+					
 					// Determine the language pack we'll be using to send this email in and load it if it isn't already.
 					if($subscribedmember['language'] != '' && $lang->language_exists($subscribedmember['language']))
 					{
@@ -1331,23 +1353,23 @@
 		
 		if($visible == 1)
 		{
-			$query = $db->simple_select("attachments", "COUNT(aid) AS attachmentcount", "pid='{$this->pid}' AND visible='1'");
-			$attachmentcount = $db->fetch_field($query, "attachmentcount");
-			if($attachmentcount > 0)
-			{
-				update_thread_counters($this->tid, array("attachmentcount" => "+{$attachmentcount}"));
-			}
-
 			update_thread_data($this->tid);
 			update_forum_counters($thread['fid'], array("threads" => "+1", "posts" => "+1"));
 		}
 		else if($visible == 0)
 		{
 			update_thread_data($this->tid);
-			update_thread_counters($thread['tid'], array("replies" => 0, "unapprovedposts" => 1));
+			update_thread_counters($this->tid, array("replies" => 0, "unapprovedposts" => 1));
 			update_forum_counters($thread['fid'], array("unapprovedthreads" => "+1", "unapprovedposts" => "+1"));
 		}
 
+		$query = $db->simple_select("attachments", "COUNT(aid) AS attachmentcount", "pid='{$this->pid}' AND visible='1'");
+		$attachmentcount = $db->fetch_field($query, "attachmentcount");
+		if($attachmentcount > 0)
+		{
+			update_thread_counters($this->tid, array("attachmentcount" => "+{$attachmentcount}"));
+		}
+
 		// Return the post's pid and whether or not it is visible.
 		return array(
 			"pid" => $this->pid,
@@ -1385,6 +1407,8 @@
 		$forum = get_forum($post['fid']);
 
 		// Decide on the visibility of this post.
+		if(isset($post['visible']) && $post['visible'] != $existing_post['visible'])
+        {
 		if($forum['mod_edit_posts'] == 1 && !is_moderator($post['fid'], "", $post['uid']))
 		{
 			if($existing_post['visible'] == 1)
@@ -1418,6 +1442,15 @@
 			}
 			$visible = 1;
 		}
+        }
+        else
+        {
+			$visible = 0;
+			if($forum['mod_edit_posts'] != 1 || is_moderator($post['fid'], "", $post['uid']))
+			{
+				$visible = 1;
+			}
+        }
 
 		// Check if this is the first post in a thread.
 		$options = array(
@@ -1437,14 +1470,14 @@
 			$first_post = false;
 		}
 		
-		// Update the thread details that might have been changed first.
-		if($first_post)
-		{
 			if($existing_post['visible'] == 0)
 			{
 				$visible = 0;
 			}
 			
+		// Update the thread details that might have been changed first.
+		if($first_post)
+		{			
 			$this->tid = $post['tid'];
 
 			$this->thread_update_data['visible'] = $visible;
@@ -1526,7 +1559,7 @@
 		}
 		else
 		{
-			$db->delete_query("threadsubscriptions", "uid='{$post['uid']}' AND tid='{$post['tid']}'");
+			$db->delete_query("threadsubscriptions", "uid='".intval($post['uid'])."' AND tid='".intval($post['tid'])."'");
 		}
 
 		update_forum_lastpost($post['fid']);
diff -rub mybb_1400/inc/datahandlers/user.php mybb_1408/inc/datahandlers/user.php
--- mybb_1400/inc/datahandlers/user.php	2008-07-29 17:45:49.000000000 +0200
+++ mybb_1408/inc/datahandlers/user.php	2009-06-26 07:27:21.000000000 +0200
@@ -1,12 +1,12 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: user.php 4052 2008-07-29 15:45:49Z Tikitiki $
+ * $Id: user.php 4384 2009-06-19 11:49:42Z Tomm $
  */
 
 // Disallow direct access to this file for security reasons
@@ -220,6 +220,7 @@
 		$user = &$this->data;
 		return true;
 	}
+	
 	/**
 	* Verifies if an email address is valid or not.
 	*
@@ -253,7 +254,8 @@
 		}
 		
 		// Check signed up emails
-		if($mybb->settings['allowmultipleemails'] == 0)
+		// Ignore the ACP because the Merge System sometimes produces users with duplicate email addresses (Not A Bug)
+		if($mybb->settings['allowmultipleemails'] == 0 && !defined("IN_ADMINCP"))
 		{
 			if(email_already_in_use($user['email'], $user['uid']))
 			{
@@ -353,8 +355,6 @@
 		$birthday['year'] = intval($birthday['year']);
 
 		// Error if a day and month exists, and the birthday day and range is not in range
-		if($birthday['day'] && $birthday['month'])
-		{
 			if($birthday['day'] < 1 || $birthday['day'] > 31 || $birthday['month'] < 1 || $birthday['month'] > 12 || ($birthday['month'] == 2 && $birthday['day'] > 29))
 			{
 				$this->set_error("invalid_birthday");
@@ -368,7 +368,6 @@
 				$this->set_error("invalid_birthday");
 				return false;
 			}
-		}
 
 		// Error if a year exists and the year is out of range
 		if($birthday['year'] != 0 && ($birthday['year'] < (date("Y")-100)) || $birthday['year'] > date("Y"))
@@ -528,7 +527,15 @@
 		$this->verify_yesno_option($options, 'showavatars', 1);
 		$this->verify_yesno_option($options, 'showquickreply', 1);
 		$this->verify_yesno_option($options, 'showredirect', 1);
+		
+		if($mybb->settings['postlayout'] == 'classic')
+		{
+			$this->verify_yesno_option($options, 'classicpostbit', 1);
+		}
+		else
+		{
 		$this->verify_yesno_option($options, 'classicpostbit', 0);
+		}
 
 		if(array_key_exists('subscriptionmethod', $options))
 		{
@@ -585,7 +592,7 @@
 		}
 
 		// Verify the "threads per page" option.
-		if($this->method == "insert" || (array_key_exists('tpp', $options) && $mybb->settings['usetppoptions']))
+		if($this->method == "insert" || (array_key_exists('tpp', $options) && $mybb->settings['usertppoptions']))
 		{
 			$explodedtpp = explode(",", $mybb->settings['usertppoptions']);
 			if(is_array($explodedtpp))
@@ -850,7 +857,10 @@
 			$this->verify_checkfields();
 		}
 
+		if(method_exists($plugins, "run_hooks_by_ref"))
+		{
 		$plugins->run_hooks_by_ref("datahandler_user_validate", $this);
+		}
 
 		// We are done validating, return.
 		$this->set_validated(true);
@@ -959,7 +969,10 @@
 			$this->user_insert_data['dst'] = 0;
 		}
 
+		if(method_exists($plugins, "run_hooks_by_ref"))
+		{
 		$plugins->run_hooks_by_ref("datahandler_user_insert", $this);
+		}
 
 		$this->uid = $db->insert_query("users", $this->user_insert_data);
 
@@ -972,10 +985,10 @@
 			{
 				continue;
 			}
-			$user['user_fields']["ufid{$profile_field['fid']}"] = '';
+			$user['user_fields']["fid{$profile_field['fid']}"] = '';
 		}
 
-		$db->insert_query("userfields", $user['user_fields']);
+		$db->insert_query("userfields", $user['user_fields'], false);
 
 		// Update forum stats
 		update_stats(array('numusers' => '+1'));
@@ -1093,7 +1106,7 @@
 		}
 		if(isset($user['birthdayprivacy']))
 		{
-			$this->user_update_data['birthdayprivacy'] = $user['birthdayprivacy'];
+			$this->user_update_data['birthdayprivacy'] = $db->escape_string($user['birthdayprivacy']);
 		}
 		if(isset($user['style']))
 		{
@@ -1150,7 +1163,10 @@
 			unset($this->user_update_data['pmnotice']);
 		}
 
+		if(method_exists($plugins, "run_hooks_by_ref"))
+		{
 		$plugins->run_hooks_by_ref("datahandler_user_update", $this);
+		}
 		
 		if(count($this->user_update_data) < 1) 
 		{ 
@@ -1161,6 +1177,10 @@
 		$db->update_query("users", $this->user_update_data, "uid='{$user['uid']}'");
 		
 		$cache->update_moderators();
+		if(isset($user['bday']))
+		{
+			$cache->update_birthdays();
+		}
 
 		// Maybe some userfields need to be updated?
 		if(is_array($user['user_fields']))
@@ -1184,7 +1204,7 @@
 				}
 				$db->insert_query("userfields", $user_fields);
 			}
-			$db->update_query("userfields", $user['user_fields'], "ufid='{$user['uid']}'");
+			$db->update_query("userfields", $user['user_fields'], "ufid='{$user['uid']}'", false);
 		}
 
 		// Let's make sure the user's name gets changed everywhere in the db if it changed.
diff -rub mybb_1400/inc/db_mysql.php mybb_1408/inc/db_mysql.php
--- mybb_1400/inc/db_mysql.php	2008-06-11 04:21:37.000000000 +0200
+++ mybb_1408/inc/db_mysql.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: db_mysql.php 3902 2008-06-11 02:21:37Z Tikitiki $
+ * $Id: db_mysql.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class DB_MySQL
@@ -143,6 +143,7 @@
 		{
 			$connections['read'][] = $config;
 		}
+		else
 		// Connecting to more than one server
 		{
 			// Specified multiple servers, but no specific read/write servers
@@ -229,7 +230,10 @@
 		}
 
 		// Select databases
-		$this->select_db($config['database']);
+		if(!$this->select_db($config['database']))
+		{
+			return false;
+		}
 
 		$this->current_link = &$this->read_link;
 		return $this->read_link;
@@ -544,6 +548,10 @@
 				trigger_error("<strong>[SQL] [".$this->error_number()."] ".$this->error_string()."</strong><br />{$string}", E_USER_ERROR);
 			}
 		}
+		else
+		{
+			return false;
+		}
 	}
 
 
@@ -1046,6 +1054,33 @@
 	}
 	
 	/**
+	 * Checks to see if an index exists on a specified table
+	 *
+	 * @param string The name of the table.
+	 * @param string The name of the index.
+	 */
+	function index_exists($table, $index)
+	{
+		$index_exists = false;
+		$query = $this->write_query("SHOW INDEX FROM {$this->table_prefix}{$table}");
+		while($ukey = $this->fetch_array($query))
+		{
+			if($ukey['Key_name'] == $index)
+			{
+				$index_exists = true;
+				break;
+			}
+		}
+		
+		if($index_exists)
+		{
+			return true;
+		}
+		
+		return false;
+	}
+	
+	/**
 	 * Drop an table with the specified table
 	 *
 	 * @param boolean hard drop - no checking
@@ -1138,7 +1173,7 @@
 	 */
 	function fetch_db_charsets()
 	{
-		if($this_link && $this->get_version() < 4.1)
+		if($this->link && version_compare($this->get_version(), "4.1", "<"))
 		{
 			return false;
 		}
@@ -1284,9 +1319,4 @@
 	}
 }
 
-if(!class_exists('databaseEngine'))
-{
-	class databaseEngine extends DB_MySQL {
-	}
-}
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/db_mysqli.php mybb_1408/inc/db_mysqli.php
--- mybb_1400/inc/db_mysqli.php	2008-06-11 04:21:37.000000000 +0200
+++ mybb_1408/inc/db_mysqli.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: db_mysqli.php 3902 2008-06-11 02:21:37Z Tikitiki $
+ * $Id: db_mysqli.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class DB_MySQLi
@@ -143,6 +143,7 @@
 		{
 			$connections['read'][] = $config;
 		}
+		else
 		// Connecting to more than one server
 		{
 			// Specified multiple servers, but no specific read/write servers
@@ -238,7 +239,10 @@
 		}
 
 		// Select databases
-		$this->select_db($config['database']);
+		if(!$this->select_db($config['database']))
+		{
+			return false;
+		}
 
 		$this->current_link = &$this->read_link;
 		return $this->read_link;
@@ -481,7 +485,7 @@
 		@mysqli_close($this->read_link);
 		if($this->write_link)
 		{
-			@mysql_close($this->write_link);
+			@mysqli_close($this->write_link);
 		}
 	}
 
@@ -550,6 +554,10 @@
 				trigger_error("<strong>[SQL] [".$this->error_number()."] ".$this->error_string()."</strong><br />{$string}", E_USER_ERROR);
 			}
 		}
+		else
+		{
+			return false;
+		}
 	}
 
 
@@ -846,7 +854,7 @@
 	 */
 	function escape_string($string)
 	{
-		if(function_exists("mysql_real_escape_string") && $this->read_link)
+		if(function_exists("mysqli_real_escape_string") && $this->read_link)
 		{
 			$string = mysqli_real_escape_string($this->read_link, $string);
 		}
@@ -1039,6 +1047,33 @@
 	}
 	
 	/**
+	 * Checks to see if an index exists on a specified table
+	 *
+	 * @param string The name of the table.
+	 * @param string The name of the index.
+	 */
+	function index_exists($table, $index)
+	{
+		$index_exists = false;
+		$query = $this->write_query("SHOW INDEX FROM {$this->table_prefix}{$table}");
+		while($ukey = $this->fetch_array($query))
+		{
+			if($ukey['Key_name'] == $index)
+			{
+				$index_exists = true;
+				break;
+			}
+		}
+		
+		if($index_exists)
+		{
+			return true;
+		}
+		
+		return false;
+	}
+	
+	/**
 	 * Drop an table with the specified table
 	 *
 	 * @param boolean hard drop - no checking
@@ -1131,7 +1166,7 @@
 	 */
 	function fetch_db_charsets()
 	{
-		if($this_link && $this->get_version() < 4.1)
+		if($this->link && version_compare($this->get_version(), "4.1", "<"))
 		{
 			return false;
 		}
@@ -1277,9 +1312,4 @@
 	}
 }
 
-if(!class_exists('databaseEngine'))
-{
-	class databaseEngine extends DB_MySQLi {
-	}
-}
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/db_pdo.php mybb_1408/inc/db_pdo.php
--- mybb_1400/inc/db_pdo.php	2008-06-01 05:52:49.000000000 +0200
+++ mybb_1408/inc/db_pdo.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: db_pdo.php 3873 2008-06-01 03:52:49Z Tikitiki $
+ * $Id: db_pdo.php 4278 2008-11-23 21:12:34Z Tikitiki $
  */
 
 class dbpdoEngine {
@@ -46,7 +46,7 @@
 		} 
 		catch(PDOException $exception)
 		{
-    		echo 'Connection failed: '.$exception->getMessage();
+    		die('Connection failed: '.$exception->getMessage());
 		}
 		
 		$this->db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
diff -rub mybb_1400/inc/db_pgsql.php mybb_1408/inc/db_pgsql.php
--- mybb_1400/inc/db_pgsql.php	2008-06-11 04:21:37.000000000 +0200
+++ mybb_1408/inc/db_pgsql.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.com
  * License: http://www.mybboard.com/license.php
  *
- * $Id: db_pgsql.php 3902 2008-06-11 02:21:37Z Tikitiki $
+ * $Id: db_pgsql.php 4340 2009-04-05 17:10:22Z Tikitiki $
  */
 
 class DB_PgSQL
@@ -157,6 +157,7 @@
 		{
 			$connections['read'][] = $config;
 		}
+		else
 		// Connecting to more than one server
 		{
 			// Specified multiple servers, but no specific read/write servers
@@ -216,12 +217,12 @@
 
 				if($single_connection['port'])
 				{
-					$this->connect_string .= "port={$single_connection['port']} ";
+					$this->connect_string .= " port={$single_connection['port']}";
 				}
 				
 				if($single_connection['hostname'] != "localhost")
 				{
-					$this->connect_string .= "host={$single_connection['hostname']} ";
+					$this->connect_string .= " host={$single_connection['hostname']}";
 				}
 				
 				if($single_connection['password'])
@@ -288,6 +289,10 @@
 		if(strtolower(substr(ltrim($string), 0, 5)) == 'alter')
 		{			
 			$string = preg_replace("#\sAFTER\s([a-z_]+?)(;*?)$#i", "", $string);
+			if(strstr($string, 'CHANGE') !== false)
+			{
+				$string = str_replace(' CHANGE ', ' ALTER ', $string);
+			}
 		}
 
 		if($write_query && $this->write_link)
@@ -718,9 +723,10 @@
 	 *
 	 * @param string The table name to perform the query on.
 	 * @param array An array of fields and their values.
+	 * @param boolean Whether or not to return an insert id. True by default
 	 * @return int The insert ID if available
 	 */
-	function insert_query($table, $array)
+	function insert_query($table, $array, $insert_id=true)
 	{
 		if(!is_array($array))
 		{
@@ -733,8 +739,16 @@
 			INTO {$this->table_prefix}{$table} (".$fields.") 
 			VALUES ('".$values."')
 		");
+		
+		if($insert_id != false)
+		{
 		return $this->insert_id();
 	}
+		else
+		{
+			return true;
+		}
+	}
 	
 	/**
 	 * Build one query for multiple inserts from a multidimensional array.
@@ -957,7 +971,7 @@
 	 */
 	function optimize_table($table)
 	{
-		$this->write_query("OPTIMIZE TABLE ".$this->table_prefix.$table."");
+		$this->write_query("VACUUM ".$this->table_prefix.$table."");
 	}
 	
 	/**
@@ -967,7 +981,7 @@
 	 */
 	function analyze_table($table)
 	{
-		$this->write_query("ANALYZE TABLE ".$this->table_prefix.$table."");
+		$this->write_query("ANALYZE ".$this->table_prefix.$table."");
 	}
 
 	/**
@@ -988,7 +1002,7 @@
 		");
 
 		$lines = array();
-		$lines[] = "CREATE TABLE {$this->table_prefix}{$table} (\n";
+		$table_lines = "CREATE TABLE {$this->table_prefix}{$table} (\n";
 		
 		while($row = $this->fetch_array($query))
 		{
@@ -1072,10 +1086,10 @@
 			$lines[] = "  CONSTRAINT $primary_key_name PRIMARY KEY (".implode(', ', $primary_key).")";
 		}
 
-		$table .= implode(", \n", $lines);
-		$table .= "\n);\n";
+		$table_lines .= implode(", \n", $lines);
+		$table_lines .= "\n)\n";
 		
-		return $table;
+		return $table_lines;
 	}
 
 	/**
@@ -1169,6 +1183,32 @@
 	}
 	
 	/**
+	 * Checks to see if an index exists on a specified table
+	 *
+	 * @param string The name of the table.
+	 * @param string The name of the index.
+	 */
+	function index_exists($table, $index)
+	{
+		$err = $this->error_reporting;
+		$this->error_reporting = 0;
+		
+		$query = $this->write_query("SELECT * FROM pg_indexes WHERE tablename='".$this->escape_string($this->table_prefix.$table)."'");
+		
+		$exists = $this->fetch_field($query, $index);
+		$this->error_reporting = $err;
+		
+		if($exists)
+		{
+			return true;
+		}
+		else
+		{
+			return false;
+		}
+	}
+	
+	/**
 	 * Drop an table with the specified table
 	 *
 	 * @param string The name of the table.
@@ -1204,8 +1244,10 @@
 	 *
 	 * @param string The table
 	 * @param array The replacements
+	 * @param string The default field
+	 * @param boolean Whether or not to return an insert id. True by default
 	 */
-	function replace_query($table, $replacements=array(), $default_field="")
+	function replace_query($table, $replacements=array(), $default_field="", $insert_id=true)
 	{
 		$i = 0;		
 		
@@ -1219,23 +1261,25 @@
 			$main_field = $default_field;
 		}
 		
+		$update = false;
 		$query = $this->write_query("SELECT {$main_field} FROM {$this->table_prefix}{$table}");
 		
 		while($column = $this->fetch_array($query))
 		{
 			if($column[$main_field] == $replacements[$main_field])
 			{				
-				++$i;
+				$update = true;
+				break;
 			}
 		}
 		
-		if($i > 0)
+		if($update === true)
 		{
 			return $this->update_query($table, $replacements, "{$main_field}='".$replacements[$main_field]."'");
 		}
 		else
 		{
-			return $this->insert_query($table, $replacements);
+			return $this->insert_query($table, $replacements, $insert_id);
 		}
 	}
 	
@@ -1247,7 +1291,6 @@
 	 */
 	function build_replace_query($table, $replacements=array(), $default_field="")
 	{
-		$i = 0;		
 		
 		if($default_field == "")
 		{
@@ -1259,17 +1302,19 @@
 			$main_field = $default_field;
 		}
 		
+		$update = false;
 		$query = $this->write_query("SELECT {$main_field} FROM {$this->table_prefix}{$table}");
 		
 		while($column = $this->fetch_array($query))
 		{
 			if($column[$main_field] == $replacements[$main_field])
 			{				
-				++$i;
+				$update = true;
+				break;
 			}
 		}
 		
-		if($i > 0)
+		if($update === true)
 		{
 			return $this->build_update_query($table, $replacements, "{$main_field}='".$replacements[$main_field]."'");
 		}
@@ -1387,9 +1432,4 @@
 	}
 }
 
-if(!class_exists('databaseEngine'))
-{
-	class databaseEngine extends DB_PgSQL {
-	}
-}
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/db_sqlite2.php mybb_1408/inc/db_sqlite2.php
--- mybb_1400/inc/db_sqlite2.php	2008-06-11 04:21:37.000000000 +0200
+++ mybb_1408/inc/db_sqlite2.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,10 @@
  * Website: http://www.mybboard.com
  * License: http://www.mybboard.com/license.php
  *
- * $Id: db_sqlite2.php 3902 2008-06-11 02:21:37Z Tikitiki $
+ * $Id: db_sqlite2.php 4335 2009-03-22 18:34:20Z Tikitiki $
  */
 
-class DB_SQLite
+class DB_SQLite2
 {
 	/**
 	 * The title of this layer.
@@ -147,7 +147,7 @@
 
 		$this->connections[] = "[WRITE] {$config['database']} (Connected in ".number_format($query_time, 0)."s)";
 		
-		sqlite_query('PRAGMA short_column_names = 1', $this->link);
+		@sqlite_query('PRAGMA short_column_names = 1', $this->link);
 		return $this->link;
 	}
 
@@ -175,13 +175,21 @@
 			else
 			{
 				$alterdefs = preg_replace("#\sAFTER\s([a-z_]+?)(;*?)$#i", "", $alterdefs);
-				$query = $this->alter_table_parse($tablename, $alterdefs);
+				$alterdefs = preg_replace("#;$#i", "", $alterdefs);
+				$query = $this->alter_table_parse($tablename, $alterdefs, $string);
 			}
 		}
 	  	else
 	  	{
+			if(version_compare(phpversion(), "5.1.0", ">="))
+			{
 			$query = sqlite_query($this->link, $string, SQLITE_BOTH, $this->error_msg);
 		}
+			else
+			{
+				$query = sqlite_query($this->link, $string, SQLITE_BOTH);
+			}
+		}
 		
 		if($this->error_msg && !$hide_errors)
 		{
@@ -591,6 +599,34 @@
 	}
 	
 	/**
+	 * Build an insert query from an array.
+	 *
+	 * @param string The table name to perform the query on.
+	 * @param array An array of fields and their values.
+	 * @return string The query string.
+	 */
+	function build_insert_query($table, $array)
+	{
+		$comma = $query1 = $query2 = "";
+		if(!is_array($array))
+		{
+			return false;
+		}
+		$comma = "";
+		$query1 = "";
+		$query2 = "";
+		foreach($array as $field => $value)
+		{
+			$query1 .= $comma.$field;
+			$query2 .= $comma."'".$value."'";
+			$comma = ", ";
+		}
+		return "INSERT 
+			INTO ".TABLE_PREFIX.$table." (".$query1.") 
+			VALUES (".$query2.")";
+	}
+	
+	/**
 	 * Build one query for multiple inserts from a multidimensional array.
 	 *
 	 * @param string The table name to perform the query on.
@@ -655,6 +691,39 @@
 	}
 
 	/**
+	 * Build an update query from an array.
+	 *
+	 * @param string The table name to perform the query on.
+	 * @param array An array of fields and their values.
+	 * @param string An optional where clause for the query.
+	 * @param string An optional limit clause for the query.
+	 * @return string The query string.
+	 */
+	function build_update_query($table, $array, $where="", $limit="")
+	{
+		if(!is_array($array))
+		{
+			return false;
+		}
+		
+		$comma = "";
+		$query = "";
+		
+		foreach($array as $field => $value)
+		{
+			$query .= $comma.$field."='".$value."'";
+			$comma = ", ";
+		}
+		
+		if(!empty($where))
+		{
+			$query .= " WHERE $where";
+		}
+		
+		return "UPDATE {$this->table_prefix}{$table} SET {$query}";
+	}
+	
+	/**
 	 * Build a delete query.
 	 *
 	 * @param string The table name to perform the query on.
@@ -767,7 +836,7 @@
 	{
 		$old_tbl_prefix = $this->table_prefix;
 		$this->set_table_prefix("");
-		$query = $this->simple_select("sqlite_master", "sql", "type = 'table' AND name = '{$this->table_prefix}{$table}'");
+		$query = $this->simple_select("sqlite_master", "sql", "type = 'table' AND name = '{$old_tbl_prefix}{$table}'");
 		$this->set_table_prefix($old_tbl_prefix);
 		$table = trim(preg_replace('#CREATE\s+TABLE\s+"?'.$this->table_prefix.$table.'"?#i', '', $this->fetch_field($query, "sql")));
 
@@ -834,6 +903,17 @@
 	}
 
 	/**
+	 * Checks to see if an index exists on a specified table
+	 *
+	 * @param string The name of the table.
+	 * @param string The name of the index.
+	 */
+	function index_exists($table, $index)
+	{
+		return false;
+	}
+	
+	/**
 	 * Drop an index with the specified name from the specified table
 	 *
 	 * @param string The name of the table.
@@ -880,8 +960,10 @@
 	 *
 	 * @param string The table
 	 * @param array The values
+	 * @param string The default field
+	 * @param boolean Whether or not to return an insert id. True by default
 	 */
-	function replace_query($table, $replacements=array())
+	function replace_query($table, $replacements=array(), $default_field="", $insert_id=true)
 	{
 		$columns = '';
 		$values = '';
@@ -899,7 +981,86 @@
 			 return false;
 		}
 		
-		return $this->query("REPLACE INTO {$this->table_prefix}{$table} ({$columns}) VALUES({$values})");
+		if($default_field == "")
+		{
+			return $this->write_query("REPLACE INTO {$this->table_prefix}{$table} ({$columns}) VALUES({$values})");
+		}
+		else
+		{
+			$update = false;
+			$query = $this->write_query("SELECT {$default_field} FROM {$this->table_prefix}{$table}");
+			
+			while($column = $this->fetch_array($query))
+			{
+				if($column[$default_field] == $replacements[$default_field])
+				{				
+					$update = true;
+					break;
+				}
+			}
+			
+			if($update === true)
+			{
+				return $this->update_query($table, $replacements, "{$default_field}='".$replacements[$default_field]."'");
+			}
+			else
+			{
+				return $this->insert_query($table, $replacements, $insert_id);
+			}
+		}
+	}
+	
+	/**
+	 * Replace contents of table with values
+	 *
+	 * @param string The table
+	 * @param array The replacements
+	 */
+	function build_replace_query($table, $replacements=array(), $default_field="")
+	{
+		$columns = '';
+		$values = '';
+		$comma = '';
+		foreach($replacements as $column => $value)
+		{
+			$columns .= $comma.$column;
+			$values .= $comma."'".$value."'";
+			
+			$comma = ',';
+		}
+		
+		if(empty($columns) || empty($values))
+		{
+			 return false;
+		}
+		
+		if($default_field == "")
+		{
+			return "REPLACE INTO {$this->table_prefix}{$table} ({$columns}) VALUES({$values})";
+		}
+		else
+		{
+			$update = false;
+			$query = $this->write_query("SELECT {$default_field} FROM {$this->table_prefix}{$table}");
+			
+			while($column = $this->fetch_array($query))
+			{
+				if($column[$default_field] == $replacements[$default_field])
+				{				
+					$update = true;
+					break;
+				}
+			}
+			
+			if($update === true)
+			{
+				return $this->build_update_query($table, $replacements, "{$default_field}='".$replacements[$default_field]."'");
+			}
+			else
+			{
+				return $this->build_insert_query($table, $replacements, $insert_id);
+			}
+		}
 	}
 	
 	/**
@@ -934,10 +1095,22 @@
 	 * Perform an "Alter Table" query in SQLite < 3.2.0 - Code taken from http://code.jenseng.com/db/
 	 *
 	 * @param string The table (optional)
+	 * @param string The ADD/Change/Drop part of the query
+	 * @param string The full part of the query
 	 * @return integer the total size of all mysql tables or a specific table
 	 */
-	function alter_table_parse($table, $alterdefs)
+	function alter_table_parse($table, $alterdefs, $fullquery="")
+	{
+		if(!$fullquery)
 	{
+			$fullquery = " ... {$alterdefs}";
+		}
+		
+		if(!defined("TIME_NOW"))
+		{
+			define("TIME_NOW", time());
+		}
+		
 		if($alterdefs != '')
 		{
 			$result = $this->query("SELECT sql,name,type FROM sqlite_master WHERE tbl_name = '{$table}' ORDER BY type DESC");
@@ -991,6 +1164,11 @@
 							
 							$createtesttableSQL = substr($createtesttableSQL, 0, strlen($createtesttableSQL)-1).',';
 							
+							if(strstr($createtesttableSQL, $defparts[1]) !== false)
+							{
+								$this->error($fullquery, 'syntax error: '.$defparts[1].' column already exists in '.$table.' table');
+							}
+							
 							for($i = 1; $i < sizeof($defparts); $i++)
 							{
 								$createtesttableSQL .= ' '.$defparts[$i];
@@ -1008,7 +1186,7 @@
 							{
 								if($newcols[$defparts[1]] != $defparts[1])
 								{
-									$this->error($alterdefs, 'unknown column "'.$defparts[1].'" in "'.$table.'"');
+									$this->error($fullquery, 'unknown column "'.$defparts[1].'" in "'.$table.'"');
 									return false;
 								}
 								
@@ -1032,14 +1210,14 @@
 							}
 							else
 							{
-								$this->error($alterdefs, 'unknown column "'.$defparts[1].'" in "'.$table.'"', E_USER_WARNING);
+								$this->error($fullquery, 'unknown column "'.$defparts[1].'" in "'.$table.'"', E_USER_WARNING);
 								return false;
 							}
 							break;
 						case 'drop':
 							if(sizeof($defparts) < 2)
 							{
-								$this->error($alterdefs, 'near "'.$defparts[0].($defparts[1] ? ' '.$defparts[1] : '').'": syntax error');
+								$this->error($fullquery, 'near "'.$defparts[0].($defparts[1] ? ' '.$defparts[1] : '').'": syntax error');
 								return false;
 							}
 							
@@ -1060,12 +1238,12 @@
 							}
 							else
 							{
-								$this->error($alterdefs, 'unknown column "'.$defparts[1].'" in "'.$table.'"');
+								$this->error($fullquery, 'unknown column "'.$defparts[1].'" in "'.$table.'"');
 								return false;
 							}
 							break;
 						default:
-							$this->error($alterdefs, 'near "'.$prevword.'": syntax error');
+							$this->error($fullquery, 'near "'.$prevword.'": syntax error');
 							return false;
 					}
 					
@@ -1176,9 +1354,4 @@
 	}
 }
 
-if(!class_exists('databaseEngine'))
-{
-	class databaseEngine extends DB_SQLite {
-	}
-}
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/db_sqlite3.php mybb_1408/inc/db_sqlite3.php
--- mybb_1400/inc/db_sqlite3.php	2008-06-11 04:21:37.000000000 +0200
+++ mybb_1408/inc/db_sqlite3.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.com
  * License: http://www.mybboard.com/license.php
  *
- * $Id: db_sqlite3.php 3902 2008-06-11 02:21:37Z Tikitiki $
+ * $Id: db_sqlite3.php 4335 2009-03-22 18:34:20Z Tikitiki $
  */
 
 class DB_SQLite3
@@ -180,7 +180,7 @@
 				}
 				else
 				{
-					$query = $this->alter_table_parse($tablename, $alterdefs);
+					$query = $this->alter_table_parse($tablename, $alterdefs, $string);
 				}
 			}
 		}
@@ -619,6 +619,34 @@
 	}
 	
 	/**
+	 * Build an insert query from an array.
+	 *
+	 * @param string The table name to perform the query on.
+	 * @param array An array of fields and their values.
+	 * @return string The query string.
+	 */
+	function build_insert_query($table, $array)
+	{
+		$comma = $query1 = $query2 = "";
+		if(!is_array($array))
+		{
+			return false;
+		}
+		$comma = "";
+		$query1 = "";
+		$query2 = "";
+		foreach($array as $field => $value)
+		{
+			$query1 .= $comma.$field;
+			$query2 .= $comma."'".$value."'";
+			$comma = ", ";
+		}
+		return "INSERT 
+			INTO ".TABLE_PREFIX.$table." (".$query1.") 
+			VALUES (".$query2.")";
+	}
+	
+	/**
 	 * Build one query for multiple inserts from a multidimensional array.
 	 *
 	 * @param string The table name to perform the query on.
@@ -683,6 +711,39 @@
 	}
 
 	/**
+	 * Build an update query from an array.
+	 *
+	 * @param string The table name to perform the query on.
+	 * @param array An array of fields and their values.
+	 * @param string An optional where clause for the query.
+	 * @param string An optional limit clause for the query.
+	 * @return string The query string.
+	 */
+	function build_update_query($table, $array, $where="", $limit="")
+	{
+		if(!is_array($array))
+		{
+			return false;
+		}
+		
+		$comma = "";
+		$query = "";
+		
+		foreach($array as $field => $value)
+		{
+			$query .= $comma.$field."='".$value."'";
+			$comma = ", ";
+		}
+		
+		if(!empty($where))
+		{
+			$query .= " WHERE $where";
+		}
+		
+		return "UPDATE {$this->table_prefix}{$table} SET {$query}";
+	}
+
+	/**
 	 * Build a delete query.
 	 *
 	 * @param string The table name to perform the query on.
@@ -795,7 +856,7 @@
 	{
 		$old_tbl_prefix = $this->table_prefix;
 		$this->set_table_prefix("");
-		$query = $this->simple_select("sqlite_master", "sql", "type = 'table' AND name = '{$this->table_prefix}{$table}'");
+		$query = $this->simple_select("sqlite_master", "sql", "type = 'table' AND name = '{$old_tbl_prefix}{$table}'");
 		$this->set_table_prefix($old_tbl_prefix);
 		$table = trim(preg_replace('#CREATE\s+TABLE\s+"?'.$this->table_prefix.$table.'"?#i', '', $this->fetch_field($query, "sql")));
 
@@ -873,6 +934,17 @@
 	}
 	
 	/**
+	 * Checks to see if an index exists on a specified table
+	 *
+	 * @param string The name of the table.
+	 * @param string The name of the index.
+	 */
+	function index_exists($table, $index)
+	{
+		return false;
+	}
+	
+	/**
 	 * Drop an table with the specified table
 	 *
 	 * @param string The name of the table.
@@ -908,8 +980,10 @@
 	 *
 	 * @param string The table
 	 * @param array The values
+	 * @param string The default field
+	 * @param boolean Whether or not to return an insert id. True by default
 	 */
-	function replace_query($table, $replacements=array())
+	function replace_query($table, $replacements=array(), $default_field="", $insert_id=true)
 	{
 		$columns = '';
 		$values = '';
@@ -927,7 +1001,86 @@
 			 return false;
 		}
 		
-		return $this->query("REPLACE INTO {$this->table_prefix}{$table} ({$columns}) VALUES({$values})");
+		if($default_field == "")
+		{
+			return $this->write_query("REPLACE INTO {$this->table_prefix}{$table} ({$columns}) VALUES({$values})");
+		}
+		else
+		{
+			$update = false;
+			$query = $this->write_query("SELECT {$default_field} FROM {$this->table_prefix}{$table}");
+			
+			while($column = $this->fetch_array($query))
+			{
+				if($column[$default_field] == $replacements[$default_field])
+				{				
+					$update = true;
+					break;
+				}
+			}
+			
+			if($update === true)
+			{
+				return $this->update_query($table, $replacements, "{$default_field}='".$replacements[$default_field]."'");
+			}
+			else
+			{
+				return $this->insert_query($table, $replacements, $insert_id);
+			}
+		}
+	}
+	
+	/**
+	 * Replace contents of table with values
+	 *
+	 * @param string The table
+	 * @param array The replacements
+	 */
+	function build_replace_query($table, $replacements=array(), $default_field="")
+	{
+		$columns = '';
+		$values = '';
+		$comma = '';
+		foreach($replacements as $column => $value)
+		{
+			$columns .= $comma.$column;
+			$values .= $comma."'".$value."'";
+			
+			$comma = ',';
+		}
+		
+		if(empty($columns) || empty($values))
+		{
+			 return false;
+		}
+		
+		if($default_field == "")
+		{
+			return "REPLACE INTO {$this->table_prefix}{$table} ({$columns}) VALUES({$values})";
+		}
+		else
+		{
+			$update = false;
+			$query = $this->write_query("SELECT {$default_field} FROM {$this->table_prefix}{$table}");
+			
+			while($column = $this->fetch_array($query))
+			{
+				if($column[$default_field] == $replacements[$default_field])
+				{				
+					$update = true;
+					break;
+				}
+			}
+			
+			if($update === true)
+			{
+				return $this->build_update_query($table, $replacements, "{$default_field}='".$replacements[$default_field]."'");
+			}
+			else
+			{
+				return $this->build_insert_query($table, $replacements, $insert_id);
+			}
+		}
 	}
 	
 	/**
@@ -964,8 +1117,18 @@
 	 * @param string The table (optional)
 	 * @return integer the total size of all mysql tables or a specific table
 	 */
-	function alter_table_parse($table, $alterdefs)
+	function alter_table_parse($table, $alterdefs, $fullquery="")
+	{
+		if(!$fullquery)
 	{
+			$fullquery = " ... {$alterdefs}";
+		}
+		
+		if(!defined("TIME_NOW"))
+		{
+			define("TIME_NOW", time());
+		}
+		
 		if($alterdefs != '')
 		{
 			$result = $this->query("SELECT sql,name,type FROM sqlite_master WHERE tbl_name = '{$table}' ORDER BY type DESC");
@@ -1045,14 +1208,14 @@
 							}
 							else
 							{
-								$this->error($alterdefs, 'unknown column "'.$defparts[1].'" in "'.$table.'"', E_USER_WARNING);
+								$this->error($fullquery, 'unknown column "'.$defparts[1].'" in "'.$table.'"', E_USER_WARNING);
 								return false;
 							}
 							break;
 						case 'drop':
 							if(sizeof($defparts) < 2)
 							{
-								$this->error($alterdefs, 'near "'.$defparts[0].($defparts[1] ? ' '.$defparts[1] : '').'": syntax error');
+								$this->error($fullquery, 'near "'.$defparts[0].($defparts[1] ? ' '.$defparts[1] : '').'": syntax error');
 								return false;
 							}
 							
@@ -1073,12 +1236,12 @@
 							}
 							else
 							{
-								$this->error($alterdefs, 'unknown column "'.$defparts[1].'" in "'.$table.'"');
+								$this->error($fullquery, 'unknown column "'.$defparts[1].'" in "'.$table.'"');
 								return false;
 							}
 							break;
 						default:
-							$this->error($alterdefs, 'near "'.$prevword.'": syntax error');
+							$this->error($fullquery, 'near "'.$prevword.'": syntax error');
 							return false;
 					}
 					
@@ -1122,7 +1285,7 @@
 			}
 			else
 			{
-				$this->error($alterdefs, 'no such table: '.$table);
+				$this->error($fullquery, 'no such table: '.$table);
 				return false;
 			}
 			return true;
@@ -1189,9 +1352,4 @@
 	}
 }
 
-if(!class_exists('databaseEngine'))
-{
-	class databaseEngine extends DB_SQLite3 {
-	}
-}
 ?>
diff -rub mybb_1400/inc/functions.php mybb_1408/inc/functions.php
--- mybb_1400/inc/functions.php	2008-08-03 02:37:09.000000000 +0200
+++ mybb_1408/inc/functions.php	2009-06-26 07:27:15.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions.php 4058 2008-08-03 00:37:09Z Tikitiki $
+ * $Id: functions.php 4377 2009-06-04 11:33:13Z Tomm $
  */
 
 /**
@@ -162,7 +162,25 @@
 		if(isset($config))
 		{
 			require_once MYBB_ROOT."inc/db_".$config['database']['type'].".php";
-			$db = new databaseEngine;
+			switch($config['database']['type'])
+			{
+				case "sqlite3":
+					$db = new DB_SQLite3;
+					break;
+				case "sqlite2":
+					$db = new DB_SQLite2;
+					break;
+				case "pgsql":
+					$db = new DB_PgSQL;
+					break;
+				case "mysqli":
+					$db = new DB_MySQLi;
+					break;
+				default:
+					$db = new DB_MySQL;
+			}
+			
+			
 			$db->connect($config['database']);
 			define("TABLE_PREFIX", $config['database']['table_prefix']);
 			$db->set_table_prefix(TABLE_PREFIX);
@@ -391,8 +409,11 @@
  * @param string The from address of the email, if blank, the board name will be used.
  * @param string The chracter set being used to send this email.
  * @param boolean Do we wish to keep the connection to the mail server alive to send more than one message (SMTP only)
+ * @param string The format of the email to be sent (text or html). text is default
+ * @param string The text message of the email if being sent in html format, for email clients that don't support html
+ * @param string The email address to return to. Defaults to admin return email address.
  */
-function my_mail($to, $subject, $message, $from="", $charset="", $headers="", $keep_alive=false, $format="text", $message_text="")
+function my_mail($to, $subject, $message, $from="", $charset="", $headers="", $keep_alive=false, $format="text", $message_text="", $return_email="")
 {
 	global $mybb;
 	static $mail;
@@ -433,7 +454,7 @@
 	}
 	
 	// Build and send
-	$mail->build_message($to, $subject, $message, $from, $charset, $headers, $format, $message_text);
+	$mail->build_message($to, $subject, $message, $from, $charset, $headers, $format, $message_text, $return_email);
 	return $mail->send();
 }
 
@@ -452,7 +473,7 @@
 	// Guests get a special string
 	else
 	{
-		return md5($mybb->config['database']['hostname'].$mybb->config['database']['username'].$mybb->config['database']['password']);
+		return md5($mybb->settings['bburl'].$mybb->config['database']['username'].$mybb->settings['internal']['encryption_key']);
 	}
 }
 
@@ -473,9 +494,16 @@
 		}
 		else
 		{
+			if(defined("IN_ADMINCP"))
+			{
+				return false;
+			}
+			else
+			{
 			error($lang->invalid_post_code);
 		}
 	}
+	}
 	else
 	{
 		return true;
@@ -747,12 +775,12 @@
 		echo "<script type=\"text/javascript\">\n";
 		if($message != "")
 		{
-			echo "alert('{$message}');\n";
+			echo 'alert("'.addslashes($message).'");';
 		}
 		$url = str_replace("#", "&#", $url);
 		$url = htmlspecialchars_decode($url);
 		$url = str_replace(array("\n","\r",";"), "", $url);
-		echo "window.location = '{$url}';\n";
+		echo 'window.location = "'.addslashes($url).'";'."\n";
 		echo "</script>\n";
 		exit;
 	}
@@ -781,7 +809,6 @@
 	}
 	else
 	{
-		$url = str_replace("#", "&#", $url);
 		$url = htmlspecialchars_decode($url);
 		$url = str_replace(array("\n","\r",";"), "", $url);
 
@@ -980,7 +1007,6 @@
 
 	$groups = explode(",", $gid);
 
-
 	if(count($groups) == 1)
 	{
 		return $groupscache[$gid];
@@ -1006,14 +1032,12 @@
 					$permbit = "";
 				}
 
-				if(in_array($perm, $groupzerogreater))
-				{
-					if($access == 0)
+				// 0 represents unlimited for numerical group permissions (i.e. private message limit) so take that into account.
+				if(in_array($perm, $groupzerogreater) && ($access == 0 || $permbit === 0))
 					{
 						$usergroup[$perm] = 0;
 						continue;
 					}
-				}
 
 				if($access > $permbit || ($access == "yes" && $permbit == "no") || !$permbit) // Keep yes/no for compatibility?
 				{
@@ -1071,9 +1095,9 @@
 
 	if(!$gid || $gid == 0) // If no group, we need to fetch it
 	{
-		if($uid != $mybb->user['uid'])
+		if($uid != 0 && $uid != $mybb->user['uid'])
 		{
-			if($usercache[$uid])
+			if(!$usercache[$uid])
 			{
 				$query = $db->simple_select("users", "*", "uid='$uid'");
 				$usercache[$uid] = $db->fetch_array($query);
@@ -1574,8 +1598,11 @@
 	$cookie = $mybb->cookies['mybb'];
 	$newcookie = unserialize($cookie[$name]);
 	$newcookie[$id] = $value;
-	$newcookie = addslashes(serialize($newcookie));
-	my_setcookie("mybb[$name]", $newcookie);
+	$newcookie = serialize($newcookie);
+	my_setcookie("mybb[$name]", addslashes($newcookie));
+	
+	// Make sure our current viarables are up-to-date as well
+	$mybb->cookies['mybb'][$name] = $newcookie;
 }
 
 /**
@@ -1597,7 +1624,7 @@
 			$serverload = explode(" ", $load);
 			$serverload[0] = round($serverload[0], 4);
 		}
-		if(!$serverload)
+		if(!is_numeric($serverload[0]))
 		{
 			if(@ini_get('safe_mode') == 'On')
 			{
@@ -1853,7 +1880,7 @@
 
 	$update_query = array();
 	
-	$counters = array('replies','unapprovedposts','attachmentcount');
+	$counters = array('replies','unapprovedposts','attachmentcount', 'attachmentcount');
 
 	// Fetch above counters for this thread
 	$query = $db->simple_select("threads", implode(",", $counters), "tid='{$tid}'");
@@ -1880,12 +1907,16 @@
 		}
 	}
 
+	$db->free_result($query);
+
 	// Only update if we're actually doing something
 	if(count($update_query) > 0)
 	{
 		$db->update_query("threads", $update_query, "tid='".intval($tid)."'");
 	}
 
+	unset($update_query, $thread);
+
 	update_thread_data($tid);
 }
 
@@ -1907,6 +1938,8 @@
 	);
 	$lastpost = $db->fetch_array($query);
 
+	$db->free_result($query);
+	
 	$query = $db->query("
 		SELECT u.uid, u.username, p.username AS postusername, p.dateline
 		FROM ".TABLE_PREFIX."posts p
@@ -1917,6 +1950,8 @@
 	");
 	$firstpost = $db->fetch_array($query);
 
+	$db->free_result($query);
+
 	if(!$firstpost['username'])
 	{
 		$firstpost['username'] = $firstpost['postusername'];
@@ -1945,6 +1980,8 @@
 		'lastposteruid' => intval($lastpost['uid']),
 	);
 	$db->update_query("threads", $update_array, "tid='{$tid}'");
+	
+	unset($firstpost, $lastpost, $update_array);
 }
 
 function update_forum_count($fid)
@@ -2004,11 +2041,12 @@
  * @param int If we need to add select boxes to this cal or not
  * @param int The current depth of forums we're at
  * @param int Whether or not to show extra items such as User CP, Forum home
+ * @param boolean Ignore the showinjump setting and show all forums (for moderation pages)
  * @param array Array of permissions
  * @param string The name of the forum jump
  * @return string Forum jump items
  */
-function build_forum_jump($pid="0", $selitem="", $addselect="1", $depth="", $showextras="1", $permissions="", $name="fid")
+function build_forum_jump($pid="0", $selitem="", $addselect="1", $depth="", $showextras="1", $showall=false, $permissions="", $name="fid")
 {
 	global $forum_cache, $jumpfcache, $permissioncache, $mybb, $selecteddone, $forumjump, $forumjumpbits, $gobutton, $theme, $templates, $lang;
 
@@ -2048,7 +2086,7 @@
 			{
 				$perms = $permissioncache[$forum['fid']];
 
-				if($forum['fid'] != "0" && ($perms['canview'] != 0 || $mybb->settings['hideprivateforums'] == 0) && $forum['linkto'] == '' && $forum['showinjump'] != 0)
+				if($forum['fid'] != "0" && ($perms['canview'] != 0 || $mybb->settings['hideprivateforums'] == 0) && $forum['linkto'] == '' && ($forum['showinjump'] != 0 || $showall == true))
 				{
 					$optionselected = "";
 
@@ -2065,7 +2103,7 @@
 					if($forum_cache[$forum['fid']])
 					{
 						$newdepth = $depth."--";
-						$forumjumpbits .= build_forum_jump($forum['fid'], $selitem, 0, $newdepth, $showextras);
+						$forumjumpbits .= build_forum_jump($forum['fid'], $selitem, 0, $newdepth, $showextras, $showall);
 					}
 				}
 			}
@@ -2848,7 +2886,7 @@
 				}
 
 				$navsize = count($navbits);
-				$navbits[$navsize]['name'] = $forumnav['name'];
+				$navbits[$navsize]['name'] = htmlspecialchars_uni($forumnav['name']);
 
 				if(IN_ARCHIVE == 1)
 				{
@@ -2920,7 +2958,7 @@
 			$url = "{$base_url}forum-{$id}.html";
 			break;
 		default:
-			$url = $mybb->setings['bburl']."/archive/index.php";
+			$url = $mybb->settings['bburl']."/archive/index.php";
 	}
 
 	return $url;
@@ -3062,7 +3100,7 @@
 	if($mybb->settings['nocacheheaders'] == 1 && $mybb->settings['standardheaders'] != 1)
 	{
 		header("Expires: Sat, 1 Jan 2000 01:00:00 GMT");
-		header("Last-Modified: ".gmdate("D, d M Y H:i:s")."GMT");
+		header("Last-Modified: ".gmdate("D, d M Y H:i:s")." GMT");
 		header("Cache-Control: no-cache, must-revalidate");
 		header("Pragma: no-cache");
 	}
@@ -3292,7 +3330,7 @@
  */
 function join_usergroup($uid, $joingroup)
 {
-	global $db;
+	global $db, $mybb;
 
 	if($uid == $mybb->user['uid'])
 	{
@@ -3300,7 +3338,7 @@
 	}
 	else
 	{
-		$query = $db->simple_select("users", "additionalgroups, usergroup", "uid='{$uid}'");
+		$query = $db->simple_select("users", "additionalgroups, usergroup", "uid='".intval($uid)."'");
 		$user = $db->fetch_array($query);
 	}
 
@@ -3323,7 +3361,16 @@
 		}
 	}
 
-	$db->update_query("users", array('additionalgroups' => $groupslist), "uid='$uid'");
+	// What's the point in updating if they're the same?
+	if($groupslist != $user['additionalgroups'])
+	{
+		$db->update_query("users", array('additionalgroups' => $groupslist), "uid='".intval($uid)."'");
+		return true;
+	}
+	else
+	{
+		return false;
+	}
 }
 
 /**
@@ -3342,10 +3389,11 @@
 	}
 	else
 	{
-		$query = $db->simple_select("users", "*", "uid='{$uid}'");
+		$query = $db->simple_select("users", "*", "uid='".intval($uid)."'");
 		$user = $db->fetch_array($query);
 	}
 
+	$groupslist = "";
 	$usergroups = "";
 	$usergroups = $user['additionalgroups'].",";
 
@@ -3364,6 +3412,7 @@
 		}
 	}
 
+	$dispupdate = "";
 	if($leavegroup == $user['displaygroup'])
 	{
 		$dispupdate = ", displaygroup=usergroup";
@@ -3372,7 +3421,7 @@
 	$db->write_query("
 		UPDATE ".TABLE_PREFIX."users
 		SET additionalgroups='$groupslist' $dispupdate
-		WHERE uid='$uid'
+		WHERE uid='".intval($uid)."'
 	");
 	
 	$cache->update_moderators();
@@ -3394,19 +3443,19 @@
 
 	if(!empty($_SERVER['PATH_INFO']))
 	{
-		$location = $_SERVER['PATH_INFO'];
+		$location = htmlspecialchars_uni($_SERVER['PATH_INFO']);
 	}
 	elseif(!empty($_ENV['PATH_INFO']))
 	{
-		$location = $_ENV['PATH_INFO'];
+		$location = htmlspecialchars_uni($_ENV['PATH_INFO']);
 	}
 	elseif(!empty($_ENV['PHP_SELF']))
 	{
-		$location = $_ENV['PHP_SELF'];
+		$location = htmlspecialchars_uni($_ENV['PHP_SELF']);
 	}
 	else
 	{
-		$location = $_SERVER['PHP_SELF'];
+		$location = htmlspecialchars_uni($_SERVER['PHP_SELF']);
 	}
 
 	if($fields == true)
@@ -3440,11 +3489,11 @@
 	{
 		if(isset($_SERVER['QUERY_STRING']))
 		{
-			$location .= "?".$_SERVER['QUERY_STRING'];
+			$location .= "?".htmlspecialchars_uni($_SERVER['QUERY_STRING']);
 		}
 		else if(isset($_ENV['QUERY_STRING']))
 		{
-			$location = "?".$_ENV['QUERY_STRING'];
+			$location .= "?".htmlspecialchars_uni($_ENV['QUERY_STRING']);
 		}
 		
 		if((isset($_SERVER['REQUEST_METHOD']) && $_SERVER['REQUEST_METHOD'] == "POST") || (isset($_ENV['REQUEST_METHOD']) && $_ENV['REQUEST_METHOD'] == "POST"))
@@ -3455,16 +3504,23 @@
 			{
 				if(isset($_POST[$var]))
 				{
-					$addloc[] = $var.'='.$_POST[$var];
+					$addloc[] = urlencode($var).'='.urlencode($_POST[$var]);
 				}
 			}
 	
-			if(isset($addlock) && is_array($addloc))
+			if(isset($addloc) && is_array($addloc))
+			{
+				if(strpos($location, "?") === false)
 			{
-				$location .= "?".implode("&", $addloc);
+					$location .= "?";
+				}
+				else
+				{
+					$location .= "&amp;";
+				}
+				$location .= implode("&amp;", $addloc);
 			}
 		}
-	
 	
 		return $location;
 	}
@@ -3611,6 +3667,71 @@
 	}
 }
 
+function convert_through_utf8($str, $to=true)
+{
+	global $lang;
+	static $charset;
+	static $use_mb;
+	static $use_iconv;
+	
+	if(!isset($charset))
+	{
+		$charset = my_strtolower($lang->settings['charset']);
+	}
+	
+	if($charset == "utf-8")
+	{
+		return $str;
+	}
+	
+	if(!isset($use_iconv))
+	{
+		$use_iconv = function_exists("iconv");
+	}
+	
+	if(!isset($use_mb))
+	{
+		$use_mb = function_exists("mb_convert_encoding");
+	}
+	
+	if($use_iconv || $use_mb)
+	{
+		if($to)
+		{
+			$from_charset = $lang->settings['charset'];
+			$to_charset = "UTF-8";
+		}
+		else
+		{
+			$from_charset = "UTF-8";
+			$to_charset = $lang->settings['charset'];
+		}
+		if($use_iconv)
+		{
+			return iconv($from_charset, $to_charset."//IGNORE", $str);
+		}
+		else
+		{
+			return @mb_convert_encoding($str, $to_charset, $from_charset);
+		}
+	}
+	elseif($charset == "iso-8859-1" && function_exists("utf8_encode"))
+	{
+		if($to)
+		{
+			return utf8_encode($str);
+		}
+		else
+		{
+			return utf8_decode($str);
+		}
+	}
+	else
+	{
+		return $str;
+	}
+}
+
 /**
  * Replacement function for PHP's wordwrap(). This version does not break up HTML tags, URLs or unicode references.
  *
@@ -3623,14 +3744,16 @@
 
 	if($mybb->settings['wordwrap'] > 0)
 	{
-		if($mybb->config['db_encoding'] == "utf8" && !preg_match("#[\x80-\xFF]#", $message))
-		{
-			$message = preg_replace("#(?>[^\s&/<>\"\\-\.\[\]]{{$mybb->settings['wordwrap']}})#u", "$0 ", $message);
-		}
-		else
+		$message = convert_through_utf8($message);
+		
+		if(!($new_message = @preg_replace("#(?>[^\s&/<>\"\\-\.\[\]]{{$mybb->settings['wordwrap']}})#u", "$0&#8203;", $message)))
 		{
-			$message = preg_replace("#(?>[^\s&/<>\"\\-\.\[\]]{{$mybb->settings['wordwrap']}})#", "$0 ", $message);
+			$new_message = preg_replace("#(?>[^\s&/<>\"\\-\.\[\]]{{$mybb->settings['wordwrap']}})#", "$0&#8203;", $message);	
 		}
+		
+		$new_message = convert_through_utf8($new_message, false);
+		
+		return $new_message;
 	}
 
 	return $message;
@@ -3742,25 +3865,37 @@
 	$find = array(
 		'm',
 		'd',
+		'D',
 		'y',
 		'Y',
 		'j',
 		'S',
 		'l',
 		'F',
+		'M',
 	);
 
 	$replace = array(
 		sprintf('%02s', $bm),
 		sprintf('%02s', $bd),
+		($wd == 2 ? my_substr($bdays[$wd], 0, 4) : ($wd == 4 ? my_substr($bdays[$wd], 0, 5) : my_substr($bdays[$wd], 0, 3))),
 		my_substr($by, 2),
 		$by,
 		($bd[0] == 0 ? my_substr($bd, 1) : $bd),
-		($db == 1 || $db == 21 || $db == 31 ? 'st' : ($db == 2 || $db == 22 ? 'nd' : ($db == 3 || $db == 23 ? 'rd' : 'th'))),
-		$bdays[$wd],
+		($bd == 1 || $bd == 21 || $bd == 31 ? 'st' : ($bd == 2 || $bd == 22 ? 'nd' : ($bd == 3 || $bd == 23 ? 'rd' : 'th'))),
+		$wd,
 		$bmonth[$bm-1],
+		($bm == 9 ? my_substr($bmonth[$bm-1], 0, 4) :  my_substr($bmonth[$bm-1], 0, 3)),
 	);
 	
+	// Do we have the full month in our output?
+	// If so there's no need for the short month
+	if(strpos($display, 'F') !== false)
+	{
+		array_pop($find);
+		array_pop($replace);
+	}
+	
 	return str_replace($find, $replace, $display);
 }
 
@@ -3798,7 +3933,7 @@
 {
 	global $db;
 
-	$query = $db->simple_select("posts", "pid", "tid='{$tid}'", array('order_by' => 'dateline', 'limit' => 1));
+	$query = $db->simple_select("posts", "pid,replyto", "tid='{$tid}'", array('order_by' => 'dateline', 'limit' => 1));
 	$post = $db->fetch_array($query);
 
 	if($post['replyto'] != 0)
@@ -3806,7 +3941,7 @@
 		$replyto_update = array(
 			"replyto" => 0
 		);
-		$db->update_query("threads", $replyto_update, "pid='{$post['pid']}'");
+		$db->update_query("posts", $replyto_update, "pid='{$post['pid']}'");
 	}
 
 	$firstpostup = array(
@@ -3825,7 +3960,7 @@
 {
     global $lang;
 
-    $string = preg_replace("#&\#(0-9]+);#", "-", $string);
+    $string = preg_replace("#&\#([0-9]+);#", "-", $string);
 
     if(strtolower($lang->settings['charset']) == "utf-8")
     {
@@ -3835,7 +3970,6 @@
 
         // Remove dodgy whitespaces
         $string = str_replace(chr(0xCA), "", $string);
-		$string = str_replace("  ", " ", $string);
     }
 	$string = trim($string);
 
@@ -3972,8 +4106,8 @@
 function unhtmlentities($string)
 {
    // Replace numeric entities
-   $string = preg_replace('~&#x([0-9a-f]+);~ei', 'chr(hexdec("\\1"))', $string);
-   $string = preg_replace('~&#([0-9]+);~e', 'chr(\\1)', $string);
+	$string = preg_replace('~&#x([0-9a-f]+);~ei', 'unichr(hexdec("\\1"))', $string);
+	$string = preg_replace('~&#([0-9]+);~e', 'unichr("\\1")', $string);
 
    // Replace literal entities
    $trans_tbl = get_html_translation_table(HTML_ENTITIES);
@@ -3983,6 +4117,39 @@
 }
 
 /**
+ * Returns any ascii to it's character (utf-8 safe).
+ *
+ * @param string The ascii to characterize.
+ * @return int The characterized ascii.
+ */
+function unichr($c)
+{
+    if($c <= 0x7F)
+	{
+        return chr($c);
+    }
+	else if($c <= 0x7FF)
+	{
+        return chr(0xC0 | $c >> 6) . chr(0x80 | $c & 0x3F);
+    }
+	else if($c <= 0xFFFF)
+	{
+        return chr(0xE0 | $c >> 12) . chr(0x80 | $c >> 6 & 0x3F)
+                                    . chr(0x80 | $c & 0x3F);
+    }
+	else if($c <= 0x10FFFF)
+	{
+        return chr(0xF0 | $c >> 18) . chr(0x80 | $c >> 12 & 0x3F)
+                                    . chr(0x80 | $c >> 6 & 0x3F)
+                                    . chr(0x80 | $c & 0x3F);
+    }
+	else
+	{
+        return false;
+    }
+}
+
+/**
  * Get the event poster.
  *
  * @param array The event data array.
@@ -4073,15 +4240,8 @@
 		// If we're in the archive, link back a directory
 		if(IN_ARCHIVE == 1)
 		{
-			global $mybb;
-			
-			if($mybb->settings['seourls'] == "yes" || ($mybb->settings['seourls'] == "auto" && $_SERVER['SEO_SUPPORT'] == 1))
-			{
 				return "<a href=\"../../".get_profile_link($uid)."\"{$target}{$onclick}>{$username}</a>";
 			}
-			
-			return "<a href=\"../".get_profile_link($uid)."\"{$target}{$onclick}>{$username}</a>";
-		}
 		elseif(IN_ADMINCP == 1)
 		{
 			return "<a href=\"../".get_profile_link($uid)."\"{$target}{$onclick}>{$username}</a>";
@@ -4238,6 +4398,10 @@
  */
 function get_calendar_week_link($calendar, $week)
 {
+	if($week < 0)
+	{
+		$week = str_replace('-', "n", $week);
+	}
 	$link = str_replace("{week}", $week, CALENDAR_URL_WEEK);
 	$link = str_replace("{calendar}", $calendar, $link);
 	return htmlspecialchars_uni($link);
@@ -4491,18 +4655,18 @@
 		}
 
 		// Work out if the user has waited long enough before letting them login again
-		if($mybb->cookies['failedlogin'] < $now - $mybb->settings['failedlogintime'] * 60)
+		if($mybb->cookies['failedlogin'] < ($now - $mybb->settings['failedlogintime'] * 60) && $mybb->user['uid'] != 0)
 		{
 			my_setcookie('loginattempts', 1);
 			my_unsetcookie('failedlogin');
 			$update_array = array(
 				'loginattempts' => 1
 			);
-			$db->update_query("sessions", $update_array, "sid = '{$session->sid}'");
+			$db->update_query("users", $update_array, "uid = '{$mybb->user['uid']}'");
 			return 1;
 		}
 		// Not waited long enough
-		else
+		else if($mybb->cookies['failedlogin'] > ($now - $mybb->settings['failedlogintime'] * 60))
 		{
 			if($fatal)
 			{
@@ -4613,8 +4777,6 @@
  */
 function build_highlight_array($terms)
 {
-	$terms = htmlspecialchars_uni($terms);
-
 	// Strip out any characters that shouldn't be included
 	$bad_characters = array(
 		"(",
@@ -4632,6 +4794,7 @@
 		$terms = explode("\"", $terms);
 		foreach($terms as $phrase)
 		{
+			$phrase = htmlspecialchars_uni($phrase);
 			if($phrase != "")
 			{
 				if($inquote)
@@ -4661,6 +4824,7 @@
 	// Otherwise just a simple search query with no phrases
 	else
 	{
+		$terms = htmlspecialchars_uni($terms);
 		$split_words = preg_split("#\s{1,}#", $terms, -1);
 		if(!is_array($split_words))
 		{
@@ -4936,8 +5100,18 @@
  * @param string The URL of the remote file
  * @return string The remote file contents.
  */
-function fetch_remote_file($url)
+function fetch_remote_file($url, $post_data=array())
 {
+	$post_body = '';
+	if(!empty($post_data))
+	{
+		foreach($post_data as $key => $val)
+		{
+			$post_body .= '&'.urlencode($key).'='.urlencode($val);
+		}
+		$post_body = ltrim($post_body, '&');
+	}
+	
 	if(function_exists("curl_init"))
 	{
 		$ch = curl_init();
@@ -4945,6 +5119,11 @@
 		curl_setopt($ch, CURLOPT_HEADER, 0);
 		curl_setopt($ch, CURLOPT_TIMEOUT, 10);
 		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
+		if(!empty($post_body))
+		{
+			curl_setopt($ch, CURLOPT_POST, 1);
+			curl_setopt($ch, CURLOPT_POSTFIELDS, $post_body);
+		}
 		$data = curl_exec($ch);
 		curl_close($ch);
 		return $data;
@@ -4974,9 +5153,28 @@
 		{
 			return false;
 		}
-		$headers = "GET {$url['path']} HTTP/1.1\r\n";
-		$headers .= "Host: {$url['host']}\r\n";
-		$headers .= "Connection: Close\r\n\r\n";
+		$headers = array();
+		if(!empty($post_body))
+		{
+			$headers[] = "POST {$url['path']} HTTP/1.0";
+			$headers[] = "Content-Length: ".strlen($post_body);
+			$headers[] = "Content-Type: application/x-www-form-urlencoded";
+		}
+		else
+		{
+			$headers[] = "GET {$url['path']} HTTP/1.0";
+		}
+		
+		$headers[] = "Host: {$url['host']}";
+		$headers[] = "Connection: Close";
+		$headers[] = "\r\n";
+		
+		if(!empty($post_body))
+		{
+			$headers[] = $post_body;
+		}
+		
+		$headers = implode("\r\n", $headers);	
 		if(!@fwrite($fp, $headers))
 		{
 			return false;
@@ -4989,10 +5187,14 @@
 		$data = explode("\r\n\r\n", $data, 2);
 		return $data[1];
 	}
-	else
+	else if(empty($post_data))
 	{
 		return @implode("", @file($url));
 	}
+	else
+	{
+		return false;
+	}
 }
 
 /**
@@ -5086,8 +5288,12 @@
 function fetch_longipv4_range($ip)
 {
 	$ip_bits = explode(".", $ip);
+	$ip_string1 = $ip_string2 = "";
 
-	if($ip == "*") return array(ip2long(0), ip2long(255));
+	if($ip == "*")
+	{
+		return array(ip2long('0.0.0.0'), ip2long('255.255.255.255'));
+	}
 
 	if(strpos($ip, ".*") === false)
 	{
@@ -5104,17 +5310,22 @@
 	// Wildcard based IP provided
 	else
 	{
+		$sep = "";
 		foreach($ip_bits as $piece)
 		{
 			if($piece == "*")
 			{
-				return array(ip2long($ip_string."0"), ip2long($ip_string."255"));
+				$ip_string1 .= $sep."0";
+				$ip_string2 .= $sep."255";
 			}
 			else
 			{
-				$ip_string .= $piece.".";
+				$ip_string1 .= $sep.$piece;
+				$ip_string2 .= $sep.$piece;
 			}
+			$sep = ".";
 		}
+		return array(ip2long($ip_string1), ip2long($ip_string2));
 	}
 }
 
@@ -5183,6 +5394,9 @@
 function expire_warnings()
 {
 	global $db;
+	
+	$users = array();
+	
 	$query = $db->query("
 		SELECT w.wid, w.uid, w.points, u.warningpoints
 		FROM ".TABLE_PREFIX."warnings w
@@ -5195,15 +5409,28 @@
 			"expired" => 1
 		);
 		$db->update_query("warnings", $updated_warning, "wid='{$warning['wid']}'");
-		$warning['warningpoints'] -= $warning['points'];
-		if($warning['warningpoints'] < 0)
+		
+		if(array_key_exists($warning['uid'], $users))
+		{
+			$users[$warning['uid']] -= $warning['points'];
+		}
+		else
+		{
+			$users[$warning['uid']] = $warning['warningpoints']-$warning['points'];
+		}
+	}
+	
+	foreach($users as $uid => $warningpoints)
+	{
+		if($warningpoints < 0)
 		{
-			$warning['warningpoints'] = 0;
+			$warningpoints = 0;
 		}
+		
 		$updated_user = array(
-			"warningpoints" => intval($warning['warningpoints'])
+			"warningpoints" => intval($warningpoints)
 		);
-		$db->update_query("users", $updated_user, "uid='{$warning['uid']}'");
+		$db->update_query("users", $updated_user, "uid='".intval($uid)."'");
 	}
 }
 
@@ -5244,16 +5471,20 @@
  * Custom chmod function to fix problems with hosts who's server configurations screw up umasks
  *
  * @param string The file to chmod
- * @param octal The mode to chmod(i.e. 0666)
+ * @param string The mode to chmod(i.e. 0666)
  */
 function my_chmod($file, $mode)
 {
+	// Passing $mode as an octal number causes strlen and substr to return incorrect values. Instead pass as a string
 	if(substr($mode, 0, 1) != '0' || strlen($mode) !== 4)
 	{
 		return false;
 	}
 	$old_umask = umask(0);
-	$result = chmod($file, $mode);
+	
+	// We convert the octal string to a decimal number because passing a octal string doesn't work with chmod
+	// and type casting subsequently removes the prepended 0 which is needed for octal numbers
+	$result = chmod($file, octdec($mode));
 	umask($old_umask);
 	return $result;
 }
@@ -5299,4 +5530,21 @@
     return @unlink($path);
 }
 
+/**
+ * Counts the number of subforums in a array([pid][disporder][fid]) starting from the pid
+ *
+ * @param array The array of forums
+ * @return integer The number of sub forums
+ */
+function subforums_count($array)
+{
+	$count = 0;
+	foreach($array as $array2)
+	{
+		$count += count($array2);
+	}
+	
+	return $count;
+}
+
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/functions_archive.php mybb_1408/inc/functions_archive.php
--- mybb_1400/inc/functions_archive.php	2008-05-03 06:43:53.000000000 +0200
+++ mybb_1408/inc/functions_archive.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_archive.php 3809 2008-05-03 04:43:53Z Tikitiki $
+ * $Id: functions_archive.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/inc/functions_calendar.php mybb_1408/inc/functions_calendar.php
--- mybb_1400/inc/functions_calendar.php	2008-07-04 01:07:21.000000000 +0200
+++ mybb_1408/inc/functions_calendar.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_calendar.php 3975 2008-07-03 23:07:21Z Tikitiki $
+ * $Id: functions_calendar.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -419,7 +419,7 @@
 		else
 		{
 			$event_date = explode("-", gmdate("j-n-Y", $event['starttime_user']));
-			$event['endtime_user'] = $event['endtime']+$offset*3600;
+			$event['endtime_user'] = $event['endtime']+($offset*3600);
 			$event['weekday_start'] = $calendar['weekstart'];
 
 			$start_day = gmmktime(0, 0, 0, $event_date[1], $event_date[0], $event_date[2]);
@@ -445,8 +445,7 @@
 			$first = "";
 			$event_date = explode("-", gmdate("j-n-Y", $range_start));
 			
-			// Get rid of hour/minutes because sometimes they cause the events to stretch into the next day
-			$range_end = gmmktime(0, 0, 0, gmdate("n", $event['endtime']), gmdate("j", $event['endtime']), gmdate("Y", $event['endtime']));
+			$range_end = gmmktime(23, 59, 59, gmdate("n", $event['endtime']), gmdate("j", $event['endtime']), gmdate("Y", $event['endtime']));
 			while($range_start < $range_end)
 			{
 				// Outside the dates we care about, break! (No unnecessary looping here!)
diff -rub mybb_1400/inc/functions_compat.php mybb_1408/inc/functions_compat.php
--- mybb_1400/inc/functions_compat.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/functions_compat.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_compat.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: functions_compat.php 4317 2009-02-04 02:30:25Z Tikitiki $
  */
 
 /**
@@ -96,7 +96,7 @@
 
 if(!function_exists('str_ireplace'))
 {
-	function build_str_ireplace(&$pattern, $k)
+	function build_str_ireplace(&$pattern)
 	{
 		$pattern = "#".preg_quote($pattern, "#")."#";
 	}
@@ -105,7 +105,7 @@
 	{
 		if(is_array($search))
 		{
-			$search = array_walk($search, 'build_str_ireplace');
+			array_walk($search, 'build_str_ireplace');
 		}
 		else
 		{
@@ -123,4 +123,61 @@
 	}
 }
 
+if(!function_exists('mb_substr'))
+{
+	/**
+	 * Multibyte safe substr function. Based off of code from http://php.net/manual/en/function.substr.php#53199
+	 *
+	 * @param string The string to cut.
+	 * @param int Where to start
+	 * @param int (optional) How much to cut
+	 * @return int The cut part of the string.
+	 */
+	function mb_substr($string, $start, $len=null)
+	{
+		// How many bytes per character does this string have? (ex. utf-8 is "3", gb2312 and big5 is "2")
+		$byte = 3;
+		$cut_string = "";
+		$count = 0;
+		$string_length = strlen($string);
+		
+		if($len == null)
+		{
+			$len = $string_length;
+		}
+		
+		for($i=0; $i < $string_length; $i++)
+		{
+			$chr = substr($string, $i, 1);
+			$ord = ord($chr);
+			
+			if(($count+1-$start) > $len)
+			{
+				break;
+			}
+			elseif($ord <= 128 && $count < $start)
+			{
+				$count++;
+			}
+			elseif($ord > 128 && $count < $start)
+			{
+				$count = $count+2;
+				$i = $i+$byte-1;
+			}
+			elseif($ord <= 128 && $count >= $start)
+			{
+				$cut_string .= $chr;
+				$count++;
+			}
+			elseif($ord > 128 && $count >= $start)
+			{
+				$cut_string .= substr($string, $i, $byte);
+				$count = $count+2;
+				$i = $i+$byte-1;
+			}
+		}
+		return $cut_string;
+	}
+}
+
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/functions_forumlist.php mybb_1408/inc/functions_forumlist.php
--- mybb_1400/inc/functions_forumlist.php	2008-07-06 19:27:56.000000000 +0200
+++ mybb_1408/inc/functions_forumlist.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_forumlist.php 3992 2008-07-06 17:27:56Z Tikitiki $
+ * $Id: functions_forumlist.php 4346 2009-04-14 07:11:03Z Tikitiki $
  */
 
 /**
@@ -53,9 +53,16 @@
 
 			// This forum has a password, and the user isn't authenticated with it - hide post information
 			$hideinfo = false;
+			$showlockicon = 0;
+			if($permissions['canviewthreads'] != 1)
+			{
+			    $hideinfo = true;
+			}
+
 			if($forum['password'] != '' && $mybb->cookies['forumpass'][$forum['fid']] != md5($mybb->user['uid'].$forum['password']))
 			{
 				$hideinfo = true;
+			    $showlockicon = 1;
 			}
 			
 			$lastpost_data = array(
@@ -121,7 +128,7 @@
 			}
 
 			// Get the lightbulb status indicator for this forum based on the lastpost
-			$lightbulb = get_forum_lightbulb($forum, $lastpost_data, $hideinfo);
+			$lightbulb = get_forum_lightbulb($forum, $lastpost_data, $showlockicon);
 
 			// Fetch the number of unapproved threads and posts for this forum
 			$unapproved = get_forum_unapproved($forum);
@@ -132,6 +139,8 @@
 			}
 
 			// Sanitize name and description of forum.
+			$forum['name'] = preg_replace("#&(?!\#[0-9]+;)#si", "&amp;", $forum['name']); // Fix & but allow unicode
+			$forum['description'] = preg_replace("#&(?!\#[0-9]+;)#si", "&amp;", $forum['description']); // Fix & but allow unicode
 			$forum['name'] = preg_replace("#&([^\#])(?![a-z1-4]{1,10};)#i", "&#038;$1", $forum['name']);
 			$forum['description'] = preg_replace("#&([^\#])(?![a-z1-4]{1,10};)#i", "&#038;$1", $forum['description']);
 
@@ -163,9 +172,9 @@
 				++$donecount;
 				if($donecount == $mybb->settings['subforumsindex'])
 				{
-					if(count($parent) > $donecount)
+					if(subforums_count($fcache[$pid]) > $donecount)
 					{
-						$forum_list .= $comma.$lang->sprintf($lang->more_subforums, (count($parent) - $donecount));
+						$forum_list .= $comma.$lang->sprintf($lang->more_subforums, (subforums_count($fcache[$pid]) - $donecount));
 					}
 				}
 				continue;
@@ -215,6 +224,7 @@
 				}
 
 				$forum_viewers_text = '';
+				$forum_viewers_text_plain = '';
 				if($mybb->settings['showforumviewing'] != 0 && $forum['viewers'] > 0)
 				{
 					if($forum['viewers'] == 1)
@@ -225,6 +235,7 @@
 					{
 						$forum_viewers_text = $lang->sprintf($lang->viewing_multiple, $forum['viewers']);
 					}
+					$forum_viewers_text_plain = $forum_viewers_text;
 					$forum_viewers_text = "<span class=\"smalltext\">{$forum_viewers_text}</span>";
 				}
 			}
diff -rub mybb_1400/inc/functions_image.php mybb_1408/inc/functions_image.php
--- mybb_1400/inc/functions_image.php	2008-07-31 07:19:05.000000000 +0200
+++ mybb_1408/inc/functions_image.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_image.php 4054 2008-07-31 05:19:05Z Tikitiki $
+ * $Id: functions_image.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -120,7 +120,7 @@
 				@imagepng($thumbim, $path."/".$filename);
 				break;
 		}
-		@my_chmod($path."/".$filename, 0666);
+		@my_chmod($path."/".$filename, '0666');
 		@imagedestroy($thumbim);
 		$thumb['code'] = 1;
 		$thumb['filename'] = $filename;
@@ -178,7 +178,22 @@
 	
 	if($thumbnail_memory > $free_memory)
 	{
-		@ini_set("memory_limit", $memory_limit+$thumbnail_memory);
+		if($matches[1] && $matches[2])
+		{
+			switch($matches[2])
+			{
+				case "k":
+					$memory_limit = (($memory_limit+$thumbnail_memory) / 1024)."K";
+					break;
+				case "m":
+					$memory_limit = (($memory_limit+$thumbnail_memory) / 1048576)."M";
+					break;
+				case "g":
+					$memory_limit = (($memory_limit+$thumbnail_memory) / 1073741824)."G";
+			}
+		}
+		
+		@ini_set("memory_limit", $memory_limit);
 	}
 }
 
diff -rub mybb_1400/inc/functions_indicators.php mybb_1408/inc/functions_indicators.php
--- mybb_1400/inc/functions_indicators.php	2008-06-20 08:35:10.000000000 +0200
+++ mybb_1408/inc/functions_indicators.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_indicators.php 3928 2008-06-20 06:35:10Z Tikitiki $
+ * $Id: functions_indicators.php 4335 2009-03-22 18:34:20Z Tikitiki $
  */
 
 /**
@@ -26,6 +26,8 @@
 		switch($db->type)
 		{
 			case "pgsql":
+			case "sqlite2":
+			case "sqlite3":
 				$db->shutdown_query($db->build_replace_query("threadsread", array('tid' => $tid, 'uid' => $mybb->user['uid'], 'dateline' => TIME_NOW), "tid"));
 				break;
 			default:
@@ -189,13 +191,30 @@
 			$done = 0;
 			foreach(array_keys($forums) as $fid)
 			{
+				switch($db->type)
+				{
+					case "pgsql":
+						$mark_query[] = array('fid' => $fid, 'uid' => $mybb->user['uid'], 'dateline' => TIME_NOW);
+						break;
+					default:
 				if($mark_query != '') $mark_query .= ', ';
-
 				$mark_query .= "('{$fid}', '{$mybb->user['uid']}', '".TIME_NOW."')";
+				}
 				++$done;
+				
 				// Only do this in loops of $update_count, save query time
 				if($done % $update_count)
 				{
+					switch($db->type)
+					{
+						case "pgsql":
+							foreach($mark_query as $replace_query)
+							{
+								$db->shutdown_query($db->build_replace_query("forumsread", $replace_query, "fid"));
+							}
+							$mark_query = array();
+							break;
+						default:
 					$db->shutdown_query("
 						REPLACE INTO ".TABLE_PREFIX."forumsread (fid, uid, dateline)
 						VALUES {$mark_query}
@@ -203,8 +222,19 @@
 					$mark_query = '';
 				}
 			}
+			}
+			
 			if($mark_query != '')
 			{
+				switch($db->type)
+				{
+					case "pgsql":
+						foreach($mark_query as $replace_query)
+						{
+							$db->shutdown_query($db->build_replace_query("forumsread", $replace_query, "fid"));
+						}
+						break;
+					default:
 				$db->shutdown_query("
 					REPLACE INTO ".TABLE_PREFIX."forumsread (fid, uid, dateline)
 					VALUES {$mark_query}
@@ -212,6 +242,7 @@
 			}
 		}
 	}
+	}
 	else
 	{
 		my_setcookie("mybb[lastvisit]", TIME_NOW);
diff -rub mybb_1400/inc/functions_massmail.php mybb_1408/inc/functions_massmail.php
--- mybb_1400/inc/functions_massmail.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/functions_massmail.php	2009-06-26 06:22:11.000000000 +0200
@@ -24,7 +24,7 @@
 		return '';
 	}
 
-	$search_sql = '1=1';
+	$search_sql = 'u.allownotices=1';
 
 	// List of valid LIKE search fields
 	$user_like_fields = array("username", "email");
@@ -54,7 +54,7 @@
 				default:
 					$direction = "=";
 			}
-			$search_sql .= " AND u.{$search_field}{$direction_field}'".$db->escape_string_like($conditions[$search_field])."'";
+			$search_sql .= " AND u.{$search_field}{$direction}'".$db->escape_string_like($conditions[$search_field])."'";
 		}
 	}
 
@@ -74,11 +74,12 @@
 				case "sqlite3":
 				case "sqlite2":
 					$additional_sql .= " OR ','||additionalgroups||',' LIKE '%,{$usergroup},%'";
+					break;
 				default:
 					$additional_sql .= " OR CONCAT(',',additionalgroups,',') LIKE '%,{$usergroup},%'";
 			}
 		}
-		$search_sql .= " AND (u.usergroup IN (".implode(",", $conditions['usergroup']).") {$additional_sql})";
+		$search_sql .= " AND (u.usergroup IN (".$db->escape_string(implode(",", $conditions['usergroup'])).") {$additional_sql})";
 	}
 
 	return $search_sql;
diff -rub mybb_1400/inc/functions_modcp.php mybb_1408/inc/functions_modcp.php
--- mybb_1400/inc/functions_modcp.php	2008-07-18 04:37:49.000000000 +0200
+++ mybb_1408/inc/functions_modcp.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_modcp.php 4024 2008-07-18 02:37:49Z Tikitiki $
+ * $Id: functions_modcp.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -23,12 +23,12 @@
 	$user_permissions = user_permissions($uid);
 
 	// Current user is only a local moderator or use with ModCP permissions, cannot manage super mods or admins
-	if($mybb->usergroup['issupermod'] == 0 && ($user_permissions['issupermod'] == 1 || $user_permissions['canadmincp'] == 1))
+	if($mybb->usergroup['issupermod'] == 0 && ($user_permissions['issupermod'] == 1 || $user_permissions['cancp'] == 1))
 	{
 		return false;
 	}
 	// Current user is a super mod or is an administrator
-	else if($mybb->usergroup['issupermod'] == 1 && $user_permissions['canadmincp'] == 1 || (is_super_admin($uid) && !is_super_admin($mybb->user['uid'])))
+	else if($user_permissions['cancp'] == 1 && ($mybb->usergroup['cancp'] != 1 || (is_super_admin($uid) && !is_super_admin($mybb->user['uid'])))) 
 	{
 		return false;
 	}
@@ -57,7 +57,7 @@
 	{
 		foreach($forum_cache as $forum)
 		{
-			$forums_by_parent[$forum['pid']][$val['disporder']][$forum['fid']] = $forum;
+			$forums_by_parent[$forum['pid']][$forum['disporder']][$forum['fid']] = $forum;
 		}
 	}
 
diff -rub mybb_1400/inc/functions_online.php mybb_1408/inc/functions_online.php
--- mybb_1400/inc/functions_online.php	2008-08-03 02:37:09.000000000 +0200
+++ mybb_1408/inc/functions_online.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_online.php 4058 2008-08-03 00:37:09Z Tikitiki $
+ * $Id: functions_online.php 4330 2009-03-16 02:17:06Z Tikitiki $
  */
 
 $uid_list = $aid_list = $pid_list = $tid_list = $fid_list = $eid_list = array();
@@ -17,7 +17,7 @@
  * @param string The location (URL) of the user.
  * @return array Array of location and activity information
  */
-function fetch_wol_activity($location)
+function fetch_wol_activity($location, $nopermission=false)
 {
 	global $uid_list, $aid_list, $pid_list, $tid_list, $fid_list, $eid_list, $plugins, $user, $parameters;
 
@@ -34,7 +34,7 @@
 	}
 	if($split_loc[1])
 	{
-		$temp = explode("&", my_substr($split_loc[1], 1));
+		$temp = explode("&amp;", my_substr($split_loc[1], 1));
 		foreach($temp as $param)
 		{
 			$temp2 = explode("=", $param, 2);
@@ -42,6 +42,12 @@
 		}
 	}
 
+	if($nopermission)
+	{
+		$filename = "nopermission";
+	}
+
+
 	switch($filename)
 	{
 		case "announcements":
@@ -256,7 +262,21 @@
 			}
 			else
 			{
-				$user_activity['activity'] = $parameters['action'];
+				$accepted_parameters = array("do_editpoll", "editpoll", "newpoll", "do_newpoll", "showresults", "vote");
+			
+				foreach($accepted_parameters as $action)
+				{
+					if($parameters['action'] == $action)
+					{
+						$user_activity['activity'] = $action;
+						break;
+					}
+				}
+				
+				if(!$user_activity['activity'])
+				{
+					$user_activity['activity'] = "showresults";
+				}
 			}
 			break;
 		case "printthread":
@@ -266,12 +286,13 @@
 			}
 			$user_activity['activity'] = "printthread";
 			$user_activity['tid'] = $parameters['tid'];
+			break;
 		case "private":
 			if($parameters['action'] == "send" || $parameters['action'] == "do_send")
 			{
 				$user_activity['activity'] = "private_send";
 			}
-			elseif($parameters['action'] == "show")
+			elseif($parameters['action'] == "read")
 			{
 				$user_activity['activity'] = "private_read";
 			}
@@ -406,13 +427,14 @@
 			break;
 		case "nopermission":
 			$user_activity['activity'] = "nopermission";
+			$user_activity['nopermission'] = 1;
 			break;
 		default:
 			$user_activity['activity'] = "unknown";
 			break;
 	}
 	
-	$user_activity['location'] = $location;
+	$user_activity['location'] = htmlspecialchars_uni($location);
 	
 	$plugins->run_hooks_by_ref("fetch_wol_activity_end", $user_activity);
 	
@@ -425,10 +447,10 @@
  * @param array Array containing activity and essential IDs.
  * @return string Location name for the activity being performed.
  */
-function build_friendly_wol_location($user_activity, $return=false)
+function build_friendly_wol_location($user_activity)
 {
 	global $db, $lang, $uid_list, $aid_list, $pid_list, $tid_list, $fid_list, $eid_list, $plugins, $parser, $mybb;
-	global $threads, $forums, $forums_linkto, $posts, $events, $users, $attachments;
+	global $threads, $forums, $forums_linkto, $posts, $events, $usernames, $attachments;
 
 	// Fetch forum permissions for this user
 	$unviewableforums = get_unviewable_forums();
@@ -438,13 +460,13 @@
 	}
 
 	// Fetch any users
-	if(!is_array($users) && count($uid_list) > 0)
+	if(!is_array($usernames) && count($uid_list) > 0)
 	{
 		$uid_sql = implode(",", $uid_list);
 		$query = $db->simple_select("users", "uid,username", "uid IN ($uid_sql)");
 		while($user = $db->fetch_array($query))
 		{
-			$users[$user['uid']] = $user['username'];
+			$usernames[$user['uid']] = $user['username'];
 		}
 	}
 
@@ -511,7 +533,7 @@
 	}
 
 	// Now we've got everything we need we can put a name to the location
-	switch($user_activity['activity']['activity'])
+	switch($user_activity['activity'])
 	{
 		// announcement.php functions
 		case "announcements":
@@ -592,9 +614,9 @@
 			$location_name = $lang->activating_account;
 			break;
 		case "member_profile":
-			if($users[$user_activity['uid']])
+			if($usernames[$user_activity['uid']])
 			{
-				$location_name = $lang->sprintf($lang->viewing_profile2, get_profile_link($user_activity['uid']), $users[$user_activity['uid']]);
+				$location_name = $lang->sprintf($lang->viewing_profile2, get_profile_link($user_activity['uid']), $usernames[$user_activity['uid']]);
 			}
 			else
 			{
@@ -757,9 +779,16 @@
 		case "vote":
 			$location_name = $lang->voting_poll;
 			break;
-		// postings.php functions
-		case "postings":
-			$location_name = $lang->using_modtools;
+		// printthread.php functions
+		case "printthread":
+			if($threads[$user_activity['tid']])
+			{
+				$location_name = $lang->sprintf($lang->printing_thread2, get_thread_link($user_activity['tid']), $threads[$user_activity['tid']]);
+			}
+			else
+			{
+				$location_name = $lang->printing_thread;
+			}
 			break;
 		// private.php functions
 		case "private_send":
@@ -814,6 +843,9 @@
 		case "usercp_profile":
 			$location_name = $lang->updating_profile;
 			break;
+		case "usercp_editlists":
+			$location_name = $lang->managing_buddyignorelist;
+			break;
 		case "usercp_options":
 			$location_name = $lang->updating_options;
 			break;
@@ -890,7 +922,7 @@
  */
 function build_wol_row($user)
 {
-	global $mybb, $lang, $templates, $themes, $session;
+	global $mybb, $lang, $templates, $theme, $session;
 
 	// We have a registered user
 	if($user['uid'] > 0)
@@ -926,7 +958,7 @@
 	$online_time = my_date($mybb->settings['timeformat'], $user['time']);
 	
 	// Fetch the location name for this users activity
-	$location = build_friendly_wol_location($user);
+	$location = build_friendly_wol_location($user['activity']);
 
 	// Can view IPs, then fetch the IP template
 	if($mybb->usergroup['canviewonlineips'] == 1)
diff -rub mybb_1400/inc/functions_post.php mybb_1408/inc/functions_post.php
--- mybb_1400/inc/functions_post.php	2008-07-29 17:45:49.000000000 +0200
+++ mybb_1408/inc/functions_post.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_post.php 4052 2008-07-29 15:45:49Z Tikitiki $
+ * $Id: functions_post.php 4342 2009-04-07 02:23:30Z Tikitiki $
  */
 
 /**
@@ -103,6 +103,16 @@
 			break;
 	}
 
+	// Sanatize our custom profile fields for use in templates, if people choose to use them
+	foreach($post as $post_field => $field_value)
+	{
+	    if(substr($post_field, 0, 3) != 'fid')
+	    {
+	        continue;
+	    }
+	    $post[$post_field] = htmlspecialchars_uni($field_value);
+	}
+	
 	if(!$postcounter)
 	{ // Used to show the # of the post
 		if($page > 1)
@@ -289,7 +299,7 @@
 			
 			if($avatar_dimensions[0] && $avatar_dimensions[1])
 			{
-				list($max_width, $max_height) = explode("x", $mybb->settings['postmaxavatarsize']);
+				list($max_width, $max_height) = explode("x", my_strtolower($mybb->settings['postmaxavatarsize']));
 			 	if($avatar_dimensions[0] > $max_width || $avatar_dimensions[1] > $max_height)
 				{
 					require_once MYBB_ROOT."inc/functions_image.php";
@@ -699,11 +709,11 @@
 		{
 			if($validationcount == 1)
 			{
-				$lang->postbit_unapproved_attachments = $lang->postbit_unapproved_attachment;
+				$postbit_unapproved_attachments = $lang->postbit_unapproved_attachment;
 			}
 			else
 			{
-				$lang->postbit_unapproved_attachments = $lang->sprintf($lang->postbit_unapproved_attachments, $validationcount);
+				$postbit_unapproved_attachments = $lang->sprintf($lang->postbit_unapproved_attachments, $validationcount);
 			}
 			eval("\$post['attachmentlist'] .= \"".$templates->get("postbit_attachments_attachment_unapproved")."\";");
 		}
diff -rub mybb_1400/inc/functions_rebuild.php mybb_1408/inc/functions_rebuild.php
--- mybb_1400/inc/functions_rebuild.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/functions_rebuild.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_rebuild.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: functions_rebuild.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/inc/functions_search.php mybb_1408/inc/functions_search.php
--- mybb_1400/inc/functions_search.php	2008-06-15 06:19:42.000000000 +0200
+++ mybb_1408/inc/functions_search.php	2009-06-26 07:27:07.000000000 +0200
@@ -1,12 +1,12 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_search.php 3914 2008-06-15 04:19:42Z Tikitiki $
+ * $Id: functions_search.php 4384 2009-06-19 11:49:42Z Tomm $
  */
 
 /**
@@ -171,6 +171,17 @@
 	$keywords = str_replace("*", "%", $keywords);
 	$keywords = preg_replace("#([\[\]\|\.\,:'])#s", " ", $keywords);
 	$keywords = preg_replace("#\s+#s", " ", $keywords);
+
+	// Search for "and" or "or" and remove if it's at the beginning
+	if(my_strpos($keywords, "or") !== false && my_strpos($keywords, "or") == 0)
+	{
+		$keywords = substr_replace($keywords, "", 0, 2);
+	}
+	if(my_strpos($keywords, "and") !== false && my_strpos($keywords, "and") == 0)
+	{
+		$keywords = substr_replace($keywords, "", 0, 3);
+	}
+
 	return trim($keywords);
 }
 
@@ -459,7 +470,7 @@
 							SELECT DISTINCT f.fid 
 							FROM ".TABLE_PREFIX."forums f 
 							LEFT JOIN ".TABLE_PREFIX."forumpermissions p ON (f.fid=p.fid AND p.gid='".$mybb->user['usergroup']."')
-							WHERE (','||parentlist||',' LIKE ',%{$forum}%,') > 0 AND active!=0 AND (p.fid IS NULL OR p.cansearch=1)
+							WHERE (','||parentlist||',' LIKE ',%{$forum}%,') = true AND active!=0 AND (p.fid IS NULL OR p.cansearch=1)
 						");
 						break;
 					case "sqlite3":
diff -rub mybb_1400/inc/functions_task.php mybb_1408/inc/functions_task.php
--- mybb_1400/inc/functions_task.php	2008-07-19 13:04:48.000000000 +0200
+++ mybb_1408/inc/functions_task.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_task.php 4028 2008-07-19 11:04:48Z ZiNgaBuRgA $
+ * $Id: functions_task.php 4344 2009-04-12 18:58:39Z Tikitiki $
  */
 
 /**
@@ -57,7 +57,7 @@
 	{
 		if($task['logging'] == 1)
 		{
-			add_task_log($task['id'], $lang->missing_task);
+			add_task_log($task, $lang->missing_task);
 		}
 		$cache->update_tasks();
 		return false;
@@ -216,14 +216,14 @@
 		{
 			if(build_next_run_bit($task['weekday'], $current_weekday) != false)
 			{
-				$next_weekday - build_next_run_bit($task['weekday'], $current_weekday);
+				$next_weekday = build_next_run_bit($task['weekday'], $current_weekday);
 			}
 			else
 			{
 				$next_weekday = fetch_first_run_time($task['weekday']);
 			}
 			$next_day = $current_day + ($next_weekday-$current_weekday);
-			if($next_day < $current_day)
+			if($next_day <= $current_day)
 			{
 				$next_day += 7;
 			}
diff -rub mybb_1400/inc/functions_upload.php mybb_1408/inc/functions_upload.php
--- mybb_1400/inc/functions_upload.php	2008-08-04 07:29:43.000000000 +0200
+++ mybb_1408/inc/functions_upload.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: functions_upload.php 4036 2008-07-24 11:35:12Z ZiNgaBuRgA $
+ * $Id: functions_upload.php 4337 2009-03-30 01:21:51Z Tikitiki $
  */
 
 
@@ -36,16 +36,26 @@
 	$plugins->run_hooks("remove_attachment_do_delete", $attachment);
 	
 	$db->delete_query("attachments", "aid='{$attachment['aid']}'");
-	@unlink($mybb->settings['uploadspath']."/".$attachment['attachname']);
+	
+	if(defined('IN_ADMINCP'))
+	{
+	    $uploadpath = '../'.$mybb->settings['uploadspath'];
+	}
+	else
+	{
+	    $uploadpath = $mybb->settings['uploadspath'];
+	}
+	
+	@unlink($uploadpath."/".$attachment['attachname']);
 	if($attachment['thumbnail'])
 	{
-		@unlink($mybb->settings['uploadspath']."/".$attachment['thumbnail']);
+		@unlink($uploadpath."/".$attachment['thumbnail']);
 	}
 
 	$date_directory = explode('/', $attachment['attachname']);
-	if(@is_dir($mybb->settings['uploadspath']."/".$date_directory[0]))
+	if(@is_dir($uploadpath."/".$date_directory[0]))
 	{
-		@rmdir($mybb->settings['uploadspath']."/".$date_directory[0]);
+		@rmdir($uploadpath."/".$date_directory[0]);
 	}
 
 	if($attachment['visible'] == 1 && $pid)
@@ -79,6 +89,15 @@
 		$query = $db->simple_select("attachments", "*", "pid='$pid'");
 	}
 
+	if(defined('IN_ADMINCP'))
+	{
+	    $uploadpath = '../'.$mybb->settings['uploadspath'];
+	}
+	else
+	{
+	    $uploadpath = $mybb->settings['uploadspath'];
+	}
+
 	$num_attachments = 0;
 	while($attachment = $db->fetch_array($query))
 	{
@@ -91,16 +110,16 @@
 		
 		$db->delete_query("attachments", "aid='".$attachment['aid']."'");
 		
-		@unlink($mybb->settings['uploadspath']."/".$attachment['attachname']);
+		@unlink($uploadpath."/".$attachment['attachname']);
 		if($attachment['thumbnail'])
 		{
-			@unlink($mybb->settings['uploadspath']."/".$attachment['thumbnail']);
+			@unlink($uploadpath."/".$attachment['thumbnail']);
 		}
 
 		$date_directory = explode('/', $attachment['attachname']);
-		if(@is_dir($mybb->settings['uploadspath']."/".$date_directory[0]))
+		if(@is_dir($uploadpath."/".$date_directory[0]))
 		{
-			@rmdir($mybb->settings['uploadspath']."/".$date_directory[0]);
+			@rmdir($uploadpath."/".$date_directory[0]);
 		}
 	}
 	
@@ -249,7 +268,7 @@
 				$ret['error'] = $lang->sprintf($lang->error_avatartoobig, $maxwidth, $maxheight);
 				if($mybb->settings['avatarresizing'] == "user")
 				{
-					$ret['error'] .= "<br /<br />".$lang->error_avataruserresize;
+					$ret['error'] .= "<br /><br />".$lang->error_avataruserresize;
 				}
 				@unlink($avatarpath."/".$filename);
 				return $ret;
@@ -385,7 +404,7 @@
 	}
 
 	// Check if an attachment with this name is already in the post
-	$query = $db->simple_select("attachments", "*", "filename='".$db->escape_string($attachment['name'])."' AND (posthash='$posthash' OR (pid='$pid' AND pid!='0'))");
+	$query = $db->simple_select("attachments", "*", "filename='".$db->escape_string($attachment['name'])."' AND (posthash='$posthash' OR (pid='".intval($pid)."' AND pid!='0'))");
 	$prevattach = $db->fetch_array($query);
 	if($prevattach['aid'])
 	{
@@ -404,10 +423,24 @@
 			$month_dir = '';
 		}
 	}    
+	
+	// If safe_mode is enabled, don't attempt to use the monthly directories as it won't work
+	if(ini_get('safe_mode') == 1 || strtolower(ini_get('safe_mode')) == 'on')
+	{
+		$month_dir = '';
+	}
+	
 	// All seems to be good, lets move the attachment!
-	$filename = "post_".$mybb->user['uid']."_".TIME_NOW.".attach";
+	$filename = "post_".$mybb->user['uid']."_".TIME_NOW."_".md5(uniqid(rand(), true)).".attach";
+	
 	$file = upload_file($attachment, $mybb->settings['uploadspath']."/".$month_dir, $filename);
 
+	// Failed to create the attachment in the monthly directory, just throw it in the main directory
+	if($file['error'] && $month_dir)
+	{
+		$file = upload_file($attachment, $mybb->settings['uploadspath'].'/', $filename);		
+	}
+
 	if($month_dir)
 	{
 		$filename = $month_dir."/".$filename;
@@ -555,7 +588,7 @@
 		$upload['error'] = 2;
 		return $upload;
 	}
-	@my_chmod($path."/".$filename, 0644);
+	@my_chmod($path."/".$filename, '0644');
 	$upload['filename'] = $filename;
 	$upload['path'] = $path;
 	$upload['type'] = $file['type'];
diff -rub mybb_1400/inc/functions_user.php mybb_1408/inc/functions_user.php
--- mybb_1400/inc/functions_user.php	2007-10-02 03:19:47.000000000 +0200
+++ mybb_1408/inc/functions_user.php	2009-06-26 06:22:11.000000000 +0200
@@ -52,7 +52,7 @@
 {
 	global $db;
 	
-	$query = $db->simple_select("users", "uid,username,password,salt,loginkey,remember,coppauser", "username='".$db->escape_string($username)."'", array('limit' => 1));
+	$query = $db->simple_select("users", "uid,username,password,salt,loginkey,remember,coppauser,usergroup", "username='".$db->escape_string($username)."'", array('limit' => 1));
 	$user = $db->fetch_array($query);
 	if(!$user['uid'])
 	{
@@ -81,7 +81,7 @@
 	}
 	if(!$user['password'])
 	{
-		$query = $db->simple_select("users", "uid,username,password,salt,loginkey", "uid='".intval($uid)."'", array('limit' => 1));
+		$query = $db->simple_select("users", "uid,username,password,salt,loginkey,usergroup", "uid='".intval($uid)."'", array('limit' => 1));
 		$user = $db->fetch_array($query);
 	}
 	if(!$user['salt'])
diff -rub mybb_1400/inc/init.php mybb_1408/inc/init.php
--- mybb_1400/inc/init.php	2008-05-04 17:34:12.000000000 +0200
+++ mybb_1408/inc/init.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: init.php 3816 2008-05-04 15:34:12Z Tikitiki $
+ * $Id: init.php 4305 2009-01-02 08:05:39Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -81,7 +81,24 @@
 }
 
 require_once MYBB_ROOT."inc/db_".$config['database']['type'].".php";
-$db = new databaseEngine;
+
+switch($config['database']['type'])
+{
+	case "sqlite3":
+		$db = new DB_SQLite3;
+		break;
+	case "sqlite2":
+		$db = new DB_SQLite2;
+		break;
+	case "pgsql":
+		$db = new DB_PgSQL;
+		break;
+	case "mysqli":
+		$db = new DB_MySQLi;
+		break;
+	default:
+		$db = new DB_MySQL;
+}
 
 // Check if our DB engine is loaded
 if(!extension_loaded($db->engine))
@@ -162,6 +179,7 @@
 $settings['wolcutoff'] = $settings['wolcutoffmins']*60;
 $settings['bbname_orig'] = $settings['bbname'];
 $settings['bbname'] = strip_tags($settings['bbname']);
+$settings['orig_bblanguage'] = $settings['bblanguage'];
 
 // Fix for people who for some specify a trailing slash on the board URL
 if(substr($settings['bburl'], -1) == "/")
@@ -169,6 +187,13 @@
 	$settings['bburl'] = my_substr($settings['bburl'], 0, -1);
 }
 
+$settings['internal'] = $cache->read("internal_settings");
+if(!$settings['internal']['encryption_key'])
+{
+	$cache->update("internal_settings", array('encryption_key' => random_str(32)));
+	$settings['internal'] = $cache->read("internal_settings");
+}
+
 $mybb->settings = &$settings;
 $mybb->parse_cookies();
 $mybb->cache = &$cache;
diff -rub mybb_1400/inc/languages/english/admin/config_attachment_types.lang.php mybb_1408/inc/languages/english/admin/config_attachment_types.lang.php
--- mybb_1400/inc/languages/english/admin/config_attachment_types.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_attachment_types.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright  2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_attachment_types.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_attachment_types.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['attachment_types'] = "Attachment Types";
diff -rub mybb_1400/inc/languages/english/admin/config_badwords.lang.php mybb_1408/inc/languages/english/admin/config_badwords.lang.php
--- mybb_1400/inc/languages/english/admin/config_badwords.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_badwords.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_badwords.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_badwords.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['bad_words'] = "Word Filters";
diff -rub mybb_1400/inc/languages/english/admin/config_banning.lang.php mybb_1408/inc/languages/english/admin/config_banning.lang.php
--- mybb_1400/inc/languages/english/admin/config_banning.lang.php	2008-07-20 22:56:39.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_banning.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_banning.lang.php 4031 2008-07-20 20:56:39Z Tikitiki $
+ * $Id: config_banning.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['banning'] = "Banning";
diff -rub mybb_1400/inc/languages/english/admin/config_calendars.lang.php mybb_1408/inc/languages/english/admin/config_calendars.lang.php
--- mybb_1400/inc/languages/english/admin/config_calendars.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_calendars.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright  2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_calendars.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_calendars.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['calendars'] = "Calendars";
diff -rub mybb_1400/inc/languages/english/admin/config_help_documents.lang.php mybb_1408/inc/languages/english/admin/config_help_documents.lang.php
--- mybb_1400/inc/languages/english/admin/config_help_documents.lang.php	2008-07-07 23:42:29.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_help_documents.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_help_documents.lang.php 3998 2008-07-07 21:42:29Z Tikitiki $
+ * $Id: config_help_documents.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['help_documents'] = "Help Documents";
diff -rub mybb_1400/inc/languages/english/admin/config_languages.lang.php mybb_1408/inc/languages/english/admin/config_languages.lang.php
--- mybb_1400/inc/languages/english/admin/config_languages.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_languages.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_languages.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_languages.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['languages'] = "Languages";
diff -rub mybb_1400/inc/languages/english/admin/config_mod_tools.lang.php mybb_1408/inc/languages/english/admin/config_mod_tools.lang.php
--- mybb_1400/inc/languages/english/admin/config_mod_tools.lang.php	2008-06-16 06:00:58.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_mod_tools.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_mod_tools.lang.php 3922 2008-06-16 04:00:58Z Tikitiki $
+ * $Id: config_mod_tools.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['mod_tools'] = "Moderator Tools";
diff -rub mybb_1400/inc/languages/english/admin/config_module_meta.lang.php mybb_1408/inc/languages/english/admin/config_module_meta.lang.php
--- mybb_1400/inc/languages/english/admin/config_module_meta.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_module_meta.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_module_meta.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: config_module_meta.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['configuration'] = "Configuration";
diff -rub mybb_1400/inc/languages/english/admin/config_mycode.lang.php mybb_1408/inc/languages/english/admin/config_mycode.lang.php
--- mybb_1400/inc/languages/english/admin/config_mycode.lang.php	2008-06-16 06:00:58.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_mycode.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_mycode.lang.php 3922 2008-06-16 04:00:58Z Tikitiki $
+ * $Id: config_mycode.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['custom_mycode'] = "Custom MyCode";
diff -rub mybb_1400/inc/languages/english/admin/config_plugins.lang.php mybb_1408/inc/languages/english/admin/config_plugins.lang.php
--- mybb_1400/inc/languages/english/admin/config_plugins.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_plugins.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_plugins.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_plugins.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['plugins'] = "Plugins";
diff -rub mybb_1400/inc/languages/english/admin/config_post_icons.lang.php mybb_1408/inc/languages/english/admin/config_post_icons.lang.php
--- mybb_1400/inc/languages/english/admin/config_post_icons.lang.php	2008-06-16 06:00:58.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_post_icons.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright  2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_post_icons.lang.php 3922 2008-06-16 04:00:58Z Tikitiki $
+ * $Id: config_post_icons.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['post_icons'] = "Post Icons";
diff -rub mybb_1400/inc/languages/english/admin/config_profile_fields.lang.php mybb_1408/inc/languages/english/admin/config_profile_fields.lang.php
--- mybb_1400/inc/languages/english/admin/config_profile_fields.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_profile_fields.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_profile_fields.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_profile_fields.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['custom_profile_fields'] = "Custom Profile Fields";
diff -rub mybb_1400/inc/languages/english/admin/config_settings.lang.php mybb_1408/inc/languages/english/admin/config_settings.lang.php
--- mybb_1400/inc/languages/english/admin/config_settings.lang.php	2008-07-01 05:04:10.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_settings.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_settings.lang.php 3969 2008-07-01 03:04:10Z Tikitiki $
+ * $Id: config_settings.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['board_settings'] = "Board Settings";
@@ -32,7 +32,7 @@
 $l['select'] = "Selection Box";
 $l['radio'] = "Radio Buttons";
 $l['checkbox'] = "Checkboxes";
-$l['language'] = "Language Selection Box";
+$l['language_selection_box'] = "Language Selection Box";
 $l['adminlanguage'] = "Administration Language Selection Box";
 $l['cpstyle'] = "Control Panel Style Selection Box";
 $l['php'] = "Evaluated PHP";
diff -rub mybb_1400/inc/languages/english/admin/config_smilies.lang.php mybb_1408/inc/languages/english/admin/config_smilies.lang.php
--- mybb_1400/inc/languages/english/admin/config_smilies.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_smilies.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright  2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_smilies.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_smilies.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['smilies'] = "Smilies";
diff -rub mybb_1400/inc/languages/english/admin/config_spiders.lang.php mybb_1408/inc/languages/english/admin/config_spiders.lang.php
--- mybb_1400/inc/languages/english/admin/config_spiders.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_spiders.lang.php	2009-06-26 07:27:30.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright  2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_spiders.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_spiders.lang.php 4365 2009-05-04 02:59:54Z Tikitiki $
  */
  
 $l['spiders_bots'] = "Spiders / Bots";
@@ -22,7 +22,7 @@
 $l['name_desc'] = "Enter the name of this bot which you want to identify it by";
 $l['user_agent'] = "User Agent String";
 $l['user_agent_desc'] = "Enter the string which will be matched against the bots user agent (partial matches are accepted)";
-$l['language'] = "Language";
+$l['language_str'] = "Language";
 $l['language_desc'] = "Select the language pack the bot will use when viewing the board.";
 $l['theme'] = "Theme";
 $l['theme_desc'] = "Select the theme the bot will use when viewing the board.";
diff -rub mybb_1400/inc/languages/english/admin/config_warning.lang.php mybb_1408/inc/languages/english/admin/config_warning.lang.php
--- mybb_1400/inc/languages/english/admin/config_warning.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/config_warning.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright  2008 MyBB Group, All Rights Reserved
  * 
- * $Id: config_warning.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: config_warning.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['warning_system'] = "Warning System";
diff -rub mybb_1400/inc/languages/english/admin/forum_akismet.lang.php mybb_1408/inc/languages/english/admin/forum_akismet.lang.php
--- mybb_1400/inc/languages/english/admin/forum_akismet.lang.php	2008-06-29 00:39:05.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/forum_akismet.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: forum_akismet.lang.php 3962 2008-06-28 22:39:05Z Tikitiki $
+ * $Id: forum_akismet.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['akismet'] = "Akismet";
diff -rub mybb_1400/inc/languages/english/admin/forum_attachments.lang.php mybb_1408/inc/languages/english/admin/forum_attachments.lang.php
--- mybb_1400/inc/languages/english/admin/forum_attachments.lang.php	2008-07-13 18:53:06.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/forum_attachments.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  *
- * $Id: forum_attachments.lang.php 4017 2008-07-13 16:53:06Z Tikitiki $
+ * $Id: forum_attachments.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Tabs
diff -rub mybb_1400/inc/languages/english/admin/forum_moderation_queue.lang.php mybb_1408/inc/languages/english/admin/forum_moderation_queue.lang.php
--- mybb_1400/inc/languages/english/admin/forum_moderation_queue.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/forum_moderation_queue.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: forum_moderation_queue.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: forum_moderation_queue.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Tabs
diff -rub mybb_1400/inc/languages/english/admin/forum_module_meta.lang.php mybb_1408/inc/languages/english/admin/forum_module_meta.lang.php
--- mybb_1400/inc/languages/english/admin/forum_module_meta.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/forum_module_meta.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: forum_module_meta.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: forum_module_meta.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['forums_and_posts'] = "Forums &amp; Posts";
diff -rub mybb_1400/inc/languages/english/admin/global.lang.php mybb_1408/inc/languages/english/admin/global.lang.php
--- mybb_1400/inc/languages/english/admin/global.lang.php	2008-07-04 01:17:04.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/global.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: global.lang.php 3976 2008-07-03 23:17:04Z Tikitiki $
+ * $Id: global.lang.php 4309 2009-01-17 18:36:01Z Tikitiki $
  */
  
 $l['today'] = "Today";
@@ -189,6 +189,7 @@
 // Misc
 $l['encountered_errors'] = "The following errors were encountered:";
 $l['invalid_post_verify_key'] = "An authorization code mismatch occurred. Please confirm that you wish to perform the action below.";
+$l['invalid_post_verify_key2'] = "An authorization code mismatch occurred. Please double check that you are accessing this page correctly.";
 $l['forums_colon'] = "Forums:";
 
 // Code buttons editor language strings
@@ -237,6 +238,13 @@
 $l['task_threadviews_ran'] = "The thread views task successfully ran.";
 $l['task_usercleanup_ran'] = "The user cleanup task successfully ran.";
 $l['task_massmail_ran'] = "The mass mail task successfully ran.";
+$l['task_massmail_ran_errors'] = "One or more problems occured sending to \"{1}\":
+{2}";
+
+$l['massmail_username'] = "Username";
+$l['email_addr'] = "Email Address";
+$l['board_name'] = "Board Name";
+$l['board_url'] = "Board URL";
 
 // If the language string for "Username" is too cramped in the ACP Login box
 // then use this to define how much larger you want the gap to be (in px)
diff -rub mybb_1400/inc/languages/english/admin/home_credits.lang.php mybb_1408/inc/languages/english/admin/home_credits.lang.php
--- mybb_1400/inc/languages/english/admin/home_credits.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/home_credits.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: home_credits.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: home_credits.lang.php 4342 2009-04-07 02:23:30Z Tikitiki $
  */
 
 $l['mybb_credits'] = "MyBB Credits";
@@ -13,5 +13,7 @@
 $l['product_managers'] = "Product Managers";
 $l['developers'] = "Developers";
 $l['graphics_and_style'] = "Graphics and Style";
+$l['software_quality_assurance'] = "Software Quality Assurance";
+$l['support_representative'] = "Support Representative";
 
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/languages/english/admin/home_dashboard.lang.php mybb_1408/inc/languages/english/admin/home_dashboard.lang.php
--- mybb_1400/inc/languages/english/admin/home_dashboard.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/home_dashboard.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: home_dashboard.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: home_dashboard.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['dashboard'] = "Dashboard";
diff -rub mybb_1400/inc/languages/english/admin/home_module_meta.lang.php mybb_1408/inc/languages/english/admin/home_module_meta.lang.php
--- mybb_1400/inc/languages/english/admin/home_module_meta.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/home_module_meta.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: home_module_meta.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: home_module_meta.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['home'] = "Home";
diff -rub mybb_1400/inc/languages/english/admin/home_preferences.lang.php mybb_1408/inc/languages/english/admin/home_preferences.lang.php
--- mybb_1400/inc/languages/english/admin/home_preferences.lang.php	2008-06-06 01:54:22.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/home_preferences.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,18 +3,21 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: home_preferences.lang.php 3886 2008-06-05 23:54:22Z Tikitiki $
+ * $Id: home_preferences.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['preferences_and_personal_notes'] = "Preferences &amp; Personal Notes";
 $l['prefs_and_personal_notes_description'] = "Here you can manage your Admin Control Panel preferences and leave personal notes for yourself.";
 
 $l['preferences'] = "Preferences";
+$l['global_preferences'] = "Global Preferences";
 $l['acp_theme'] = "Admin Control Panel Theme";
 $l['select_acp_theme'] = "Please select a theme to use in the Admin Control Panel";
 $l['notes_not_shared'] = "These notes are not shared with other Administrators.";
 $l['save_notes_and_prefs'] = "Save Personal Notes & Preferences";
 $l['personal_notes'] = "Personal Notes";
+$l['codepress'] = "Turn on / off Codepress";
+$l['use_codepress_desc'] = "This preference allows you to turn off Codepress (used in template editing and stylesheet editing for syntax highlighing) if you are experiencing issues / slow loading.";
 
 $l['success_preferences_updated'] = "The preferences have been successfully updated.";
 
diff -rub mybb_1400/inc/languages/english/admin/home_version_check.lang.php mybb_1408/inc/languages/english/admin/home_version_check.lang.php
--- mybb_1400/inc/languages/english/admin/home_version_check.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/home_version_check.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: home_version_check.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: home_version_check.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['version_check'] = "Version Check";
diff -rub mybb_1400/inc/languages/english/admin/style_module_meta.lang.php mybb_1408/inc/languages/english/admin/style_module_meta.lang.php
--- mybb_1400/inc/languages/english/admin/style_module_meta.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/style_module_meta.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: style_module_meta.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: style_module_meta.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['templates_and_style'] = "Templates &amp; Style";
diff -rub mybb_1400/inc/languages/english/admin/style_templates.lang.php mybb_1408/inc/languages/english/admin/style_templates.lang.php
--- mybb_1400/inc/languages/english/admin/style_templates.lang.php	2008-07-03 20:15:00.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/style_templates.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -148,7 +148,7 @@
 
 $l['success_template_saved'] = "The selected template has successfully been saved.";
 $l['success_template_deleted'] = "The selected template has successfully been deleted.";
-$l['success_template_reverted'] = "The selected template has successfully been reverted..";
+$l['success_template_reverted'] = "The selected template has successfully been reverted.";
 $l['success_template_set_saved'] = "The selected template set has successfully been saved.";
 $l['success_template_set_deleted'] = "The selected template set has successfully been deleted.";
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/languages/english/admin/tools_adminlog.lang.php mybb_1408/inc/languages/english/admin/tools_adminlog.lang.php
--- mybb_1400/inc/languages/english/admin/tools_adminlog.lang.php	2008-07-28 00:27:20.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_adminlog.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_adminlog.lang.php 4050 2008-07-27 22:27:20Z Tikitiki $
+ * $Id: tools_adminlog.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 
diff -rub mybb_1400/inc/languages/english/admin/tools_backupdb.lang.php mybb_1408/inc/languages/english/admin/tools_backupdb.lang.php
--- mybb_1400/inc/languages/english/admin/tools_backupdb.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_backupdb.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_backupdb.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: tools_backupdb.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 
diff -rub mybb_1400/inc/languages/english/admin/tools_cache.lang.php mybb_1408/inc/languages/english/admin/tools_cache.lang.php
--- mybb_1400/inc/languages/english/admin/tools_cache.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_cache.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_cache.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: tools_cache.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['cache'] = "Cache:";
diff -rub mybb_1400/inc/languages/english/admin/tools_mailerrors.lang.php mybb_1408/inc/languages/english/admin/tools_mailerrors.lang.php
--- mybb_1400/inc/languages/english/admin/tools_mailerrors.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_mailerrors.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_mailerrors.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: tools_mailerrors.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['system_email_log'] = "System Email Log";
diff -rub mybb_1400/inc/languages/english/admin/tools_maillogs.lang.php mybb_1408/inc/languages/english/admin/tools_maillogs.lang.php
--- mybb_1400/inc/languages/english/admin/tools_maillogs.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_maillogs.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_maillogs.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: tools_maillogs.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['user_email_log'] = "User Email Log";
@@ -32,6 +32,7 @@
 $l['email_contains'] = "Email Address contains";
 $l['subject_contains'] = "Subject contains";
 $l['from'] = "From";
+$l['find_emails_to_user'] = "Find all emails sent to this user"; 
 
 $l['error_invalid_user'] = "The username you entered does not exist.";
 
diff -rub mybb_1400/inc/languages/english/admin/tools_module_meta.lang.php mybb_1408/inc/languages/english/admin/tools_module_meta.lang.php
--- mybb_1400/inc/languages/english/admin/tools_module_meta.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_module_meta.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_module_meta.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: tools_module_meta.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['tools_and_maintenance'] = "Tools &amp; Maintenance";
diff -rub mybb_1400/inc/languages/english/admin/tools_optimizedb.lang.php mybb_1408/inc/languages/english/admin/tools_optimizedb.lang.php
--- mybb_1400/inc/languages/english/admin/tools_optimizedb.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_optimizedb.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_optimizedb.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: tools_optimizedb.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['optimize_database'] = "Optimize Database";
diff -rub mybb_1400/inc/languages/english/admin/tools_php_info.lang.php mybb_1408/inc/languages/english/admin/tools_php_info.lang.php
--- mybb_1400/inc/languages/english/admin/tools_php_info.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_php_info.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_php_info.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: tools_php_info.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['php_info'] = "PHP Info";
diff -rub mybb_1400/inc/languages/english/admin/tools_recount_rebuild.lang.php mybb_1408/inc/languages/english/admin/tools_recount_rebuild.lang.php
--- mybb_1400/inc/languages/english/admin/tools_recount_rebuild.lang.php	2008-07-04 01:17:04.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_recount_rebuild.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_recount_rebuild.lang.php 3976 2008-07-03 23:17:04Z Tikitiki $
+ * $Id: tools_recount_rebuild.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['recount_rebuild'] = "Recount &amp; Rebuild";
diff -rub mybb_1400/inc/languages/english/admin/tools_system_health.lang.php mybb_1408/inc/languages/english/admin/tools_system_health.lang.php
--- mybb_1400/inc/languages/english/admin/tools_system_health.lang.php	2008-06-16 04:51:24.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_system_health.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_system_health.lang.php 3921 2008-06-16 02:51:24Z Tikitiki $
+ * $Id: tools_system_health.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['system_health'] = "System Health";
diff -rub mybb_1400/inc/languages/english/admin/tools_tasks.lang.php mybb_1408/inc/languages/english/admin/tools_tasks.lang.php
--- mybb_1400/inc/languages/english/admin/tools_tasks.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/tools_tasks.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: tools_tasks.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: tools_tasks.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['task_manager'] = "Task Manager";
diff -rub mybb_1400/inc/languages/english/admin/user_admin_permissions.lang.php mybb_1408/inc/languages/english/admin/user_admin_permissions.lang.php
--- mybb_1400/inc/languages/english/admin/user_admin_permissions.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/user_admin_permissions.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: user_admin_permissions.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: user_admin_permissions.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['admin_permissions'] = "Admin Permissions";
diff -rub mybb_1400/inc/languages/english/admin/user_banning.lang.php mybb_1408/inc/languages/english/admin/user_banning.lang.php
--- mybb_1400/inc/languages/english/admin/user_banning.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/user_banning.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: user_banning.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: user_banning.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Tabs
diff -rub mybb_1400/inc/languages/english/admin/user_group_promotions.lang.php mybb_1408/inc/languages/english/admin/user_group_promotions.lang.php
--- mybb_1400/inc/languages/english/admin/user_group_promotions.lang.php	2008-06-29 00:39:05.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/user_group_promotions.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: user_group_promotions.lang.php 3962 2008-06-28 22:39:05Z Tikitiki $
+ * $Id: user_group_promotions.lang.php 4338 2009-04-03 23:26:21Z Tikitiki $
  */
 
 $l['user_group_promotions'] = "User Group Promotions";
@@ -38,7 +38,7 @@
 $l['time_registered_desc'] = "Enter the number of hours, days, weeks, months, or years that this user must have been registered for. Time registered must be selected as a required value for this to be included. Select whether the time registered should be counted in hours, days, weeks, months, or years.";
 $l['all_user_groups'] = 'All User Groups';
 $l['orig_user_group'] = 'Original User Group';
-$l['orig_user_group_desc'] = "Select which user group or user groups that the user must be in for the promotion to run. Holding down CTRL selects multiple groups. Select 'All User Groups' if you want this promotion to be available for any user group.";
+$l['orig_user_group_desc'] = "Select which user group or user groups that the user must be in for the promotion to run. Holding down CTRL selects multiple groups.";
 $l['new_user_group'] = 'New User Group';
 $l['new_user_group_desc'] = "Select the user group that the user will be moved into after this promotion.";
 $l['primary_user_group'] = 'Primary User Group';
diff -rub mybb_1400/inc/languages/english/admin/user_module_meta.lang.php mybb_1408/inc/languages/english/admin/user_module_meta.lang.php
--- mybb_1400/inc/languages/english/admin/user_module_meta.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/user_module_meta.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: user_module_meta.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: user_module_meta.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['users_and_groups'] = "Users &amp; Groups";
diff -rub mybb_1400/inc/languages/english/admin/user_titles.lang.php mybb_1408/inc/languages/english/admin/user_titles.lang.php
--- mybb_1400/inc/languages/english/admin/user_titles.lang.php	2008-06-09 02:16:11.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/user_titles.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: user_titles.lang.php 3892 2008-06-09 00:16:11Z chris $
+ * $Id: user_titles.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['user_titles'] = "User Titles";
diff -rub mybb_1400/inc/languages/english/admin/user_users.lang.php mybb_1408/inc/languages/english/admin/user_users.lang.php
--- mybb_1400/inc/languages/english/admin/user_users.lang.php	2008-07-10 19:53:25.000000000 +0200
+++ mybb_1408/inc/languages/english/admin/user_users.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: user_users.lang.php 4005 2008-07-10 17:53:25Z Tikitiki $
+ * $Id: user_users.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['users'] = "Users";
diff -rub mybb_1400/inc/languages/english/akismet.lang.php mybb_1408/inc/languages/english/akismet.lang.php
--- mybb_1400/inc/languages/english/akismet.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/akismet.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: akismet.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: akismet.lang.php 4279 2008-11-26 00:01:25Z Tikitiki $
  */
 
 $l['spam'] = "Spam";
@@ -11,6 +11,9 @@
 $l['post_spam_success'] = "The post(s) has been marked as spam successfully.";
 $l['thread_spam_success'] = "The thread has been marked as spam successfully.";
 
+$l['mark_as_spam'] = "Mark as Spam";
+$l['confirm_mark_as_spam'] = "Are you sure you wish to mark the selected post/thread as spam?";
+
 $l['akismet_error'] = "Akismet Error";
 
 $l['redirect_newthread'] = "Akismet has detected that this is a spam message and will not be processed.<br />If you find this is in error please contact your forum administrator.";
diff -rub mybb_1400/inc/languages/english/announcements.lang.php mybb_1408/inc/languages/english/announcements.lang.php
--- mybb_1400/inc/languages/english/announcements.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/announcements.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: announcements.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: announcements.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_announcements'] = "Forum Announcement";
diff -rub mybb_1400/inc/languages/english/archive.lang.php mybb_1408/inc/languages/english/archive.lang.php
--- mybb_1400/inc/languages/english/archive.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/archive.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: archive.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: archive.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['archive_fullversion'] = "Full Version:";
diff -rub mybb_1400/inc/languages/english/calendar.lang.php mybb_1408/inc/languages/english/calendar.lang.php
--- mybb_1400/inc/languages/english/calendar.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/calendar.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
- * $Id: calendar.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: calendar.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_calendar'] = "Calendar";
diff -rub mybb_1400/inc/languages/english/customhelpdocs.lang.php mybb_1408/inc/languages/english/customhelpdocs.lang.php
--- mybb_1400/inc/languages/english/customhelpdocs.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/customhelpdocs.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: customhelpdocs.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: customhelpdocs.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /*
diff -rub mybb_1400/inc/languages/english/customhelpsections.lang.php mybb_1408/inc/languages/english/customhelpsections.lang.php
--- mybb_1400/inc/languages/english/customhelpsections.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/customhelpsections.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: customhelpsections.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: customhelpsections.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /*
diff -rub mybb_1400/inc/languages/english/datahandler_event.lang.php mybb_1408/inc/languages/english/datahandler_event.lang.php
--- mybb_1400/inc/languages/english/datahandler_event.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/datahandler_event.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  *
- * $Id: datahandler_event.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: datahandler_event.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['eventdata_missing_name'] = 'The name for the event is missing. Please enter an event name.';
diff -rub mybb_1400/inc/languages/english/datahandler_pm.lang.php mybb_1408/inc/languages/english/datahandler_pm.lang.php
--- mybb_1400/inc/languages/english/datahandler_pm.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/datahandler_pm.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
- * $Id: datahandler_pm.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: datahandler_pm.lang.php 4269 2008-11-13 05:48:19Z Tikitiki $
  */
 
 $l['pmdata_too_long_subject'] = 'The subject of your private message is too long. Please enter a shorter subject.';
@@ -17,5 +17,7 @@
 $l['pmdata_recipient_pms_disabled'] = '{1} has private messaging disabled. You cannot send private messages to this user.';
 $l['pmdata_recipient_reached_quota'] = '{1} has reached their private message quota so your message could not be sent.';
 
+$l['pmdata_pm_flooding'] = 'You are trying to send a message too quickly after sending a previous message. Please wait {1} more seconds.';
+$l['pmdata_pm_flooding_one_second'] = 'You are trying to send a message too quickly after sending a previous message. Please wait 1 more second.';
 
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/languages/english/datahandler_post.lang.php mybb_1408/inc/languages/english/datahandler_post.lang.php
--- mybb_1400/inc/languages/english/datahandler_post.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/datahandler_post.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: datahandler_post.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: datahandler_post.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['postdata_invalid_user_id'] = 'The user id does not exist. Please supply a valid user id.';
diff -rub mybb_1400/inc/languages/english/datahandler_user.lang.php mybb_1408/inc/languages/english/datahandler_user.lang.php
--- mybb_1400/inc/languages/english/datahandler_user.lang.php	2008-06-23 12:54:06.000000000 +0200
+++ mybb_1408/inc/languages/english/datahandler_user.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  *
- * $Id: datahandler_user.lang.php 3946 2008-06-23 10:54:06Z ZiNgaBuRgA $
+ * $Id: datahandler_user.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['userdata_missing_username'] = 'You did not enter a username. Please enter one.';
diff -rub mybb_1400/inc/languages/english/editpost.lang.php mybb_1408/inc/languages/english/editpost.lang.php
--- mybb_1400/inc/languages/english/editpost.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/editpost.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: editpost.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: editpost.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_editpost'] = "Edit Post";
diff -rub mybb_1400/inc/languages/english/forumdisplay.lang.php mybb_1408/inc/languages/english/forumdisplay.lang.php
--- mybb_1400/inc/languages/english/forumdisplay.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/forumdisplay.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: forumdisplay.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: forumdisplay.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['post_thread'] = "Post Thread";
diff -rub mybb_1400/inc/languages/english/global.lang.php mybb_1408/inc/languages/english/global.lang.php
--- mybb_1400/inc/languages/english/global.lang.php	2008-06-01 06:32:49.000000000 +0200
+++ mybb_1408/inc/languages/english/global.lang.php	2009-06-26 07:27:27.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
- * $Id: global.lang.php 3875 2008-06-01 04:32:49Z Tikitiki $
+ * $Id: global.lang.php 4367 2009-05-08 09:55:13Z Tomm $
  */
 
 $l['redirect_width'] = "50%";
@@ -289,8 +289,8 @@
 $l['with_trout'] = "around a bit with a large trout.";
 
 $l['quickdelete_confirm'] = "Are you sure you want to delete this post?";
-$l['newpm_notice_one'] = "<strong>You have one unread private message</strong> from <a href=\"{1}\">{2}</a> titled <a href=\"private.php?action=read&amp;pmid={3}\" style=\"font-weight: bold;\">{4}</a>";
-$l['newpm_notice_multiple'] = "<strong>You have {1} unread private messages.</strong> The most recent is from <a href=\"{2}\">{3}</a> titled <a href=\"private.php?action=read&amp;pmid={4}\" style=\"font-weight: bold;\">{5}</a>";
+$l['newpm_notice_one'] = "<strong>You have one unread private message</strong> from {1} titled <a href=\"private.php?action=read&amp;pmid={2}\" style=\"font-weight: bold;\">{3}</a>";
+$l['newpm_notice_multiple'] = "<strong>You have {1} unread private messages.</strong> The most recent is from {2} titled <a href=\"private.php?action=read&amp;pmid={3}\" style=\"font-weight: bold;\">{4}</a>";
 $l['deleteevent_confirm'] = "Are you sure you want to delete this event?";
 $l['removeattach_confirm'] = "Are you sure you want to remove the selected attachment from this post?";
 
@@ -366,10 +366,17 @@
 $l['task_threadviews_ran'] = "The thread views task successfully ran.";
 $l['task_usercleanup_ran'] = "The user cleanup task successfully ran.";
 $l['task_massmail_ran'] = "The mass mail task successfully ran.";
+$l['task_massmail_ran_errors'] = "One or more problems occured sending to \"{1}\":
+{2}";
 
 $l['dismiss_notice'] = "Dismiss this notice";
 
 $l['next'] = "Next";
 $l['previous'] = "Previous";
 $l['delete'] = "Delete";
+
+$l['massmail_username'] = "Username";
+$l['email_addr'] = "Email Address";
+$l['board_name'] = "Board Name";
+$l['board_url'] = "Board URL";
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/languages/english/helpdocs.lang.php mybb_1408/inc/languages/english/helpdocs.lang.php
--- mybb_1400/inc/languages/english/helpdocs.lang.php	2008-07-04 01:17:04.000000000 +0200
+++ mybb_1408/inc/languages/english/helpdocs.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: helpdocs.lang.php 3976 2008-07-03 23:17:04Z Tikitiki $
+ * $Id: helpdocs.lang.php 4276 2008-11-23 03:01:33Z Tikitiki $
  */
 
 // Help Document 1
@@ -24,7 +24,7 @@
 $l['d3_document'] = "MyBB makes use of cookies to store your login information if you are registered, and your last visit if you are not.
 <br /><br />Cookies are small text documents stored on your computer; the cookies set by this forum can only be used on this website and pose no security risk.
 <br /><br />Cookies on this forum also track the specific topics you have read and when you last read them.
-<br /><br />To clear all cookies set by this forum, you can click <a href=\"misc.php?action=clearcookies\">here</a>.";
+<br /><br />To clear all cookies set by this forum, you can click <a href=\"misc.php?action=clearcookies&amp;key={1}\">here</a>.";
 
 // Help Document 4
 $l['d4_name'] = "Logging In and Out";
diff -rub mybb_1400/inc/languages/english/helpsections.lang.php mybb_1408/inc/languages/english/helpsections.lang.php
--- mybb_1400/inc/languages/english/helpsections.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/helpsections.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: helpsections.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: helpsections.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Help Section 1
diff -rub mybb_1400/inc/languages/english/index.lang.php mybb_1408/inc/languages/english/index.lang.php
--- mybb_1400/inc/languages/english/index.lang.php	2008-07-04 01:17:04.000000000 +0200
+++ mybb_1408/inc/languages/english/index.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: index.lang.php 3976 2008-07-03 23:17:04Z Tikitiki $
+ * $Id: index.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['boardstats'] = "Board Statistics";
diff -rub mybb_1400/inc/languages/english/mailhandler.lang.php mybb_1408/inc/languages/english/mailhandler.lang.php
--- mybb_1400/inc/languages/english/mailhandler.lang.php	2008-05-03 15:52:18.000000000 +0200
+++ mybb_1408/inc/languages/english/mailhandler.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  *
- * $Id: mailhandler.lang.php 3813 2008-05-03 13:52:18Z chris $
+ * $Id: mailhandler.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 $l['error_no_connection'] = 'There was an error establishing a connection through the server: ';
diff -rub mybb_1400/inc/languages/english/managegroup.lang.php mybb_1408/inc/languages/english/managegroup.lang.php
--- mybb_1400/inc/languages/english/managegroup.lang.php	2008-06-27 22:10:24.000000000 +0200
+++ mybb_1408/inc/languages/english/managegroup.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: managegroup.lang.php 3959 2008-06-27 20:10:24Z Tikitiki $
+ * $Id: managegroup.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_group_management'] = "{1} Group Management";
diff -rub mybb_1400/inc/languages/english/member.lang.php mybb_1408/inc/languages/english/member.lang.php
--- mybb_1400/inc/languages/english/member.lang.php	2008-07-04 01:17:04.000000000 +0200
+++ mybb_1408/inc/languages/english/member.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: member.lang.php 3976 2008-07-03 23:17:04Z Tikitiki $
+ * $Id: member.lang.php 4270 2008-11-15 08:03:49Z Tikitiki $
  */
 
 $l['nav_register'] = "Register";
@@ -105,7 +105,6 @@
 $l['coppa_desc'] = "In order to register on these forums, we require you to verify your age to comply with <a href=\"http://coppa.org/\" title=\"Children's Online Privacy Protection Act\" target=\"_blank\">COPPA</a>. Please enter your date of birth below.<br /><br />If you are under the age of 13, parental permission must be obtained prior to registration. A parent or legal guardian will need to download, fill in and submit to us a completed copy of our <a href=\"member.php?action=coppa_form\" target=\"_blank\">COPPA Compliance &amp; Permission form</a>.";
 $l['hide_dob'] = "You can chose to hide your date of birth and age by editing your profile after registering.";
 $l['continue_registration'] = "Continue with Registration";
-$l['date_of_birth'] = "Date of Birth:";
 $l['birthdayprivacy'] = "Date of Birth Privacy:";
 $l['birthdayprivacyall'] = "Display Age and Date of Birth";
 $l['birthdayprivacynone'] = "Hide Age and Date of Birth";
@@ -188,6 +187,7 @@
 $l['error_bannedusername'] = "You have entered a username that is banned from registration.  Please choose another username.";
 $l['error_notloggedout'] = "Your user ID could not be verified to log you out.  This may have been because a malicious Javascript was attempting to log you out automatically.  If you intended to log out, please click the Log Out button at the top menu.";
 $l['error_regimageinvalid'] = "The image verification code that you entered was incorrect. Please enter the code exactly how it appears in the image.";
+$l['error_regimagerequired'] = "Please fill out the image verification code to continue the login process. Please enter the code exactly how it appears in the image.";
 
 $l['js_validator_no_username'] = "You must enter a username";
 $l['js_validator_invalid_email'] = "You need to enter a valid email address";
diff -rub mybb_1400/inc/languages/english/memberlist.lang.php mybb_1408/inc/languages/english/memberlist.lang.php
--- mybb_1400/inc/languages/english/memberlist.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/memberlist.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: memberlist.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: memberlist.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_memberlist'] = "Member List";
diff -rub mybb_1400/inc/languages/english/messages.lang.php mybb_1408/inc/languages/english/messages.lang.php
--- mybb_1400/inc/languages/english/messages.lang.php	2008-07-06 03:01:20.000000000 +0200
+++ mybb_1408/inc/languages/english/messages.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: messages.lang.php 3990 2008-07-06 01:01:20Z Tikitiki $
+ * $Id: messages.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['click_no_wait'] = "Click here if you don't want to wait any longer.";
diff -rub mybb_1400/inc/languages/english/misc.lang.php mybb_1408/inc/languages/english/misc.lang.php
--- mybb_1400/inc/languages/english/misc.lang.php	2008-07-01 03:29:14.000000000 +0200
+++ mybb_1408/inc/languages/english/misc.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: misc.lang.php 3968 2008-07-01 01:29:14Z Tikitiki $
+ * $Id: misc.lang.php 4276 2008-11-23 03:01:33Z Tikitiki $
  */
 
 $l['nav_helpdocs'] = "Help Documents";
@@ -77,6 +77,7 @@
 
 $l['error_invalidimtype'] = "This user does not have this type of instant messenger account specified in their profile.";
 $l['error_invalidhelpdoc'] = "The specified help document does not appear to exist.";
+$l['error_invalidkey'] = "You could not be verified to clear cookies.  This may have been because a malicious Javascript was attempting to clear your cookies automatically. If you intended to clear your cookies, please view the \"Use of Cookies on MyBB\" help document.";
 
 $l['dst_settings_updated'] = "Your daylight saving time settings have automatically been adjusted.<br /><br />You will now be taken back to the forum index.";
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/languages/english/modcp.lang.php mybb_1408/inc/languages/english/modcp.lang.php
--- mybb_1400/inc/languages/english/modcp.lang.php	2008-07-09 00:34:00.000000000 +0200
+++ mybb_1408/inc/languages/english/modcp.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  *
- * $Id: modcp.lang.php 4001 2008-07-08 22:34:00Z Tikitiki $
+ * $Id: modcp.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_width'] = "180";
diff -rub mybb_1400/inc/languages/english/moderation.lang.php mybb_1408/inc/languages/english/moderation.lang.php
--- mybb_1400/inc/languages/english/moderation.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/moderation.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: moderation.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: moderation.lang.php 4322 2009-02-21 23:00:49Z Tikitiki $
  */
 
 $l['nav_deletethread'] = "Delete Thread";
@@ -115,6 +115,7 @@
 $l['error_mergewithself'] = "Threads cannot be merged with themselves.<br />Please go back and enter a valid URL.";
 
 $l['redirect_pollnotdeleted'] = "The poll was not deleted because you did not check the \"Delete\" checkbox.<br />You will now be returned to the thread.";
+$l['redirect_polldeleted'] = "Thank you, the poll has successfully been removed from the thread.<br />You will now be taken back to the thread.";
 $l['redirect_mergeposts'] = "The selected posts have now been merged together. You will now be returned to the thread.";
 $l['redirect_openthread'] = "Thank you, the thread has successfully been opened.<br />You will now be returned to the thread.";
 $l['redirect_closethread'] = "Thank you, the thread has successfully been closed.<br />You will now be returned to the thread.";
diff -rub mybb_1400/inc/languages/english/newreply.lang.php mybb_1408/inc/languages/english/newreply.lang.php
--- mybb_1400/inc/languages/english/newreply.lang.php	2008-05-26 06:24:54.000000000 +0200
+++ mybb_1408/inc/languages/english/newreply.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: newreply.lang.php 3865 2008-05-26 04:24:54Z ZiNgaBuRgA $
+ * $Id: newreply.lang.php 4277 2008-11-23 20:47:16Z Tikitiki $
  */
 
 $l['nav_newreply'] = "Post Reply";
@@ -39,7 +39,7 @@
 $l['multiquote_external_quote'] = "Quote these posts too";
 
 $l['redirect_newreply'] = "Thank you, your reply has been posted.";
-$l['redirect_newreply_moderation'] = "<br />The administrator has specified that all new posts require moderation. You will now be returned to the thread.";
+$l['redirect_newreply_moderation'] = "The administrator has specified that all new posts require moderation. You will now be returned to the thread.";
 $l['redirect_newreply_post'] = "<br />You will now be taken to your post.";
 $l['redirect_newreplyerror'] = "Sorry, but your reply has been rejected for lack of content. <br />You will now be returned to the thread.";
 $l['redirect_threadclosed'] = "You cannot post replies in this thread because it has been closed by a moderator.";
diff -rub mybb_1400/inc/languages/english/newthread.lang.php mybb_1408/inc/languages/english/newthread.lang.php
--- mybb_1400/inc/languages/english/newthread.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/newthread.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: newthread.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: newthread.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_newthread'] = "New Thread";
diff -rub mybb_1400/inc/languages/english/online.lang.php mybb_1408/inc/languages/english/online.lang.php
--- mybb_1400/inc/languages/english/online.lang.php	2008-07-25 20:52:06.000000000 +0200
+++ mybb_1408/inc/languages/english/online.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: online.lang.php 4039 2008-07-25 18:52:06Z Tikitiki $
+ * $Id: online.lang.php 4330 2009-03-16 02:17:06Z Tikitiki $
  */
 
 $l['nav_online'] = "Who's Online";
@@ -12,7 +12,7 @@
 $l['viewing_announcements'] = "Viewing <a href=\"{1}\">{2}</a> Announcements";
 $l['viewing_announcements2'] = "Viewing Forum Announcements";
 $l['viewing_attachment'] = "Viewing Attachment";
-$l['viewing_attachment2'] = "Viewing <a href=\"attachment.php?aid={1}\">Attachment</a> in Thread <a href=\"{3}\">{2}</a>";
+$l['viewing_attachment2'] = "Viewing <a href=\"attachment.php?aid={1}\" target=\"_blank\">Attachment</a> in Thread <a href=\"{3}\">{2}</a>";
 $l['viewing_calendar'] = "Viewing <a href=\"calendar.php\">Calendar</a>";
 $l['viewing_event'] = "Viewing Event";
 $l['viewing_event2'] = "Viewing Event <a href=\"{1}\">{2}</a>";
@@ -126,4 +126,7 @@
 $l['viewing_warning'] = "Viewing a warning";
 $l['managing_warnings'] = "Managing warnings";
 $l['changing_dst'] = "Changing DST Switch";
+$l['printing_thread'] = "Printing a Thread";
+$l['printing_thread2'] = "Printing Thread <a href=\"{1}\">{2}</a>";
+$l['managing_buddyignorelist'] = "Managing Buddy/Ignore List";
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/languages/english/polls.lang.php mybb_1408/inc/languages/english/polls.lang.php
--- mybb_1400/inc/languages/english/polls.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/polls.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: polls.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: polls.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_postpoll'] = "Post Poll";
diff -rub mybb_1400/inc/languages/english/portal.lang.php mybb_1408/inc/languages/english/portal.lang.php
--- mybb_1400/inc/languages/english/portal.lang.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/inc/languages/english/portal.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: portal.lang.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: portal.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_portal'] = "Portal";
diff -rub mybb_1400/inc/languages/english/printthread.lang.php mybb_1408/inc/languages/english/printthread.lang.php
--- mybb_1400/inc/languages/english/printthread.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/printthread.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: printthread.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: printthread.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['forum'] = "Forum:";
diff -rub mybb_1400/inc/languages/english/private.lang.php mybb_1408/inc/languages/english/private.lang.php
--- mybb_1400/inc/languages/english/private.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/private.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
- * $Id: private.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: private.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_pms'] = "Private Messages";
diff -rub mybb_1400/inc/languages/english/ratethread.lang.php mybb_1408/inc/languages/english/ratethread.lang.php
--- mybb_1400/inc/languages/english/ratethread.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/ratethread.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: ratethread.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: ratethread.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['redirect_threadrated'] = "Thank you, the thread has been rated successfully. You will now be returned to the thread.";
diff -rub mybb_1400/inc/languages/english/report.lang.php mybb_1408/inc/languages/english/report.lang.php
--- mybb_1400/inc/languages/english/report.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/report.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: report.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: report.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['report_post'] = "Report Post";
diff -rub mybb_1400/inc/languages/english/reputation.lang.php mybb_1408/inc/languages/english/reputation.lang.php
--- mybb_1400/inc/languages/english/reputation.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/reputation.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
- * $Id: reputation.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: reputation.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_reputation'] = "Reputation Report";
diff -rub mybb_1400/inc/languages/english/search.lang.php mybb_1408/inc/languages/english/search.lang.php
--- mybb_1400/inc/languages/english/search.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/search.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
- * $Id: search.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: search.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_search'] = "Search";
@@ -75,6 +75,14 @@
 $l['inline_post_moderation'] = "Inline Post Moderation:";
 $l['inline_go'] = "Go";
 $l['clear'] = "Clear";
+$l['icon_dot'] = "Contains posts by you. "; // The spaces for the icon labels are strategically placed so that there should be no extra space at the beginning or end of the resulting label and that spaces separate each 'status' ;)
+$l['icon_no_new'] = "No new posts.";
+$l['icon_new'] = "New posts.";
+$l['icon_hot'] = " Hot thread.";
+$l['icon_lock'] = " Locked thread.";
+$l['attachment_count'] = "This thread contains 1 attachment.";
+$l['attachment_count_multiple'] = "This thread contains {1} attachments.";
+$l['goto_first_unread'] = "Go to first unread post";
 
 $l['redirect_searchresults'] = "Thank you, your search has been submitted and you will now be taken to the results list.";
 
diff -rub mybb_1400/inc/languages/english/sendthread.lang.php mybb_1408/inc/languages/english/sendthread.lang.php
--- mybb_1400/inc/languages/english/sendthread.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/sendthread.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: sendthread.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: sendthread.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_sendthread'] = "Send Thread to a Friend";
diff -rub mybb_1400/inc/languages/english/showteam.lang.php mybb_1408/inc/languages/english/showteam.lang.php
--- mybb_1400/inc/languages/english/showteam.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/showteam.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: showteam.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: showteam.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_showteam'] = "Forum Team";
diff -rub mybb_1400/inc/languages/english/showthread.lang.php mybb_1408/inc/languages/english/showthread.lang.php
--- mybb_1400/inc/languages/english/showthread.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/showthread.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: showthread.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: showthread.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['delete_poll'] = "Delete Poll";
@@ -82,4 +82,6 @@
 $l['enter_keywords'] = "Enter Keywords";
 $l['image_verification'] = "Image Verification";
 $l['verification_note'] = "Please enter the text within the image on the left in to the text box below. This process is used to prevent automated posts.";
+$l['verification_subnote'] = "(case insensitive)";
+
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/languages/english/stats.lang.php mybb_1408/inc/languages/english/stats.lang.php
--- mybb_1400/inc/languages/english/stats.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/stats.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: stats.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: stats.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_stats'] = "Board Statistics";
diff -rub mybb_1400/inc/languages/english/syndication.lang.php mybb_1408/inc/languages/english/syndication.lang.php
--- mybb_1400/inc/languages/english/syndication.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/syndication.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: syndication.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: syndication.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['all_forums'] = "All Forums";
diff -rub mybb_1400/inc/languages/english/usercp.lang.php mybb_1408/inc/languages/english/usercp.lang.php
--- mybb_1400/inc/languages/english/usercp.lang.php	2008-07-12 05:47:42.000000000 +0200
+++ mybb_1408/inc/languages/english/usercp.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
- * $Id: usercp.lang.php 4009 2008-07-12 03:47:42Z Tikitiki $
+ * $Id: usercp.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['nav_usercp'] = "User Control Panel";
diff -rub mybb_1400/inc/languages/english/usercpnav.lang.php mybb_1408/inc/languages/english/usercpnav.lang.php
--- mybb_1400/inc/languages/english/usercpnav.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/usercpnav.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: usercpnav.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: usercpnav.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['ucp_nav_width'] = "180";
diff -rub mybb_1400/inc/languages/english/warnings.lang.php mybb_1408/inc/languages/english/warnings.lang.php
--- mybb_1400/inc/languages/english/warnings.lang.php	2008-07-25 22:13:08.000000000 +0200
+++ mybb_1408/inc/languages/english/warnings.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -43,7 +43,7 @@
 $l['expiration_months'] = "months";
 $l['redirect_warned_banned'] = "The user has also been moved to the {1} group for {2}.";
 $l['redirect_warned_suspended'] = "This users posting privileges have been suspended for {1}.";
-$l['redirect_warned_moderate'] = "All posts by this user will now be moderated for {1} {2}.";
+$l['redirect_warned_moderate'] = "All posts by this user will now be moderated for {1}.";
 $l['redirect_warned'] = "The warning level of {1} has been increased to {2}%.{3}<br /><br />You will now be taken back to where you came from.";
 $l['error_warning_system_disabled'] = "You cannot use the warning system as it has been disabled by the board administrator.";
 $l['reached_max_warnings_day'] = "You cannot warn anyone as you have reached your limit on the number of warnings you can give out per day.<br /><br />The maximum number of warnings you can give out per day is {1}.";
diff -rub mybb_1400/inc/languages/english/xmlhttp.lang.php mybb_1408/inc/languages/english/xmlhttp.lang.php
--- mybb_1400/inc/languages/english/xmlhttp.lang.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/languages/english/xmlhttp.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright Â© 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: xmlhttp.lang.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: xmlhttp.lang.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 $l['no_new_subject'] = "You did not enter a new subject.";
diff -rub mybb_1400/inc/languages/english.php mybb_1408/inc/languages/english.php
--- mybb_1400/inc/languages/english.php	2008-05-21 01:36:44.000000000 +0200
+++ mybb_1408/inc/languages/english.php	2009-06-26 07:27:24.000000000 +0200
@@ -3,7 +3,7 @@
  * MyBB 1.4 English Language Pack
  * Copyright © 2008 MyBB Group, All Rights Reserved
  * 
- * $Id: english.php 3857 2008-05-20 23:36:44Z Tikitiki $
+ * $Id: english.php 4386 2009-06-25 07:30:06Z RyanGordon $
  */
 
 // The friendly name of the language
@@ -16,7 +16,7 @@
 $langinfo['website'] = "http://www.mybboard.net/";
 
 // Compatible version of MyBB
-$langinfo['version'] = "1400";
+$langinfo['version'] = "1408";
 
 // Sets if the translation includes the Admin CP (1 = yes, 0 = no)
 $langinfo['admin'] = 1;
diff -rub mybb_1400/inc/mailhandlers/php.php mybb_1408/inc/mailhandlers/php.php
--- mybb_1400/inc/mailhandlers/php.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/mailhandlers/php.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: php.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: php.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 // Disallow direct access to this file for security reasons
@@ -45,29 +45,23 @@
 			$this->delimiter = "\n";
 		}
 
-		if(function_exists('mb_send_mail'))
+		// Some mail providers ignore email's with incorrect return-to path's so try and fix that here
+		$this->sendmail_from = @ini_get('sendmail_from');
+		if($this->sendmail_from != $mybb->settings['adminemail'])
 		{
-			if(function_exists('mb_language'))
-			{
-				if($this->charset == "UTF-8")
-				{
-					$language = 'uni';
-				}
-				else
-				{
-					$language = $lang->settings['htmllang'];
-				}
-				@mb_language($language);
+			@ini_set("sendmail_from", $mybb->settings['adminemail']);
 			}
 			
-			$sent = @mb_send_mail($this->to, $this->subject, $this->message, trim($this->headers), $this->additional_parameters);
-			$function_used = 'mb_send_mail()';
+		// If safe mode is on, don't send the additional parameters as we're not allowed to
+		if(ini_get('safe_mode') == 1 || strtolower(ini_get('safe_mode')) == 'on')
+		{
+			$sent = @mail($this->to, $this->subject, $this->message, trim($this->headers));
 		}
 		else
 		{
 			$sent = @mail($this->to, $this->subject, $this->message, trim($this->headers), $this->additional_parameters);
-			$function_used = 'mail()';
 		}
+		$function_used = 'mail()';
 
 		if(!$sent)
 		{
diff -rub mybb_1400/inc/mailhandlers/smtp.php mybb_1408/inc/mailhandlers/smtp.php
--- mybb_1400/inc/mailhandlers/smtp.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/inc/mailhandlers/smtp.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: smtp.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: smtp.php 4343 2009-04-09 05:36:29Z Tikitiki $
  */
 
  // Disallow direct access to this file for security reasons
@@ -116,6 +116,13 @@
 	var $code = 0;
 	
 	/**
+	 * The last received error message from the SMTP server.
+	 *
+	 * @var string
+	 */
+	var $last_error = '';
+	
+	/**
 	 * Are we keeping the connection to the SMTP server alive?
 	 *
 	 * @var boolean
@@ -192,7 +199,7 @@
 		{
 			if(!$this->send_data('MAIL FROM:<'.$this->from.'>', '250'))
 			{
-				$this->fatal_error("The mail server does not understand the MAIL FROM command");
+				$this->fatal_error("The mail server does not understand the MAIL FROM command. Reason: ".$this->get_error());
 				return false;
 			}
 			
@@ -203,7 +210,7 @@
 				$to = trim($to);
 				if(!$this->send_data('RCPT TO:<'.$to.'>', '250'))
 				{
-					$this->fatal_error("The mail server does not understand the RCPT TO command");
+					$this->fatal_error("The mail server does not understand the RCPT TO command. Reason: ".$this->get_error());
 					return false;
 				}
 			}
@@ -332,13 +339,13 @@
 			
 			if(!$this->send_data(base64_encode($this->username), '334'))
 			{
-				$this->fatal_error("The SMTP server rejected the supplied SMTP username");
+				$this->fatal_error("The SMTP server rejected the supplied SMTP username. Reason: ".$this->get_error());
 				return false;
 			}
 			
 			if(!$this->send_data(base64_encode($this->password), '235'))
 			{
-				$this->fatal_error("The SMTP server rejected the supplied SMTP password");
+				$this->fatal_error("The SMTP server rejected the supplied SMTP password. Reason: ".$this->get_error());
 				return false;
 			}
 		}
@@ -356,7 +363,7 @@
 			$auth = base64_encode(chr(0).$this->username.chr(0).$this->password);
 			if(!$this->send_data($auth, 235))
 			{
-				$this->fatal_error("The SMTP server rejected the supplied login username and password");
+				$this->fatal_error("The SMTP server rejected the supplied login username and password. Reason: ".$this->get_error());
 				return false;
 			}
 		}
@@ -428,6 +435,7 @@
 					}
 					else
 					{
+						$this->set_error($rec);
 						return false;
 					}
 				}
@@ -472,5 +480,30 @@
 			$this->status = 0;
 		}
 	}
+	
+	/**
+	 * Get the last error message response from the SMTP server
+	 *
+	 * @return string The error message response from the SMTP server
+	 */
+	function get_error()
+	{
+		if(!$this->last_error)
+		{
+			$this->last_error = "N/A";
+		}
+		
+		return $this->last_error;
+	}
+	
+	/**
+	 * Set the last error message response from the SMTP server
+	 *
+	 * @param string The error message response
+	 */
+	function set_error($error)
+	{
+		$this->last_error = $error;
+	}
 }
 ?>
\ No newline at end of file
diff -rub mybb_1400/inc/mybb_group.php mybb_1408/inc/mybb_group.php
--- mybb_1400/inc/mybb_group.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/mybb_group.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: mybb_group.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: mybb_group.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 function output_logo()
diff -rub mybb_1400/inc/plugins/akismet.php mybb_1408/inc/plugins/akismet.php
--- mybb_1400/inc/plugins/akismet.php	2008-07-07 11:32:32.000000000 +0200
+++ mybb_1408/inc/plugins/akismet.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: akismet.php 3995 2008-07-07 09:32:32Z Tikitiki $
+ * $Id: akismet.php 4343 2009-04-09 05:36:29Z Tikitiki $
  */
 
 // Disallow direct access to this file for security reasons
@@ -57,7 +57,7 @@
 		"website"		=> "http://mybboard.net",
 		"author"		=> "MyBB Group",
 		"authorsite"	=> "http://mybboard.net",
-		"version"		=> "1.2",
+		"version"       => "1.2.1",
 		"guid"			=> "e57a80dbe7ff85083596a1a3b7da3ce7",
 		"compatibility" => "14*",
 	);
@@ -309,9 +309,55 @@
 	}
 }
 
+
+function akismet_show_confirm_page()
+{
+	global $mybb, $lang, $theme, $pid, $fid, $db, $headerinclude, $header, $footer;
+	
+	$pid = intval($pid);
+	$fid = intval($fid);
+	
+	$query = $db->simple_select("posts", "subject", "pid='{$pid}'", 1);
+	$post = $db->fetch_array($query);
+	
+	if(!$post)
+	{
+		error("Invalid Post ID.");
+	}
+	
+	output_page("<html>
+<head>
+<title>{$mybb->settings['bbname']} - {$lang->mark_as_spam}</title>
+{$headerinclude}
+</head>
+<body>
+{$header}
+<form action=\"moderation.php\" method=\"post\">
+<input type=\"hidden\" name=\"my_post_key\" value=\"{$mybb->post_code}\" />
+<table border=\"0\" cellspacing=\"{$theme['borderwidth']}\" cellpadding=\"{$theme['tablespace']}\" class=\"tborder\">
+<tr>
+<td class=\"thead\" colspan=\"2\"><strong>{$post['subject']} - {$lang->mark_as_spam}</strong></td>
+</tr>
+<tr>
+<td class=\"trow1\" colspan=\"2\" align=\"center\">{$lang->confirm_mark_as_spam}</td>
+</tr>
+{$loginbox}
+</table>
+<br />
+<div align=\"center\"><input type=\"submit\" class=\"button\" name=\"submit\" value=\"{$lang->mark_as_spam}\" /></div>
+<input type=\"hidden\" name=\"action\" value=\"mark_as_spam\" />
+<input type=\"hidden\" name=\"pid\" value=\"{$pid}\" />
+<input type=\"hidden\" name=\"fid\" value=\"{$fid}\" />
+</form>
+{$footer}
+</body>
+</html>");
+	exit;
+}
+
 function akismet_moderation_start()
 {
-	global $mybb, $db, $akismet, $lang, $cache;
+	global $mybb, $db, $akismet, $lang, $cache, $fid, $pid;
 	
 	if(!$mybb->settings['akismetswitch'] || $mybb->input['action'] != 'mark_as_spam')
 	{
@@ -340,9 +386,10 @@
 	}
 	
 	$query = $db->query("
-		SELECT p.username, u.email, u.website, u.akismetstopped, p.message, p.ipaddress, p.tid, p.replyto, p.fid
+		SELECT p.uid, p.username, u.email, u.website, u.akismetstopped, p.message, p.ipaddress, p.tid, p.replyto, p.fid, f.usepostcounts
 		FROM ".TABLE_PREFIX."posts p
 		LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=p.uid)
+		LEFT JOIN ".TABLE_PREFIX."forums f ON (f.fid=p.fid)
 		WHERE p.pid = '{$pid}'
 	");
 	$post = $db->fetch_array($query);
@@ -352,6 +399,13 @@
 		error("Invalid Post ID.");
 	}
 		
+	if(!$mybb->input['my_post_key'] || $mybb->request_method != "post")
+	{
+		akismet_show_confirm_page();
+	}
+	
+	verify_post_check($mybb->input['my_post_key']);
+	
 	$akismet_array = array(
 		'type' => 'post',
 		'username' => $post['username'],
@@ -380,8 +434,7 @@
 	
 	$akismet->submit_spam();
 	
-	$unapprovedakismetthread = 0;
-	$unapprovedakismetpost = 0;
+	$numakismetthread = $numakismetpost = 0;
 	
 	if($snippit == "thread")
 	{
@@ -389,19 +442,31 @@
 			SELECT p.uid, u.usergroup
 			FROM ".TABLE_PREFIX."posts p
 			LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=p.uid)
-			WHERE tid = '{$post['tid']}'
+			WHERE p.tid = '{$post['tid']}'
 		");
 		while($post2 = $db->fetch_array($query))
 		{
+			++$numakismetpost;
+
+			if($post['usepostcounts'] != 0)
+			{
+				$db->write_query("UPDATE ".TABLE_PREFIX."users SET postnum=postnum-1 WHERE uid = '{$post2['uid']}'");
+			}
+
 			if($mybb->settings['akismetuidsignore'])
 			{
 				$akismet_uids_ignore = explode(',', $mybb->settings['akismetuidsignore']);
-				if(in_array($post2['usergroup'], $akismet_uids_ignore))
+				if(in_array($post2['usergroup'], $akismet_uids_ignore) || is_super_admin($post2['uid']))
 				{
 					continue;
 				}
 			}
 			
+			if(is_super_admin($post2['uid']))
+			{
+				continue;
+			}
+			
 			$db->write_query("UPDATE ".TABLE_PREFIX."users SET akismetstopped=akismetstopped+1 WHERE uid = '{$post2['uid']}'");
 			$query1 = $db->simple_select("users", "akismetstopped", "uid = '{$post2['uid']}'");
 			$akismetstopped = $db->fetch_field($query1, 'akismetstopped');
@@ -411,13 +476,14 @@
 			{
 				$banned_user = array(
 					"uid" => $post2['uid'],
-					"admin" => "Akismet",
+					"admin" => 0,
 					"gid" => 7,
 					"oldgroup" => $post2['usergroup'],
 					"dateline" => TIME_NOW,
 					"bantime" => 'perm',
 					"lifted" => 'perm',
-					"reason" => "Automatically banned by the Akismet system for spamming."
+					"reason" => "Automatically banned by the Akismet system for spamming.",
+					"oldadditionalgroups" => ''
 				);
 				$db->insert_query("banned", $banned_user);
 				
@@ -425,10 +491,9 @@
 				
 				$cache->update_moderators();
 			}
-			
-			++$unapprovedakismetthread;
-			++$unapprovedakismetpost;
 		}
+		
+		++$numakismetthread;
 	}
 	else
 	{
@@ -446,18 +511,24 @@
 			}
 		}
 		
+		if(is_super_admin($post['uid']))
+		{
+			continue;
+		}
+		
 		// Check if the person should be banned
 		if($mybb->settings['akismetnumtillban'] > 0 && $akismetstopped >= $mybb->settings['akismetnumtillban'])
 		{			
 			$banned_user = array(
 				"uid" => $post['uid'],
-				"admin" => "Akismet",
+				"admin" => 0,
 				"gid" => 7,
 				"oldgroup" => $usergroup,
 				"dateline" => TIME_NOW,
 				"bantime" => 'perm',
 				"lifted" => 'perm',
-				"reason" => "Automatically banned by the Akismet system for spamming."
+				"reason" => "Automatically banned by the Akismet system for spamming.",
+				"oldadditionalgroups" => ''
 			);
 			$db->insert_query("banned", $banned_user);
 			
@@ -466,12 +537,16 @@
 			$cache->update_moderators();
 		}
 		
-		++$unapprovedakismetthread;
-		++$unapprovedakismetpost;
+		++$numakismetpost;
+		
+		if($post['usepostcounts'] != 0)
+		{
+			$db->write_query("UPDATE ".TABLE_PREFIX."users SET postnum=postnum-1 WHERE uid = '{$post['uid']}'");
+		}
 	}
 	
-	update_thread_counters($post['tid'], array('unapprovedposts' => '-'.$unapprovedakismetpost));
-	update_forum_counters($post['fid'], array('unapprovedthreads' => $unapprovedakismetthread, 'unapprovedposts' => '-'.$unapprovedakismetpost));
+	update_thread_counters($post['tid'], array('replies' => '-'.$numakismetpost));
+	update_forum_counters($post['fid'], array('threads' => '-'.$numakismetthread, 'posts' => '-'.$numakismetpost));
 	
 	if($snippit == "thread")
 	{
@@ -492,6 +567,20 @@
 		return;
 	}
 	
+	if($mybb->settings['akismetuidsignore'])
+	{
+		$akismet_uids_ignore = explode(',', $mybb->settings['akismetuidsignore']);
+		if(in_array($usergroup, $akismet_uids_ignore))
+		{
+			return;
+		}
+	}
+	
+	if(is_super_admin($post['uid']))
+	{
+		return;
+	}
+	
 	$lang->load("akismet", false, true);
 	
 	eval("\$post['button_spam'] = \"".$templates->get("akismet_postbit_spam")."\";");
@@ -518,7 +607,7 @@
 	
 	$exclude_array = explode(',', $mybb->settings['akismetuserstoignore']);
 	
-	if(!$mybb->settings['akismetswitch'] || in_array($mybb->user['uid'], $exclude_array))
+	if(!$mybb->settings['akismetswitch'] || in_array($mybb->user['uid'], $exclude_array) || is_super_admin($mybb->user['uid']))
 	{
 		return;
 	}
@@ -570,13 +659,14 @@
 		{
 			$banned_user = array(
 				"uid" => $mybb->user['uid'],
-				"admin" => "Akismet",
+				"admin" => 0,
 				"gid" => 7,
 				"oldgroup" => $mybb->user['usergroup'],
 				"dateline" => TIME_NOW,
 				"bantime" => 'perm',
 				"lifted" => 'perm',
-				"reason" => "Automatically banned by the Akismet system for spamming."
+				"reason" => "Automatically banned by the Akismet system for spamming.",
+				"oldadditionalgroups" => ''
 			);
 			$db->insert_query("banned", $banned_user);
 			
@@ -685,7 +775,7 @@
 	
 	$page->add_breadcrumb_item($lang->akismet);
 	
-	if($mybb->input['delete_all'])
+	if($mybb->input['delete_all'] && $mybb->request_method == "post")
 	{	
 		// User clicked no
 		if($mybb->input['no'])
@@ -710,7 +800,7 @@
 		}
 	}
 	
-	if($mybb->input['unmark'])
+	if($mybb->input['unmark'] && $mybb->request_method == "post")
 	{
 		$unmark = $mybb->input['akismet'];
 	
@@ -721,12 +811,12 @@
 		}
 		
 		$posts_in = '';
+		$comma = '';
 		foreach($unmark as $key => $val)
 		{
-			$posts_in .= $comma.$key;
+			$posts_in .= $comma.intval($key);
 			$comma = ',';
 		}
-		$comma = '';
 	
 		$query = $db->simple_select("posts", "pid, tid", "pid IN ({$posts_in}) AND replyto = '0'");
 		while($post = $db->fetch_array($query))
@@ -742,7 +832,7 @@
 		$thread_list = implode(',', $threadp);
 		
 		$query = $db->query("
-			SELECT p.tid, f.usepostcounts, p.uid, p.fid, p.dateline, t.lastpost, t.lastposter, t.lastposteruid, t.subject
+			SELECT p.tid, f.usepostcounts, p.uid, p.fid, p.dateline, p.replyto, t.lastpost, t.lastposter, t.lastposteruid, t.subject
 			FROM ".TABLE_PREFIX."posts p
 			LEFT JOIN ".TABLE_PREFIX."threads t ON (t.tid=p.tid)
 			LEFT JOIN ".TABLE_PREFIX."forums f ON (f.fid=p.fid)
@@ -750,22 +840,15 @@
 		");
 		while($post = $db->fetch_array($query))
 		{
-			if($post['usepostcounts'] != 0)
-			{
-				$db->write_query("UPDATE ".TABLE_PREFIX."users SET postnum=postnum+1 WHERE uid = '{$post['uid']}'");
-			}
-	
-			update_thread_counters($post['tid'], array('posts' => '+1'));
-			
 			// Fetch the last post for this forum
-			$query = $db->query("
+			$query2 = $db->query("
 				SELECT tid, lastpost, lastposter, lastposteruid, subject
 				FROM ".TABLE_PREFIX."threads
 				WHERE fid='{$post['fid']}' AND visible='1' AND closed NOT LIKE 'moved|%'
 				ORDER BY lastpost DESC
 				LIMIT 0, 1
 			");
-			$lastpost = $db->fetch_array($query);
+			$lastpost = $db->fetch_array($query2);
 			
 			if($post['lastpost'] > $lastpost['lastpost'])
 			{
@@ -776,18 +859,7 @@
 				$lastpost['tid'] = $post['tid'];
 			}
 			
-			// Fetch the number of threads and replies in this forum (Approved only)
-			$query = $db->query("
-				SELECT COUNT(*) AS threads, SUM(replies) AS replies
-				FROM ".TABLE_PREFIX."threads
-				WHERE fid='{$post['fid']}' AND visible='1' AND closed NOT LIKE 'moved|%'
-			");
-			$count = $db->fetch_array($query);
-			$count['posts'] = $count['threads'] + $count['replies'];
-		
 			$update_count = array(
-				"posts" => intval($count['posts'])+1,
-				"threads" => intval($count['threads'])+1,
 				"lastpost" => intval($lastpost['lastpost']),
 				"lastposter" => $db->escape_string($lastpost['lastposter']),
 				"lastposteruid" => intval($lastpost['lastposteruid']),
@@ -797,15 +869,7 @@
 		
 			$db->update_query("forums", $update_count, "fid='{$post['fid']}'");
 			
-			$query = $db->query("
-				SELECT COUNT(*) AS replies
-				FROM ".TABLE_PREFIX."posts
-				WHERE tid='{$post['tid']}'
-				AND visible='1' OR pid = '{$post['pid']}'
-			");
-			$treplies = $db->fetch_field($query, 'replies');
-	
-			$query = $db->query("
+			$query2 = $db->query("
 				SELECT u.uid, u.username, p.username AS postusername, p.dateline
 				FROM ".TABLE_PREFIX."posts p 
 				LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=p.uid)
@@ -813,9 +877,9 @@
 				ORDER BY p.dateline DESC
 				LIMIT 1"
 			);
-			$lastpost = $db->fetch_array($query);
+			$lastpost = $db->fetch_array($query2);
 		
-			$query = $db->query("
+			$query2 = $db->query("
 				SELECT u.uid, u.username, p.username AS postusername, p.dateline
 				FROM ".TABLE_PREFIX."posts p 
 				LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=p.uid)
@@ -823,7 +887,7 @@
 				ORDER BY p.dateline ASC
 				LIMIT 0,1
 			");
-			$firstpost = $db->fetch_array($query);
+			$firstpost = $db->fetch_array($query2);
 			
 			if(!$firstpost['username'])
 			{
@@ -857,9 +921,27 @@
 				'lastpost' => intval($lastpost['dateline']),
 				'lastposter' => $lastpost['username'],
 				'lastposteruid' => intval($lastpost['uid']),
-				'replies' => $treplies
 			);
 			$db->update_query("threads", $update_array, "tid='{$post['tid']}'");
+			
+			if($post['usepostcounts'] != 0)
+			{
+				$db->write_query("UPDATE ".TABLE_PREFIX."users SET postnum=postnum+1 WHERE uid = '{$post['uid']}'");
+			}
+			
+			$newthreads = $newreplies = 0;
+			
+			if($post['replyto'] == 0)
+			{
+				++$newthreads;
+			}
+			else
+			{
+				++$newreplies;
+			}
+			
+			update_thread_counters($post['tid'], array('replies' => '+'.$newreplies));
+			update_forum_counters($post['fid'], array('threads' => '+'.$newthreads, 'posts' => '+1'));
 		}
 		
 		$approve = array(
@@ -880,7 +962,7 @@
 		admin_redirect("index.php?module=forum/akismet");
 	}
 	
-	if($mybb->input['delete'])
+	if($mybb->input['delete'] && $mybb->request_method == "post")
 	{
 		$deletepost = $mybb->input['akismet'];
 	
@@ -891,9 +973,10 @@
 		}
 		
 		$posts_in = '';
+		$comma = '';
 		foreach($deletepost as $key => $val)
 		{
-			$posts_in .= $comma.$key;
+			$posts_in .= $comma.intval($key);
 			$comma = ',';
 		}
 	
@@ -910,30 +993,30 @@
 		
 		require_once MYBB_ROOT."inc/functions_upload.php";
 		
-		foreach($deletepost as $key => $val)
+		foreach($deletepost as $pid => $val)
 		{
-			if(array_key_exists($key, $threadp))
+			if(array_key_exists($pid, $threadp))
 			{
 				$db->delete_query("posts", "pid IN ({$posts_in})");
 				$db->delete_query("attachments", "pid IN ({$posts_in})");
 	
 				// Get thread info
-				$query = $db->simple_select("threads", "poll", "tid='{$threadp[".$key."]}'");
+				$query = $db->simple_select("threads", "poll", "tid='".$threadp[$pid]."'");
 				$poll = $db->fetch_field($query, 'poll');
 		
 				// Delete threads, redirects, favorites, polls, and poll votes
-				$db->delete_query("threads", "tid='{$threadp[".$key."]}'");
-				$db->delete_query("threads", "closed='moved|{$threadp[".$key."]}'");
-				$db->delete_query("favorites", "tid='{$threadp[".$key."]}'");
-				$db->delete_query("polls", "tid='{$threadp[".$key."]}'");
-				$db->delete_query("pollvotes", "pid='$poll'");
+				$db->delete_query("threads", "tid='".$threadp[$pid]."'");
+				$db->delete_query("threads", "closed='moved|".$threadp[$pid]."'");
+				$db->delete_query("threadsubscriptions", "tid='".$threadp[$pid]."'");
+				$db->delete_query("polls", "tid='".$threadp[$pid]."'");
+				$db->delete_query("pollvotes", "pid='{$poll}'");
 			}
 			
 			// Remove attachments
-			remove_attachments($post['pid']);
+			remove_attachments($pid);
 			
 			// Delete the post
-			$db->delete_query("posts", "pid='{$post['pid']}'");
+			$db->delete_query("posts", "pid='{$pid}'");
 		}
 		
 		// Log admin action
@@ -1041,7 +1124,7 @@
 }
 
 /**
- * This class is Copyright 2007 Ryan Gordon (Tikitiki)
+ * This class is Copyright 2009 Ryan Gordon (Tikitiki)
  * Built to communicate with the akismet server
  */
 
diff -rub mybb_1400/inc/plugins/hello.php mybb_1408/inc/plugins/hello.php
--- mybb_1400/inc/plugins/hello.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/plugins/hello.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: hello.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: hello.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 // Disallow direct access to this file for security reasons
diff -rub mybb_1400/inc/settings.php mybb_1408/inc/settings.php
--- mybb_1400/inc/settings.php	2007-12-31 17:37:36.000000000 +0100
+++ mybb_1408/inc/settings.php	2009-06-26 06:22:11.000000000 +0200
@@ -1,2 +0,0 @@
-<?php
-?>
\ No newline at end of file
diff -rub mybb_1400/inc/tasks/backupdb.php mybb_1408/inc/tasks/backupdb.php
--- mybb_1400/inc/tasks/backupdb.php	2008-06-13 09:09:05.000000000 +0200
+++ mybb_1408/inc/tasks/backupdb.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: backupdb.php 3908 2008-06-13 07:09:05Z Tikitiki $
+ * $Id: backupdb.php 4350 2009-04-14 23:14:07Z Tikitiki $
  */
 
 function task_backupdb($task)
@@ -35,7 +35,7 @@
 	{
 		$db->set_table_prefix('');
 		
-		$file = MYBB_ADMIN_DIR.'backups/backup_'.substr(md5($mybb->user['uid'].TIME_NOW.random_str()), 0, 10);
+		$file = MYBB_ADMIN_DIR.'backups/backup_'.substr(md5($mybb->user['uid'].TIME_NOW), 0, 10).random_str(54);
 		
 		if(function_exists('gzopen'))
 		{
diff -rub mybb_1400/inc/tasks/checktables.php mybb_1408/inc/tasks/checktables.php
--- mybb_1400/inc/tasks/checktables.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/tasks/checktables.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,13 +6,19 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: checktables.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: checktables.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 function task_checktables($task)
 {
 	global $db, $mybb, $lang;
 	
+	// Sorry SQLite, you don't have a decent way of checking if the table is corrupted or not.
+	if($db->type == "sqlite2" || $db->type == "sqlite3")
+	{
+		return;
+	}
+	
 	@set_time_limit(0);
 	
 	$ok = array(
diff -rub mybb_1400/inc/tasks/dailycleanup.php mybb_1408/inc/tasks/dailycleanup.php
--- mybb_1400/inc/tasks/dailycleanup.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/tasks/dailycleanup.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,13 +6,15 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: dailycleanup.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: dailycleanup.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 function task_dailycleanup($task)
 {
 	global $mybb, $db, $cache, $lang;
 
+	require_once MYBB_ROOT."inc/functions_user.php";
+
 	// Clear out sessions older than 24h
 	$cut = TIME_NOW-60*60*24;
 	$db->delete_query("sessions", "uid='0' AND time < '{$cut}'");
diff -rub mybb_1400/inc/tasks/hourlycleanup.php mybb_1408/inc/tasks/hourlycleanup.php
--- mybb_1400/inc/tasks/hourlycleanup.php	2008-06-12 05:39:34.000000000 +0200
+++ mybb_1408/inc/tasks/hourlycleanup.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: hourlycleanup.php 3905 2008-06-12 03:39:34Z Tikitiki $
+ * $Id: hourlycleanup.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 function task_hourlycleanup($task)
diff -rub mybb_1400/inc/tasks/massmail.php mybb_1408/inc/tasks/massmail.php
--- mybb_1400/inc/tasks/massmail.php	2008-07-26 01:46:54.000000000 +0200
+++ mybb_1408/inc/tasks/massmail.php	2009-06-26 06:22:11.000000000 +0200
@@ -45,17 +45,23 @@
 		$query2 = $db->simple_select("users u", "u.uid, u.language, u.pmnotify, u.lastactive, u.username, u.email", $member_query, array('limit_start' => $mass_email['sentcount'], 'limit' => $mass_email['perpage'], 'order_by' => 'u.uid', 'order_dir' => 'asc'));
 		while($user = $db->fetch_array($query2))
 		{
-			$mass_email['message'] = str_replace("{uid}", $user['uid'], $mass_email['message']);
-			$mass_email['message'] = str_replace("{username}", $user['username'], $mass_email['message']);
-			$mass_email['message'] = str_replace("{email}", $user['email'], $mass_email['message']);
-			$mass_email['message'] = str_replace("{bbname}", $mybb->settings['bbname'], $mass_email['message']);
-			$mass_email['message'] = str_replace("{bburl}", $mybb->settings['bburl'], $mass_email['message']);
-			
-			$mass_email['htmlmessage'] = str_replace("{uid}", $user['uid'], $mass_email['htmlmessage']);
-			$mass_email['htmlmessage'] = str_replace("{username}", $user['username'], $mass_email['htmlmessage']);
-			$mass_email['htmlmessage'] = str_replace("{email}", $user['email'], $mass_email['htmlmessage']);
-			$mass_email['htmlmessage'] = str_replace("{bbname}", $mybb->settings['bbname'], $mass_email['htmlmessage']);
-			$mass_email['htmlmessage'] = str_replace("{bburl}", $mybb->settings['bburl'], $mass_email['htmlmessage']);
+			$replacement_fields = array(
+				"{uid}" => $user['uid'],						
+				"{username}" => $user['username'],
+				"{email}" => $user['email'],
+				"{bbname}" => $mybb->settings['bbname'],
+				"{bburl}" => $mybb->settings['bburl'],
+				"[".$lang->massmail_username."]" => $user['username'],
+				"[".$lang->email_addr."]" => $user['email'],
+				"[".$lang->board_name."]" => $mybb->settings['bbname'],
+				"[".$lang->board_url."]" => $mybb->settings['bburl']
+			);
+			
+			foreach($replacement_fields as $find => $replace)
+			{
+				$mass_email['message'] = str_replace($find, $replace, $mass_email['message']);
+				$mass_email['htmlmessage'] = str_replace($find, $replace, $mass_email['htmlmessage']);												
+			}
 				
 			// Private Message
 			if($mass_email['type'] == 1)
@@ -66,14 +72,23 @@
 				$pm = array(
 					"subject" => $mass_email['subject'],
 					"message" => $mass_email['message'],
-					"fromid" => $mass_email['uid']
+					"fromid" => $mass_email['uid'],
+					"options" => array("savecopy" => 0),
 				);
 				
 				$pm['to'] = explode(",", $user['username']);
 				$pm_handler->set_data($pm);
-				$pm_handler->validate_pm();
+				if(!$pm_handler->validate_pm())
+				{
+					$friendly_errors = implode('\n', $pm_handler->get_friendly_errors());
+					add_task_log($task, $lang->sprintf($lang->task_massmail_ran_errors, htmlspecialchars_uni($user['username']), $friendly_errors));
+					$friendly_errors = "";
+				}
+				else
+				{
 				$pm_handler->insert_pm();
 			}
+			}
 			// Normal Email
 			else
 			{
diff -rub mybb_1400/inc/tasks/promotions.php mybb_1408/inc/tasks/promotions.php
--- mybb_1400/inc/tasks/promotions.php	2008-06-05 02:38:28.000000000 +0200
+++ mybb_1408/inc/tasks/promotions.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: promotions.php 3883 2008-06-05 00:38:28Z Tikitiki $
+ * $Id: promotions.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 function task_promotions($task)
@@ -49,10 +49,10 @@
 				case "weeks":
 					$regdate = $promotion['registered']*60*60*24*7;
 				case "months":
-					$regdate = $promotion['registered']*60*60*24*7*30;
+					$regdate = $promotion['registered']*60*60*24*30;
 					break;
 				case "years":
-					$regdate = $promotion['registered']*60*60*24*7*365;
+					$regdate = $promotion['registered']*60*60*24*365;
 					break;
 				default:
 					$regdate = $promotion['registered']*60*60*24;
@@ -89,9 +89,10 @@
 			$usergroup_select = "usergroup";
 		}
 		
-		$query = $db->simple_select("users", "uid,{$usergroup_select}", $sql_where);
-		while($user = $db->fetch_array($query))
+		$query2 = $db->simple_select("users", "uid,{$usergroup_select}", $sql_where);
+		while($user = $db->fetch_array($query2))
 		{
+			// super admin check?
 			if($usergroup_select == "additionalgroups")
 			{
 				$log_inserts[] = array(
@@ -120,7 +121,12 @@
 			
 			if($usergroup_select == "additionalgroups")
 			{
-				join_usergroup($user['uid'], $promotion['newusergroup']);
+				if(join_usergroup($user['uid'], $promotion['newusergroup']) === false)
+				{
+					// Did the user already have the additional usergroup?
+					array_pop($log_inserts);
+					array_pop($uids);
+				}
 			}
 			
 			if((count($uids) % 20) == 0)
diff -rub mybb_1400/inc/tasks/threadviews.php mybb_1408/inc/tasks/threadviews.php
--- mybb_1400/inc/tasks/threadviews.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/inc/tasks/threadviews.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: threadviews.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: threadviews.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 function task_threadviews($task)
diff -rub mybb_1400/inc/tasks/usercleanup.php mybb_1408/inc/tasks/usercleanup.php
--- mybb_1400/inc/tasks/usercleanup.php	2008-06-05 02:38:28.000000000 +0200
+++ mybb_1408/inc/tasks/usercleanup.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: usercleanup.php 3883 2008-06-05 00:38:28Z Tikitiki $
+ * $Id: usercleanup.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 function task_usercleanup($task)
@@ -41,7 +41,7 @@
 		$updated_user = array(
 			"usergroup" => $ban['oldgroup'],
 			"additionalgroups" => $ban['oldadditionalgroups'],
-			"displaygroup" => $ban['displaygroup']
+			"displaygroup" => $ban['olddisplaygroup']
 		);
 		$db->update_query("users", $updated_user, "uid='{$ban['uid']}'");
 		$db->delete_query("banned", "uid='{$ban['uid']}'");
diff -rub mybb_1400/index.php mybb_1408/index.php
--- mybb_1400/index.php	2008-07-03 20:15:00.000000000 +0200
+++ mybb_1408/index.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: index.php 3973 2008-07-03 18:15:00Z Tikitiki $
+ * $Id: index.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'index.php');
 
 $templatelist = "index,index_whosonline,index_welcomemembertext,index_welcomeguest,index_whosonline_memberbit,forumbit_depth1_cat,forumbit_depth1_forum,forumbit_depth2_cat,forumbit_depth2_forum,forumbit_depth1_forum_lastpost,forumbit_depth2_forum_lastpost,index_modcolumn,forumbit_moderators,forumbit_subforums,index_welcomeguesttext";
 $templatelist .= ",index_birthdays_birthday,index_birthdays,index_pms,index_loginform,index_logoutlink,index_stats,forumbit_depth3,forumbit_depth3_statusicon,index_boardstats";
@@ -124,7 +125,8 @@
 	}
 
 	// Build the who's online bit on the index page.
-	$onlinecount = $membercount + $guestcount;
+	$onlinecount = $membercount + $guestcount + $botcount;
+	
 	if($onlinecount != 1)
 	{
 		$onlinebit = $lang->online_online_plural;
@@ -202,6 +204,7 @@
 			++$bdaycount;
 			$comma = ", ";
 		}
+	}
 		
 		if($hiddencount > 0)
 		{
@@ -211,7 +214,6 @@
 			}
 			$bdays .= "{$hiddencount} {$lang->birthdayhidden}";
 		}
-	}
 	
 	// If there are one or more birthdays, show them.
 	if($bdaycount > 0 || $hiddencount > 0)
diff -rub mybb_1400/install/index.php mybb_1408/install/index.php
--- mybb_1400/install/index.php	2008-08-02 05:19:04.000000000 +0200
+++ mybb_1408/install/index.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: index.php 4057 2008-08-02 03:19:04Z Tikitiki $
+ * $Id: index.php 4305 2009-01-02 08:05:39Z Tikitiki $
  */
 
 @error_reporting(E_ALL & ~E_NOTICE);
@@ -97,7 +97,7 @@
 if(function_exists('sqlite_open'))
 {
 	$dboptions['sqlite2'] = array(
-		'class' => 'DB_SQLite',
+		'class' => 'DB_SQLite2',
 		'title' => 'SQLite 2',
 		'short_title' => 'SQLite',
 		'structure_file' => 'sqlite_db_tables.php',
@@ -215,37 +215,632 @@
 	
 	$output->print_header($lang->license_agreement, 'license');
 
-	$license = '<h3>Important - Read Carefully</h3>
-<p>This MyBB End-User License Agreement ("EULA") is a legal agreement between you (either an individual or a single entity) and the MyBB Group for the MyBB product, which includes computer software and may include associated media, printed materials, and "online" or electronic documentation. By installing, copying, or otherwise using the MyBB product, you agree to be bound by the terms of this EULA. If you do not agree to the terms of this EULA, do not install or use the MyBB product and destroy any copies of the application.</p>
-<p>The MyBB Group may alter or modify this license agreement without notification and any changes made to the EULA will affect all past and current copies of MyBB</p>
-
-<h4>MyBB is FREE software</h4>
-<p>MyBB is distributed as "FREE" software granting you the right to download MyBB for FREE and installing a working physical copy at no extra charge.</p>
-<p>You may charge a fee for the physical act of transferring a copy.</p>
-
-<h4>Reproduction and Distribution</h4>
-<p>You may produce re-distributable copies of MyBB as long as the following terms are met:</p>
-<ul>
-	<li>You may not remove, alter or otherwise attempt to hide the MyBB copyright notice in any of the files within the original MyBB package.</li>
-	<li>Any additional files you add must not bare the copyright of the MyBB Group.</li>
-	<li>You agree that no support will be given to those who use the distributed modified copies.</li>
-	<li>The modified and re-distributed copies of MyBB must also be distributed with this exact license and licensed as FREE software. You may not charge for the software or distribution of the software.</li>
-</ul>
-
-<h4>Separation of Components</h4>
-<p>The MyBB software is licensed as a single product. Components, parts or any code may not be separated from the original MyBB package for either personal use or inclusion in other applications.</p>
-
-<h4>Termination</h4>
-<p>Without prejudice to any other rights, the MyBB Group may terminate this EULA if you fail to comply with the terms and conditions of this EULA. In such event, you must destroy all copies of the MyBB software and all of its component parts. The MyBB Group also reserve the right to revoke redistribution rights of MyBB from any corporation or entity for any specified reason.</p>
-
-<h4>Copyright</h4>
-<p>All title and copyrights in and to the MyBB software (including but not limited to any images, text, javascript and code incorporated in to the MyBB software), the accompanying materials and any copies of the MyBB software are owned by the MyBB Group.</p>
-<p>MyBB is protected by copyright laws and international treaty provisions. Therefore, you must treat MyBB like any other copyrighted material.</p>
-<p>The MyBB Group has several copyright notices and "powered by" lines embedded within the product. You must not remove, alter or hinder the visibility of any of these statements (including but not limited to the copyright notice at the top of files and the copyright/powered by lines found in publicly visible "templates").</p>
-
-<h4>Product Warranty and Liability for Damages</h4>
-<p>The MyBB Group expressly disclaims any warranty for MyBB. The MyBB software and any related documentation is provided "as is" without warranty of any kind, either express or implied, including, without limitation, the implied warranties or merchant-ability, fitness for a particular purpose, or non-infringement. The entire risk arising out of use or performance of MyBB remains with you.</p>
-<p>In no event shall the MyBB Group be liable for any damages whatsoever (including, without limitation, damages for loss of business profits, business interruption, loss of business information, or any other pecuniary loss) arising out of the use of or inability to use this product, even if the MyBB Group has been advised of the possibility of such damages. Because some states/jurisdictions do not allow the exclusion or limitation of liability for consequential or incidental damages, the above limitation may not apply to you.</p>';
+	$license = <<<EOF
+<pre>
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 3, 29 June 2007
+
+ Copyright (C) 2007 Free Software Foundation, Inc. &lt;http://fsf.org/&gt;
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The GNU General Public License is a free, copyleft license for
+software and other kinds of works.
+
+  The licenses for most software and other practical works are designed
+to take away your freedom to share and change the works.  By contrast,
+the GNU General Public License is intended to guarantee your freedom to
+share and change all versions of a program--to make sure it remains free
+software for all its users.  We, the Free Software Foundation, use the
+GNU General Public License for most of our software; it applies also to
+any other work released this way by its authors.  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+them if you wish), that you receive source code or can get it if you
+want it, that you can change the software or use pieces of it in new
+free programs, and that you know you can do these things.
+
+  To protect your rights, we need to prevent others from denying you
+these rights or asking you to surrender the rights.  Therefore, you have
+certain responsibilities if you distribute copies of the software, or if
+you modify it: responsibilities to respect the freedom of others.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must pass on to the recipients the same
+freedoms that you received.  You must make sure that they, too, receive
+or can get the source code.  And you must show them these terms so they
+know their rights.
+
+  Developers that use the GNU GPL protect your rights with two steps:
+(1) assert copyright on the software, and (2) offer you this License
+giving you legal permission to copy, distribute and/or modify it.
+
+  For the developers' and authors' protection, the GPL clearly explains
+that there is no warranty for this free software.  For both users' and
+authors' sake, the GPL requires that modified versions be marked as
+changed, so that their problems will not be attributed erroneously to
+authors of previous versions.
+
+  Some devices are designed to deny users access to install or run
+modified versions of the software inside them, although the manufacturer
+can do so.  This is fundamentally incompatible with the aim of
+protecting users' freedom to change the software.  The systematic
+pattern of such abuse occurs in the area of products for individuals to
+use, which is precisely where it is most unacceptable.  Therefore, we
+have designed this version of the GPL to prohibit the practice for those
+products.  If such problems arise substantially in other domains, we
+stand ready to extend this provision to those domains in future versions
+of the GPL, as needed to protect the freedom of users.
+
+  Finally, every program is threatened constantly by software patents.
+States should not allow patents to restrict development and use of
+software on general-purpose computers, but in those that do, we wish to
+avoid the special danger that patents applied to a free program could
+make it effectively proprietary.  To prevent this, the GPL assures that
+patents cannot be used to render the program non-free.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                       TERMS AND CONDITIONS
+
+  0. Definitions.
+
+  "This License" refers to version 3 of the GNU General Public License.
+
+  "Copyright" also means copyright-like laws that apply to other kinds of
+works, such as semiconductor masks.
+
+  "The Program" refers to any copyrightable work licensed under this
+License.  Each licensee is addressed as "you".  "Licensees" and
+"recipients" may be individuals or organizations.
+
+  To "modify" a work means to copy from or adapt all or part of the work
+in a fashion requiring copyright permission, other than the making of an
+exact copy.  The resulting work is called a "modified version" of the
+earlier work or a work "based on" the earlier work.
+
+  A "covered work" means either the unmodified Program or a work based
+on the Program.
+
+  To "propagate" a work means to do anything with it that, without
+permission, would make you directly or secondarily liable for
+infringement under applicable copyright law, except executing it on a
+computer or modifying a private copy.  Propagation includes copying,
+distribution (with or without modification), making available to the
+public, and in some countries other activities as well.
+
+  To "convey" a work means any kind of propagation that enables other
+parties to make or receive copies.  Mere interaction with a user through
+a computer network, with no transfer of a copy, is not conveying.
+
+  An interactive user interface displays "Appropriate Legal Notices"
+to the extent that it includes a convenient and prominently visible
+feature that (1) displays an appropriate copyright notice, and (2)
+tells the user that there is no warranty for the work (except to the
+extent that warranties are provided), that licensees may convey the
+work under this License, and how to view a copy of this License.  If
+the interface presents a list of user commands or options, such as a
+menu, a prominent item in the list meets this criterion.
+
+  1. Source Code.
+
+  The "source code" for a work means the preferred form of the work
+for making modifications to it.  "Object code" means any non-source
+form of a work.
+
+  A "Standard Interface" means an interface that either is an official
+standard defined by a recognized standards body, or, in the case of
+interfaces specified for a particular programming language, one that
+is widely used among developers working in that language.
+
+  The "System Libraries" of an executable work include anything, other
+than the work as a whole, that (a) is included in the normal form of
+packaging a Major Component, but which is not part of that Major
+Component, and (b) serves only to enable use of the work with that
+Major Component, or to implement a Standard Interface for which an
+implementation is available to the public in source code form.  A
+"Major Component", in this context, means a major essential component
+(kernel, window system, and so on) of the specific operating system
+(if any) on which the executable work runs, or a compiler used to
+produce the work, or an object code interpreter used to run it.
+
+  The "Corresponding Source" for a work in object code form means all
+the source code needed to generate, install, and (for an executable
+work) run the object code and to modify the work, including scripts to
+control those activities.  However, it does not include the work's
+System Libraries, or general-purpose tools or generally available free
+programs which are used unmodified in performing those activities but
+which are not part of the work.  For example, Corresponding Source
+includes interface definition files associated with source files for
+the work, and the source code for shared libraries and dynamically
+linked subprograms that the work is specifically designed to require,
+such as by intimate data communication or control flow between those
+subprograms and other parts of the work.
+
+  The Corresponding Source need not include anything that users
+can regenerate automatically from other parts of the Corresponding
+Source.
+
+  The Corresponding Source for a work in source code form is that
+same work.
+
+  2. Basic Permissions.
+
+  All rights granted under this License are granted for the term of
+copyright on the Program, and are irrevocable provided the stated
+conditions are met.  This License explicitly affirms your unlimited
+permission to run the unmodified Program.  The output from running a
+covered work is covered by this License only if the output, given its
+content, constitutes a covered work.  This License acknowledges your
+rights of fair use or other equivalent, as provided by copyright law.
+
+  You may make, run and propagate covered works that you do not
+convey, without conditions so long as your license otherwise remains
+in force.  You may convey covered works to others for the sole purpose
+of having them make modifications exclusively for you, or provide you
+with facilities for running those works, provided that you comply with
+the terms of this License in conveying all material for which you do
+not control copyright.  Those thus making or running the covered works
+for you must do so exclusively on your behalf, under your direction
+and control, on terms that prohibit them from making any copies of
+your copyrighted material outside their relationship with you.
+
+  Conveying under any other circumstances is permitted solely under
+the conditions stated below.  Sublicensing is not allowed; section 10
+makes it unnecessary.
+
+  3. Protecting Users' Legal Rights From Anti-Circumvention Law.
+
+  No covered work shall be deemed part of an effective technological
+measure under any applicable law fulfilling obligations under article
+11 of the WIPO copyright treaty adopted on 20 December 1996, or
+similar laws prohibiting or restricting circumvention of such
+measures.
+
+  When you convey a covered work, you waive any legal power to forbid
+circumvention of technological measures to the extent such circumvention
+is effected by exercising rights under this License with respect to
+the covered work, and you disclaim any intention to limit operation or
+modification of the work as a means of enforcing, against the work's
+users, your or third parties' legal rights to forbid circumvention of
+technological measures.
+
+  4. Conveying Verbatim Copies.
+
+  You may convey verbatim copies of the Program's source code as you
+receive it, in any medium, provided that you conspicuously and
+appropriately publish on each copy an appropriate copyright notice;
+keep intact all notices stating that this License and any
+non-permissive terms added in accord with section 7 apply to the code;
+keep intact all notices of the absence of any warranty; and give all
+recipients a copy of this License along with the Program.
+
+  You may charge any price or no price for each copy that you convey,
+and you may offer support or warranty protection for a fee.
+
+  5. Conveying Modified Source Versions.
+
+  You may convey a work based on the Program, or the modifications to
+produce it from the Program, in the form of source code under the
+terms of section 4, provided that you also meet all of these conditions:
+
+    a) The work must carry prominent notices stating that you modified
+    it, and giving a relevant date.
+
+    b) The work must carry prominent notices stating that it is
+    released under this License and any conditions added under section
+    7.  This requirement modifies the requirement in section 4 to
+    "keep intact all notices".
+
+    c) You must license the entire work, as a whole, under this
+    License to anyone who comes into possession of a copy.  This
+    License will therefore apply, along with any applicable section 7
+    additional terms, to the whole of the work, and all its parts,
+    regardless of how they are packaged.  This License gives no
+    permission to license the work in any other way, but it does not
+    invalidate such permission if you have separately received it.
+
+    d) If the work has interactive user interfaces, each must display
+    Appropriate Legal Notices; however, if the Program has interactive
+    interfaces that do not display Appropriate Legal Notices, your
+    work need not make them do so.
+
+  A compilation of a covered work with other separate and independent
+works, which are not by their nature extensions of the covered work,
+and which are not combined with it such as to form a larger program,
+in or on a volume of a storage or distribution medium, is called an
+"aggregate" if the compilation and its resulting copyright are not
+used to limit the access or legal rights of the compilation's users
+beyond what the individual works permit.  Inclusion of a covered work
+in an aggregate does not cause this License to apply to the other
+parts of the aggregate.
+
+  6. Conveying Non-Source Forms.
+
+  You may convey a covered work in object code form under the terms
+of sections 4 and 5, provided that you also convey the
+machine-readable Corresponding Source under the terms of this License,
+in one of these ways:
+
+    a) Convey the object code in, or embodied in, a physical product
+    (including a physical distribution medium), accompanied by the
+    Corresponding Source fixed on a durable physical medium
+    customarily used for software interchange.
+
+    b) Convey the object code in, or embodied in, a physical product
+    (including a physical distribution medium), accompanied by a
+    written offer, valid for at least three years and valid for as
+    long as you offer spare parts or customer support for that product
+    model, to give anyone who possesses the object code either (1) a
+    copy of the Corresponding Source for all the software in the
+    product that is covered by this License, on a durable physical
+    medium customarily used for software interchange, for a price no
+    more than your reasonable cost of physically performing this
+    conveying of source, or (2) access to copy the
+    Corresponding Source from a network server at no charge.
+
+    c) Convey individual copies of the object code with a copy of the
+    written offer to provide the Corresponding Source.  This
+    alternative is allowed only occasionally and noncommercially, and
+    only if you received the object code with such an offer, in accord
+    with subsection 6b.
+
+    d) Convey the object code by offering access from a designated
+    place (gratis or for a charge), and offer equivalent access to the
+    Corresponding Source in the same way through the same place at no
+    further charge.  You need not require recipients to copy the
+    Corresponding Source along with the object code.  If the place to
+    copy the object code is a network server, the Corresponding Source
+    may be on a different server (operated by you or a third party)
+    that supports equivalent copying facilities, provided you maintain
+    clear directions next to the object code saying where to find the
+    Corresponding Source.  Regardless of what server hosts the
+    Corresponding Source, you remain obligated to ensure that it is
+    available for as long as needed to satisfy these requirements.
+
+    e) Convey the object code using peer-to-peer transmission, provided
+    you inform other peers where the object code and Corresponding
+    Source of the work are being offered to the general public at no
+    charge under subsection 6d.
+
+  A separable portion of the object code, whose source code is excluded
+from the Corresponding Source as a System Library, need not be
+included in conveying the object code work.
+
+  A "User Product" is either (1) a "consumer product", which means any
+tangible personal property which is normally used for personal, family,
+or household purposes, or (2) anything designed or sold for incorporation
+into a dwelling.  In determining whether a product is a consumer product,
+doubtful cases shall be resolved in favor of coverage.  For a particular
+product received by a particular user, "normally used" refers to a
+typical or common use of that class of product, regardless of the status
+of the particular user or of the way in which the particular user
+actually uses, or expects or is expected to use, the product.  A product
+is a consumer product regardless of whether the product has substantial
+commercial, industrial or non-consumer uses, unless such uses represent
+the only significant mode of use of the product.
+
+  "Installation Information" for a User Product means any methods,
+procedures, authorization keys, or other information required to install
+and execute modified versions of a covered work in that User Product from
+a modified version of its Corresponding Source.  The information must
+suffice to ensure that the continued functioning of the modified object
+code is in no case prevented or interfered with solely because
+modification has been made.
+
+  If you convey an object code work under this section in, or with, or
+specifically for use in, a User Product, and the conveying occurs as
+part of a transaction in which the right of possession and use of the
+User Product is transferred to the recipient in perpetuity or for a
+fixed term (regardless of how the transaction is characterized), the
+Corresponding Source conveyed under this section must be accompanied
+by the Installation Information.  But this requirement does not apply
+if neither you nor any third party retains the ability to install
+modified object code on the User Product (for example, the work has
+been installed in ROM).
+
+  The requirement to provide Installation Information does not include a
+requirement to continue to provide support service, warranty, or updates
+for a work that has been modified or installed by the recipient, or for
+the User Product in which it has been modified or installed.  Access to a
+network may be denied when the modification itself materially and
+adversely affects the operation of the network or violates the rules and
+protocols for communication across the network.
+
+  Corresponding Source conveyed, and Installation Information provided,
+in accord with this section must be in a format that is publicly
+documented (and with an implementation available to the public in
+source code form), and must require no special password or key for
+unpacking, reading or copying.
+
+  7. Additional Terms.
+
+  "Additional permissions" are terms that supplement the terms of this
+License by making exceptions from one or more of its conditions.
+Additional permissions that are applicable to the entire Program shall
+be treated as though they were included in this License, to the extent
+that they are valid under applicable law.  If additional permissions
+apply only to part of the Program, that part may be used separately
+under those permissions, but the entire Program remains governed by
+this License without regard to the additional permissions.
+
+  When you convey a copy of a covered work, you may at your option
+remove any additional permissions from that copy, or from any part of
+it.  (Additional permissions may be written to require their own
+removal in certain cases when you modify the work.)  You may place
+additional permissions on material, added by you to a covered work,
+for which you have or can give appropriate copyright permission.
+
+  Notwithstanding any other provision of this License, for material you
+add to a covered work, you may (if authorized by the copyright holders of
+that material) supplement the terms of this License with terms:
+
+    a) Disclaiming warranty or limiting liability differently from the
+    terms of sections 15 and 16 of this License; or
+
+    b) Requiring preservation of specified reasonable legal notices or
+    author attributions in that material or in the Appropriate Legal
+    Notices displayed by works containing it; or
+
+    c) Prohibiting misrepresentation of the origin of that material, or
+    requiring that modified versions of such material be marked in
+    reasonable ways as different from the original version; or
+
+    d) Limiting the use for publicity purposes of names of licensors or
+    authors of the material; or
+
+    e) Declining to grant rights under trademark law for use of some
+    trade names, trademarks, or service marks; or
+
+    f) Requiring indemnification of licensors and authors of that
+    material by anyone who conveys the material (or modified versions of
+    it) with contractual assumptions of liability to the recipient, for
+    any liability that these contractual assumptions directly impose on
+    those licensors and authors.
+
+  All other non-permissive additional terms are considered "further
+restrictions" within the meaning of section 10.  If the Program as you
+received it, or any part of it, contains a notice stating that it is
+governed by this License along with a term that is a further
+restriction, you may remove that term.  If a license document contains
+a further restriction but permits relicensing or conveying under this
+License, you may add to a covered work material governed by the terms
+of that license document, provided that the further restriction does
+not survive such relicensing or conveying.
+
+  If you add terms to a covered work in accord with this section, you
+must place, in the relevant source files, a statement of the
+additional terms that apply to those files, or a notice indicating
+where to find the applicable terms.
+
+  Additional terms, permissive or non-permissive, may be stated in the
+form of a separately written license, or stated as exceptions;
+the above requirements apply either way.
+
+  8. Termination.
+
+  You may not propagate or modify a covered work except as expressly
+provided under this License.  Any attempt otherwise to propagate or
+modify it is void, and will automatically terminate your rights under
+this License (including any patent licenses granted under the third
+paragraph of section 11).
+
+  However, if you cease all violation of this License, then your
+license from a particular copyright holder is reinstated (a)
+provisionally, unless and until the copyright holder explicitly and
+finally terminates your license, and (b) permanently, if the copyright
+holder fails to notify you of the violation by some reasonable means
+prior to 60 days after the cessation.
+
+  Moreover, your license from a particular copyright holder is
+reinstated permanently if the copyright holder notifies you of the
+violation by some reasonable means, this is the first time you have
+received notice of violation of this License (for any work) from that
+copyright holder, and you cure the violation prior to 30 days after
+your receipt of the notice.
+
+  Termination of your rights under this section does not terminate the
+licenses of parties who have received copies or rights from you under
+this License.  If your rights have been terminated and not permanently
+reinstated, you do not qualify to receive new licenses for the same
+material under section 10.
+
+  9. Acceptance Not Required for Having Copies.
+
+  You are not required to accept this License in order to receive or
+run a copy of the Program.  Ancillary propagation of a covered work
+occurring solely as a consequence of using peer-to-peer transmission
+to receive a copy likewise does not require acceptance.  However,
+nothing other than this License grants you permission to propagate or
+modify any covered work.  These actions infringe copyright if you do
+not accept this License.  Therefore, by modifying or propagating a
+covered work, you indicate your acceptance of this License to do so.
+
+  10. Automatic Licensing of Downstream Recipients.
+
+  Each time you convey a covered work, the recipient automatically
+receives a license from the original licensors, to run, modify and
+propagate that work, subject to this License.  You are not responsible
+for enforcing compliance by third parties with this License.
+
+  An "entity transaction" is a transaction transferring control of an
+organization, or substantially all assets of one, or subdividing an
+organization, or merging organizations.  If propagation of a covered
+work results from an entity transaction, each party to that
+transaction who receives a copy of the work also receives whatever
+licenses to the work the party's predecessor in interest had or could
+give under the previous paragraph, plus a right to possession of the
+Corresponding Source of the work from the predecessor in interest, if
+the predecessor has it or can get it with reasonable efforts.
+
+  You may not impose any further restrictions on the exercise of the
+rights granted or affirmed under this License.  For example, you may
+not impose a license fee, royalty, or other charge for exercise of
+rights granted under this License, and you may not initiate litigation
+(including a cross-claim or counterclaim in a lawsuit) alleging that
+any patent claim is infringed by making, using, selling, offering for
+sale, or importing the Program or any portion of it.
+
+  11. Patents.
+
+  A "contributor" is a copyright holder who authorizes use under this
+License of the Program or a work on which the Program is based.  The
+work thus licensed is called the contributor's "contributor version".
+
+  A contributor's "essential patent claims" are all patent claims
+owned or controlled by the contributor, whether already acquired or
+hereafter acquired, that would be infringed by some manner, permitted
+by this License, of making, using, or selling its contributor version,
+but do not include claims that would be infringed only as a
+consequence of further modification of the contributor version.  For
+purposes of this definition, "control" includes the right to grant
+patent sublicenses in a manner consistent with the requirements of
+this License.
+
+  Each contributor grants you a non-exclusive, worldwide, royalty-free
+patent license under the contributor's essential patent claims, to
+make, use, sell, offer for sale, import and otherwise run, modify and
+propagate the contents of its contributor version.
+
+  In the following three paragraphs, a "patent license" is any express
+agreement or commitment, however denominated, not to enforce a patent
+(such as an express permission to practice a patent or covenant not to
+sue for patent infringement).  To "grant" such a patent license to a
+party means to make such an agreement or commitment not to enforce a
+patent against the party.
+
+  If you convey a covered work, knowingly relying on a patent license,
+and the Corresponding Source of the work is not available for anyone
+to copy, free of charge and under the terms of this License, through a
+publicly available network server or other readily accessible means,
+then you must either (1) cause the Corresponding Source to be so
+available, or (2) arrange to deprive yourself of the benefit of the
+patent license for this particular work, or (3) arrange, in a manner
+consistent with the requirements of this License, to extend the patent
+license to downstream recipients.  "Knowingly relying" means you have
+actual knowledge that, but for the patent license, your conveying the
+covered work in a country, or your recipient's use of the covered work
+in a country, would infringe one or more identifiable patents in that
+country that you have reason to believe are valid.
+
+  If, pursuant to or in connection with a single transaction or
+arrangement, you convey, or propagate by procuring conveyance of, a
+covered work, and grant a patent license to some of the parties
+receiving the covered work authorizing them to use, propagate, modify
+or convey a specific copy of the covered work, then the patent license
+you grant is automatically extended to all recipients of the covered
+work and works based on it.
+
+  A patent license is "discriminatory" if it does not include within
+the scope of its coverage, prohibits the exercise of, or is
+conditioned on the non-exercise of one or more of the rights that are
+specifically granted under this License.  You may not convey a covered
+work if you are a party to an arrangement with a third party that is
+in the business of distributing software, under which you make payment
+to the third party based on the extent of your activity of conveying
+the work, and under which the third party grants, to any of the
+parties who would receive the covered work from you, a discriminatory
+patent license (a) in connection with copies of the covered work
+conveyed by you (or copies made from those copies), or (b) primarily
+for and in connection with specific products or compilations that
+contain the covered work, unless you entered into that arrangement,
+or that patent license was granted, prior to 28 March 2007.
+
+  Nothing in this License shall be construed as excluding or limiting
+any implied license or other defenses to infringement that may
+otherwise be available to you under applicable patent law.
+
+  12. No Surrender of Others' Freedom.
+
+  If conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot convey a
+covered work so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you may
+not convey it at all.  For example, if you agree to terms that obligate you
+to collect a royalty for further conveying from those to whom you convey
+the Program, the only way you could satisfy both those terms and this
+License would be to refrain entirely from conveying the Program.
+
+  13. Use with the GNU Affero General Public License.
+
+  Notwithstanding any other provision of this License, you have
+permission to link or combine any covered work with a work licensed
+under version 3 of the GNU Affero General Public License into a single
+combined work, and to convey the resulting work.  The terms of this
+License will continue to apply to the part which is the covered work,
+but the special requirements of the GNU Affero General Public License,
+section 13, concerning interaction through a network will apply to the
+combination as such.
+
+  14. Revised Versions of this License.
+
+  The Free Software Foundation may publish revised and/or new versions of
+the GNU General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+  Each version is given a distinguishing version number.  If the
+Program specifies that a certain numbered version of the GNU General
+Public License "or any later version" applies to it, you have the
+option of following the terms and conditions either of that numbered
+version or of any later version published by the Free Software
+Foundation.  If the Program does not specify a version number of the
+GNU General Public License, you may choose any version ever published
+by the Free Software Foundation.
+
+  If the Program specifies that a proxy can decide which future
+versions of the GNU General Public License can be used, that proxy's
+public statement of acceptance of a version permanently authorizes you
+to choose that version for the Program.
+
+  Later license versions may give you additional or different
+permissions.  However, no additional obligations are imposed on any
+author or copyright holder as a result of your choosing to follow a
+later version.
+
+  15. Disclaimer of Warranty.
+
+  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
+APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
+HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
+OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
+THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
+IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
+ALL NECESSARY SERVICING, REPAIR OR CORRECTION.
+
+  16. Limitation of Liability.
+
+  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS
+THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
+GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE
+USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF
+DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD
+PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),
+EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
+SUCH DAMAGES.
+
+  17. Interpretation of Sections 15 and 16.
+
+  If the disclaimer of warranty and limitation of liability provided
+above cannot be given local legal effect according to their terms,
+reviewing courts shall apply local law that most closely approximates
+an absolute waiver of all civil liability in connection with the
+Program, unless a warranty or assumption of liability accompanies a
+copy of the Program in return for a fee.
+
+                     END OF TERMS AND CONDITIONS
+</pre>
+EOF;
+
 	echo $lang->sprintf($lang->license_step, $license);
 	$output->print_footer('requirements_check');
 }
@@ -375,8 +970,8 @@
 	{
 		$cachestatus = $lang->sprintf($lang->req_step_span_pass, $lang->writable);
 		@fclose($cachewritable);
-	  	@my_chmod(MYBB_ROOT.'cache', 0777);
-	  	@my_chmod(MYBB_ROOT.'cache/test.write', 0777);
+	  	@my_chmod(MYBB_ROOT.'cache', '0777');
+	  	@my_chmod(MYBB_ROOT.'cache/test.write', '0777');
 		@unlink(MYBB_ROOT.'cache/test.write');
 	}
 
@@ -393,8 +988,8 @@
 	{
 		$uploadsstatus = $lang->sprintf($lang->req_step_span_pass, $lang->writable);
 		@fclose($uploadswritable);
-	  	@my_chmod(MYBB_ROOT.'uploads', 0777);
-	  	@my_chmod(MYBB_ROOT.'uploads/test.write', 0777);
+	  	@my_chmod(MYBB_ROOT.'uploads', '0777');
+	  	@my_chmod(MYBB_ROOT.'uploads/test.write', '0777');
 		@unlink(MYBB_ROOT.'uploads/test.write');
 	}
 
@@ -411,8 +1006,8 @@
 	{
 		$avatarsstatus = $lang->sprintf($lang->req_step_span_pass, $lang->writable);
 		@fclose($avatarswritable);
-		@my_chmod(MYBB_ROOT.'uploads/avatars', 0777);
-	  	@my_chmod(MYBB_ROOT.'uploads/avatars/test.write', 0777);
+		@my_chmod(MYBB_ROOT.'uploads/avatars', '0777');
+	  	@my_chmod(MYBB_ROOT.'uploads/avatars/test.write', '0777');
 		@unlink(MYBB_ROOT.'uploads/avatars/test.write');
   	}
 
@@ -616,7 +1211,23 @@
 
 	// Attempt to connect to the db
 	require_once MYBB_ROOT."inc/db_{$mybb->input['dbengine']}.php";
-	$db = new databaseEngine;
+	switch($mybb->input['dbengine'])
+	{
+		case "sqlite3":
+			$db = new DB_SQLite3;
+			break;
+		case "sqlite2":
+			$db = new DB_SQLite2;
+			break;
+		case "pgsql":
+			$db = new DB_PgSQL;
+			break;
+		case "mysqli":
+			$db = new DB_MySQLi;
+			break;
+		default:
+			$db = new DB_MySQL;
+	}
  	$db->error_reporting = 0;
 
 	$connect_array = array(
@@ -853,15 +1464,16 @@
 	{
 		require_once MYBB_ROOT.$mybb->config['admin_dir']."/inc/functions_themes.php";
 	}
-	else if(file_exists(MYBB_ROOT."admin/inc/functions_themes.php"))
+	elseif(file_exists(MYBB_ROOT."admin/inc/functions_themes.php"))
 	{
 		require_once MYBB_ROOT."admin/inc/functions_themes.php";
+		
 	}
 	else
 	{
 		$output->print_error("Please make sure your admin directory is uploaded correctly.");
 	}
-	$theme_id = import_theme_xml($contents, array("templateset" => -2));
+	$theme_id = import_theme_xml($contents, array("templateset" => -2, "version_compat" => 1));
 	$tid = build_new_theme("Default", null, $theme_id);
 	
 	// Update our properties template set to the correct one
@@ -1336,6 +1948,7 @@
 	$cache->update_banned();
 	$cache->update_birthdays();
 	$cache->update("plugins", array());
+	$cache->update("internal_settings", array('encryption_key' => random_str(32)));
 	echo $lang->done . '</p>';
 
 	echo $lang->done_step_success;
@@ -1362,13 +1975,31 @@
 function db_connection($config)
 {
 	require_once MYBB_ROOT."inc/db_{$config['database']['type']}.php";
-	$db = new databaseEngine;
+	switch($config['database']['type'])
+	{
+		case "sqlite3":
+			$db = new DB_SQLite3;
+			break;
+		case "sqlite2":
+			$db = new DB_SQLite2;
+			break;
+		case "pgsql":
+			$db = new DB_PgSQL;
+			break;
+		case "mysqli":
+			$db = new DB_MySQLi;
+			break;
+		default:
+			$db = new DB_MySQL;
+	}
 	
 	// Connect to Database
 	define('TABLE_PREFIX', $config['database']['table_prefix']);
 
 	$db->connect($config['database']);
 	$db->set_table_prefix(TABLE_PREFIX);
+	$db->type = $config['database']['type'];
+	
 	return $db;
 }
 
diff -rub mybb_1400/install/resources/language.lang.php mybb_1408/install/resources/language.lang.php
--- mybb_1400/install/resources/language.lang.php	2008-07-19 20:51:09.000000000 +0200
+++ mybb_1408/install/resources/language.lang.php	2009-06-26 06:22:11.000000000 +0200
@@ -244,6 +244,7 @@
 					<td class="first"><label for="contactemail">Contact Email:</label></td>
 					<td class="last alt_col"><input type="text" class="text_input" name="contactemail" id="contactemail" value="{7}" /></td>
 				</tr>
+				</tbody>
 			</table>
 		</div>
 
@@ -317,7 +318,7 @@
 <p>The MyBB Group thanks you for your support in installing our software and we hope to see you around the community forums if you need help or wish to become a part of the MyBB community.</p>';
 $l['done_step_locked'] = '<p>Your installer has been locked. To unlock the installer please delete the \'lock\' file in this directory.</p><p>You may now proceed to your new copy of <a href="../index.php">MyBB</a> or its <a href="../admin/index.php">Admin Control Panel</a>.</p>';
 $l['done_step_dirdelete'] = '<p><strong><span style="colour:red">Please remove this directory before exploring your copy of MyBB.</span></strong></p>';
-$l['done_subscribe_mailing'] = '<div class="error"><p><strong>Make sure you\'re subscribed to the updates mailing list!</strong></p><p>Everytime we release a new version of MyBB, be it a new feature release or security update, we send out a message via our mailing list to alert you of the release.</p><p>This helps keep you up to date with new security releases and ensures you\'re running the latest and greatest version of MyBB!</p><p><a href="http://www.mybboard.net/mailinglist.php">Subscribe to the updates mailing list!</a></p>';
+$l['done_subscribe_mailing'] = '<div class="error"><p><strong>Make sure you\'re subscribed to the updates mailing list!</strong></p><p>Everytime we release a new version of MyBB, be it a new feature release or security update, we send out a message via our mailing list to alert you of the release.</p><p>This helps keep you up to date with new security releases and ensures you\'re running the latest and greatest version of MyBB!</p><p><a href="http://www.mybboard.net/mailing-list" target="_blank">Subscribe to the updates mailing list!</a></p>';
 
 /* UPGRADE LANGUAGE VARIABLES */
 $l['upgrade'] = "Upgrade Process";
diff -rub mybb_1400/install/resources/mybb_theme.xml mybb_1408/install/resources/mybb_theme.xml
--- mybb_1400/install/resources/mybb_theme.xml	2008-08-02 05:19:04.000000000 +0200
+++ mybb_1408/install/resources/mybb_theme.xml	2009-06-26 07:28:19.000000000 +0200
@@ -424,6 +424,13 @@
 	font-weight: normal;
 }
 
+
+blockquote cite span.highlight {
+	float: none;
+	font-weight: bold;
+	padding-bottom: 0;
+}
+
 .codeblock {
 	background: #fff;
 	border: 1px solid #ccc;
@@ -1126,7 +1133,7 @@
 {$footer}
 </body>
 </html>]]></template>
-		<template name="modcp_modlogs" version="1400"><![CDATA[<html>
+		<template name="modcp_modlogs" version="1405"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->modlogs}</title>
 {$headerinclude}
@@ -1197,7 +1204,7 @@
 					</table>
 					<br />
 					<div align="center">
-						<input type="submit" value="{$lang->filter_logs}" />
+						<input type="submit" class="button" value="{$lang->filter_logs}" />
 					</div>
 				</td>
 			</tr>
@@ -1378,7 +1385,7 @@
 		<template name="modcp_modlogs_multipage" version="1400"><![CDATA[<tr>
 <td class="tcat" colspan="6"><span class="smalltext"> {$multipage}</span></td>
 </tr>]]></template>
-		<template name="modcp_ipsearch" version="1400"><![CDATA[
+		<template name="modcp_ipsearch" version="1405"><![CDATA[
 		<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->ipsearch}</title>
@@ -1410,7 +1417,7 @@
 					</table>
 					<br />
 					<div align="center">
-						<input type="submit" value="{$lang->find}" />
+						<input type="submit" class="button" value="{$lang->find}" />
 					</div>
 				</td>
 			</tr>
@@ -1431,9 +1438,10 @@
 					</table>
 					{$multipage}
 					<br />]]></template>
-		<template name="modcp_ipsearch_result" version="1400"><![CDATA[<tr>
+		<template name="modcp_ipsearch_result" version="1408"><![CDATA[<tr>
 <td class="{$trow}" align="center">{$ip}</td>
 <td class="{$trow}">{$subject}</td>
+</tr>
 ]]></template>
 		<template name="modcp_ipsearch_noresults" version="1400"><![CDATA[<tr>
 	<td class="trow1" align="center" colspan="2">{$lang->error_no_results}</td>
@@ -1446,14 +1454,14 @@
 				<a href="{$mybb->settings['bburl']}/search.php?action=getnew">{$lang->welcome_newposts}</a> | <a href="{$mybb->settings['bburl']}/search.php?action=getdaily">{$lang->welcome_todaysposts}</a> | <a href="{$mybb->settings['bburl']}/private.php">{$lang->welcome_pms}</a> {$lang->welcome_pms_usage}]]></template>
 		<template name="header_welcomeblock_member_moderator" version="1400"><![CDATA[ &mdash; <a href="{$mybb->settings['bburl']}/modcp.php">{$lang->welcome_modcp}</a>]]></template>
 		<template name="postbit_online" version="1400"><![CDATA[<a href="online.php" title="{$lang->postbit_status_online}"><img src="{$theme['imgdir']}/buddy_online.gif" border="0" alt="{$lang->postbit_status_online}" /></a>]]></template>
-		<template name="showthread_moderationoptions" version="1400"><![CDATA[{$inlinemod}
-<form action="moderation.php" method="get" style="margin-top: 0; margin-bottom: 0;">
+		<template name="showthread_moderationoptions" version="1404"><![CDATA[{$inlinemod}
+<form action="moderation.php" method="post" style="margin-top: 0; margin-bottom: 0;" id="moderator_options">
 	<input type="hidden" name="modtype" value="thread" />
 	<input type="hidden" name="tid" value="{$tid}" />
 	<input type="hidden" name="my_post_key" value="{$mybb->post_code}" />
 	<span class="smalltext">
 	<strong>{$lang->moderation_options}</strong></span>
-	<select name="action" onchange="window.location=('moderation.php?action='+this.options[this.selectedIndex].value+'&amp;tid={$tid}&amp;modtype=thread&amp;my_post_key={$mybb->post_code}')">
+	<select name="action" onchange="$('moderator_options').submit();">
 		<optgroup label="{$lang->standard_mod_tools}">
 			<option value="threadnotes">{$lang->thread_notes}</option>
 			<option value="openclosethread">{$lang->open_close_thread}</option>
@@ -2444,7 +2452,7 @@
 <td class="{$bgcolor}" valign="top" align="center" style="white-space: nowrap">{$posts}{$unapproved['unapproved_posts']}</td>
 <td class="{$bgcolor}" valign="top" align="right" style="white-space: nowrap">{$lastpost}</td>
 </tr>]]></template>
-		<template name="forumbit_depth3" version="1400"><![CDATA[{$comma}{$statusicon}<a href="{$forum_url}" title="{$forum_viewers_text}">{$forum['name']}</a>]]></template>
+		<template name="forumbit_depth3" version="1404"><![CDATA[{$comma}{$statusicon}<a href="{$forum_url}" title="{$forum_viewers_text_plain}">{$forum['name']}</a>]]></template>
 		<template name="forumbit_depth3_statusicon" version="1400"><![CDATA[<img src="{$theme['imgdir']}/{$lightbulb['folder']}.gif" alt="{$lightbulb['altonoff']}" title="{$lightbulb['altonoff']}" class="subforumicon ajax_mark_read" id="mark_read_{$forum['fid']}" />]]></template>
 		<template name="forumbit_subforums" version="120"><![CDATA[<br />{$lang->subforums} {$sub_forums}]]></template>
 		<template name="private_empty" version="120"><![CDATA[<html>
@@ -2539,7 +2547,7 @@
 <td class="trow2" width="50%">{$reputation_link} [<a href="reputation.php?uid={$mybb->user['uid']}">{$lang->details}</a>]</td>
 </tr>]]></template>
 		<template name="usercp_currentavatar" version="120"><![CDATA[<td class="trow1" rowspan="6" valign="middle" align="center" width="1"><img src="{$mybb->user['avatar']}" alt="{$mybb->user['username']}" title="{$mybb->user['username']}" {$avatar_width_height} /></td>]]></template>
-		<template name="footer" version="1400"><![CDATA[			<br />
+		<template name="footer" version="1405"><![CDATA[			<br />
 			<div class="bottommenu">
 				<div class="float_right">{$lang_select}</div>
 				<div>
@@ -2550,13 +2558,14 @@
 		<hr class="hidden" />
 			<div id="copyright">
 				<div id="debug"><debugstuff></div>
-				<!-- You may NOT remove, modify or hinder the visibility of the MyBB copyright at any time.
-				     It must contain the links to the MyBB website and be formatted appropriately.
+				<!-- MyBB is free software developed and maintained by a volunteer community. 
+					 It would be much appreciated by the MyBB Group if you left the full copyright and "powered by" notice intact, 
+					 to show your support for MyBB.  If you choose to remove or modify the copyright below, 
+					 you may be refused support on the MyBB Community Forums.
 
-					 Failure to comply with the above will result in prosecution to the full extent of the law.
 					 This is free software, support us and we'll support you. -->
 {$lang->powered_by} <a href="http://www.mybboard.net" target="_blank">MyBB{$mybbversion}</a>, &copy; 2002-{$copy_year} <a href="http://www.mybboard.net" target="_blank">MyBB Group</a>.<br />
-				<!-- End copyright -->
+				<!-- End powered by -->
 				<br />
 <br class="clear" />
 <!-- The following piece of code allows MyBB to run scheduled tasks. DO NOT REMOVE -->{$task_image}<!-- End task image code -->
@@ -3437,7 +3446,7 @@
 <td class="{$altbg}" align="center"><input type="radio" class="radio" name="request[{$user['uid']}]" value="decline" /></td>
 </tr>
 ]]></template>
-		<template name="private_send" version="1400"><![CDATA[<html>
+		<template name="private_send" version="1402"><![CDATA[<html>
 <head>
 <title>{$lang->compose_pm}</title>
 {$headerinclude}
@@ -3481,6 +3490,7 @@
 <td class="trow2">
 <textarea name="message" id="message" rows="20" cols="70" tabindex="4">{$message}</textarea>
 {$codebuttons}
+</td>
 </tr>
 <tr>
 <td class="trow1" valign="top"><strong>{$lang->compose_options}</strong></td>
@@ -3642,17 +3652,17 @@
 		<template name="postbit_quote" version="120"><![CDATA[<a href="newreply.php?tid={$tid}&amp;pid={$post['pid']}"><img src="{$theme['imglangdir']}/postbit_quote.gif" alt="{$lang->postbit_quote}" title="{$lang->postbit_quote}" /></a>]]></template>
 		<template name="postbit_report" version="120"><![CDATA[<a href="javascript:Thread.reportPost({$post['pid']});"><img src="{$theme['imglangdir']}/postbit_report.gif" alt="{$lang->postbit_report}" title="{$lang->postbit_report}" /></a>]]></template>
 		<template name="postbit_www" version="120"><![CDATA[<a href="{$post['website']}" target="_blank"><img src="{$theme['imglangdir']}/postbit_www.gif" alt="{$lang->postbit_website}" title="{$lang->postbit_website}" /></a>]]></template>
-		<template name="polls_showresults_resultbit" version="120"><![CDATA[<tr>
+		<template name="polls_showresults_resultbit" version="1402"><![CDATA[<tr>
 <td class="{$optionbg}" align="right">{$option}{$votestar}</td>
 <td class="{$optionbg}" width="{$imagerowwidth}"><img src="{$theme['imgdir']}/pollbar-s.gif" alt="" /><img src="{$theme['imgdir']}/pollbar.gif" width="{$imagewidth}" height="10" alt="{$percent}%" title="{$percent}%" /><img src="{$theme['imgdir']}/pollbar-e.gif" alt="" /><br />{$userlist}</td>
-<td class="{$optionbg}" width="67" align="center"><a href="polls.php?action=showresults&amp;pid={$poll['pid']}#option{$number}">{$votes}</a></td>
+<td class="{$optionbg}" width="67" align="center">{$votes}</td>
 <td class="{$optionbg}" width="67" align="center">{$percent}%</td>
 </tr>
 ]]></template>
-		<template name="showthread_poll_resultbit" version="120"><![CDATA[<tr>
+		<template name="showthread_poll_resultbit" version="1402"><![CDATA[<tr>
 <td class="{$optionbg}" align="right">{$option}{$votestar}</td>
 <td class="{$optionbg}"><img src="{$theme['imgdir']}/pollbar-s.gif" alt="" /><img src="{$theme['imgdir']}/pollbar.gif" width="{$imagewidth}" height="10" alt="{$percent}%" title="{$percent}%" /><img src="{$theme['imgdir']}/pollbar-e.gif" alt="" /></td>
-<td class="{$optionbg}" width="67" align="center"><a href="polls.php?action=showresults&amp;pid={$poll['pid']}#option{$number}">{$votes}</a></td>
+<td class="{$optionbg}" width="67" align="center">{$votes}</td>
 <td class="{$optionbg}" width="67" align="center">{$percent}%</td>
 </tr>
 ]]></template>
@@ -4300,7 +4310,7 @@
 </script>
 </body>
 </html>]]></template>
-		<template name="memberlist_search" version="1400"><![CDATA[<html>
+		<template name="memberlist_search" version="1405"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->search_member_list}</title>
 {$headerinclude}
@@ -4366,7 +4376,7 @@
 			<option value="username">{$lang->sort_by_username}</option>
 			<option value="regdate">{$lang->sort_by_regdate}</option>
 			<option value="lastvisit">{$lang->sort_by_lastvisit}</option>
-			<option value="posts">{$lang->sort_by_posts}</option>
+			<option value="postnum">{$lang->sort_by_posts}</option>
 		</select><br />
 		<span class="smalltext">
 		<input type="radio" class="radio" name="order" id="order_asc" value="asc" /> <label for="order_asc">{$lang->order_asc}</label><br />
@@ -4473,9 +4483,9 @@
 		<td width="130" align="center"><span class="smalltext"><strong>{$lang->pmspaceused}</strong></span></td>
 	</tr>
 </table></span>]]></template>
-		<template name="forumdisplay_announcements_announcement" version="1400"><![CDATA[<tr>
-<td align="center" class="{$bgcolor}"><img src="{$theme['imgdir']}/{$folder}.gif" alt=""/></td>
-<td align="center" class="{$bgcolor}">&nbsp;</td>
+		<template name="forumdisplay_announcements_announcement" version="1408"><![CDATA[<tr>
+<td align="center" class="{$bgcolor}" width="2%"><img src="{$theme['imgdir']}/{$folder}.gif" alt=""/></td>
+<td align="center" class="{$bgcolor}" width="2%">&nbsp;</td>
 <td class="{$bgcolor}">
 	<a href="{$announcement['announcementlink']}"{$new_class}>{$announcement['subject']}</a>
 	<div class="author smalltext">{$announcement['profilelink']}</div>
@@ -4624,7 +4634,7 @@
 </span>
 </td>
 </tr>]]></template>
-		<template name="search" version="1400"><![CDATA[<html>
+		<template name="search" version="1402"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->search}</title>
 {$headerinclude}
@@ -4691,7 +4701,7 @@
 <option value="lastpost">{$lang->sort_lastpost}</option>
 <option value="starter">{$lang->sort_author}</option>
 <option value="forum">{$lang->sort_forum}</option>
-</select> {$lang->sort_in} <input type="radio" class="radio" name="sorder" value="asc" />{$lang->sort_asc} <input type="radio" class="radio" name="sorder" value="desc" checked="checked" />{$lang->sort_desc} {$lang->sort_order}
+</select> {$lang->sort_in} <input type="radio" class="radio" name="sortordr" value="asc" />{$lang->sort_asc} <input type="radio" class="radio" name="sortordr" value="desc" checked="checked" />{$lang->sort_desc} {$lang->sort_order}
 </td>
 </tr>
 <tr>
@@ -4906,24 +4916,12 @@
 <td class="{$trow}">{$report['reason']}</td>
 <td class="{$trow}" align="center" style="white-space: nowrap"><span class="smalltext">{$reportdate}<br />{$reporttime}</span></td>
 </tr>]]></template>
-	<template name="moderation_allreports_multipage" version="120"><![CDATA[<tr>
-<td class="tcat" colspan="6"><span class="smalltext"> {$multipage}</span></td>
-</tr>]]></template>
 	<template name="modcp_reports_allnoreports" version="120"><![CDATA[<tr>
 <td class="trow1" align="center" colspan="6">{$lang->no_reports}</td>
 </tr>]]></template>
 		<template name="modcp_reports_noreports" version="120"><![CDATA[<tr>
 <td class="trow1" align="center" colspan="6">{$lang->no_reports}</td>
 </tr>]]></template>
-		<template name="newthread_postpoll" version="120"><![CDATA[<tr>
-<td class="{$bgcolor}" valign="top">
-<strong>{$lang->poll}</strong><br /><span class="smalltext">{$lang->poll_desc}</span>
-</td>
-<td class="{$bgcolor}" valign="top">
-<span class="smalltext"><input type="checkbox" class="checkbox" name="postpoll" value="1" {$postpollchecked} /><strong>{$lang->poll_check}</strong><br />
-{$lang->num_options} <input type="text" class="textbox" name="numpolloptions" value="{$numpolloptions}" size="10" />{$lang->max_options}</span>
-</td>
-</tr>]]></template>
 		<template name="global_unreadreports" version="1400"><![CDATA[<table border="0" cellspacing="{$theme['borderwidth']}" cellpadding="{$theme['tablespace']}" class="tborder">
 <tr>
 <td class="trow1" align="right"><span class="smalltext"><a href="modcp.php?action=reports">{$lang->unread_reports}</a></span></td>
@@ -4936,7 +4934,7 @@
 </tr>
 </table>
 <br />]]></template>
-		<template name="member_login" version="1400"><![CDATA[<html>
+		<template name="member_login" version="1404"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->login}</title>
 {$headerinclude}
@@ -4944,6 +4942,7 @@
 <body>
 {$header}
 <br />
+{$inline_errors}
 {$member_loggedin_notice}
 <form action="member.php" method="post">
 <table border="0" cellspacing="{$theme['borderwidth']}" cellpadding="{$theme['tablespace']}" class="tborder">
@@ -4952,12 +4951,13 @@
 </tr>
 <tr>
 <td class="trow1"><strong>{$lang->username}</strong></td>
-<td class="trow1"><input type="text" class="textbox" name="username" size="25" maxlength="{$mybb->settings['maxnamelength']}" style="width: 200px;" /></td>
+<td class="trow1"><input type="text" class="textbox" name="username" size="25" maxlength="{$mybb->settings['maxnamelength']}" style="width: 200px;" value="{$username}" /></td>
 </tr>
 <tr>
 <td class="trow2"><strong>{$lang->password}</strong><br /><span class="smalltext">{$lang->pw_note}</span></td>
-<td class="trow2"><input type="password" class="textbox" name="password" size="25" style="width: 200px;" /> (<a href="member.php?action=lostpw">{$lang->lostpw_note}</a>)</td>
+<td class="trow2"><input type="password" class="textbox" name="password" size="25" style="width: 200px;" value="{$password}" /> (<a href="member.php?action=lostpw">{$lang->lostpw_note}</a>)</td>
 </tr>
+{$captcha}
 </table>
 <br />
 <div align="center"><input type="submit" class="button" name="submit" value="{$lang->login}" /></div>
@@ -5214,11 +5214,11 @@
 {$post['attachmentlist']}
 </fieldset>]]></template>
 		<template name="postbit_attachments_attachment" version="120"><![CDATA[<br />{$attachment['icon']}&nbsp;&nbsp;<a href="attachment.php?aid={$attachment['aid']}" target="_blank">{$attachment['filename']}</a> ({$lang->postbit_attachment_size} {$attachment['filesize']} / {$lang->postbit_attachment_downloads} {$attachment['downloads']})]]></template>
-		<template name="postbit_attachments_attachment_unapproved" version="120"><![CDATA[<br /><strong>{$lang->postbit_unapproved_attachments}</strong>]]></template>
+		<template name="postbit_attachments_attachment_unapproved" version="1402"><![CDATA[<br /><strong>{$postbit_unapproved_attachments}</strong>]]></template>
 		<template name="postbit_attachments_images" version="120"><![CDATA[<span class="smalltext"><strong>{$lang->postbit_attachments_images}</strong></span><br />
 {$post['imagelist']}
 <br />]]></template>
-		<template name="post_attachments_attachment_postinsert" version="120"><![CDATA[<input type="button" name="insert" value="{$lang->insert_attachment_post}" onclick="clickableEditor.insertAttachment({$attachment['aid']});" />]]></template>
+		<template name="post_attachments_attachment_postinsert" version="1405"><![CDATA[<input type="button" class="button" name="insert" value="{$lang->insert_attachment_post}" onclick="clickableEditor.insertAttachment({$attachment['aid']});" />]]></template>
 		<template name="moderation_mergeposts" version="1400"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->merge_posts}</title>
@@ -5519,13 +5519,13 @@
 </table>
 <br />]]></template>
 		<template name="portal_announcement_numcomments" version="1400"><![CDATA[- <a href="{$mybb->settings['bburl']}/{$announcement['threadlink']}">{$lang->replies}</a> ({$announcement['replies']})]]></template>
-		<template name="portal_announcement" version="1400"><![CDATA[<table cellspacing="{$theme['borderwidth']}" cellpadding="{$theme['tablespace']}" class="tborder">
+		<template name="portal_announcement" version="1405"><![CDATA[<table cellspacing="{$theme['borderwidth']}" cellpadding="{$theme['tablespace']}" class="tborder">
 <tr>
 <td class="thead"><strong>{$icon} <a href="{$mybb->settings['bburl']}/{$announcement['threadlink']}">{$announcement['subject']}</a></strong></td>
 </tr>
 <tr>
 <td class="trow2" align="right">
-<span class="smalltext">{$lang->posted_by} <a href="{$mybb->settings['bburl']}/{$announcement['profilelink']}">{$announcement['username']}</a>  - {$anndate} {$anntime} {$numcomments}</span>
+<span class="smalltext">{$lang->posted_by} {$profilelink}  - {$anndate} {$anntime} {$numcomments}</span>
 </td>
 </tr>
 <tr>
@@ -5738,8 +5738,8 @@
 </tr>]]></template>
 		<template name="private_archive_csv_message" version="1400"><![CDATA[{$senddate},"{$foldername}","{$message['subject']}","{$message['tousername']}","{$message['fromusername']}","{$message['message']}"
 ]]></template>
-		<template name="search_results_threads_thread" version="1400"><![CDATA[<tr>
-	<td align="center" class="{$bgcolor}" width="2%"><img src="{$theme['imgdir']}/{$folder}.gif" alt=""/></td>
+		<template name="search_results_threads_thread" version="1401"><![CDATA[<tr>
+	<td align="center" class="{$bgcolor}" width="2%"><img src="{$theme['imgdir']}/{$folder}.gif"  alt="{$folder_label}" title="{$folder_label}" /></td>
 	<td align="center" class="{$bgcolor}" width="2%">{$icon}</td>
 	<td class="{$bgcolor}">
 		{$attachment_count}
@@ -5759,7 +5759,7 @@
 	</td>
 	{$inline_mod_checkbox}
 </tr>]]></template>
-		<template name="search_results_threads" version="120"><![CDATA[<html>
+		<template name="search_results_threads" version="1405"><![CDATA[<html>
 		<head>
 		<title>{$mybb->settings['bbname']} - {$lang->search_results}</title>
 		{$headerinclude}
@@ -5773,7 +5773,7 @@
 		</table>
 		<table border="0" cellspacing="{$theme['borderwidth']}" cellpadding="{$theme['tablespace']}" class="tborder">
 			<tr>
-				<td colspan="9" class="thead">
+				<td colspan="8" class="thead">
 					<strong>{$lang->search_results}</strong>
 				</td>
 			</tr>
@@ -5935,7 +5935,7 @@
 <td width="40%" class="trow1"><strong>{$lang->your_email}</strong><br /><span class="smalltext">{$lang->email_note}</span></td>
 <td width="60%" class="trow1"><input type="text" class="textbox" size="50" name="fromemail" /></td>
 </tr>]]></template>
-		<template name="usercp_subscriptions" version="1400"><![CDATA[<html>
+		<template name="usercp_subscriptions" version="1401"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->subscriptions}</title>
 {$headerinclude}
@@ -5974,7 +5974,7 @@
 				{$gobutton}
 			</div>
 			<div>
-				<strong><a href="usercp2.php?action=removesubscriptions">{$lang->remove_all_subscriptions}</a></strong>
+				<strong><a href="usercp2.php?action=removesubscriptions&amp;my_post_key={$mybb->post_code}">{$lang->remove_all_subscriptions}</a></strong>
 			</div>
 		</td>
 	</tr>
@@ -6623,7 +6623,7 @@
 		<template name="private_read_action" version="1400"><![CDATA[<tr>
 	<td class="tcat" align="center"><strong>{$actioned_on}</strong></td>
 </tr>]]></template>
-		<template name="private_read" version="1400"><![CDATA[<html>
+		<template name="private_read" version="1405"><![CDATA[<html>
 <head>
 <title>{$lang->viewing_pm} {$pm['subject']}</title>
 {$headerinclude}
@@ -6643,6 +6643,8 @@
 {$action_time}
 {$message}
 </table>
+</td>
+</tr>
 </table>
 {$footer}
 </body>
@@ -7373,7 +7375,7 @@
 	</ul>
 </div>
 <br />]]></template>
-		<template name="member_register" version="1400"><![CDATA[<html>
+		<template name="member_register" version="1405"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->registration}</title>
 {$headerinclude}
@@ -7510,7 +7512,7 @@
 <!--
 	regValidator = new FormValidator('registration_form');
 	regValidator.register('username', 'notEmpty', {failure_message:'{$lang->js_validator_no_username}'});
-	regValidator.register('email', 'regexp', {match_field:'email2', regexp:'^([a-zA-Z0-9_\.\+\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$', failure_message:'{$lang->js_validator_invalid_email}'});
+    regValidator.register('email', 'regexp', {match_field:'email2', regexp:'^([a-zA-Z0-9_\\.\\+\\-])+\\@(([a-zA-Z0-9\\-])+\\.)+([a-zA-Z0-9]{2,4})+$', failure_message:'{$lang->js_validator_invalid_email}'});
 	regValidator.register('email2', 'matches', {match_field:'email', status_field:'email_status', failure_message:'{$lang->js_validator_email_match}'});
 {$validator_extra}
 	regValidator.register('username', 'ajax', {url:'xmlhttp.php?action=username_availability', loading_message:'{$lang->js_validator_checking_username}'}); // needs to be last
@@ -7921,7 +7923,7 @@
 					</div>
 				</td>
 ]]></template>
-		<template name="calendar_addevent" version="1400"><![CDATA[<html>
+		<template name="calendar_addevent" version="1402"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->calendar} - {$lang->add_event}</title>
 {$headerinclude}
@@ -8227,8 +8229,8 @@
 </html>]]></template>
 		<template name="calendar_addprivateevent" version="1400"><![CDATA[<a href="calendar.php?action=addevent&amp;calendar={$calendar['cid']}&amp;private=1">{$lang->add_private_event}</a>]]></template>
 		<template name="calendar_addpublicevent" version="1400"><![CDATA[<a href="calendar.php?action=addevent&amp;calendar={$calendar['cid']}">{$lang->add_public_event}</a>]]></template>
-		<template name="calendar_eventbit_private" version="1400"><![CDATA[<div style="margin-bottom: 4px;" class="smalltext eventbit_private"><a href="{$event['eventlink']}" title="{$event['fullname']}">{$event['fullname']}</a></div>]]></template>
-		<template name="calendar_eventbit" version="1400"><![CDATA[<div style="margin-bottom: 4px;" class="smalltext {$event_class}"><a href="{$event['eventlink']}" title="{$event['fullname']}">{$event['fullname']}</a></div>]]></template>
+		<template name="calendar_eventbit_private" version="1402"><![CDATA[<div style="margin-bottom: 4px;" class="smalltext eventbit_private"><a href="{$event['eventlink']}" title="{$event['fullname']}">{$event['name']}</a></div>]]></template>
+		<template name="calendar_eventbit" version="1402"><![CDATA[<div style="margin-bottom: 4px;" class="smalltext {$event_class}"><a href="{$event['eventlink']}" title="{$event['fullname']}">{$event['name']}</a></div>]]></template>
 		<template name="calendar_weekview" version="1400"><![CDATA[<html>
 <head>
 	<title>{$mybb->settings['bbname']} - {$lang->calendar}</title>
@@ -8341,7 +8343,7 @@
 					{$day_link}
 				</td>]]></template>
 		<template name="calendar_addeventlink" version="1400"><![CDATA[<a href="calendar.php?action=addevent&amp;calendar={$calendar['cid']}">{$lang->add_public_event}</a> | <a href="calendar.php?action=addevent&amp;calendar={$calendar['cid']}&amp;private=1">{$lang->add_private_event}</a>]]></template>
-		<template name="calendar_editevent" version="1400"><![CDATA[<html>
+		<template name="calendar_editevent" version="1402"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->calendar} - {$lang->edit_event}</title>
 {$headerinclude}
@@ -8642,7 +8644,7 @@
 		<tr>
 			<td width="20%" class="trow2"><strong>{$lang->event_options}</strong></td>
 			<td class="trow2">
-				<input type="checkbox" class="checkbox" name=thread value="1"{$privatecheck} /><span class="smalltext">{$lang->private_option}</span><br />
+				<input type="checkbox" class="checkbox" name="private" value="1"{$privatecheck} /><span class="smalltext">{$lang->private_option}</span><br />
 			</td>
 		</tr>
 	</table>
@@ -8654,7 +8656,7 @@
 {$footer}
 </body>
 </html>]]></template>
-		<template name="calendar_move" version="1400"><![CDATA[<html>
+		<template name="calendar_move" version="1402"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->calendar} - {$lang->move_event}</title>
 {$headerinclude}
@@ -8668,7 +8670,7 @@
 			<td colspan="2" width="100%" class="thead"><strong>{$lang->move_event}: {$event['name']}</strong></td>
 		</tr>
 		<tr>
-			<td width="20%" class="trow1"><strong>Move to Calendar:</strong></td>
+			<td width="20%" class="trow1"><strong>{$lang->move_to_calendar}:</strong></td>
 			<td class="trow1">
 				<select name="new_calendar">
 					{$calendar_select}
@@ -8776,7 +8778,7 @@
 					{$gobutton}
 				</form>
 				<br />]]></template>
-		<template name="calendar_dayview" version="1400"><![CDATA[<html>
+		<template name="calendar_dayview" version="1405"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->calendar}</title>
 {$headerinclude}
@@ -8812,6 +8814,8 @@
 							<option value="12">{$lang->alt_month_12}</option>
 						</select>
 						<select name="year">
+							<option value="{$year}">{$year}</option>
+							<option value="{$year}">----------</option>
 							{$yearsel}
 						</select>
 						{$gobutton}
@@ -9059,7 +9063,7 @@
 						</tr>
 						</table>
 					</dd>]]></template>
-		<template name="warnings_warn_pm" version="1400"><![CDATA[		<tr>
+		<template name="warnings_warn_pm" version="1402"><![CDATA[		<tr>
 			<td width="20%" class="trow1" valign="top">
 				<strong>{$lang->send_pm}</strong>
 				<div style="margin:auto" id="pm_smilie_insert">{$smilieinserter}</div>
@@ -9078,7 +9082,7 @@
 							if(mybb_editor_disabled == true && editor_language)
 							{
 								mybb_editor_disabled = false;
-								clickableEditor = new messageEditor("message", {lang: editor_language, rtl: 0});
+								clickableEditor = new messageEditor("message", {lang: editor_language, rtl: {$lang->settings['rtl']}, theme: "{$theme['editortheme']}"});
 								if(clickableEditor)
 								{
 									clickableEditor.bindSmilieInserter("clickable_smilies");
@@ -9252,7 +9256,7 @@
 		<td class="trow2" colspan="2">{$revoke_reason}</td>
 	</tr>
 </table>]]></template>
-		<template name="xmlhttp_buddyselect" version="1400"><![CDATA[<table border="0" cellspacing="1" cellpadding="4" class="tborder" style="width: 300px;">
+		<template name="xmlhttp_buddyselect" version="1405"><![CDATA[<table border="0" cellspacing="1" cellpadding="4" class="tborder" style="width: 300px;">
 	<thead>
 		<tr>
 			<td class="thead">
@@ -9279,7 +9283,7 @@
 			<td class="trow1">
 				<div class="smalltext"><strong>{$lang->selected_recipients}</strong></div>
 				<div id="buddyselect_buddies" class="smalltext" style="padding-left: 10px; height: 50px; overflow: auto;"></div>
-				<div style="text-align: right;"><input type="button" value="{$lang->ok}" onclick="UserCP.closeBuddySelect();" /> <input type="button" value="{$lang->cancel}" onclick="UserCP.closeBuddySelect(true);" /></div>
+				<div style="text-align: right;"><input type="button" class="button" value="{$lang->ok}" onclick="UserCP.closeBuddySelect();" /> <input type="button" class="button" value="{$lang->cancel}" onclick="UserCP.closeBuddySelect(true);" /></div>
 			</td>
 		</tr>
 	</tbody>
@@ -9307,11 +9311,6 @@
 <a href="{$lastpost_link}" title="{$full_lastpost_subject}"><strong>{$lastpost_subject}</strong></a>
 <br />{$lastpost_date} {$lastpost_time}<br />{$lang->by} {$lastpost_profilelink}</span>
 ]]></template>
-	<template name="calendar_dayview_noevents" version="120"><![CDATA[<table border="0" cellspacing="{$theme['borderwidth']}" cellpadding="{$theme['tablespace']}" class="tborder">
-<tr>
-<td class="trow1">{$lang->no_events}</td>
-</tr>
-</table>]]></template>
 		<template name="member_register_coppa" version="1400"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->coppa_compliance}</title>
@@ -9814,7 +9813,7 @@
 	{$footer}
 </body>
 </html>]]></template>
-		<template name="modcp_finduser" version="1400"><![CDATA[<html>
+		<template name="modcp_finduser" version="1405"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->find_users}</title>
 {$headerinclude}
@@ -9869,7 +9868,7 @@
 					</table>
 					<br />
 					<div align="center">
-						<input type="submit" value="{$lang->find_users}" />
+						<input type="submit" class="button" value="{$lang->find_users}" />
 					</div>
 				</td>
 			</tr>
@@ -10055,7 +10054,7 @@
 <a href="{$post['link']}#pid{$post['pid']}" title="{$post['fullsubject']}"><strong>{$post['subject']}</strong></a>
 <br />{$post['date']} {$post['time']}<br />{$lang->by} {$post['profilelink']}</span>
 ]]></template>
-	<template name="modcp_warninglogs" version="1400"><![CDATA[<html>
+	<template name="modcp_warninglogs" version="1405"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->warning_logs}</title>
 {$headerinclude}
@@ -10124,7 +10123,7 @@
 					</table>
 					<br />
 					<div align="center">
-						<input type="submit" value="{$lang->filter_warning_logs}" />
+						<input type="submit" class="button" value="{$lang->filter_warning_logs}" />
 					</div>
 				</form>
 			</td>
@@ -10217,7 +10216,7 @@
 	{$footer}
 </body>
 </html>]]></template>
-<template name="modcp_announcements_new" version="1400"><![CDATA[<html>
+<template name="modcp_announcements_new" version="1405"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->manage_announcement}</title>
 {$headerinclude}
@@ -10232,7 +10231,7 @@
 			<tr>
 				{$modcp_nav}
 				<td valign="top">
-					{$announcements_global}
+					{$errors}
 					<table border="0" cellspacing="{$theme['borderwidth']}" cellpadding="{$theme['tablespace']}" class="tborder">
 						<tr>
 							<td class="thead" colspan="6"><strong>{$lang->add_announcement}</strong></td>
@@ -10292,8 +10291,8 @@
 					</table>
 					<br />
 					<div align="center">
-						<input type="submit" class="submitbutton" name="Add Announcement" value="{$lang->add_announcement}" />&nbsp;&nbsp;
-						<input type="reset" class="submitbutton" name="Reset" value="{$lang->reset}" />
+						<input type="submit" class="button" name="Add Announcement" value="{$lang->add_announcement}" />&nbsp;&nbsp;
+						<input type="reset" class="button" name="Reset" value="{$lang->reset}" />
 					</div>
 				</td>
 			</tr>
@@ -10302,7 +10301,7 @@
 	{$footer}
 </body>
 </html>]]></template>
-<template name="modcp_announcements_edit" version="1400"><![CDATA[<html>
+<template name="modcp_announcements_edit" version="1405"><![CDATA[<html>
 <head>
 <title>{$mybb->settings['bbname']} - {$lang->manage_announcement}</title>
 {$headerinclude}
@@ -10378,8 +10377,8 @@
 					</table>
 					<br />
 					<div align="center">
-						<input type="submit" class="submitbutton" name="Edit Announcement" value="{$lang->edit_announcement}" />&nbsp;&nbsp;
-						<input type="reset" class="submitbutton" name="Reset" value="{$lang->reset}" />
+						<input type="submit" class="button" name="Edit Announcement" value="{$lang->edit_announcement}" />&nbsp;&nbsp;
+						<input type="reset" class="button" name="Reset" value="{$lang->reset}" />
 					</div>
 				</td>
 			</tr>
@@ -10430,7 +10429,7 @@
 	<template name="search_results_inlinemodcol" version="120"><![CDATA[<td class="tcat" align="center">&nbsp;</td>]]></template>
 	<template name="search_results_posts_inlinemoderation_custom" version="120"><![CDATA[<optgroup label="{$lang->custom_mod_tools}">{$customposttools}</optgroup>]]></template>
 	<template name="search_results_posts_inlinemoderation_custom_tool" version="120"><![CDATA[<option value="{$tool['tid']}">{$tool['name']}</option>]]></template>
-	<template name="search_results_posts_inlinemoderation" version="1400"><![CDATA[<script type="text/javascript" src="jscripts/inline_moderation.js?ver=1400"></script>
+	<template name="search_results_posts_inlinemoderation" version="1405"><![CDATA[<script type="text/javascript" src="jscripts/inline_moderation.js?ver=1400"></script>
 <form action="moderation.php" method="post" style="margin-top: 0; margin-bottom: 0;">
 <input type="hidden" name="my_post_key" value="{$mybb->post_code}" />
 <input type="hidden" name="tid" value="0" />
@@ -10440,8 +10439,6 @@
 <select name="action">
 <optgroup label="{$lang->standard_mod_tools}">
 	<option value="multideleteposts">{$lang->inline_delete_posts}</option>
-	<option value="multimergeposts">{$lang->inline_merge_posts}</option>
-	<option value="multisplitposts">{$lang->inline_split_posts}</option>
 	<option value="multiapproveposts">{$lang->inline_approve_posts}</option>
 	<option value="multiunapproveposts">{$lang->inline_unapprove_posts}</option>
 </optgroup>
diff -rub mybb_1400/install/resources/mysql_db_inserts.php mybb_1408/install/resources/mysql_db_inserts.php
--- mybb_1400/install/resources/mysql_db_inserts.php	2008-07-20 22:56:39.000000000 +0200
+++ mybb_1408/install/resources/mysql_db_inserts.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: mysql_db_inserts.php 4031 2008-07-20 20:56:39Z Tikitiki $
+ * $Id: mysql_db_inserts.php 4276 2008-11-23 03:01:33Z Tikitiki $
  */
 
 $inserts[] = "INSERT INTO mybb_attachtypes (atid, name, mimetype, extension, maxsize, icon) VALUES (1, 'ZIP File', 'application/zip', 'zip', 1024, 'images/attachtypes/zip.gif');";
@@ -37,7 +37,7 @@
 
 $inserts[] = "INSERT INTO mybb_helpdocs (hid, sid, name, description, document, usetranslation, enabled, disporder) VALUES (1, 1, 'User Registration', 'Perks and privileges to user registration.', 'Some parts of this forum may require you to be logged in and registered. Registration is free and takes a few minutes to complete.<br />\r\n<br />\r\nYou are encouraged to register; once you register you will be able to post messages, set your own preferences, and maintain a profile.<br />\r\n<br />\r\nSome of the features that generally require registration are subscriptions, changing of styles, accessing of your Personal Pad (simple notepad) and emailing forum members.', 1, 1, 1);";
 $inserts[] = "INSERT INTO mybb_helpdocs (hid, sid, name, description, document, usetranslation, enabled, disporder) VALUES (2, 1, 'Updating Profile', 'Changing your data currently on record.', 'At some point during your stay, you may decide you need to update some information such as your instant messenger information, your password, or perhaps you need to change your email address. You may change any of this information from your user control panel. To access this control panel, simply click on the link in the upper right hand corner of most any page entitled \"user cp\". From there, simply choose \"Edit Profile\" and change or update any desired items, then proceed to click the submit button located at the bottom of the page for changes to take effect.', 1, 1, 2);";
-$inserts[] = "INSERT INTO mybb_helpdocs (hid, sid, name, description, document, usetranslation, enabled, disporder) VALUES (3, 1, 'Use of Cookies on myBB', 'myBB uses cookies to store certain information about your registration.', 'myBulletinBoard makes use of cookies to store your login information if you are registered, and your last visit if you are not.<br />\r\n<br />\r\nCookies are small text documents stored on your computer; the cookies set by this forum can only be used on this website and pose no security risk.<br />\r\n<br />\r\nCookies on this forum also track the specific topics you have read and when you last read them.<br />\r\n<br />\r\nTo clear all cookies set by this forum, you can click <a href=\"misc.php?action=clearcookies\">here</a>.', 1, 1, 3);";
+$inserts[] = "INSERT INTO mybb_helpdocs (hid, sid, name, description, document, usetranslation, enabled, disporder) VALUES (3, 1, 'Use of Cookies on myBB', 'myBB uses cookies to store certain information about your registration.', 'myBulletinBoard makes use of cookies to store your login information if you are registered, and your last visit if you are not.<br />\r\n<br />\r\nCookies are small text documents stored on your computer; the cookies set by this forum can only be used on this website and pose no security risk.<br />\r\n<br />\r\nCookies on this forum also track the specific topics you have read and when you last read them.<br />\r\n<br />\r\nTo clear all cookies set by this forum, you can click <a href=\"misc.php?action=clearcookies&amp;key={1}\">here</a>.', 1, 1, 3);";
 $inserts[] = "INSERT INTO mybb_helpdocs (hid, sid, name, description, document, usetranslation, enabled, disporder) VALUES (4, 1, 'Logging In and Out', 'How to login and log out.', 'When you login, you set a cookie on your machine so that you can browse the forums without having to enter in your username and password each time. Logging out clears that cookie to ensure nobody else can browse the forum as you.<br />\r\n<br />\r\nTo login, simply click the login link at the top right hand corner of the forum. To log out, click the log out link in the same place. In the event you cannot log out, clearing cookies on your machine will take the same effect.', 1, 1, 4);";
 $inserts[] = "INSERT INTO mybb_helpdocs (hid, sid, name, description, document, usetranslation, enabled, disporder) VALUES (5, 2, 'Posting a New Topic', 'Starting a new thread in a forum.', 'When you go to a forum you are interested in and you wish to create a new topic (or thread), simply choose the button at the top and bottom of the forums entitled \"New topic\". Please take note that you may not have permission to post a new topic in every forum as your administrator may have restricted posting in that forum to staff or archived the forum entirely.', 1, 1, 1);";
 $inserts[] = "INSERT INTO mybb_helpdocs (hid, sid, name, description, document, usetranslation, enabled, disporder) VALUES (6, 2, 'Posting a Reply', 'Replying to a topic within a forum.', 'During the course of your visit, you may encounter a thread to which you would like to make a reply. To do so, simply click the \"Post reply\" button at the bottom or top of the thread. Please take note that your administrator may have restricted posting to certain individuals in that particular forum.<br />\r\n<br />\r\nAdditionally, a moderator of a forum may have closed a thread meaning that users cannot reply to it. There is no way for a user to open such a thread without the help of a moderator or administrator.', 1, 1, 2);";
diff -rub mybb_1400/install/resources/mysql_db_tables.php mybb_1408/install/resources/mysql_db_tables.php
--- mybb_1400/install/resources/mysql_db_tables.php	2008-07-04 23:24:03.000000000 +0200
+++ mybb_1408/install/resources/mysql_db_tables.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: mysql_db_tables.php 3981 2008-07-04 21:24:03Z Tikitiki $
+ * $Id: mysql_db_tables.php 4322 2009-02-21 23:00:49Z Tikitiki $
  */
 
 $tables[] = "CREATE TABLE mybb_adminlog (
@@ -22,6 +22,7 @@
 $tables[] = "CREATE TABLE mybb_adminoptions (
   uid int(10) NOT NULL default '0',
   cpstyle varchar(50) NOT NULL default '',
+  codepress int(1) NOT NULL default '1',
   notes text NOT NULL,
   permissions text NOT NULL,
   defaultviews text NOT NULL,
@@ -188,7 +189,7 @@
   dateline int(10) unsigned NOT NULL default '0',
   starttime int(10) unsigned NOT NULL default '0',
   endtime int(10) unsigned NOT NULL default '0',
-  timezone int(3) NOT NULL default '0',
+  timezone varchar(4) NOT NULL default '0',
   ignoretimezone int(1) NOT NULL default '0',
   usingtime int(1) NOT NULL default '0',
   repeats text NOT NULL,
@@ -470,7 +471,7 @@
   dateline bigint(30) NOT NULL default '0',
   message text NOT NULL,
   ipaddress varchar(30) NOT NULL default '',
-  longipaddress int(10) NOT NULL default '0',
+  longipaddress int(11) NOT NULL default '0',
   includesig int(1) NOT NULL default '0',
   smilieoff int(1) NOT NULL default '0',
   edituid int unsigned NOT NULL default '0',
@@ -481,6 +482,7 @@
   KEY uid (uid),
   KEY visible (visible),
   KEY dateline (dateline),
+  KEY longipaddress (longipaddress),
   PRIMARY KEY (pid)
 ) TYPE=MyISAM;";
 
@@ -603,13 +605,12 @@
   nopermission int(1) NOT NULL default '0',
   location1 int(10) NOT NULL default '0',
   location2 int(10) NOT NULL default '0',
-  loginattempts tinyint(2) NOT NULL default '1',
-  failedlogin bigint(30) NOT NULL default '0',
   PRIMARY KEY(sid),
   KEY location1 (location1),
   KEY location2 (location2),
   KEY time (time),
-  KEY uid (uid)
+  KEY uid (uid),
+  KEY ip (ip)
 ) TYPE=MyISAM;";
 
 $tables[] = "CREATE TABLE mybb_settinggroups (
@@ -941,8 +942,8 @@
   reputation bigint(30) NOT NULL default '0',
   regip varchar(50) NOT NULL default '',
   lastip varchar(50) NOT NULL default '',
-  longregip int(10) NOT NULL default '0',
-  longlastip int(10) NOT NULL default '0',
+  longregip int(11) NOT NULL default '0',
+  longlastip int(11) NOT NULL default '0',
   language varchar(50) NOT NULL default '',
   timeonline bigint(30) NOT NULL default '0',
   showcodebuttons int(1) NOT NULL default '1',
@@ -955,9 +956,13 @@
   suspensiontime bigint(30) NOT NULL default '0',
   coppauser int(1) NOT NULL default '0',
   classicpostbit int(1) NOT NULL default '0',
+  loginattempts tinyint(2) NOT NULL default '1',
+  failedlogin bigint(30) NOT NULL default '0',
   UNIQUE KEY username (username),
   KEY usergroup (usergroup),
   KEY birthday (birthday),
+  KEY longregip (longregip),
+  KEY longlastip (longlastip),
   PRIMARY KEY (uid)
 ) TYPE=MyISAM;";
 
diff -rub mybb_1400/install/resources/output.php mybb_1408/install/resources/output.php
--- mybb_1400/install/resources/output.php	2008-06-19 21:25:23.000000000 +0200
+++ mybb_1408/install/resources/output.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: output.php 3927 2008-06-19 19:25:23Z Tikitiki $
+ * $Id: output.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 class installerOutput {
diff -rub mybb_1400/install/resources/pgsql_db_tables.php mybb_1408/install/resources/pgsql_db_tables.php
--- mybb_1400/install/resources/pgsql_db_tables.php	2008-07-04 23:25:56.000000000 +0200
+++ mybb_1408/install/resources/pgsql_db_tables.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: pgsql_db_tables.php 3982 2008-07-04 21:25:56Z Tikitiki $
+ * $Id: pgsql_db_tables.php 4290 2008-12-10 02:39:25Z Tikitiki $
  */
 
 $tables[] = "CREATE TABLE mybb_adminlog (
@@ -21,6 +21,7 @@
 $tables[] = "CREATE TABLE mybb_adminoptions (
   uid int NOT NULL default '0',
   cpstyle varchar(50) NOT NULL default '',
+  codepress int NOT NULL default '1',
   notes text NOT NULL default '',
   permissions text NOT NULL default '',
   defaultviews text NOT NULL,
@@ -164,7 +165,7 @@
 $tables[] = "CREATE TABLE mybb_datacache (
   title varchar(50) NOT NULL default '',
   cache text NOT NULL default '',
-  UNIQUE (title)
+  PRIMARY KEY (title)
 );";
 
 $tables[] = "CREATE TABLE mybb_events (
@@ -178,7 +179,7 @@
   dateline int NOT NULL default '0',
   starttime int NOT NULL default '0',
   endtime int  NOT NULL default '0',
-  timezone int NOT NULL default '0',
+  timezone varchar(4) NOT NULL default '0',
   ignoretimezone int NOT NULL default '0',
   usingtime int NOT NULL default '0',
   repeats text NOT NULL,
@@ -576,8 +577,6 @@
   nopermission int NOT NULL default '0',
   location1 int NOT NULL default '0',
   location2 int NOT NULL default '0',
-  loginattempts smallint NOT NULL default '1',
-  failedlogin bigint NOT NULL default '0',
   UNIQUE (sid)
 );";
 
@@ -772,6 +771,18 @@
   PRIMARY KEY (ufid)
 );";
 
+$query = $db->write_query("SELECT column_name
+						  FROM information_schema.constraint_column_usage
+						  WHERE table_name = '".$config['tableprefix']."userfields' 
+						  AND constraint_name = '".$config['tableprefix']."userfields_pkey'
+						  LIMIT 1");
+$main_field = $db->fetch_field($query, 'column_name');
+if(!empty($main_field))
+{
+	$tables[] = "DROP SEQUENCE mybb_userfields_ufid_seq;";
+}
+$tables[] = "CREATE SEQUENCE mybb_userfields_ufid_seq;";
+
 $tables[] = "CREATE TABLE mybb_usergroups (
   gid serial,
   type smallint NOT NULL default '2',
@@ -912,6 +923,8 @@
   suspensiontime bigint NOT NULL default '0',
   coppauser int NOT NULL default '0',
   classicpostbit int NOT NULL default '0',
+  loginattempts smallint NOT NULL default '1',
+  failedlogin bigint NOT NULL default '0',
   PRIMARY KEY (uid)
 );";
 
@@ -953,8 +966,8 @@
 	expired int NOT NULL default '0',
 	daterevoked bigint NOT NULL default '0',
 	revokedby int NOT NULL default '0',
-	revokereason text NOT NULL,
-	notes text NOT NULL,
+	revokereason text NOT NULL default '',
+	notes text NOT NULL default '',
 	PRIMARY KEY(wid)
 );";
 
diff -rub mybb_1400/install/resources/settings.xml mybb_1408/install/resources/settings.xml
--- mybb_1400/install/resources/settings.xml	2008-07-25 22:13:08.000000000 +0200
+++ mybb_1408/install/resources/settings.xml	2009-06-26 06:22:11.000000000 +0200
@@ -535,7 +535,7 @@
 			<title>SMTP password</title>
 			<description><![CDATA[The corresponding password used to authenticate with the SMTP server.<br />Only required if SMTP Mail is selected as the Mail Handler, and the SMTP server requires authentication.]]></description>
 			<disporder>5</disporder>
-			<optionscode><![CDATA[text]]></optionscode>
+			<optionscode><![CDATA[passwordbox]]></optionscode>
 			<settingvalue><![CDATA[]]></settingvalue>
 			<isdefault>1</isdefault>
 			<helpkey></helpkey>
@@ -1089,7 +1089,7 @@
 		</setting>
 		<setting name="logip">
 			<title>Log Posting IP Addresses</title>
-			<description><![CDATA[Do you wish to log ip addresses of users who post, and who to you want to show ip addresses to.]]></description>
+			<description><![CDATA[Do you wish to log ip addresses of users who post, and who you want to show ip addresses to.]]></description>
 			<disporder>10</disporder>
 			<optionscode><![CDATA[radio
 no=Do not log IP
@@ -1329,7 +1329,7 @@
 	<settinggroup name="server" title="Server and Optimization Options" description="These options allow you to set various server and optimization preferences allowing you to reduce the load on your server, and gain better performance on your board." disporder="3" isdefault="1">
 		<setting name="seourls">
 			<title>Enable search engine friendly URLs?</title>
-			<description><![CDATA[Search engine friendly URLs change the MyBB links to shorter URLs which search engines prefer and are easier to type. showthread.php?tid=1 becomes thread1.html. <strong>Once this setting is enabled you need to make sure you have the MyBB .htaccess in your MyBB root directory (or the equivilent for your web server). Automatic detection may not work on all servers.</strong> Please see <a href="http://wiki.mybboard.net/index.php/SEF_URLS">The MyBB wiki</a> for assistance.]]></description>
+			<description><![CDATA[Search engine friendly URLs change the MyBB links to shorter URLs which search engines prefer and are easier to type. showthread.php?tid=1 becomes thread-1.html. <strong>Once this setting is enabled you need to make sure you have the MyBB .htaccess in your MyBB root directory (or the equivilent for your web server). Automatic detection may not work on all servers.</strong> Please see <a href="http://wiki.mybboard.net/index.php/SEF_URLS">The MyBB wiki</a> for assistance.]]></description>
 			<disporder>1</disporder>
 			<optionscode><![CDATA[select
 auto=Automatic Detection
diff -rub mybb_1400/install/resources/sqlite_db_tables.php mybb_1408/install/resources/sqlite_db_tables.php
--- mybb_1400/install/resources/sqlite_db_tables.php	2008-07-04 23:25:56.000000000 +0200
+++ mybb_1408/install/resources/sqlite_db_tables.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: sqlite_db_tables.php 3982 2008-07-04 21:25:56Z Tikitiki $
+ * $Id: sqlite_db_tables.php 4289 2008-12-06 21:22:41Z Tikitiki $
  */
 
 $tables[] = "CREATE TABLE mybb_adminlog (
@@ -15,14 +15,17 @@
   dateline bigint(30) NOT NULL default '0',
   module varchar(50) NOT NULL default '',
   action varchar(50) NOT NULL default '',
-  data TEXT NOT NULL );";
+  data TEXT NOT NULL 
+ );";
 
 $tables[] = "CREATE TABLE mybb_adminoptions (
   uid int(10) NOT NULL default '0',
   cpstyle varchar(50) NOT NULL default '',
+  codepress int(1) NOT NULL default '1',
   notes TEXT NOT NULL,
   permissions TEXT NOT NULL,
-  defaultviews TEXT NOT NULL );";
+  defaultviews TEXT NOT NULL 
+ );";
 
 $tables[] = "CREATE TABLE mybb_adminsessions (
 	sid varchar(32) NOT NULL default '',
@@ -31,7 +34,8 @@
 	ip varchar(40) NOT NULL default '',
 	dateline bigint(30) NOT NULL default '0',
 	lastactive bigint(30) NOT NULL default '0',
-	data TEXT NOT NULL );";
+	data TEXT NOT NULL
+);";
 
 $tables[] = "CREATE TABLE mybb_adminviews (
 	vid INTEGER PRIMARY KEY,
@@ -151,8 +155,9 @@
 );";
 
 $tables[] = "CREATE TABLE mybb_datacache (
-  title varchar(50) NOT NULL default '',
-  cache mediumTEXT NOT NULL );";
+  title varchar(50) NOT NULL default '' PRIMARY KEY,
+  cache mediumTEXT NOT NULL
+);";
 
 $tables[] = "CREATE TABLE mybb_events (
   eid INTEGER PRIMARY KEY,
@@ -165,7 +170,7 @@
   dateline int(10) NOT NULL default '0',
   starttime int(10) NOT NULL default '0',
   endtime int(10) NOT NULL default '0',
-  timezone int(3) NOT NULL default '0',
+  timezone varchar(4) NOT NULL default '0',
   ignoretimezone int(1) NOT NULL default '0',
   usingtime int(1) NOT NULL default '0',
   repeats TEXT NOT NULL );";
@@ -418,7 +423,7 @@
   dateline bigint(30) NOT NULL default '0',
   message TEXT NOT NULL,
   ipaddress varchar(30) NOT NULL default '',
-  longipaddress int(10) NOT NULL default '0',
+  longipaddress int(11) NOT NULL default '0',
   includesig int(1) NOT NULL default '0',
   smilieoff int(1) NOT NULL default '0',
   edituid int NOT NULL default '0',
@@ -531,9 +536,7 @@
   anonymous int(1) NOT NULL default '0',
   nopermission int(1) NOT NULL default '0',
   location1 int(10) NOT NULL default '0',
-  location2 int(10) NOT NULL default '0',
-  loginattempts tinyint(2) NOT NULL default '1',
-  failedlogin bigint(30) NOT NULL default '0'
+  location2 int(10) NOT NULL default '0'
 );";
 
 $tables[] = "CREATE TABLE mybb_settinggroups (
@@ -706,7 +709,8 @@
   ufid int NOT NULL default '0',
   fid1 TEXT NOT NULL,
   fid2 TEXT NOT NULL,
-  fid3 TEXT NOT NULL );";
+  fid3 TEXT NOT NULL
+);";
 
 $tables[] = "CREATE TABLE mybb_usergroups (
   gid INTEGER PRIMARY KEY,
@@ -833,8 +837,8 @@
   reputation bigint(30) NOT NULL default '0',
   regip varchar(50) NOT NULL default '',
   lastip varchar(50) NOT NULL default '',
-  longregip int(10) NOT NULL default '0',
-  longlastip int(10) NOT NULL default '0',
+  longregip int(11) NOT NULL default '0',
+  longlastip int(11) NOT NULL default '0',
   language varchar(50) NOT NULL default '',
   timeonline bigint(30) NOT NULL default '0',
   showcodebuttons int(1) NOT NULL default '1',
@@ -846,7 +850,9 @@
   suspendposting int(1) NOT NULL default '0',
   suspensiontime bigint(30) NOT NULL default '0',
   coppauser int(1) NOT NULL default '0',
-  classicpostbit int(1) NOT NULL default '0'
+  classicpostbit int(1) NOT NULL default '0',
+  loginattempts tinyint(2) NOT NULL default '1',
+  failedlogin bigint(30) NOT NULL default '0'
 );";
 
 
@@ -861,7 +867,8 @@
 $tables[] = "CREATE TABLE mybb_warninglevels (
 	lid INTEGER PRIMARY KEY,
 	percentage int(2) NOT NULL default '0',
-	action TEXT NOT NULL );";
+	action TEXT NOT NULL
+);";
 
 $tables[] = "CREATE TABLE mybb_warningtypes (
 	tid INTEGER PRIMARY KEY,
diff -rub mybb_1400/install/resources/upgrade1.php mybb_1408/install/resources/upgrade1.php
--- mybb_1400/install/resources/upgrade1.php	2008-05-10 18:35:33.000000000 +0200
+++ mybb_1408/install/resources/upgrade1.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade1.php 3825 2008-05-10 16:35:33Z Tikitiki $
+ * $Id: upgrade1.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -354,7 +354,7 @@
 	$db->write_query("INSERT INTO `settings` (`sid`, `name`, `title`, `description`, `optionscode`, `value`, `disporder`, `gid`) VALUES (54, 'publiceventcolor', 'Public Events Color', 'The color that public events will be shown in on the main calendar page.', 'text', 'green', 1, 17);");
 	$db->write_query("INSERT INTO `settings` (`sid`, `name`, `title`, `description`, `optionscode`, `value`, `disporder`, `gid`) VALUES (55, 'movedprefix', 'Moved Threads Prefix', 'The prefix that threads that have been moved to another forum should have.', 'text', '<b>Moved:</b>', 5, 7);");
 	$db->write_query("INSERT INTO `settings` (`sid`, `name`, `title`, `description`, `optionscode`, `value`, `disporder`, `gid`) VALUES (56, 'hottopicviews', 'Views For Hot Topic', 'The number of views a thread can have before it is considered \'hot\'.', 'text', '150', 7, 7);");
-	$db->write_query("INSERT INTO `settings` (`sid`, `name`, `title`, `description`, `optionscode`, `value`, `disporder`, `gid`) VALUES (59, 'logip', 'Log Posting IP Addresses', 'Do you wish to log ip addresses of users who post, and who to you want to show ip addresses to.', 'radio\r\nno=Do not log IP\r\nhide=Show to Admins & Mods\r\nshow=Show to all Users', 'hide', 3, 13);");
+	$db->write_query("INSERT INTO `settings` (`sid`, `name`, `title`, `description`, `optionscode`, `value`, `disporder`, `gid`) VALUES (59, 'logip', 'Log Posting IP Addresses', 'Do you wish to log ip addresses of users who post, and who you want to show ip addresses to.', 'radio\r\nno=Do not log IP\r\nhide=Show to Admins & Mods\r\nshow=Show to all Users', 'hide', 3, 13);");
 	$db->write_query("INSERT INTO `settings` (`sid`, `name`, `title`, `description`, `optionscode`, `value`, `disporder`, `gid`) VALUES (60, 'statslimit', 'Stats Limit', 'The number of threads to show on the stats page for most replies and most views.', 'text', '15', 5, 1);");
 	$db->write_query("INSERT INTO `settings` (`sid`, `name`, `title`, `description`, `optionscode`, `value`, `disporder`, `gid`) VALUES (65, 'modlist', 'Forums\' Moderator Listing', 'Here you can turn on or off the listing of moderators for each forum on index.php and forumdisplay.php', 'onoff', 'on', 5, 16);");
 	$db->write_query("INSERT INTO `settings` (`sid`, `name`, `title`, `description`, `optionscode`, `value`, `disporder`, `gid`) VALUES (66, 'smilieinserter', 'Clickable Smilies Inserter', 'Clickable smilies will appear on the posting pages if this option is set to \'on\'.', 'onoff', 'on', 1, 20);");
diff -rub mybb_1400/install/resources/upgrade10.php mybb_1408/install/resources/upgrade10.php
--- mybb_1400/install/resources/upgrade10.php	2008-07-06 02:54:32.000000000 +0200
+++ mybb_1408/install/resources/upgrade10.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.com
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade10.php 3988 2008-07-06 00:54:32Z Tikitiki $
+ * $Id: upgrade10.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/install/resources/upgrade11.php mybb_1408/install/resources/upgrade11.php
--- mybb_1400/install/resources/upgrade11.php	2008-08-04 07:25:48.000000000 +0200
+++ mybb_1408/install/resources/upgrade11.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.com
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade11.php 3988 2008-07-06 00:54:32Z Tikitiki $
+ * $Id: upgrade11.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/install/resources/upgrade12.php mybb_1408/install/resources/upgrade12.php
--- mybb_1400/install/resources/upgrade12.php	2008-08-03 08:29:10.000000000 +0200
+++ mybb_1408/install/resources/upgrade12.php	2009-06-26 06:22:11.000000000 +0200
@@ -26,8 +26,6 @@
 // during load_module $db is not globalized in the function
 global $db;
 
-$collation = $db->build_create_table_collation();
-
 // FIRST STEP IS FOR INTEGER CONVERSION PROJECT
 
 function upgrade12_dbchanges()
@@ -52,7 +50,7 @@
 		"privatemessages" => array("pmid", "includesig","smilieoff"),
 		"profilefields" => array("fid", "required","editable","hidden"),
 		"smilies" => array("sid", "showclickable"),
-		"usergroups" => array("gid","isbannedgroup","canview","canviewthreads","canviewprofiles","candlattachments","canpostthreads","canpostreplys","canpostattachments","canratethreads","caneditposts","candeleteposts","candeletethreads","caneditattachments","canpostpolls","canvotepolls","canusepms","cansendpms","cantrackpms","candenypmreceipts","cansendemail","canviewmemberlist","canviewcalendar","canviewonline","canviewwolinvis","canviewonlineips","cancp","issupermod","cansearch","canusercp","canuploadavatars","canratemembers","canchangename","showforumteam","usereputationsystem","cangivereputations"),
+		"usergroups" => array("gid","isbannedgroup","canview","canviewthreads","canviewprofiles","candlattachments","canpostthreads","canpostreplys","canpostattachments","canratethreads","caneditposts","candeleteposts","candeletethreads","caneditattachments","canpostpolls","canvotepolls","canusepms","cansendpms","cantrackpms","candenypmreceipts","cansendemail","canviewmemberlist","canviewcalendar","canviewonline","canviewwolinvis","canviewonlineips","cancp","issupermod","cansearch","canusercp","canuploadavatars","canratemembers","canchangename","showforumteam","usereputationsystem","cangivereputations","candisplaygroup","cancustomtitle"),
 		"users" => array("uid","allownotices","hideemail","invisible","receivepms","pmpopup","pmnotify","remember","showsigs","showavatars","showquickreply","showredirect","away"),
 		"threads" => array("tid", "closed")
 	);
@@ -268,7 +266,7 @@
 	echo "<p>Adding longipaddress column to posts table ... ";
 	flush();
 	
-	$db->write_query("ALTER TABLE ".TABLE_PREFIX."posts ADD longipaddress int(10) NOT NULL default '0' AFTER ipaddress");
+	$db->write_query("ALTER TABLE ".TABLE_PREFIX."posts ADD longipaddress int(11) NOT NULL default '0' AFTER ipaddress");
 	
 	echo "done.</p>";
 	flush();
@@ -427,6 +425,8 @@
 	$db->drop_table("promotionlogs");
 	$db->drop_table("massemails");
 
+	$collation = $db->build_create_table_collation();
+
 	$db->write_query("CREATE TABLE ".TABLE_PREFIX."massemails (
 		mid int unsigned NOT NULL auto_increment,
 		uid int unsigned NOT NULL default '0',
@@ -615,7 +615,7 @@
 
 	if($db->field_exists('emailnotify', "users"))
 	{
-		$db->update_query("users", array('emailnotify' => 1), "emailnotify='no' OR emailnotify='0'");
+		$db->update_query("users", array('emailnotify' => 0), "emailnotify='no' OR emailnotify='0'");
 		$db->update_query("users", array('emailnotify' => 2), "emailnotify='yes' OR emailnotify='1'");
 		$db->update_query("users", array('emailnotify' => 0), "emailnotify != 1 AND emailnotify != 2");
 		$db->write_query("ALTER TABLE ".TABLE_PREFIX."users CHANGE emailnotify subscriptionmethod int(1) NOT NULL default '0'");
@@ -706,13 +706,13 @@
 	{
 		$db->write_query("ALTER TABLE ".TABLE_PREFIX."users DROP longregip;");
 	}
-	$db->write_query("ALTER TABLE ".TABLE_PREFIX."users ADD longregip int(10) NOT NULL default '0' AFTER lastip");
+	$db->write_query("ALTER TABLE ".TABLE_PREFIX."users ADD longregip int(11) NOT NULL default '0' AFTER lastip");
 	
 	if($db->field_exists('longlastip', "users"))
 	{
 		$db->write_query("ALTER TABLE ".TABLE_PREFIX."users DROP longlastip;");
 	}
-	$db->write_query("ALTER TABLE ".TABLE_PREFIX."users ADD longlastip int(10) NOT NULL default '0' AFTER lastip");
+	$db->write_query("ALTER TABLE ".TABLE_PREFIX."users ADD longlastip int(11) NOT NULL default '0' AFTER lastip");
 	
 	// Unused column
 	if($db->field_exists('titles', "searchlog"))
@@ -1147,7 +1147,7 @@
 	{
 		$db->write_query("ALTER TABLE ".TABLE_PREFIX."users DROP KEY username");
 	}
-	$db->write_query("ALTER TABLE ".TABLE_PREFIX."users ADD KEY username (username)");
+	$db->write_query("ALTER TABLE ".TABLE_PREFIX."users ADD UNIQUE KEY username (username)");
 
 	if($db->field_exists('statustime', "privatemessages"))
 	{
@@ -1276,7 +1276,7 @@
 		$view_count++;
 	}
 	
-	$avatardimensions = str_replace('x', '|', $mybb->settings['postmaxavatarsize']);
+	$avatardimensions = str_replace('x', '|', my_strtolower($mybb->settings['postmaxavatarsize']));
 	
 	$db->simple_select("users", "uid", "avatar != '' && avatardimensions = ''");
 	while($user = $db->fetch_array($query))
@@ -1795,8 +1795,8 @@
 	else
 	{
 		@fclose($cachewritable);
-	  	@my_chmod(MYBB_ROOT.'cache', 0777);
-	  	@my_chmod(MYBB_ROOT.'cache/test.write', 0777);
+	  	@my_chmod(MYBB_ROOT.'cache', '0777');
+	  	@my_chmod(MYBB_ROOT.'cache/test.write', '0777');
 		@unlink(MYBB_ROOT.'cache/test.write');
 	}
 
@@ -1826,8 +1826,8 @@
 	else
 	{
 		@fclose($themewritable);
-	  	@my_chmod(MYBB_ROOT.'cache/themes', 0777);
-	  	@my_chmod(MYBB_ROOT.'cache/themes/test.write', 0777);
+	  	@my_chmod(MYBB_ROOT.'cache/themes', '0777');
+	  	@my_chmod(MYBB_ROOT.'cache/themes/test.write', '0777');
 		@unlink(MYBB_ROOT.'cache/themes/test.write');
 	}
 	
@@ -1886,13 +1886,15 @@
 		require_once MYBB_ROOT."admin/inc/functions_themes.php";
 	}
 	else
-
 	{
 		$output->print_error("Please make sure your admin directory is uploaded correctly.");
 	}
 
 	// Import master theme
-	import_theme_xml($contents, array("tid" => 1, "no_templates" => 1));
+	if(import_theme_xml($contents, array("tid" => 1, "no_templates" => 1, "version_compat" => 1)) === -1)
+	{
+		$output->print_error("Please make sure your install/resources/mybb_theme.xml file is uploaded correctly.");
+	}
 
 	// Fetch out default stylesheets from master
 	$query = $db->simple_select("themes", "*", "tid=1");
@@ -1900,6 +1902,8 @@
 
 	$master_stylesheets = unserialize($master_theme['stylesheets']);
 
+	if(is_array($master_stylesheets))
+	{
 	// Note: 1.4 only ships with one global|global stylesheet
 	foreach($master_stylesheets as $location => $sheets)
 	{
@@ -1917,6 +1921,7 @@
 			}
 		}
 	}
+	}
 	
 	$query = $db->simple_select("themes");
 	while($theme = $db->fetch_array($query))
Only in mybb_1408/install/resources: upgrade13.php
Only in mybb_1408/install/resources: upgrade14.php
Only in mybb_1408/install/resources: upgrade15.php
Only in mybb_1408/install/resources: upgrade16.php
diff -rub mybb_1400/install/resources/upgrade2.php mybb_1408/install/resources/upgrade2.php
--- mybb_1400/install/resources/upgrade2.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/install/resources/upgrade2.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade2.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: upgrade2.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -233,7 +233,7 @@
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'publiceventcolor', 'Public Events Color', 'The color that public events will be shown in on the main calendar page.', 'text', 'green', 1, 17);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'movedprefix', 'Moved Threads Prefix', 'The prefix that threads that have been moved to another forum should have.', 'text', '<b>Moved:</b>', 5, 7);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'hottopicviews', 'Views For Hot Topic', 'The number of views a thread can have before it is considered \'hot\'.', 'text', '150', 7, 7);");
-	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'logip', 'Log Posting IP Addresses', 'Do you wish to log ip addresses of users who post, and who to you want to show ip addresses to.', 'radio\r\nno=Do not log IP\r\nhide=Show to Admins & Mods\r\nshow=Show to all Users', 'hide', 3, 13);");
+	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'logip', 'Log Posting IP Addresses', 'Do you wish to log ip addresses of users who post, and who you want to show ip addresses to.', 'radio\r\nno=Do not log IP\r\nhide=Show to Admins & Mods\r\nshow=Show to all Users', 'hide', 3, 13);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'statslimit', 'Stats Limit', 'The number of threads to show on the stats page for most replies and most views.', 'text', '15', 10, 1);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'modlist', 'Forums\' Moderator Listing', 'Here you can turn on or off the listing of moderators for each forum on index.php and forumdisplay.php', 'onoff', 'on', 5, 16);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'smilieinserter', 'Clickable Smilies Inserter', 'Clickable smilies will appear on the posting pages if this option is set to \'on\'.', 'onoff', 'on', 1, 20);");
diff -rub mybb_1400/install/resources/upgrade3.php mybb_1408/install/resources/upgrade3.php
--- mybb_1400/install/resources/upgrade3.php	2008-05-10 18:49:24.000000000 +0200
+++ mybb_1408/install/resources/upgrade3.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade3.php 3826 2008-05-10 16:49:24Z Tikitiki $
+ * $Id: upgrade3.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
@@ -38,7 +38,7 @@
 	{
 		if(!@is_writable("../uploads/"))
 		{
-			@my_chmod("../uploads", 766);
+			@my_chmod("../uploads", '0777');
 			if(!@is_writable("../uploads/"))
 			{
 				$errors = "<p>../uploads/ is not writable! Please chmod this directory so it's writable (766 or 777).";
@@ -53,7 +53,7 @@
 	{
 		if(!@is_writable("../uploads/avatars/"))
 		{
-			@my_chmod("../uploads/avatars/", 766);
+			@my_chmod("../uploads/avatars/", '0777');
 			if(!is_writable("../uploads/avatars/"))
 			{
 				$errors = "<p>../uploads/avatars/ is not writable! Please chmod this directory so it's writable (766 or 777).";
@@ -576,7 +576,7 @@
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'privateeventcolor', 'Private Events Color', 'The color that private events will be shown in on the main calendar page.', 'text', 'red', 2, 17);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'publiceventcolor', 'Public Events Color', 'The color that public events will be shown in on the main calendar page.', 'text', 'green', 1, 17);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'hottopicviews', 'Views For Hot Topic', 'The number of views a thread can have before it is considered ''hot''.', 'text', '150', 7, 7);");
-	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'logip', 'Log Posting IP Addresses', 'Do you wish to log ip addresses of users who post, and who to you want to show ip addresses to.', 'radio\r\nno=Do not log IP\r\nhide=Show to Admins & Mods\r\nshow=Show to all Users', 'hide', 3, 13);");
+	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'logip', 'Log Posting IP Addresses', 'Do you wish to log ip addresses of users who post, and who you want to show ip addresses to.', 'radio\r\nno=Do not log IP\r\nhide=Show to Admins & Mods\r\nshow=Show to all Users', 'hide', 3, 13);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'statslimit', 'Stats Limit', 'The number of threads to show on the stats page for most replies and most views.', 'text', '15', 10, 1);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'modlist', 'Forums'' Moderator Listing', 'Here you can turn on or off the listing of moderators for each forum on index.php and forumdisplay.php', 'onoff', 'on', 5, 16);");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."settings (sid, name, title, description, optionscode, value, disporder, gid) VALUES (NULL, 'smilieinserter', 'Clickable Smilies Inserter', 'Clickable smilies will appear on the posting pages if this option is set to ''on''.', 'onoff', 'on', 1, 20);");
diff -rub mybb_1400/install/resources/upgrade4.php mybb_1408/install/resources/upgrade4.php
--- mybb_1400/install/resources/upgrade4.php	2008-05-10 18:49:24.000000000 +0200
+++ mybb_1408/install/resources/upgrade4.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade4.php 3826 2008-05-10 16:49:24Z Tikitiki $
+ * $Id: upgrade4.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/install/resources/upgrade5.php mybb_1408/install/resources/upgrade5.php
--- mybb_1400/install/resources/upgrade5.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/install/resources/upgrade5.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade5.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: upgrade5.php 4289 2008-12-06 21:22:41Z Tikitiki $
  */
 
 /**
@@ -132,7 +132,7 @@
 	
 	if($db->field_exists('canmanagemembers', "groupleaders"))
 	{
-		$db->write_query("ALTER TABLE ".TABLE_PREFIX."groupleaders DROP gcanmanagemembers;");
+		$db->write_query("ALTER TABLE ".TABLE_PREFIX."groupleaders DROP canmanagemembers;");
 	}
 	$db->write_query("ALTER TABLE ".TABLE_PREFIX."groupleaders ADD canmanagemembers char(3) NOT NULL default '' AFTER uid;");
 	
@@ -235,7 +235,7 @@
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."templategroups (gid,prefix,title) VALUES ('25','newreply','<lang:group_newreply>');");
 	$db->write_query("INSERT INTO ".TABLE_PREFIX."templategroups (gid,prefix,title) VALUES ('26','member','<lang:group_member>');");
 
-	$db->drop_table("searhlog");
+	$db->drop_table("searchlog");
 	$db->write_query("CREATE TABLE ".TABLE_PREFIX."searchlog (
 		  sid varchar(32) NOT NULL default '',
 		  uid int unsigned NOT NULL default '0',
@@ -457,12 +457,12 @@
  * Database configuration
  */
 
-\$config['dbtype'] = '{$config['dbtype']}';
-\$config['hostname'] = '{$config['hostname']}';
-\$config['username'] = '{$config['username']}';
-\$config['password'] = '{$config['password']}';
-\$config['database'] = '{$config['database']}';
-\$config['table_prefix'] = '{$config['table_prefix']}';
+\$config['dbtype'] = '{$config['database']['type']}';
+\$config['hostname'] = '{$config['database']['hostname']}';
+\$config['username'] = '{$config['database']['username']}';
+\$config['password'] = '{$config['database']['password']}';
+\$config['database'] = '{$config['database']['database']}';
+\$config['table_prefix'] = '{$config['database']['table_prefix']}';
 
 /**
  * Admin CP directory
@@ -530,6 +530,8 @@
 	}
 	else
 	{
+		require_once MYBB_ROOT."inc/functions_rebuild.php";
+		
 		$query = $db->simple_select("threads", "COUNT(*) as num_threads", "closed NOT LIKE 'moved|%'");
 		$num_threads = $db->fetch_field($query, 'num_threads');
 		$tpp = intval($_POST['tpp']);
diff -rub mybb_1400/install/resources/upgrade6.php mybb_1408/install/resources/upgrade6.php
--- mybb_1400/install/resources/upgrade6.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/install/resources/upgrade6.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade6.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: upgrade6.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/install/resources/upgrade7.php mybb_1408/install/resources/upgrade7.php
--- mybb_1400/install/resources/upgrade7.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/install/resources/upgrade7.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade7.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: upgrade7.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/install/resources/upgrade8.php mybb_1408/install/resources/upgrade8.php
--- mybb_1400/install/resources/upgrade8.php	2008-05-07 02:18:54.000000000 +0200
+++ mybb_1408/install/resources/upgrade8.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade8.php 3818 2008-05-07 00:18:54Z Tikitiki $
+ * $Id: upgrade8.php 4289 2008-12-06 21:22:41Z Tikitiki $
  */
 
 /**
@@ -31,14 +31,14 @@
 
 	echo "<p>Performing necessary upgrade queries..</p>";
 
-	if($db->field_exists('oldadditionalgroups', TABLE_PREFIX."banned"))
+	if($db->field_exists('oldadditionalgroups', "banned"))
 	{
 		$db->write_query("ALTER TABLE ".TABLE_PREFIX."banned DROP oldadditionalgroups;");
 	}
 	$db->write_query("ALTER TABLE ".TABLE_PREFIX."banned ADD oldadditionalgroups TEXT NOT NULL AFTER oldgroup");
 	
 
-	if($db->field_exists('olddisplaygroup', TABLE_PREFIX."banned"))
+	if($db->field_exists('olddisplaygroup', "banned"))
 	{
 		$db->write_query("ALTER TABLE ".TABLE_PREFIX."banned DROP olddisplaygroup;");
 	}
diff -rub mybb_1400/install/resources/upgrade9.php mybb_1408/install/resources/upgrade9.php
--- mybb_1400/install/resources/upgrade9.php	2008-07-06 02:54:32.000000000 +0200
+++ mybb_1408/install/resources/upgrade9.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.com
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade9.php 3988 2008-07-06 00:54:32Z Tikitiki $
+ * $Id: upgrade9.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /**
diff -rub mybb_1400/install/stylesheet.css mybb_1408/install/stylesheet.css
--- mybb_1400/install/stylesheet.css	2008-06-01 21:39:47.000000000 +0200
+++ mybb_1408/install/stylesheet.css	2009-06-26 06:22:11.000000000 +0200
@@ -162,7 +162,7 @@
 	padding: 10px;
 	overflow: scroll;
 	height: 400px;
-	width: 500px;
+	width: 560px;
 	border: 1px solid #ccc;
 }
 
diff -rub mybb_1400/install/upgrade.php mybb_1408/install/upgrade.php
--- mybb_1400/install/upgrade.php	2008-07-29 17:45:49.000000000 +0200
+++ mybb_1408/install/upgrade.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: upgrade.php 4052 2008-07-29 15:45:49Z Tikitiki $
+ * $Id: upgrade.php 4353 2009-04-19 00:25:42Z Tikitiki $
  */
 error_reporting(E_ALL & ~E_NOTICE);
 
@@ -14,6 +14,7 @@
 define("INSTALL_ROOT", dirname(__FILE__)."/");
 define("TIME_NOW", time());
 define('IN_MYBB', 1);
+define("IN_UPGRADE", 1);
 
 require_once MYBB_ROOT."inc/class_core.php";
 $mybb = new MyBB;
@@ -47,12 +48,29 @@
 $lang->load('language');
 
 require_once MYBB_ROOT."inc/db_{$config['database']['type']}.php";
-$db = new databaseEngine;
+switch($config['database']['type'])
+{
+	case "sqlite3":
+		$db = new DB_SQLite3;
+		break;
+	case "sqlite2":
+		$db = new DB_SQLite2;
+		break;
+	case "pgsql":
+		$db = new DB_PgSQL;
+		break;
+	case "mysqli":
+		$db = new DB_MySQLi;
+		break;
+	default:
+		$db = new DB_MySQL;
+}
 	
 // Connect to Database
 define('TABLE_PREFIX', $config['database']['table_prefix']);
 $db->connect($config['database']);
 $db->set_table_prefix(TABLE_PREFIX);
+$db->type = $config['database']['type'];
 
 // Load Settings
 if(file_exists(MYBB_ROOT."inc/settings.php"))
@@ -123,7 +141,29 @@
 }
 else
 {
-	if($mybb->input['action'] == "do_login" && $mybb->request_method == "post")
+	if($mybb->input['action'] == "logout" && $mybb->user['uid'])
+	{	
+		// Check session ID if we have one
+		if($mybb->input['logoutkey'] != $mybb->user['logoutkey'])
+		{
+			$output->print_error("Your user ID could not be verified to log you out.  This may have been because a malicious Javascript was attempting to log you out automatically.  If you intended to log out, please click the Log Out button at the top menu.");
+		}
+	
+		my_unsetcookie("mybbuser");
+		my_unsetcookie("sid");
+		if($mybb->user['uid'])
+		{
+			$time = TIME_NOW;
+			$lastvisit = array(
+				"lastactive" => $time-900,
+				"lastvisit" => $time,
+			);
+			$db->update_query("users", $lastvisit, "uid='".$mybb->user['uid']."'");
+			$db->delete_query("sessions", "sid='".$session->sid."'");
+		}
+		header("Location: upgrade.php");
+	}
+	else if($mybb->input['action'] == "do_login" && $mybb->request_method == "post")
 	{	
 		require_once MYBB_ROOT."inc/functions_user.php";
 	
@@ -135,18 +175,23 @@
 		$user = $db->fetch_array($query);
 		if(!$user['uid'])
 		{
-			$output->print_error("The password you entered is incorrect. If you have forgotten your password, click <a href=\"../member.php?action=lostpw\">here</a>. Otherwise, go back and try again.");
+			$output->print_error("The username you have entered appears to be invalid.");
 		}
 		else
 		{
 			$user = validate_password_from_uid($user['uid'], $mybb->input['password'], $user);
+			if(!$user['uid'])
+			{
+				$output->print_error("The password you entered is incorrect. If you have forgotten your password, click <a href=\"../member.php?action=lostpw\">here</a>. Otherwise, go back and try again.");
+			}
 		}
 		
 		$db->delete_query("sessions", "ip='".$db->escape_string($session->ipaddress)."' AND sid != '".$session->sid."'");
+		
 		$newsession = array(
-			"uid" => $user['uid'],
-			"loginattempts" => 1,
+			"uid" => $user['uid']
 		);
+		
 		$db->update_query("sessions", $newsession, "sid='".$session->sid."'");
 	
 		// Temporarily set the cookie remember option for the login cookies
@@ -196,7 +241,7 @@
 	}
 	else if($mybb->usergroup['cancp'] != 1 && $mybb->usergroup['cancp'] != 'yes')
 	{
-		$output->print_error("You do not have permissions to run this process.");
+		$output->print_error("You do not have permissions to run this process. You need administrator permissions to be able to run the upgrade procedure.<br /><br />If you need to logout, please click <a href=\"upgrade.php?action=logout&amp;logoutkey={$mybb->user['logoutkey']}\">here</a>. From there you will be able to log in again under your administrator account.");
 	}
 
 	if(!$mybb->input['action'] || $mybb->input['action'] == "intro")
@@ -335,7 +380,7 @@
 		  status varchar(10) NOT NULL default '',
 		  dateline int(10) NOT NULL default '0',
 		  PRIMARY KEY  (tid)
-		) TYPE=MyISAM;{$charset}");
+		) TYPE=MyISAM{$charset};");
 	}
 
 	if($system_upgrade_detail['revert_all_themes'] > 0)
@@ -377,7 +422,7 @@
 		{
 			$output->print_error("Please make sure your admin directory is uploaded correctly.");
 		}
-		import_theme_xml($contents, array("templateset" => -2, "no_templates" => 1));
+		import_theme_xml($contents, array("templateset" => -2, "no_templates" => 1, "version_compat" => 1));
 		$tid = build_new_theme("Default", null, 1);
 
 		$db->update_query("themes", array("def" => 1), "tid='{$tid}'");
@@ -411,7 +456,7 @@
 		}
 		
 		// Import master theme
-		import_theme_xml($contents, array("tid" => 1, "no_templates" => 1));
+		import_theme_xml($contents, array("tid" => 1, "no_templates" => 1, "version_compat" => 1));
 	}
 
 	$sid = -2;
@@ -483,7 +528,7 @@
 
 function buildcaches()
 {
-	global $db, $output, $cache, $lang;
+	global $db, $output, $cache, $lang, $mybb;
 
 	$output->print_header($lang->upgrade_datacache_building);
 
@@ -656,33 +701,43 @@
 		  title varchar(220) NOT NULL default '',
 		  description text NOT NULL,
 		  disporder smallint unsigned NOT NULL default '0',
-		  isdefault int(1) NOT NULL default '',
+		  isdefault int(1) NOT NULL default '0',
 		  PRIMARY KEY  (gid)
 		) TYPE=MyISAM;");
 
 		$db->drop_table("settings");
 
 		$db->write_query("CREATE TABLE ".TABLE_PREFIX."settings (
-		  sid smallint(6) NOT NULL auto_increment,
+		  sid smallint unsigned NOT NULL auto_increment,
 		  name varchar(120) NOT NULL default '',
 		  title varchar(120) NOT NULL default '',
 		  description text NOT NULL,
 		  optionscode text NOT NULL,
 		  value text NOT NULL,
-		  disporder smallint(6) NOT NULL default '0',
-		  gid smallint(6) NOT NULL default '0',
+		  disporder smallint unsigned NOT NULL default '0',
+		  gid smallint unsigned NOT NULL default '0',
+		  isdefault int(1) NOT NULL default '0',
 		  PRIMARY KEY  (sid)
 		) TYPE=MyISAM;");
 	}
 	else
 	{
-		$query = $db->simple_select("settings", "name,sid", "isdefault='1' OR isdefault='yes'");
+		if($db->type == "mysql" || $db->type == "mysqli")
+        {
+            $wheresettings = "isdefault='1' OR isdefault='yes'";
+        }
+        else
+        {
+            $wheresettings = "isdefault='1'";
+        }
+		
+        $query = $db->simple_select("settings", "name,sid", $wheresettings);
 		while($setting = $db->fetch_array($query))
 		{
 			$settings[$setting['name']] = $setting['sid'];
 		}
 		
-		$query = $db->simple_select("settinggroups", "name,title,gid", "isdefault='1' OR isdefault='yes'");
+		$query = $db->simple_select("settinggroups", "name,title,gid", $wheresettings);
 		while($group = $db->fetch_array($query))
 		{
 			$settinggroups[$group['name']] = $group['gid'];
@@ -749,28 +804,12 @@
 		}
 	}
 	
-	foreach($settinggroups as $groupname)
-	{
-		if(!in_array($groupname, $settinggroupnames))
-		{
-			$db->delete_query("settinggroups", "gid='".$settinggroups[$groupname]."'", 1);
-		}
-	}
-	
-	foreach($settings as $settingname)
-	{
-		if(!in_array($settingname, $settingnames))
-		{
-			$db->delete_query("settings", "sid='".$settings[$settingname]."'", 1);
-		}
-	}
-	
 	if($redo >= 1)
 	{
 		require MYBB_ROOT."inc/settings.php";
 		foreach($settings as $key => $val)
 		{
-			$db->update_query("settings", array('value' => $db->escape_string($val)), "name='$key'");
+			$db->update_query("settings", array('value' => $db->escape_string($val)), "name='".$db->escape_string($key)."'");
 		}
 	}
 	unset($settings);
diff -rub mybb_1400/jscripts/editor.js mybb_1408/jscripts/editor.js
--- mybb_1400/jscripts/editor.js	2008-08-03 03:15:09.000000000 +0200
+++ mybb_1408/jscripts/editor.js	2009-06-26 06:22:11.000000000 +0200
@@ -251,6 +251,8 @@
 
 		// Create text area
 		textInput = document.createElement("textarea");
+		textInput.setAttribute("cols", oldTextarea.getAttribute("cols"));
+		textInput.setAttribute("rows", oldTextarea.getAttribute("rows"));
 		textInput.id = this.textarea;
 		textInput.name = oldTextarea.name+"_new";
 		textInput.style.height = parseInt(areaContainer.style.height)+"px";
@@ -292,10 +294,6 @@
 			Event.observe($(this.textarea), 'blur', function() {
 				this.trackingCaret = false;
 			}.bindAsEventListener(this));
-			Event.observe($(this.textarea), 'keyup', function() {
-				this.trackingCaret = true;
-				this.storeCaret();
-			}.bindAsEventListener(this));
 			Event.observe($(this.textarea), 'mousedown', function() {
 				this.trackingCaret = true;
 				this.storeCaret();
Files mybb_1400/jscripts/editor_themes/Office_2007/images/toolbar.gif and mybb_1408/jscripts/editor_themes/Office_2007/images/toolbar.gif differ
Files mybb_1400/jscripts/editor_themes/default/images/toolbar.gif and mybb_1408/jscripts/editor_themes/default/images/toolbar.gif differ
diff -rub mybb_1400/jscripts/general.js mybb_1408/jscripts/general.js
--- mybb_1400/jscripts/general.js	2008-07-26 05:04:54.000000000 +0200
+++ mybb_1408/jscripts/general.js	2009-06-26 06:22:11.000000000 +0200
@@ -50,6 +50,10 @@
 		{
 			this.browser = "safari";
 		}
+		else if(this.useragent.indexOf("chrome") != -1)
+		{
+			this.browser = "chrome";
+		}
 		else if(navigator.product == "Gecko")
 		{
 			this.browser = "mozilla";
@@ -266,7 +270,7 @@
 
 		promptres = prompt("Quick Page Jump\nPlease enter a page number between 1 and "+pages+" to jump to.", defpage);
 
-		if((promptres != null) && (promptres != "") & (promptres > 1) && (promptres <= pages))
+		if((promptres != null) && (promptres != "") && (promptres > 1) && (promptres <= pages))
 		{
 			window.location = "showthread.php?tid="+tid+"&page"+promotres;
 		}
@@ -415,12 +419,26 @@
 			
 			if(this.browser == "ie")
 			{
-				var input = document.createElement("<input name=\"username\">");
+				var input = document.createElement("<input name=\"quick_login\">");
 			}
 			else
 			{
 				var input = document.createElement("input");
-				input.setAttribute("name", "username");
+				input.setAttribute("name", "quick_login");
+			}
+			
+			input.setAttribute("type", "hidden");
+			input.setAttribute("value", "1");
+			form.appendChild(input);
+			
+			if(this.browser == "ie")
+			{
+				var input = document.createElement("<input name=\"quick_username\">");
+			}
+			else
+			{
+				var input = document.createElement("input");
+				input.setAttribute("name", "quick_username");
 			}
 			input.setAttribute("type", "text");
 			input.setAttribute("value", lang.username);
@@ -433,12 +451,12 @@
 			
 			if(this.browser == "ie")
 			{
-				var input = document.createElement("<input name=\"password\">");
+				var input = document.createElement("<input name=\"quick_password\">");
 			}
 			else
 			{
 				var input = document.createElement("input");
-				input.setAttribute("name", "password");
+				input.setAttribute("name", "quick_password");
 			}
 			input.setAttribute("type", "password");
 			input.setAttribute("value", lang.password);
@@ -474,8 +492,6 @@
 	}
 };
 
-
-
 var Cookie = {
 	get: function(name)
 	{
diff -rub mybb_1400/jscripts/popup_menu.js mybb_1408/jscripts/popup_menu.js
--- mybb_1400/jscripts/popup_menu.js	2007-09-16 02:52:25.000000000 +0200
+++ mybb_1408/jscripts/popup_menu.js	2009-06-26 06:22:11.000000000 +0200
@@ -49,6 +49,17 @@
 				if(Element.getStyle(element, 'position') == 'relative' || Element.getStyle(element, 'position') == 'absolute') break;
 			}
 		} while(element);
+		offsetTopReal = offsetTop;
+		offsetLeftReal = offsetLeft;
+		if(element) // will be true if we broke off the last loop
+		{
+			// calculate the true top/left position relative to page borders (this is used for checking whether the popup menu will be displayed within the page)
+			do
+			{
+				offsetTopReal += element.offsetTop || 0;
+				offsetLeftReal += element.offsetLeft || 0;
+			} while(element = element.offsetParent);
+		}
 		element = $(this.id);
 		element.blur();
 		this.menu.style.position = "absolute";
@@ -71,7 +82,7 @@
 			menuWidth = this.menu.offsetWidth;
 		}
 		pageSize = DomLib.getPageSize();
-		if(offsetLeft+menuWidth >= pageSize[0])
+		if(offsetLeftReal+menuWidth >= pageSize[0])
 		{
 			this.menu.style.left = (offsetLeft-menuWidth+element.offsetWidth)+"px";
 		}
diff -rub mybb_1400/jscripts/prototype.uncompressed.js mybb_1408/jscripts/prototype.uncompressed.js
--- mybb_1400/jscripts/prototype.uncompressed.js	2008-03-01 07:44:54.000000000 +0100
+++ mybb_1408/jscripts/prototype.uncompressed.js	2009-06-26 06:22:11.000000000 +0200
@@ -1,4 +1,4 @@
-/*  Prototype JavaScript framework, version 1.6.0.2
+/*  Prototype JavaScript framework, version 1.6.0.3
  *  (c) 2005-2008 Sam Stephenson
  *
  *  Prototype is freely distributable under the terms of an MIT-style license.
@@ -7,23 +7,26 @@
  *--------------------------------------------------------------------------*/
 
 var Prototype = {
-  Version: '1.6.0.2',
+  Version: '1.6.0.3',
 
   Browser: {
-    IE:     !!(window.attachEvent && !window.opera),
-    Opera:  !!window.opera,
+    IE:     !!(window.attachEvent &&
+      navigator.userAgent.indexOf('Opera') === -1),
+    Opera:  navigator.userAgent.indexOf('Opera') > -1,
     WebKit: navigator.userAgent.indexOf('AppleWebKit/') > -1,
-    Gecko:  navigator.userAgent.indexOf('Gecko') > -1 && navigator.userAgent.indexOf('KHTML') == -1,
+    Gecko:  navigator.userAgent.indexOf('Gecko') > -1 &&
+      navigator.userAgent.indexOf('KHTML') === -1,
     MobileSafari: !!navigator.userAgent.match(/Apple.*Mobile.*Safari/)
   },
 
   BrowserFeatures: {
     XPath: !!document.evaluate,
+    SelectorsAPI: !!document.querySelector,
     ElementExtensions: !!window.HTMLElement,
     SpecificElementExtensions:
-      document.createElement('div').__proto__ &&
-      document.createElement('div').__proto__ !==
-        document.createElement('form').__proto__
+      document.createElement('div')['__proto__'] &&
+      document.createElement('div')['__proto__'] !==
+        document.createElement('form')['__proto__']
   },
 
   ScriptFragment: '<script[^>]*>([\\S\\s]*?)<\/script>',
@@ -83,12 +86,13 @@
       var property = properties[i], value = source[property];
       if (ancestor && Object.isFunction(value) &&
           value.argumentNames().first() == "$super") {
-        var method = value, value = Object.extend((function(m) {
+        var method = value;
+        value = (function(m) {
           return function() { return ancestor[m].apply(this, arguments) };
-        })(property).wrap(method), {
-          valueOf:  function() { return method },
-          toString: function() { return method.toString() }
-        });
+        })(property).wrap(method);
+
+        value.valueOf = method.valueOf.bind(method);
+        value.toString = method.toString.bind(method);
       }
       this.prototype[property] = value;
     }
@@ -167,7 +171,7 @@
   },
 
   isElement: function(object) {
-    return object && object.nodeType == 1;
+    return !!(object && object.nodeType == 1);
   },
 
   isArray: function(object) {
@@ -198,7 +202,8 @@
 
 Object.extend(Function.prototype, {
   argumentNames: function() {
-    var names = this.toString().match(/^[\s\(]*function[^(]*\((.*?)\)/)[1].split(",").invoke("strip");
+    var names = this.toString().match(/^[\s\(]*function[^(]*\(([^\)]*)\)/)[1]
+      .replace(/\s+/g, '').split(',');
     return names.length == 1 && !names[0] ? [] : names;
   },
 
@@ -232,6 +237,11 @@
     }, timeout);
   },
 
+  defer: function() {
+    var args = [0.01].concat($A(arguments));
+    return this.delay.apply(this, args);
+  },
+
   wrap: function(wrapper) {
     var __method = this;
     return function() {
@@ -248,8 +258,6 @@
   }
 });
 
-Function.prototype.defer = Function.prototype.delay.curry(0.01);
-
 Date.prototype.toJSON = function() {
   return '"' + this.getUTCFullYear() + '-' +
     (this.getUTCMonth() + 1).toPaddedString(2) + '-' +
@@ -530,7 +538,7 @@
     return this.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
   },
   unescapeHTML: function() {
-    return this.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>');
+    return this.stripTags().replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>');
   }
 });
 
@@ -547,7 +555,7 @@
   text: document.createTextNode('')
 });
 
-with (String.prototype.escapeHTML) div.appendChild(text);
+String.prototype.escapeHTML.div.appendChild(String.prototype.escapeHTML.text);
 
 var Template = Class.create({
   initialize: function(template, pattern) {
@@ -589,10 +597,9 @@
 var Enumerable = {
   each: function(iterator, context) {
     var index = 0;
-    iterator = iterator.bind(context);
     try {
       this._each(function(value) {
-        iterator(value, index++);
+        iterator.call(context, value, index++);
       });
     } catch (e) {
       if (e != $break) throw e;
@@ -601,47 +608,46 @@
   },
 
   eachSlice: function(number, iterator, context) {
-    iterator = iterator ? iterator.bind(context) : Prototype.K;
     var index = -number, slices = [], array = this.toArray();
+    if (number < 1) return array;
     while ((index += number) < array.length)
       slices.push(array.slice(index, index+number));
     return slices.collect(iterator, context);
   },
 
   all: function(iterator, context) {
-    iterator = iterator ? iterator.bind(context) : Prototype.K;
+    iterator = iterator || Prototype.K;
     var result = true;
     this.each(function(value, index) {
-      result = result && !!iterator(value, index);
+      result = result && !!iterator.call(context, value, index);
       if (!result) throw $break;
     });
     return result;
   },
 
   any: function(iterator, context) {
-    iterator = iterator ? iterator.bind(context) : Prototype.K;
+    iterator = iterator || Prototype.K;
     var result = false;
     this.each(function(value, index) {
-      if (result = !!iterator(value, index))
+      if (result = !!iterator.call(context, value, index))
         throw $break;
     });
     return result;
   },
 
   collect: function(iterator, context) {
-    iterator = iterator ? iterator.bind(context) : Prototype.K;
+    iterator = iterator || Prototype.K;
     var results = [];
     this.each(function(value, index) {
-      results.push(iterator(value, index));
+      results.push(iterator.call(context, value, index));
     });
     return results;
   },
 
   detect: function(iterator, context) {
-    iterator = iterator.bind(context);
     var result;
     this.each(function(value, index) {
-      if (iterator(value, index)) {
+      if (iterator.call(context, value, index)) {
         result = value;
         throw $break;
       }
@@ -650,17 +656,16 @@
   },
 
   findAll: function(iterator, context) {
-    iterator = iterator.bind(context);
     var results = [];
     this.each(function(value, index) {
-      if (iterator(value, index))
+      if (iterator.call(context, value, index))
         results.push(value);
     });
     return results;
   },
 
   grep: function(filter, iterator, context) {
-    iterator = iterator ? iterator.bind(context) : Prototype.K;
+    iterator = iterator || Prototype.K;
     var results = [];
 
     if (Object.isString(filter))
@@ -668,7 +673,7 @@
 
     this.each(function(value, index) {
       if (filter.match(value))
-        results.push(iterator(value, index));
+        results.push(iterator.call(context, value, index));
     });
     return results;
   },
@@ -696,9 +701,8 @@
   },
 
   inject: function(memo, iterator, context) {
-    iterator = iterator.bind(context);
     this.each(function(value, index) {
-      memo = iterator(memo, value, index);
+      memo = iterator.call(context, memo, value, index);
     });
     return memo;
   },
@@ -711,10 +715,10 @@
   },
 
   max: function(iterator, context) {
-    iterator = iterator ? iterator.bind(context) : Prototype.K;
+    iterator = iterator || Prototype.K;
     var result;
     this.each(function(value, index) {
-      value = iterator(value, index);
+      value = iterator.call(context, value, index);
       if (result == null || value >= result)
         result = value;
     });
@@ -722,10 +726,10 @@
   },
 
   min: function(iterator, context) {
-    iterator = iterator ? iterator.bind(context) : Prototype.K;
+    iterator = iterator || Prototype.K;
     var result;
     this.each(function(value, index) {
-      value = iterator(value, index);
+      value = iterator.call(context, value, index);
       if (result == null || value < result)
         result = value;
     });
@@ -733,10 +737,10 @@
   },
 
   partition: function(iterator, context) {
-    iterator = iterator ? iterator.bind(context) : Prototype.K;
+    iterator = iterator || Prototype.K;
     var trues = [], falses = [];
     this.each(function(value, index) {
-      (iterator(value, index) ?
+      (iterator.call(context, value, index) ?
         trues : falses).push(value);
     });
     return [trues, falses];
@@ -751,19 +755,20 @@
   },
 
   reject: function(iterator, context) {
-    iterator = iterator.bind(context);
     var results = [];
     this.each(function(value, index) {
-      if (!iterator(value, index))
+      if (!iterator.call(context, value, index))
         results.push(value);
     });
     return results;
   },
 
   sortBy: function(iterator, context) {
-    iterator = iterator.bind(context);
     return this.map(function(value, index) {
-      return {value: value, criteria: iterator(value, index)};
+      return {
+        value: value,
+        criteria: iterator.call(context, value, index)
+      };
     }).sort(function(left, right) {
       var a = left.criteria, b = right.criteria;
       return a < b ? -1 : a > b ? 1 : 0;
@@ -815,8 +820,12 @@
 if (Prototype.Browser.WebKit) {
   $A = function(iterable) {
     if (!iterable) return [];
-    if (!(Object.isFunction(iterable) && iterable == '[object NodeList]') &&
-        iterable.toArray) return iterable.toArray();
+    // In Safari, only use the `toArray` method if it's not a NodeList.
+    // A NodeList is a function, has an function `item` property, and a numeric
+    // `length` property. Adapted from Google Doctype.
+    if (!(typeof iterable === 'function' && typeof iterable.length ===
+        'number' && typeof iterable.item === 'function') && iterable.toArray)
+      return iterable.toArray();
     var length = iterable.length || 0, results = new Array(length);
     while (length--) results[length] = iterable[length];
     return results;
@@ -963,8 +972,8 @@
     return this + 1;
   },
 
-  times: function(iterator) {
-    $R(0, this, true).each(iterator);
+  times: function(iterator, context) {
+    $R(0, this, true).each(iterator, context);
     return this;
   },
 
@@ -1011,6 +1020,8 @@
     },
 
     get: function(key) {
+      // simulating poorly supported hasOwnProperty
+      if (this._object[key] !== Object.prototype[key])
       return this._object[key];
     },
 
@@ -1051,14 +1062,14 @@
     },
 
     toQueryString: function() {
-      return this.map(function(pair) {
+      return this.inject([], function(results, pair) {
         var key = encodeURIComponent(pair.key), values = pair.value;
 
         if (values && typeof values == 'object') {
           if (Object.isArray(values))
-            return values.map(toQueryPair.curry(key)).join('&');
-        }
-        return toQueryPair(key, values);
+            return results.concat(values.map(toQueryPair.curry(key)));
+        } else results.push(toQueryPair(key, values));
+        return results;
       }).join('&');
     },
 
@@ -1198,6 +1209,8 @@
 
     this.parameters = params;
 
+
+
     if (params = Object.toQueryString(params)) {
       // when GET, append parameters to URL
       if (this.method == 'get')
@@ -1558,6 +1571,7 @@
     return Element.writeAttribute(cache[tagName].cloneNode(false), attributes);
   };
   Object.extend(this.Element, element || { });
+  if (element) this.Element.prototype = element.prototype;
 }).call(window);
 
 Element.cache = { };
@@ -1574,12 +1588,14 @@
   },
 
   hide: function(element) {
-    $(element).style.display = 'none';
+    element = $(element);
+    element.style.display = 'none';
     return element;
   },
 
   show: function(element) {
-    $(element).style.display = '';
+    element = $(element);
+    element.style.display = '';
     return element;
   },
 
@@ -1733,7 +1749,7 @@
     element = $(element);
     if (arguments.length == 1) return element.firstDescendant();
     return Object.isNumber(expression) ? element.descendants()[expression] :
-      element.select(expression)[index || 0];
+      Element.select(element, expression)[index || 0];
   },
 
   previous: function(element, expression, index) {
@@ -1863,24 +1879,16 @@
 
   descendantOf: function(element, ancestor) {
     element = $(element), ancestor = $(ancestor);
-    var originalAncestor = ancestor;
 
     if (element.compareDocumentPosition)
       return (element.compareDocumentPosition(ancestor) & 8) === 8;
 
-    if (element.sourceIndex && !Prototype.Browser.Opera) {
-      var e = element.sourceIndex, a = ancestor.sourceIndex,
-       nextAncestor = ancestor.nextSibling;
-      if (!nextAncestor) {
-        do { ancestor = ancestor.parentNode; }
-        while (!(nextAncestor = ancestor.nextSibling) && ancestor.parentNode);
-      }
-      if (nextAncestor && nextAncestor.sourceIndex)
-       return (e > a && e < nextAncestor.sourceIndex);
-    }
+    if (ancestor.contains)
+      return ancestor.contains(element) && ancestor !== element;
 
     while (element = element.parentNode)
-      if (element == originalAncestor) return true;
+      if (element == ancestor) return true;
+
     return false;
   },
 
@@ -1895,7 +1903,7 @@
     element = $(element);
     style = style == 'float' ? 'cssFloat' : style.camelize();
     var value = element.style[style];
-    if (!value) {
+    if (!value || value == 'auto') {
       var css = document.defaultView.getComputedStyle(element, null);
       value = css ? css[style] : null;
     }
@@ -1934,7 +1942,7 @@
 
   getDimensions: function(element) {
     element = $(element);
-    var display = $(element).getStyle('display');
+    var display = element.getStyle('display');
     if (display != 'none' && display != null) // Safari bug
       return {width: element.offsetWidth, height: element.offsetHeight};
 
@@ -1963,7 +1971,7 @@
       element.style.position = 'relative';
       // Opera returns the offset relative to the positioning context, when an
       // element is position relative but top and left have not been defined
-      if (window.opera) {
+      if (Prototype.Browser.Opera) {
         element.style.top = 0;
         element.style.left = 0;
       }
@@ -2018,7 +2026,7 @@
       valueL += element.offsetLeft || 0;
       element = element.offsetParent;
       if (element) {
-        if (element.tagName == 'BODY') break;
+        if (element.tagName.toUpperCase() == 'BODY') break;
         var p = Element.getStyle(element, 'position');
         if (p !== 'static') break;
       }
@@ -2028,7 +2036,7 @@
 
   absolutize: function(element) {
     element = $(element);
-    if (element.getStyle('position') == 'absolute') return;
+    if (element.getStyle('position') == 'absolute') return element;
     // Position.prepare(); // To be done manually by Scripty when it needs it.
 
     var offsets = element.positionedOffset();
@@ -2052,7 +2060,7 @@
 
   relativize: function(element) {
     element = $(element);
-    if (element.getStyle('position') == 'relative') return;
+    if (element.getStyle('position') == 'relative') return element;
     // Position.prepare(); // To be done manually by Scripty when it needs it.
 
     element.style.position = 'relative';
@@ -2103,7 +2111,7 @@
 
     element = forElement;
     do {
-      if (!Prototype.Browser.Opera || element.tagName == 'BODY') {
+      if (!Prototype.Browser.Opera || (element.tagName && (element.tagName.toUpperCase() == 'BODY'))) {
         valueT -= element.scrollTop  || 0;
         valueL -= element.scrollLeft || 0;
       }
@@ -2218,6 +2226,9 @@
   Element.Methods.getOffsetParent = Element.Methods.getOffsetParent.wrap(
     function(proceed, element) {
       element = $(element);
+      // IE throws an error if element is not in document
+      try { element.offsetParent }
+      catch(e) { return $(document.body) }
       var position = element.getStyle('position');
       if (position !== 'static') return proceed(element);
       element.setStyle({ position: 'relative' });
@@ -2231,6 +2242,8 @@
     Element.Methods[method] = Element.Methods[method].wrap(
       function(proceed, element) {
         element = $(element);
+        try { element.offsetParent }
+        catch(e) { return Element._returnOffset(0,0) }
         var position = element.getStyle('position');
         if (position !== 'static') return proceed(element);
         // Trigger hasLayout on the offset parent so that IE6 reports
@@ -2246,6 +2259,14 @@
     );
   });
 
+  Element.Methods.cumulativeOffset = Element.Methods.cumulativeOffset.wrap(
+    function(proceed, element) {
+      try { element.offsetParent }
+      catch(e) { return Element._returnOffset(0,0) }
+      return proceed(element);
+    }
+  );
+
   Element.Methods.getStyle = function(element, style) {
     element = $(element);
     style = (style == 'float' || style == 'cssFloat') ? 'styleFloat' : style.camelize();
@@ -2337,7 +2358,7 @@
   Element._attributeTranslations.has = {};
 
   $w('colSpan rowSpan vAlign dateTime accessKey tabIndex ' +
-      'encType maxLength readOnly longDesc').each(function(attr) {
+      'encType maxLength readOnly longDesc frameBorder').each(function(attr) {
     Element._attributeTranslations.write.names[attr.toLowerCase()] = attr;
     Element._attributeTranslations.has[attr.toLowerCase()] = attr;
   });
@@ -2390,7 +2411,7 @@
       (value < 0.00001) ? 0 : value;
 
     if (value == 1)
-      if(element.tagName == 'IMG' && element.width) {
+      if(element.tagName.toUpperCase() == 'IMG' && element.width) {
         element.width++; element.width--;
       } else try {
         var n = document.createTextNode(' ');
@@ -2521,7 +2542,7 @@
   hasAttribute: function(element, attribute) {
     attribute = Element._attributeTranslations.has[attribute] || attribute;
     var node = $(element).getAttributeNode(attribute);
-    return node && node.specified;
+    return !!(node && node.specified);
   }
 };
 
@@ -2530,9 +2551,9 @@
 Object.extend(Element, Element.Methods);
 
 if (!Prototype.BrowserFeatures.ElementExtensions &&
-    document.createElement('div').__proto__) {
+    document.createElement('div')['__proto__']) {
   window.HTMLElement = { };
-  window.HTMLElement.prototype = document.createElement('div').__proto__;
+  window.HTMLElement.prototype = document.createElement('div')['__proto__'];
   Prototype.BrowserFeatures.ElementExtensions = true;
 }
 
@@ -2547,7 +2568,7 @@
         element.nodeType != 1 || element == window) return element;
 
     var methods = Object.clone(Methods),
-      tagName = element.tagName, property, value;
+      tagName = element.tagName.toUpperCase(), property, value;
 
     // extend methods for specific tags
     if (ByTag[tagName]) Object.extend(methods, ByTag[tagName]);
@@ -2643,7 +2664,7 @@
     if (window[klass]) return window[klass];
 
     window[klass] = { };
-    window[klass].prototype = document.createElement(tagName).__proto__;
+    window[klass].prototype = document.createElement(tagName)['__proto__'];
     return window[klass];
   }
 
@@ -2669,12 +2690,18 @@
 
 document.viewport = {
   getDimensions: function() {
-    var dimensions = { };
-    var B = Prototype.Browser;
+    var dimensions = { }, B = Prototype.Browser;
     $w('width height').each(function(d) {
       var D = d.capitalize();
-      dimensions[d] = (B.WebKit && !document.evaluate) ? self['inner' + D] :
-        (B.Opera) ? document.body['client' + D] : document.documentElement['client' + D];
+      if (B.WebKit && !document.evaluate) {
+        // Safari <3.0 needs self.innerWidth/Height
+        dimensions[d] = self['inner' + D];
+      } else if (B.Opera && parseFloat(window.opera.version()) < 9.5) {
+        // Opera <9.5 needs document.body.clientWidth/Height
+        dimensions[d] = document.body['client' + D]
+      } else {
+        dimensions[d] = document.documentElement['client' + D];
+      }
     });
     return dimensions;
   },
@@ -2693,14 +2720,24 @@
       window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop);
   }
 };
-/* Portions of the Selector class are derived from Jack SlocumÃ¢â¬â¢s DomQuery,
+/* Portions of the Selector class are derived from Jack Slocum's DomQuery,
  * part of YUI-Ext version 0.40, distributed under the terms of an MIT-style
  * license.  Please see http://www.yui-ext.com/ for more information. */
 
 var Selector = Class.create({
   initialize: function(expression) {
     this.expression = expression.strip();
+
+    if (this.shouldUseSelectorsAPI()) {
+      this.mode = 'selectorsAPI';
+    } else if (this.shouldUseXPath()) {
+      this.mode = 'xpath';
+      this.compileXPathMatcher();
+    } else {
+      this.mode = "normal";
     this.compileMatcher();
+    }
+
   },
 
   shouldUseXPath: function() {
@@ -2715,16 +2752,29 @@
 
     // XPath can't do namespaced attributes, nor can it read
     // the "checked" property from DOM nodes
-    if ((/(\[[\w-]*?:|:checked)/).test(this.expression))
+    if ((/(\[[\w-]*?:|:checked)/).test(e))
       return false;
 
     return true;
   },
 
-  compileMatcher: function() {
-    if (this.shouldUseXPath())
-      return this.compileXPathMatcher();
+  shouldUseSelectorsAPI: function() {
+    if (!Prototype.BrowserFeatures.SelectorsAPI) return false;
+
+    if (!Selector._div) Selector._div = new Element('div');
 
+    // Make sure the browser treats the selector as valid. Test on an
+    // isolated element to minimize cost of this check.
+    try {
+      Selector._div.querySelector(this.expression);
+    } catch(e) {
+      return false;
+    }
+
+    return true;
+  },
+
+  compileMatcher: function() {
     var e = this.expression, ps = Selector.patterns, h = Selector.handlers,
         c = Selector.criteria, le, p, m;
 
@@ -2781,8 +2831,27 @@
 
   findElements: function(root) {
     root = root || document;
-    if (this.xpath) return document._getElementsByXPath(this.xpath, root);
+    var e = this.expression, results;
+
+    switch (this.mode) {
+      case 'selectorsAPI':
+        // querySelectorAll queries document-wide, then filters to descendants
+        // of the context element. That's not what we want.
+        // Add an explicit context to the selector if necessary.
+        if (root !== document) {
+          var oldId = root.id, id = $(root).identify();
+          e = "#" + id + " " + e;
+        }
+
+        results = $A(root.querySelectorAll(e)).map(Element.extend);
+        root.id = oldId;
+
+        return results;
+      case 'xpath':
+        return document._getElementsByXPath(this.xpath, root);
+      default:
     return this.matcher(root);
+    }
   },
 
   match: function(element) {
@@ -2873,10 +2942,10 @@
       'first-child': '[not(preceding-sibling::*)]',
       'last-child':  '[not(following-sibling::*)]',
       'only-child':  '[not(preceding-sibling::* or following-sibling::*)]',
-      'empty':       "[count(*) = 0 and (count(text()) = 0 or translate(text(), ' \t\r\n', '') = '')]",
+      'empty':       "[count(*) = 0 and (count(text()) = 0)]",
       'checked':     "[@checked]",
-      'disabled':    "[@disabled]",
-      'enabled':     "[not(@disabled)]",
+      'disabled':    "[(@disabled) and (@type!='hidden')]",
+      'enabled':     "[not(@disabled) and (@type!='hidden')]",
       'not': function(m) {
         var e = m[6], p = Selector.patterns,
             x = Selector.xpath, le, v;
@@ -2968,7 +3037,7 @@
     className:    /^\.([\w\-\*]+)(\b|$)/,
     pseudo:
 /^:((first|last|nth|nth-last|only)(-child|-of-type)|empty|checked|(en|dis)abled|not)(\((.*?)\))?(\b|$|(?=\s|[:+~>]))/,
-    attrPresence: /^\[([\w]+)\]/,
+    attrPresence: /^\[((?:[\w]+:)?[\w]+)\]/,
     attr:         /\[((?:[\w-]*:)?[\w-]+)\s*(?:([!^$*~|]?=)\s*((['"])([^\4]*?)\4|([^'"][^\]]*?)))?\]/
   },
 
@@ -3270,7 +3339,7 @@
     'empty': function(nodes, value, root) {
       for (var i = 0, results = [], node; node = nodes[i]; i++) {
         // IE treats comments as element nodes
-        if (node.tagName == '!' || (node.firstChild && !node.innerHTML.match(/^\s*$/))) continue;
+        if (node.tagName == '!' || node.firstChild) continue;
         results.push(node);
       }
       return results;
@@ -3288,7 +3357,8 @@
 
     'enabled': function(nodes, value, root) {
       for (var i = 0, results = [], node; node = nodes[i]; i++)
-        if (!node.disabled) results.push(node);
+        if (!node.disabled && (!node.type || node.type !== 'hidden'))
+          results.push(node);
       return results;
     },
 
@@ -3308,11 +3378,14 @@
   operators: {
     '=':  function(nv, v) { return nv == v; },
     '!=': function(nv, v) { return nv != v; },
-    '^=': function(nv, v) { return nv.startsWith(v); },
+    '^=': function(nv, v) { return nv == v || nv && nv.startsWith(v); },
+    '$=': function(nv, v) { return nv == v || nv && nv.endsWith(v); },
+    '*=': function(nv, v) { return nv == v || nv && nv.include(v); },
     '$=': function(nv, v) { return nv.endsWith(v); },
     '*=': function(nv, v) { return nv.include(v); },
     '~=': function(nv, v) { return (' ' + nv + ' ').include(' ' + v + ' '); },
-    '|=': function(nv, v) { return ('-' + nv.toUpperCase() + '-').include('-' + v.toUpperCase() + '-'); }
+    '|=': function(nv, v) { return ('-' + (nv || "").toUpperCase() +
+     '-').include('-' + (v || "").toUpperCase() + '-'); }
   },
 
   split: function(expression) {
@@ -3386,7 +3459,7 @@
     var data = elements.inject({ }, function(result, element) {
       if (!element.disabled && element.name) {
         key = element.name; value = $(element).getValue();
-        if (value != null && (element.type != 'submit' || (!submitted &&
+        if (value != null && element.type != 'file' && (element.type != 'submit' || (!submitted &&
             submit !== false && (!submit || key == submit) && (submitted = true)))) {
           if (key in result) {
             // a key is already present; construct an array of values
@@ -3403,7 +3476,6 @@
   }
 };
 
-
 Form.Methods = {
   serialize: function(form, options) {
     return Form.serializeElements(Form.getElements(form), options);
@@ -3548,7 +3620,6 @@
 
   disable: function(element) {
     element = $(element);
-    element.blur();
     element.disabled = true;
     return element;
   },
@@ -3588,22 +3659,22 @@
     else element.value = value;
   },
 
-  select: function(element, index) {
-    if (Object.isUndefined(index))
+  select: function(element, value) {
+    if (Object.isUndefined(value))
       return this[element.type == 'select-one' ?
         'selectOne' : 'selectMany'](element);
     else {
-      var opt, value, single = !Object.isArray(index);
+      var opt, currentValue, single = !Object.isArray(value);
       for (var i = 0, length = element.length; i < length; i++) {
         opt = element.options[i];
-        value = this.optionValue(opt);
+        currentValue = this.optionValue(opt);
         if (single) {
-          if (value == index) {
+          if (currentValue == value) {
             opt.selected = true;
             return;
           }
         }
-        else opt.selected = index.include(value);
+        else opt.selected = value.include(currentValue);
       }
     }
   },
@@ -3774,8 +3845,23 @@
     isRightClick:  function(event) { return isButton(event, 2) },
 
     element: function(event) {
-      var node = Event.extend(event).target;
-      return Element.extend(node.nodeType == Node.TEXT_NODE ? node.parentNode : node);
+      event = Event.extend(event);
+
+      var node          = event.target,
+          type          = event.type,
+          currentTarget = event.currentTarget;
+
+      if (currentTarget && currentTarget.tagName) {
+        // Firefox screws up the "click" event when moving between radio buttons
+        // via arrow keys. It also screws up the "load" and "error" events on images,
+        // reporting the document as the target instead of the original image.
+        if (type === 'load' || type === 'error' ||
+          (type === 'click' && currentTarget.tagName.toLowerCase() === 'input'
+            && currentTarget.type === 'radio'))
+              node = currentTarget;
+      }
+      if (node.nodeType == Node.TEXT_NODE) node = node.parentNode;
+      return Element.extend(node);
     },
 
     findElement: function(event, expression) {
@@ -3786,11 +3872,15 @@
     },
 
     pointer: function(event) {
+      var docElement = document.documentElement,
+      body = document.body || { scrollLeft: 0, scrollTop: 0 };
       return {
         x: event.pageX || (event.clientX +
-          (document.documentElement.scrollLeft || document.body.scrollLeft)),
+          (docElement.scrollLeft || body.scrollLeft) -
+          (docElement.clientLeft || 0)),
         y: event.pageY || (event.clientY +
-          (document.documentElement.scrollTop || document.body.scrollTop))
+          (docElement.scrollTop || body.scrollTop) -
+          (docElement.clientTop || 0))
       };
     },
 
@@ -3835,7 +3925,7 @@
     };
 
   } else {
-    Event.prototype = Event.prototype || document.createEvent("HTMLEvents").__proto__;
+    Event.prototype = Event.prototype || document.createEvent("HTMLEvents")['__proto__'];
     Object.extend(Event.prototype, methods);
     return Prototype.K;
   }
@@ -3900,10 +3990,20 @@
         cache[id][eventName] = null;
   }
 
+
+  // Internet Explorer needs to remove event handlers on page unload
+  // in order to avoid memory leaks.
   if (window.attachEvent) {
     window.attachEvent("onunload", destroyCache);
   }
 
+  // Safari has a dummy event handler on page unload so that it won't
+  // use its bfcache. Safari <= 3.1 has an issue with restoring the "document"
+  // object when page is returned to via the back button using its bfcache.
+  if (Prototype.Browser.WebKit) {
+    window.addEventListener('unload', Prototype.emptyFunction, false);
+  }
+
   return {
     observe: function(element, eventName, handler) {
       element = $(element);
diff -rub mybb_1400/jscripts/thread.js mybb_1408/jscripts/thread.js
--- mybb_1400/jscripts/thread.js	2008-05-17 03:26:01.000000000 +0200
+++ mybb_1408/jscripts/thread.js	2009-06-26 06:22:11.000000000 +0200
@@ -387,7 +387,7 @@
 			var post = document.createElement("div");
 			post.innerHTML = request.responseText;
 			$('posts').appendChild(post);
-			if(MyBB.browser == "ie" || MyBB.browser == "opera" || MyBB.browser == "safari")
+			if(MyBB.browser == "ie" || MyBB.browser == "opera" || MyBB.browser == "safari" || MyBB.browser == "chrome")
 			{
 				var scripts = request.responseText.extractScripts();
 				scripts.each(function(script)
diff -rub mybb_1400/jscripts/usercp.js mybb_1408/jscripts/usercp.js
--- mybb_1400/jscripts/usercp.js	2008-07-28 00:27:20.000000000 +0200
+++ mybb_1408/jscripts/usercp.js	2009-06-26 06:22:11.000000000 +0200
@@ -181,7 +181,7 @@
 			var list = 'buddy';
 		}
 
-		new Ajax.Updater(list+'_list', 'usercp.php?action=do_editlists&my_post_key='+my_post_key+'&manage='+type, {method: 'post', postBody: 'ajax=1&add_username='+$(type+'_add_username').value, evalScripts: true, onComplete: function() { $(type+'_submit').value = old_value; $(type+'_submit').disabled = false; $(type+'_add_username').disabled = false; $(type+'_add_username').value = ''; $(type+'_add_username').focus(); }});
+		new Ajax.Updater(list+'_list', 'usercp.php?action=do_editlists&my_post_key='+my_post_key+'&manage='+type, {method: 'post', postBody: 'ajax=1&add_username='+encodeURIComponent($(type+'_add_username').value), evalScripts: true, onComplete: function() { $(type+'_submit').value = old_value; $(type+'_submit').disabled = false; $(type+'_add_username').disabled = false; $(type+'_add_username').value = ''; $(type+'_add_username').focus(); }});
 		$(type+'_add_username').disabled = true;
 		$(type+'_submit').disabled = true;
 		return false;
diff -rub mybb_1400/jscripts/validator.js mybb_1408/jscripts/validator.js
--- mybb_1400/jscripts/validator.js	2008-07-04 23:24:03.000000000 +0200
+++ mybb_1408/jscripts/validator.js	2009-06-26 06:22:11.000000000 +0200
@@ -136,21 +136,22 @@
 					{
 						for(x = 0; x < options.extra_body.length; ++x)
 						{
-							extra += "&" + options.extra_body[x] + "=" + this.getValue(options.extra_body[x]);
+							extra += "&" + options.extra_body[x] + "=" + encodeURIComponent(this.getValue(options.extra_body[x]));
 						}
 					}
 					else if(typeof options.extra_body != "undefined")
 					{
-						extra = "&" + options.extra_body + "=" + this.getValue(options.extra_body);
+						extra = "&" + options.extra_body + "=" + encodeURIComponent(this.getValue(options.extra_body));
 					}
 
-					new Ajax.Request(options.url, {method:'post', postBody:"value=" + value + extra, onComplete: function(request) { this.ajaxValidateComplete(id, options, request); }.bind(this)});
+					new Ajax.Request(options.url, {method:'post', postBody:"value=" + encodeURIComponent(value) + extra, onComplete: function(request) { this.ajaxValidateComplete(id, options, request); }.bind(this)});
 
 					return "loading";
 					break;
 				}
 				type = "notempty";
 			case "notempty":
+				value = value.replace(/^\s+|\s+$/g,"");
 				if(value == null || value.length == 0)
 				{
 					return false;
diff -rub mybb_1400/managegroup.php mybb_1408/managegroup.php
--- mybb_1400/managegroup.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/managegroup.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: managegroup.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: managegroup.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'managegroup.php');
 
 require_once "./global.php";
 
diff -rub mybb_1400/member.php mybb_1408/member.php
--- mybb_1400/member.php	2008-07-09 00:34:00.000000000 +0200
+++ mybb_1408/member.php	2009-06-26 07:26:31.000000000 +0200
@@ -6,14 +6,15 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: member.php 4001 2008-07-08 22:34:00Z Tikitiki $
+ * $Id: member.php 4359 2009-04-23 18:50:06Z dennis $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'member.php');
 
 $nosession['avatar'] = 1;
 $templatelist = "member_register,error_nousername,error_nopassword,error_passwordmismatch,error_invalidemail,error_usernametaken,error_emailmismatch,error_noemail,redirect_registered";
-$templatelist .= ",redirect_loggedout,login,redirect_loggedin,error_invalidusername,error_invalidpassword,member_profile_email,member_profile_offline,member_profile_reputation,member_profile_warn,member_profile_warninglevel,member_profile_customfields_field,member_profile_customfields,member_profile_adminoptions,member_profile,member_login,member_profile_online,member_profile_modoptions";
+$templatelist .= ",redirect_loggedout,login,redirect_loggedin,error_invalidusername,error_invalidpassword,member_profile_email,member_profile_offline,member_profile_reputation,member_profile_warn,member_profile_warninglevel,member_profile_customfields_field,member_profile_customfields,member_profile_adminoptions,member_profile,member_login,member_profile_online,member_profile_modoptions,member_profile_signature,member_profile_groupimage";
 require_once "./global.php";
 
 require_once MYBB_ROOT."inc/functions_post.php";
@@ -372,7 +373,7 @@
 	if((!isset($mybb->input['agree']) && !isset($mybb->input['regsubmit'])) || $mybb->request_method != "post")
 	{
 		// Is this user a COPPA user? We need to show the COPPA agreement too
-		if($mybb->setings['coppa'] != "disabled" && ($mybb->cookies['coppauser'] == 1 || $under_thirteen))
+		if($mybb->settings['coppa'] != "disabled" && ($mybb->cookies['coppauser'] == 1 || $under_thirteen))
 		{
 			if($mybb->settings['coppa'] == "deny")
 			{
@@ -609,7 +610,12 @@
 			else
 			{
 				$value = htmlspecialchars_uni($userfield);
-				$code = "<input type=\"text\" name=\"profile_fields[$field]\" id=\"{$field}\" class=\"textbox\" size=\"{$profilefield['length']}\" maxlength=\"{$profilefield['maxlength']}\" value=\"$value\" />";
+				$maxlength = "";
+				if($profilefield['maxlength'] > 0)
+				{
+					$maxlength = " maxlength=\"{$profilefield['maxlength']}\"";
+				}
+				$code = "<input type=\"text\" name=\"profile_fields[$field]\" id=\"{$field}\" class=\"textbox\" size=\"{$profilefield['length']}\"{$maxlength} value=\"$value\" />";
 			}
 			if($profilefield['required'] == 1)
 			{
@@ -945,35 +951,8 @@
 	}
 }
 
-if($mybb->input['action'] == "login")
-{
-	$plugins->run_hooks("member_login");
-	
-	$member_loggedin_notice = "";
-	if($mybb->user['uid'] != 0)
-	{
-		$lang->already_logged_in = $lang->sprintf($lang->already_logged_in, build_profile_link($mybb->user['username'], $mybb->user['uid']));
-		eval("\$member_loggedin_notice = \"".$templates->get("member_loggedin_notice")."\";");
-	}
-
-	// Checks to make sure the user can login; they haven't had too many tries at logging in.
-	// Is a fatal call if user has had too many tries
-	login_attempt_check();
-
-	// Redirect to the page where the user came from, but not if that was the login page.
-	if($mybb->input['url'] && !preg_match("/action=login/i", $mybb->input['url']))
-	{
-		$redirect_url = htmlentities($mybb->input['url']);
-	}
-	elseif($_SERVER['HTTP_REFERER'])
-	{
-		$redirect_url = htmlentities($_SERVER['HTTP_REFERER']);
-	}
-
-	eval("\$login = \"".$templates->get("member_login")."\";");
-	output_page($login);
-}
-
+$do_captcha = $correct = false;
+$inline_errors = "";
 if($mybb->input['action'] == "do_login" && $mybb->request_method == "post")
 {
 	$plugins->run_hooks("member_do_login_start");
@@ -983,28 +962,89 @@
 	$logins = login_attempt_check();
 	$login_text = '';
 
+	// Did we come from the quick login form
+	if($mybb->input['quick_login'] == "1" && $mybb->input['quick_password'] && $mybb->input['quick_username'])
+	{
+		$mybb->input['password'] = $mybb->input['quick_password'];
+		$mybb->input['username'] = $mybb->input['quick_username'];
+	}
+
 	if(!username_exists($mybb->input['username']))
 	{
 		my_setcookie('loginattempts', $logins + 1);
-		$db->write_query("UPDATE ".TABLE_PREFIX."sessions SET loginattempts=loginattempts+1 WHERE sid = '{$session->sid}'");
-		if($mybb->settings['failedlogintext'] == 1)
-		{
-			$login_text = $lang->sprintf($lang->failed_login_again, $mybb->settings['failedlogincount'] - $logins);
-		}
 		error($lang->error_invalidpworusername.$login_text);
 	}
+	
+	$query = $db->simple_select("users", "loginattempts", "LOWER(username)='".$db->escape_string(my_strtolower($mybb->input['username']))."'", array('limit' => 1));
+	$loginattempts = $db->fetch_field($query, "loginattempts");
+	
+	$errors = array();
+	
 	$user = validate_password_from_username($mybb->input['username'], $mybb->input['password']);
 	if(!$user['uid'])
 	{
 		my_setcookie('loginattempts', $logins + 1);
-		$db->write_query("UPDATE ".TABLE_PREFIX."sessions SET loginattempts=loginattempts+1 WHERE sid = '{$session->sid}'");
+		$db->write_query("UPDATE ".TABLE_PREFIX."users SET loginattempts=loginattempts+1 WHERE LOWER(username) = '".$db->escape_string(my_strtolower($mybb->input['username']))."'");
+		
+		$mybb->input['action'] = "login";
+		$mybb->input['request_method'] = "get";
+		
 		if($mybb->settings['failedlogintext'] == 1)
 		{
 			$login_text = $lang->sprintf($lang->failed_login_again, $mybb->settings['failedlogincount'] - $logins);
 		}
-		error($lang->error_invalidpassword.$login_text);
+		
+		$errors[] = $lang->error_invalidpworusername.$login_text;
+	}
+	else
+	{
+		$correct = true;
 	}
 
+	if($loginattempts > 3 || intval($mybb->cookies['loginattempts']) > 3)
+	{		
+		// Show captcha image for guests if enabled
+		if($mybb->settings['captchaimage'] == 1 && function_exists("imagepng") && !$mybb->user['uid'])
+		{
+			// If previewing a post - check their current captcha input - if correct, hide the captcha input area
+			if($mybb->input['imagestring'])
+			{
+				$imagehash = $db->escape_string($mybb->input['imagehash']);
+				$imagestring = $db->escape_string($mybb->input['imagestring']);
+				$query = $db->simple_select("captcha", "*", "imagehash='{$imagehash}' AND imagestring='{$imagestring}'");
+				$imgcheck = $db->fetch_array($query);
+				if($imgcheck['dateline'] > 0)
+				{		
+					$correct = true;
+				}
+				else
+				{
+					$db->delete_query("captcha", "imagehash='{$imagehash}'");
+					$errors[] = $lang->error_regimageinvalid;
+				}
+			}
+			else if($mybb->input['quick_login'] == 1 && $mybb->input['quick_password'] && $mybb->input['quick_username'])
+			{
+				$errors[] = $lang->error_regimagerequired;
+			}
+			else
+			{
+				$errors[] = $lang->error_regimagerequired;
+			}
+		}
+		
+		$do_captcha = true;
+	}
+	
+	if(!empty($errors))
+	{
+		$mybb->input['action'] = "login";
+		$mybb->input['request_method'] = "get";
+		
+		$inline_errors = inline_error($errors);
+	}
+	else if($correct)
+	{		
 	if($user['coppauser'])
 	{
 		error($lang->error_awaitingcoppa);
@@ -1014,10 +1054,11 @@
 	$db->delete_query("sessions", "ip='".$db->escape_string($session->ipaddress)."' AND sid != '".$session->sid."'");
 	$newsession = array(
 		"uid" => $user['uid'],
-		"loginattempts" => 1,
 	);
 	$db->update_query("sessions", $newsession, "sid='".$session->sid."'");
 
+		$db->update_query("users", array("loginattempts" => 1), "uid='{$user['uid']}'");
+		
 	// Temporarily set the cookie remember option for the login cookies
 	$mybb->user['remember'] = $user['remember'];
 
@@ -1042,6 +1083,70 @@
 	{
 		redirect("index.php", $lang->redirect_loggedin);
 	}
+	}
+	else
+	{
+		$mybb->input['action'] = "login";
+		$mybb->input['request_method'] = "get";
+	}
+	
+	$plugins->run_hooks("member_do_login_end");
+}
+
+if($mybb->input['action'] == "login")
+{
+	$plugins->run_hooks("member_login");
+	
+	$member_loggedin_notice = "";
+	if($mybb->user['uid'] != 0)
+	{
+		$lang->already_logged_in = $lang->sprintf($lang->already_logged_in, build_profile_link($mybb->user['username'], $mybb->user['uid']));
+		eval("\$member_loggedin_notice = \"".$templates->get("member_loggedin_notice")."\";");
+	}
+
+	// Checks to make sure the user can login; they haven't had too many tries at logging in.
+	// Is a fatal call if user has had too many tries
+	login_attempt_check();
+
+	// Redirect to the page where the user came from, but not if that was the login page.
+	if($mybb->input['url'] && !preg_match("/action=login/i", $mybb->input['url']))
+	{
+		$redirect_url = htmlentities($mybb->input['url']);
+	}
+	elseif($_SERVER['HTTP_REFERER'])
+	{
+		$redirect_url = htmlentities($_SERVER['HTTP_REFERER']);
+	}
+	
+	$captcha = "";
+	// Show captcha image for guests if enabled
+	if($mybb->settings['captchaimage'] == 1 && function_exists("imagepng") && $do_captcha == true)
+	{	
+		$randomstr = random_str(5);
+		$imagehash = md5(random_str(12));
+		$imagearray = array(
+			"imagehash" => $imagehash,
+			"imagestring" => $randomstr,
+			"dateline" => TIME_NOW
+		);
+		$db->insert_query("captcha", $imagearray);
+		eval("\$captcha = \"".$templates->get("post_captcha")."\";");
+	}
+	
+	$username = "";
+	$password = "";
+	if($mybb->input['username'] && $mybb->request_method == "post")
+	{
+		$username = htmlspecialchars_uni($mybb->input['username']);
+	}
+	
+	if($mybb->input['password'] && $mybb->request_method == "post")
+	{
+		$password = htmlspecialchars_uni($mybb->input['password']);
+	}
+
+	eval("\$login = \"".$templates->get("member_login")."\";");
+	output_page($login);
 }
 
 if($mybb->input['action'] == "logout")
@@ -1233,14 +1338,14 @@
 		$ppd = $memprofile['postnum'];
 	}
 	$stats = $cache->read("stats");
-	$posts = $stats['numposts'];
-	if($posts == 0)
+	$numposts = $stats['numposts'];
+	if($numposts == 0)
 	{
 		$percent = "0";
 	}
 	else
 	{
-		$percent = $memprofile['postnum']*100/$posts;
+		$percent = $memprofile['postnum']*100/$numposts;
 		$percent = round($percent, 2);
 	}
 	
@@ -1333,7 +1438,7 @@
 				
 				if($membday[2] >= 1970)
 				{
-					$w_day = get_weekday($membday[1], $membday[0], $membday[2]);
+					$w_day = date("l", mktime(0, 0, 0, $membday[1], $membday[0], $membday[2]));
 					$membday = format_bdays($mybb->settings['dateformat'], $membday[1], $membday[0], $membday[2], $w_day);
 				}
 				else
@@ -1375,6 +1480,8 @@
 	$displaygroup = usergroup_displaygroup($memprofile['displaygroup']);
 
 	// Get the user title for this user
+	unset($usertitle);
+	unset($stars);
 	if(trim($memprofile['usertitle']) != '')
 	{
 		// User has custom user title
@@ -1403,8 +1510,23 @@
 	
 	if($displaygroup['stars'])
 	{
+		// Set the number of stars if display group has constant number of stars
 		$stars = $displaygroup['stars'];
 	}
+	elseif(!$stars)
+	{
+		// This is for cases where the user has a title, but the group has no defined number of stars (use number of stars as per default usergroups)
+		$query = $db->simple_select("usertitles", "*", "", array('order_by' => 'posts', 'order_dir' => 'DESC'));
+		while($title = $db->fetch_array($query))
+		{
+			if($memprofile['postnum'] >= $title['posts'])
+			{
+				$stars = $title['stars'];
+				$starimage = $title['starimage'];
+				break;
+			}
+		}
+	}
 
 	if(!empty($displaygroup['image']))
 	{
@@ -1434,15 +1556,15 @@
 	
 	// User is currently online and this user has permissions to view the user on the WOL
 	$timesearch = TIME_NOW - $mybb->settings['wolcutoffmins']*60;
-	$query = $db->simple_select("sessions", "location", "uid='$uid' AND time>'{$timesearch}'", array('order_by' => 'time', 'order_dir' => 'DESC', 'limit' => 1));
-	$location = $db->fetch_field($query, 'location');
+	$query = $db->simple_select("sessions", "location,nopermission", "uid='$uid' AND time>'{$timesearch}'", array('order_by' => 'time', 'order_dir' => 'DESC', 'limit' => 1));
+	$session = $db->fetch_array($query);
 	
-	if(($memprofile['invisible'] != 1 || $mybb->usergroup['canviewwolinvis'] == 1 || $memprofile['uid'] == $mybb->user['uid']) && $location)
+	if(($memprofile['invisible'] != 1 || $mybb->usergroup['canviewwolinvis'] == 1 || $memprofile['uid'] == $mybb->user['uid']) && !empty($session))
 	{
 		// Fetch their current location
 		$lang->load("online");
 		require_once MYBB_ROOT."inc/functions_online.php";
-		$activity = fetch_wol_activity($location);
+		$activity = fetch_wol_activity($session['location'], $session['nopermission']);
 		$location = build_friendly_wol_location($activity);
 		$location_time = my_date($mybb->settings['timeformat'], $memprofile['lastactive']);
 
@@ -1585,9 +1707,9 @@
 	// Check group limits
 	if($mybb->usergroup['maxemails'] > 0)
 	{
-		$query = $db->simple_select("maillogs", "COUNT(*) AS sent_count", "fromuid='{$mybb->user['uid']}'");
-		$sent_count = $db->fetch_field($query, "maillogs");
-		if($sent_count > $mybb->usergroup['maxemails'])
+		$query = $db->simple_select("maillogs", "COUNT(*) AS sent_count", "fromuid='{$mybb->user['uid']}' AND dateline >= '".(TIME_NOW - (60*60*24))."'");
+		$sent_count = $db->fetch_field($query, "sent_count");
+		if($sent_count >= $mybb->usergroup['maxemails'])
 		{
 			$lang->error_max_emails_day = $lang->sprintf($lang->error_max_emails_day, $mybb->usergroup['maxemails']);
 			error($lang->error_max_emails_day);
@@ -1619,10 +1741,17 @@
 
 	if(count($errors) == 0)
 	{
+		if($mybb->settings['mail_handler'] == 'smtp')
+		{
+			$from = $mybb->user['email'];
+		}
+		else
+		{
 		$from = "{$mybb->user['username']} <{$mybb->user['email']}>";
+		}
 		
 		$message = $lang->sprintf($lang->email_emailuser, $to_user['username'], $mybb->user['username'], $mybb->settings['bbname'], $mybb->settings['bburl'], $mybb->input['message']);
-		my_mail($to_user['email'], $mybb->input['subject'], $message, $from);
+		my_mail($to_user['email'], $mybb->input['subject'], $message, $from, "", "", false, "text", "", $mybb->user['email']);
 		
 		if($mybb->settings['mail_logging'] > 0)
 		{
@@ -1664,8 +1793,8 @@
 	// Check group limits
 	if($mybb->usergroup['maxemails'] > 0)
 	{
-		$query = $db->simple_select("maillogs", "COUNT(*) AS sent_count", "fromuid='{$mybb->user['uid']}'");
-		$sent_count = $db->fetch_field($query, "maillogs");
+		$query = $db->simple_select("maillogs", "COUNT(*) AS sent_count", "fromuid='{$mybb->user['uid']}' AND dateline >= '".(TIME_NOW - (60*60*24))."'");
+		$sent_count = $db->fetch_field($query, "sent_count");
 		if($sent_count > $mybb->usergroup['maxemails'])
 		{
 			$lang->error_max_emails_day = $lang->sprintf($lang->error_max_emails_day, $mybb->usergroup['maxemails']);
diff -rub mybb_1400/memberlist.php mybb_1408/memberlist.php
--- mybb_1400/memberlist.php	2008-05-26 05:53:48.000000000 +0200
+++ mybb_1408/memberlist.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: memberlist.php 3864 2008-05-26 03:53:48Z ZiNgaBuRgA $
+ * $Id: memberlist.php 4314 2009-01-31 00:43:26Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'memberlist.php');
 
 $templatelist = "memberlist,memberlist_member,memberlist_search,memberlist_user,memberlist_user_groupimage,memberlist_user_avatar";
 $templatelist .= ",postbit_www,postbit_email,multipage_nextpage,multipage_page_current,multipage_page,multipage_start,multipage_end,multipage";
@@ -298,7 +299,7 @@
 			
 			if($avatar_dimensions[0] && $avatar_dimensions[1])
 			{
-				list($max_width, $max_height) = explode("x", $mybb->settings['memberlistmaxavatarsize']);
+				list($max_width, $max_height) = explode("x", my_strtolower($mybb->settings['memberlistmaxavatarsize']));
 			 	if($avatar_dimensions[0] > $max_width || $avatar_dimensions[1] > $max_height)
 				{
 					require_once MYBB_ROOT."inc/functions_image.php";
@@ -319,7 +320,7 @@
 		}		
 		
 		$user['regdate'] = my_date($mybb->settings['dateformat'], $user['regdate']).", ".my_date($mybb->settings['timeformat'], $user['regdate']);
-		$user['lastvisit'] = my_date($mybb->settings['dateformat'], $user['lastactive']).", ".my_date($mybb->settings['timeformat'], $user['lastactive']);;
+		$user['lastvisit'] = my_date($mybb->settings['dateformat'], $user['lastactive']).", ".my_date($mybb->settings['timeformat'], $user['lastactive']);
 		$user['postnum'] = my_number_format($user['postnum']);
 		$alt_bg = alt_trow();
 		eval("\$users .= \"".$templates->get("memberlist_user")."\";");
diff -rub mybb_1400/misc.php mybb_1408/misc.php
--- mybb_1400/misc.php	2008-06-10 06:41:52.000000000 +0200
+++ mybb_1408/misc.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: misc.php 3901 2008-06-10 04:41:52Z Tikitiki $
+ * $Id: misc.php 4276 2008-11-23 03:01:33Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'misc.php');
 
 $templatelist = "redirect_markallread,redirect_markforumread";
 $templatelist .= ",misc_buddypopup,misc_buddypopup_user_online,misc_buddypopup_user_offline,misc_buddypopup_user_sendpm";
@@ -184,6 +185,11 @@
 				if($lang->$langdocvar)
 				{
 					$helpdoc['document'] = $lang->$langdocvar;
+					
+					if($langdocvar == "d3_document")
+					{
+						$helpdoc['document'] = $lang->sprintf($helpdoc['document'], $mybb->user['logoutkey']);
+					}
 				}
 			}
 			add_breadcrumb($helpdoc['name']);
@@ -454,7 +460,7 @@
 	$smilies = '';
 	if($mybb->input['popup'])
 	{ // make small popup list of smilies
-		$editor = htmlspecialchars($mybb->input['editor']);
+		$editor = addslashes(htmlentities($mybb->input['editor']));
 		$e = 1;
 		$class = "trow1";
 		$smilies = "<tr>";
@@ -650,11 +656,15 @@
 	output_page($syndication);
 }
 
-
 if($mybb->input['action'] == "clearcookies")
 {
 	$plugins->run_hooks("misc_clearcookies");
 
+	if($mybb->input['key'] != $mybb->user['logoutkey'])
+	{
+		error($lang->error_invalidkey);
+	}
+
 	$remove_cookies = array('mybb', 'mybbuser', 'mybb[password]', 'mybb[lastvisit]', 'mybb[lastactive]', 'collapsed', 'mybb[forumread]', 'mybb[threadsread]', 'mybbadmin');
 
 	if($mybb->settings['cookiedomain'])
diff -rub mybb_1400/modcp.php mybb_1408/modcp.php
--- mybb_1400/modcp.php	2008-07-25 10:50:26.000000000 +0200
+++ mybb_1408/modcp.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: modcp.php 4038 2008-07-25 08:50:26Z dennis $
+ * $Id: modcp.php 4308 2009-01-14 03:58:30Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'modcp.php');
 
 $templatelist = "modcp_reports,modcp_reports_report,modcp_reports_multipage,modcp_reports_allreport";
 $templatelist .= ",modcp_reports_allnoreports,modcp_reports_noreports,modcp_banning,modcp_banning_ban";
@@ -19,7 +20,7 @@
 $templatelist .= ",codebuttons,smilieinsert,modcp_announcements_new,modcp_modqueue_empty,forumjump_bit,forumjump_special";
 $templatelist .= ",modcp_modlogs,modcp_finduser_user,modcp_finduser,usercp_profile_customfield,usercp_profile_profilefields";
 $templatelist .= ",modcp_editprofile,modcp_ipsearch,modcp_banuser_addusername,modcp_banuser,modcp_warninglogs_nologs";
-$templatelist .= ",modcp_warninglogs";
+$templatelist .= ",modcp_warninglogs,modcp_modlogs_result";
 
 require_once "./global.php";
 require_once MYBB_ROOT."inc/functions_user.php";
@@ -49,6 +50,12 @@
 	while($forum = $db->fetch_array($query))
 	{
 		$flist .= ",'{$forum['fid']}'";
+		
+		$children = get_child_list($forum['fid']);
+		if(!empty($children))
+		{
+			$flist .= ",'".implode("','", $children)."'";
+		}
 		$moderated_forums[] = $forum['fid'];
 	}
 	if($flist)
@@ -80,7 +87,7 @@
 		error($lang->error_noselected_reports);
 	}
 
-	array_walk($mybb->input['reports'], "intval");
+	$mybb->input['reports'] = array_map("intval", $mybb->input['reports']);
 	$rids = implode($mybb->input['reports'], "','");
 	$rids = "'0','{$rids}'";
 
@@ -125,10 +132,12 @@
 			$page = intval($result / $perpage) + 1;
 		}
 	}
-	$postcount = intval($report_count)+1;
+	$postcount = intval($report_count);
 	$pages = $postcount / $perpage;
 	$pages = ceil($pages);
 
+
+
 	if($mybb->input['page'] == "last")
 	{
 		$page = $pages;
@@ -234,7 +243,7 @@
 			$page = intval($result / $perpage) + 1;
 		}
 	}
-	$postcount = intval($warnings)+1;
+	$postcount = intval($warnings);
 	$pages = $postcount / $perpage;
 	$pages = ceil($pages);
 
@@ -332,7 +341,7 @@
 	add_breadcrumb($lang->mcp_nav_modlogs, "modcp.php?action=modlogs");
 
 	$perpage = intval($mybb->input['perpage']);
-	if(!$perpage)
+	if(!$perpage || $perpage <= 0)
 	{
 		$perpage = $mybb->settings['threadsperpage'];
 	}
@@ -411,7 +420,7 @@
 		$page = 1;
 	}
 
-	$multipage = multipage($postcount, $perpage, $page, "modcp.php?action=modlogs&amp;perpage=$perpage&amp;uid={$mybb->input['uid']}&amp;fid={$mybb->input['fid']}&amp;orderby=$mybb->input['sortby']&amp;order={$mybb->input['order']}");
+	$multipage = multipage($postcount, $perpage, $page, "modcp.php?action=modlogs&amp;perpage=$perpage&amp;uid={$mybb->input['uid']}&amp;fid={$mybb->input['fid']}&amp;sortby={$mybb->input['sortby']}&amp;order={$mybb->input['order']}");
 	if($postcount > $perpage)
 	{
 		eval("\$resultspages = \"".$templates->get("modcp_modlogs_multipage")."\";");
@@ -481,7 +490,7 @@
 		$user_options .= "<option value=\"{$user['uid']}\"{$selected}>".htmlspecialchars_uni($user['username'])."</option>\n";
 	}
 
-	$forum_select = build_forum_jump("", $mybb->input['fid'], 1, '', 0, '', "fid");
+	$forum_select = build_forum_jump("", $mybb->input['fid'], 1, '', 0, true, '', "fid");
 
 	eval("\$modlogs = \"".$templates->get("modcp_modlogs")."\";");
 	output_page($modlogs);
@@ -599,7 +608,7 @@
 		{
 			$mybb->input['endtime_month'] = 1;
 		}
-		$enddate = gmmktime($enddatehour, intval($mybb->input['endtime_time']), 0, (int)$mybb->input['endtime_month'], intval($mybb->input['endtime_day']), intval($mybb->input['endtime_year']));
+		$enddate = gmmktime(intval($enddate[0]), intval($enddate[1]), 0, (int)$mybb->input['endtime_month'], intval($mybb->input['endtime_day']), intval($mybb->input['endtime_year']));
 		if($enddate < 0 || $enddate == false)
 		{
 			$errors[] = $lang->error_invalid_end_date;
@@ -651,20 +660,35 @@
 		$errors = inline_error($errors);
 
 		// Set $announcement to input stuff
-		$title = $mybb->input['title'];
-		$message = $mybb->input['message'];
-		$startmonth = intval($mybb->input['starttime_month']);
+		$announcement['subject'] = $mybb->input['title'];
+		$announcement['message'] = $mybb->input['message'];
+		$announcement['allowhtml'] = $mybb->input['allowhtml'];
+		$announcement['allowmycode'] = $mybb->input['allowmycode'];
+		$announcement['allowsmilies'] = $mybb->input['allowsmilies'];
+		
+		$months = array('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12');			
+		if(!in_array($mybb->input['starttime_month'], $months))
+		{
+			$mybb->input['starttime_month'] = 1;
+		}
+		
+		if(!in_array($mybb->input['endtime_month'], $months))
+		{
+			$mybb->input['endtime_month'] = 1;
+		}
+		
+		$startmonth = $mybb->input['starttime_month'];
 		$startdateyear = htmlspecialchars_uni($mybb->input['starttime_year']);
 		$startday = intval($mybb->input['starttime_day']);
 		$starttime_time = htmlspecialchars($mybb->input['starttime_time']);
-		$endmonth = intval($mybb->input['endtime_month']);
+		$endmonth = $mybb->input['endtime_month'];
 		$enddateyear = htmlspecialchars_uni($mybb->input['endtime_year']);
 		$endday = intval($mybb->input['endtime_day']);
 		$endtime_time = htmlspecialchars($mybb->input['endtime_time']);
 	}
 	else
 	{
-		// Note: dates are not in user's timezone
+		// Note: dates are in GMT timezone
 		$starttime_time = gmdate("g:i a", TIME_NOW);
 		$endtime_time = gmdate("g:i a", TIME_NOW);
 		$startday = $endday = gmdate("j", TIME_NOW);
@@ -810,6 +834,29 @@
 		$errors[] = $lang->error_missing_forum;
 	}
 
+	$startdate = @explode(" ", $mybb->input['starttime_time']);
+	$startdate = @explode(":", $startdate[0]);
+	$enddate = @explode(" ", $mybb->input['endtime_time']);
+	$enddate = @explode(":", $enddate[0]);
+
+	if(stristr($mybb->input['starttime_time'], "pm"))
+	{
+		$startdate[0] = 12+$startdate[0];
+		if($startdate[0] >= 24)
+		{
+			$startdate[0] = "00";
+		}
+	}
+
+	if(stristr($mybb->input['endtime_time'], "pm"))
+	{
+		$enddate[0] = 12+$enddate[0];
+		if($enddate[0] >= 24)
+		{
+			$enddate[0] = "00";
+		}
+	}
+
 	$months = array('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12');			
 	if(!in_array($mybb->input['starttime_month'], $months))
 	{
@@ -832,7 +879,7 @@
 		{
 			$mybb->input['endtime_month'] = 1;
 		}
-		$enddate = gmmktime($enddatehour, intval($mybb->input['endtime_time']), 0, (int)$mybb->input['endtime_month'], intval($mybb->input['endtime_day']), intval($mybb->input['endtime_year']));
+		$enddate = gmmktime(intval($enddate[0]), intval($enddate[1]), 0, (int)$mybb->input['endtime_month'], intval($mybb->input['endtime_day']), intval($mybb->input['endtime_year']));
 		if($enddate < 0 || $enddate == false)
 		{
 			$errors[] = $lang->error_invalid_end_date;
@@ -898,11 +945,23 @@
 		$announcement['allowhtml'] = $mybb->input['allowhtml'];
 		$announcement['allowmycode'] = $mybb->input['allowmycode'];
 		$announcement['allowsmilies'] = $mybb->input['allowsmilies'];
-		$startmonth = intval($mybb->input['starttime_month']);
+		
+		$months = array('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12');			
+		if(!in_array($mybb->input['starttime_month'], $months))
+		{
+			$mybb->input['starttime_month'] = 1;
+		}
+		
+		if(!in_array($mybb->input['endtime_month'], $months))
+		{
+			$mybb->input['endtime_month'] = 1;
+		}
+		
+		$startmonth = $mybb->input['starttime_month'];
 		$startdateyear = htmlspecialchars_uni($mybb->input['starttime_year']);
 		$startday = intval($mybb->input['starttime_day']);
 		$starttime_time = htmlspecialchars($mybb->input['starttime_time']);
-		$endmonth = intval($mybb->input['endtime_month']);
+		$endmonth = $mybb->input['endtime_month'];
 		$enddateyear = htmlspecialchars_uni($mybb->input['endtime_year']);
 		$endday = intval($mybb->input['endtime_day']);
 		$endtime_time = htmlspecialchars($mybb->input['endtime_time']);
@@ -911,18 +970,18 @@
 	}
 	else
 	{
-		// Note: dates are in user's timezone
-		$starttime_time = my_date('g:i a', $announcement['startdate']);
-		$endtime_time = my_date('g:i a', $announcement['enddate']);
+		// Note: dates are in GMT timezone
+		$starttime_time = gmdate('g:i a', $announcement['startdate']);
+		$endtime_time = gmdate('g:i a', $announcement['enddate']);
 
-		$startday = my_date('j', $announcement['startdate']);
-		$endday = my_date('j', $announcement['enddate']);
+		$startday = gmdate('j', $announcement['startdate']);
+		$endday = gmdate('j', $announcement['enddate']);
 
-		$startmonth = my_date('m', $announcement['startdate']);
-		$endmonth = my_date('m', $announcement['enddate']);
+		$startmonth = gmdate('m', $announcement['startdate']);
+		$endmonth = gmdate('m', $announcement['enddate']);
 
-		$startdateyear = my_date('Y', $announcement['startdate']);
-		$enddateyear = my_date('Y', $announcement['enddate']);
+		$startdateyear = gmdate('Y', $announcement['startdate']);
+		$enddateyear = gmdate('Y', $announcement['enddate']);
 
 		$errored = false;
 	}
@@ -1142,7 +1201,13 @@
 	}
 	else if(is_array($mybb->input['attachments']))
 	{
-		$query = $db->simple_select("attachments", "aid, pid", "aid IN (".implode(",", array_map("intval", array_keys($mybb->input['attachments'])))."){$flist}");
+		$query = $db->query("
+			SELECT a.pid, a.aid
+			FROM  ".TABLE_PREFIX."attachments a
+			LEFT JOIN ".TABLE_PREFIX."posts p ON (a.pid=p.pid)
+			LEFT JOIN ".TABLE_PREFIX."threads t ON (t.tid=p.tid)
+			WHERE aid IN (".implode(",", array_map("intval", array_keys($mybb->input['attachments'])))."){$tflist}
+		");
 		while($attachment = $db->fetch_array($query))
 		{
 			$action = $mybb->input['attachments'][$attachment['aid']];
@@ -1198,7 +1263,7 @@
 			$page = 1;
 		}
 
-		$multipage = multipage($postcount, $perpage, $page, "modcp.php?action=modqueue&amp;type=threads");
+		$multipage = multipage($pages, $perpage, $page, "modcp.php?action=modqueue&amp;type=threads");
 
 		$query = $db->query("
 			SELECT t.tid, t.dateline, t.fid, t.subject, p.message AS postmessage, u.username AS username, t.uid
@@ -1281,7 +1346,7 @@
 			$page = 1;
 		}
 
-		$multipage = multipage($postcount, $perpage, $page, "modcp.php?action=modqueue&amp;type=posts");
+		$multipage = multipage($pages, $perpage, $page, "modcp.php?action=modqueue&amp;type=posts");
 
 		$query = $db->query("
 			SELECT p.pid, p.subject, p.message, t.subject AS threadsubject, t.tid, u.username, p.uid, t.fid, p.dateline
@@ -1341,7 +1406,7 @@
 		}
 
 		$perpage = $mybb->settings['postsperpage'];
-		$pages = $unapprovedthreads / $perpage;
+		$pages = $unapproved_attachments / $perpage;
 		$pages = ceil($pages);
 
 		if($mybb->input['page'] == "last")
@@ -1364,7 +1429,7 @@
 			$page = 1;
 		}
 
-		$multipage = multipage($postcount, $perpage, $page, "modcp.php?action=modqueue&amp;type=attachments");
+		$multipage = multipage($pages, $perpage, $page, "modcp.php?action=modqueue&amp;type=attachments");
 
 		$query = $db->query("
 			SELECT a.*, p.subject AS postsubject, p.dateline, p.uid, u.username, t.tid, t.subject AS threadsubject
@@ -1438,12 +1503,12 @@
 	$user_permissions = user_permissions($user['uid']);
 
 	// Current user is only a local moderator, cannot edit super mods or admins
-	if($mybb->user['usergroup'] == 6 && ($user_permissions['issupermod'] == 1 || $user_permissions['canadmincp'] == 1))
+	if($mybb->user['usergroup'] == 6 && ($user_permissions['issupermod'] == 1 || $user_permissions['cancp'] == 1))
 	{
 		error_no_permission();
 	}
 	// Current user is a super mod or is an administrator and the user we are editing is a super admin, cannot edit admins
-	else if($mybb->usergroup['issupermod'] == 1 && $user_permissions['canadmincp'] == 1 || (is_super_admin($user['uid']) && !is_super_admin($user['uid'])))
+	else if(!modcp_can_manage_user($user['uid']))
 	{
 		error_no_permission();
 	}
@@ -1527,12 +1592,12 @@
 	$user_permissions = user_permissions($user['uid']);
 
 	// Current user is only a local moderator, cannot edit super mods or admins
-	if($mybb->user['usergroup'] == 6 && ($user_permissions['issupermod'] == 1 || $user_permissions['canadmincp'] == 1))
+	if($mybb->user['usergroup'] == 6 && ($user_permissions['issupermod'] == 1 || $user_permissions['cancp'] == 1))
 	{
 		error_no_permission();
 	}
 	// Current user is a super mod or is an administrator and the user we are editing is a super admin, cannot edit admins
-	else if($mybb->usergroup['issupermod'] == 1 && $user_permissions['canadmincp'] == 1 || (is_super_admin($user['uid']) && !is_super_admin($user['uid'])))
+	else if(!modcp_can_manage_user($user['uid']))
 	{
 		error_no_permission();
 	}
@@ -1740,7 +1805,12 @@
 		else
 		{
 			$value = htmlspecialchars_uni($userfield);
-			$code = "<input type=\"text\" name=\"profile_fields[$field]\" class=\"textbox\" size=\"{$profilefield['length']}\" maxlength=\"{$profilefield['maxlength']}\" value=\"$value\" />";
+			$maxlength = "";
+			if($profilefield['maxlength'] > 0)
+			{
+				$maxlength = " maxlength=\"{$profilefield['maxlength']}\"";
+			}
+			$code = "<input type=\"text\" name=\"profile_fields[$field]\" class=\"textbox\" size=\"{$profilefield['length']}\"{$maxlength} value=\"$value\" />";
 		}
 		if($profilefield['required'] == 1)
 		{
@@ -1774,7 +1844,8 @@
 
 if($mybb->input['action'] == "finduser")
 {
-	if(!$perpage)
+	$perpage = intval($mybb->input['perpage']);
+	if(!$perpage || $perpage <= 0)
 	{
 		$perpage = $mybb->settings['threadsperpage'];
 	}
@@ -1843,6 +1914,7 @@
 		if($mybb->input[$field])
 		{
 			$page_url .= "&amp;{$field}=".htmlspecialchars_uni($mybb->input[$field]);
+			$mybb->input[$field] = htmlspecialchars_uni($mybb->input[$field]);
 		}
 	}
 
@@ -1859,8 +1931,8 @@
 		$user['postnum'] = my_number_format($user['postnum']);
 		$regdate = my_date($mybb->settings['dateformat'], $user['regdate']);
 		$regtime = my_date($mybb->settings['timeformat'], $user['regdate']);
-		$lastdate = my_date($mybb->settings['dateformat'], $user['lastactive']);
-		$lasttime = my_date($mybb->settings['timeformat'], $user['lastactive']);
+		$lastdate = my_date($mybb->settings['dateformat'], $user['lastvisit']);
+		$lasttime = my_date($mybb->settings['timeformat'], $user['lastvisit']);
 		$usergroup = $usergroups_cache[$user['usergroup']]['title'];
 		eval("\$users .= \"".$templates->get("modcp_finduser_user")."\";");
 	}
@@ -1886,6 +1958,7 @@
 		$search['username'] = $db->escape_string($mybb->input['filter']['username']);
 		$query = $db->simple_select("users", "uid", "username='{$search['username']}'");
 		$mybb->input['filter']['uid'] = $db->fetch_field($query, "uid");
+		$mybb->input['filter']['username'] = htmlspecialchars_uni($mybb->input['filter']['username']);
 	}
 	if($mybb->input['filter']['uid'])
 	{
@@ -1894,7 +1967,7 @@
 		if(!isset($mybb->input['search']['username']))
 		{
 			$user = get_user($mybb->input['search']['uid']);
-			$mybb->input['search']['username'] = $user['username'];
+			$mybb->input['search']['username'] = htmlspecialchars_uni($user['username']);
 		}
 	}
 	if($mybb->input['filter']['mod_username'])
@@ -1902,6 +1975,7 @@
 		$search['mod_username'] = $db->escape_string($mybb->input['filter']['mod_username']);
 		$query = $db->simple_select("users", "uid", "username='{$search['mod_username']}'");
 		$mybb->input['filter']['mod_uid'] = $db->fetch_field($query, "uid");
+		$mybb->input['filter']['mod_username'] = htmlspecialchars_uni($mybb->input['filter']['mod_username']);
 	}
 	if($mybb->input['filter']['mod_uid'])
 	{
@@ -1910,13 +1984,14 @@
 		if(!isset($mybb->input['search']['mod_username']))
 		{
 			$mod_user = get_user($mybb->input['search']['uid']);
-			$mybb->input['search']['mod_username'] = $mod_user['username'];
+			$mybb->input['search']['mod_username'] = htmlspecialchars_uni($mod_user['username']);
 		}
 	}
 	if($mybb->input['filter']['reason'])
 	{
 		$search['reason'] = $db->escape_string($mybb->input['filter']['reason']);
 		$where_sql .= " AND (w.notes LIKE '%{$search['reason']}%' OR t.title LIKE '%{$search['reason']}%' OR w.title LIKE '%{$search['reason']}%')";
+		$mybb->input['filter']['reason'] = htmlspecialchars_uni($mybb->input['filter']['reason']);
 	}
 	$sortbysel = array();
 	switch($mybb->input['filter']['sortby'])
@@ -2121,7 +2196,7 @@
 
 		// Now we have the result counts, paginate
 		$perpage = intval($mybb->input['perpage']);
-		if(!$perpage)
+		if(!$perpage || $perpage <= 0)
 		{
 			$perpage = $mybb->settings['threadsperpage'];
 		}
@@ -2155,7 +2230,7 @@
 			$page = 1;
 		}
 
-		$page_url = "modcp.php?action=ipsearch&amp;perpage={$perpage}&amp;ipaddress={$mybb->input['ipaddress']}";
+		$page_url = "modcp.php?action=ipsearch&amp;perpage={$perpage}";
 		foreach(array('ipaddress', 'search_users', 'search_posts') as $input)
 		{
 			if(!$mybb->input[$input]) continue;
@@ -2206,21 +2281,46 @@
 		if($total_results > $user_results && $post_limit)
 		{
 			$post_start = $start-$user_results;
-			if($post_start < 0) $post_start = 0;
+			if($post_start < 0)
+			{
+				$post_start = 0;
+			}
 		}
 		if($mybb->input['search_posts'] && (!$mybb->input['search_users'] || ($mybb->input['search_users'] && $post_limit > 0)))
 		{
+			$ipaddresses = $tids = $uids = array();
 			$query = $db->query("
-				SELECT p.username AS postusername, p.uid, u.username, p.subject, p.pid, p.tid, p.ipaddress, t.subject AS threadsubject
-				FROM ".TABLE_PREFIX."posts p
-				LEFT JOIN ".TABLE_PREFIX."threads t ON (t.tid=p.tid)
-				LEFT JOIN ".TABLE_PREFIX."users u ON(p.uid=u.uid)
+				SELECT username AS postusername, uid, subject, pid, tid, ipaddress
+				FROM ".TABLE_PREFIX."posts
 				WHERE {$post_ip_sql}
-				ORDER BY p.dateline DESC
+				ORDER BY dateline DESC
 				LIMIT {$post_start}, {$post_limit}
 			");
 			while($ipaddress = $db->fetch_array($query))
 			{
+				$tids[$ipaddress['tid']] = $ipaddress['pid'];
+				$uids[$ipaddress['uid']] = $ipaddress['pid'];
+				$ipaddresses[$ipaddress['pid']] = $ipaddress;
+			}
+			
+			if(!empty($ipaddresses))
+			{
+				$query = $db->simple_select("threads", "subject, tid", "tid IN(".implode(',', array_keys($tids)).")");
+				while($thread = $db->fetch_array($query))
+				{
+					$ipaddresses[$tids[$thread['tid']]]['threadsubject'] = $thread['subject'];
+				}
+				unset($tids);
+				
+				$query = $db->simple_select("users", "username, uid", "uid IN(".implode(',', array_keys($uids)).")");
+				while($user = $db->fetch_array($query))
+				{
+					$ipaddresses[$uids[$user['uid']]]['username'] = $user['username'];
+				}
+				unset($uids);
+				
+				foreach($ipaddresses as $ipaddress)
+				{
 				$ip = $ipaddress['ipaddress'];
 				if(!$ipaddress['username']) $ipaddress['username'] = $ipaddress['postusername']; // Guest username support
 				$trow = alt_trow();
@@ -2228,10 +2328,11 @@
 				{
 					$ipaddress['subject'] = "RE: {$ipaddress['threadsubject']}";
 				}
-				$subject = "<strong>{$lang->ipresult_post}</strong> <a href=\"".get_post_link($ipaddress['pid'], $ipaddress['tid'])."\">".htmlspecialchars_uni($ipaddress['subject'])."</a> by ".build_profile_link($ipaddress['username'], $ipaddress['uid']);
+					$subject = "<strong>{$lang->ipresult_post}</strong> <a href=\"".get_post_link($ipaddress['pid'], $ipaddress['tid'])."\">".htmlspecialchars_uni($ipaddress['subject'])."</a> {$lang->by} ".build_profile_link($ipaddress['username'], $ipaddress['uid']);
 				eval("\$results .= \"".$templates->get("modcp_ipsearch_result")."\";");
 			}
 		}
+		}
 
 		if(!$results)
 		{
@@ -2288,7 +2389,7 @@
 	$query = $db->simple_select("banned", "COUNT(uid) AS count");
 	$banned_count = $db->fetch_field($query, "count");
 
-	$postcount = intval($banned_count)+1;
+	$postcount = intval($banned_count);
 	$pages = $postcount / $perpage;
 	$pages = ceil($pages);
 
@@ -2335,7 +2436,7 @@
 
 		// Only show the edit & lift links if current user created ban, or is super mod/admin
 		$edit_link = '';
-		if($mybb->user['uid'] == $banned['admin'] || !$banned['adminuser'] || $mybb->usergroup['issupermod'] == 1 || $mybb->usergroup['canadmincp'] == 1)
+		if($mybb->user['uid'] == $banned['admin'] || !$banned['adminuser'] || $mybb->usergroup['issupermod'] == 1 || $mybb->usergroup['cancp'] == 1)
 		{
 			$edit_link = "<br /><span class=\"smalltext\"><a href=\"modcp.php?action=banuser&amp;uid={$banned['uid']}\">{$lang->edit_ban}</a> | <a href=\"modcp.php?action=liftban&amp;uid={$banned['uid']}&amp;my_post_key={$mybb->post_code}\">{$lang->lift_ban}</a></span>";
 		}
@@ -2407,11 +2508,11 @@
 
 	if(!$ban['uid'])
 	{
-		$lang->error_invalidban;
+		error($lang->error_invalidban);
 	}
 
 	// Permission to edit this ban?
-	if($mybb->user['uid'] != $ban['admin'] && $mybb->usergroup['issupermod'] != 1 && $mybb->usergroup['canadmincp'] != 1)
+	if($mybb->user['uid'] != $ban['admin'] && $mybb->usergroup['issupermod'] != 1 && $mybb->usergroup['cancp'] != 1)
 	{
 		error_no_permission();
 	}
@@ -2452,12 +2553,10 @@
 		}
 
 		// Permission to edit this ban?
-		if($mybb->user['uid'] != $user['admin'] && $mybb->usergroup['issupermod'] != 1 && $mybb->usergroup['canadmincp'] != 1)
+		if($mybb->user['uid'] != $user['admin'] && $mybb->usergroup['issupermod'] != 1 && $mybb->usergroup['cancp'] != 1)
 		{
 			error_no_permission();
 		}
-		
-		$lift_link = "<div class=\"float_right\"><a href=\"modcp.php?action=liftban&amp;bid={$user['uid']}&amp;my_post_key={$mybb->post_code}\">{$lang->lift_ban}</a></div>";
 	}
 	// Creating a new ban
 	else
@@ -2591,7 +2690,7 @@
 	if($mybb->input['uid'])
 	{
 		$query = $db->query("
-			SELECT b.*, u.username
+			SELECT b.*, u.username, u.uid
 			FROM ".TABLE_PREFIX."banned b
 			LEFT JOIN ".TABLE_PREFIX."users u ON (b.uid=u.uid)
 			WHERE b.uid='{$mybb->input['uid']}'
@@ -2602,12 +2701,14 @@
 			$username = htmlspecialchars_uni($banned['username']);
 			$banreason = htmlspecialchars_uni($banned['reason']);
 			$uid = $mybb->input['uid'];
+			$user = get_user($banned['uid']);
 			$lang->ban_user = $lang->edit_ban; // Swap over lang variables
 			eval("\$banuser_username = \"".$templates->get("modcp_banuser_editusername")."\";");
 		}
 	}
+	
 	// New ban!
-	if(!$banuer_username)
+	if(!$banuser_username)
 	{
 		if($mybb->input['uid'])
 		{
@@ -2664,12 +2765,17 @@
 		$bangroups .= "<option value=\"{$item['gid']}\"{$selected}>".htmlspecialchars_uni($item['title'])."</option>\n";
 	}
 
+	$lift_link = "<div class=\"float_right\"><a href=\"modcp.php?action=liftban&amp;uid={$user['uid']}&amp;my_post_key={$mybb->post_code}\">{$lang->lift_ban}</a></div>";
+
 	eval("\$banuser = \"".$templates->get("modcp_banuser")."\";");
 	output_page($banuser);
 }
 
 if($mybb->input['action'] == "do_modnotes")
 {
+	// Verify incoming POST request
+	verify_post_check($mybb->input['my_post_key']);
+	
 	// Update Moderator Notes cache
 	$update_cache = array(
 		"modmessage" => $mybb->input['modnotes']
@@ -2693,7 +2799,7 @@
 	if($unapproved_attachments > 0)
 	{
 		$query = $db->query("
-			SELECT t.tid, p.pid, t.uid, t.username, a.filename, a.dateuploaded
+			SELECT t.tid, p.pid, p.uid, t.username, a.filename, a.dateuploaded
 			FROM  ".TABLE_PREFIX."attachments a
 			LEFT JOIN ".TABLE_PREFIX."posts p ON (p.pid=a.pid)
 			LEFT JOIN ".TABLE_PREFIX."threads t ON (t.tid=p.tid)
@@ -2726,7 +2832,7 @@
 	if($unapproved_posts > 0)
 	{
 		$query = $db->query("
-			SELECT p.pid, p.tid, p.subject, p.uid, p.username
+			SELECT p.pid, p.tid, p.subject, p.uid, p.username, p.dateline
 			FROM  ".TABLE_PREFIX."posts p
 			LEFT JOIN ".TABLE_PREFIX."threads t ON (t.tid=p.tid)
 			WHERE p.visible='0' {$tflist} AND t.firstpost != p.pid
@@ -2741,7 +2847,7 @@
 		$post['subject'] = $post['fullsubject'] = $parser->parse_badwords($post['subject']);
 		if(my_strlen($post['subject']) > 25)
 		{
-			$lastpost_subject = my_substr($post['subject'], 0, 25)."...";
+			$post['subject'] = my_substr($post['subject'], 0, 25)."...";
 		}
 		$post['subject'] = htmlspecialchars_uni($post['subject']);
 		$post['fullsubject'] = htmlspecialchars_uni($post['fullsubject']);
@@ -2767,7 +2873,7 @@
 		$thread['subject'] = $thread['fullsubject'] = $parser->parse_badwords($thread['subject']);
 		if(my_strlen($thread['subject']) > 25)
 		{
-			$lastpost_subject = my_substr($thread['subject'], 0, 25)."...";
+			$post['subject'] = my_substr($thread['subject'], 0, 25)."...";
 		}
 		$thread['subject'] = htmlspecialchars_uni($thread['subject']);
 		$thread['fullsubject'] = htmlspecialchars_uni($thread['fullsubject']);
@@ -2835,7 +2941,7 @@
 
 		// Only show the edit & lift links if current user created ban, or is super mod/admin
 		$edit_link = '';
-		if($mybb->user['uid'] == $banned['admin'] || !$banned['adminuser'] || $mybb->usergroup['issupermod'] == 1 || $mybb->usergroup['canadmincp'] == 1)
+		if($mybb->user['uid'] == $banned['admin'] || !$banned['adminuser'] || $mybb->usergroup['issupermod'] == 1 || $mybb->usergroup['cancp'] == 1)
 		{
 			$edit_link = "<br /><span class=\"smalltext\"><a href=\"modcp.php?action=banuser&amp;uid={$banned['uid']}\">{$lang->edit_ban}</a> | <a href=\"modcp.php?action=liftban&amp;uid={$banned['uid']}&amp;my_post_key={$mybb->post_code}\">{$lang->lift_ban}</a></span>";
 		}
diff -rub mybb_1400/moderation.php mybb_1408/moderation.php
--- mybb_1400/moderation.php	2008-05-10 18:49:24.000000000 +0200
+++ mybb_1408/moderation.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: moderation.php 3826 2008-05-10 16:49:24Z Tikitiki $
+ * $Id: moderation.php 4308 2009-01-14 03:58:30Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'moderation.php');
 
 $templatelist = 'changeuserbox';
 
@@ -96,6 +97,11 @@
 	eval("\$loginbox = \"".$templates->get("loginbox")."\";");
 }
 
+if($mybb->request_method != "post" && $mybb->input['action'] != "getip")
+{
+	error_no_permission();
+}
+
 // Begin!
 switch($mybb->input['action'])
 {
@@ -193,8 +199,6 @@
 			}
 		}
 		
-		$thread['subject'] = htmlspecialchars_uni($thread['subject']);
-
 		$plugins->run_hooks("moderation_deletethread");
 
 		eval("\$deletethread = \"".$templates->get("moderation_deletethread")."\";");
@@ -508,7 +512,7 @@
 
 		$plugins->run_hooks("moderation_move");
 
-		$forumselect = build_forum_jump("", '', 1, '', 0, '', "moveto");
+		$forumselect = build_forum_jump("", '', 1, '', 0, true, '', "moveto");
 		eval("\$movethread = \"".$templates->get("moderation_move")."\";");
 		output_page($movethread);
 		break;
@@ -600,15 +604,15 @@
 			$info = '';
 			if($modaction['tsubject'])
 			{
-				$info .= "<strong>$lang->thread</strong> <a href=\"".get_thread_link($modaction['tid'])."\">".$modaction['tsubject']."</a><br />";
+				$info .= "<strong>$lang->thread</strong> <a href=\"".get_thread_link($modaction['tid'])."\">".htmlspecialchars_uni($modaction['tsubject'])."</a><br />";
 			}
 			if($modaction['fname'])
 			{
-				$info .= "<strong>$lang->forum</strong> <a href=\"".get_forum_link($modaction['fid'])."\">".$modaction['fname']."</a><br />";
+				$info .= "<strong>$lang->forum</strong> <a href=\"".get_forum_link($modaction['fid'])."\">".htmlspecialchars_uni($modaction['fname'])."</a><br />";
 			}
 			if($modaction['psubject'])
 			{
-				$info .= "<strong>$lang->post</strong> <a href=\"".get_post_link($modaction['pid'])."#pid".$modaction['pid']."\">".$modaction['psubject']."</a>";
+				$info .= "<strong>$lang->post</strong> <a href=\"".get_post_link($modaction['pid'])."#pid".$modaction['pid']."\">".htmlspecialchars_uni($modaction['psubject'])."</a>";
 			}
 
 			eval("\$modactions .= \"".$templates->get("moderation_threadnotes_modaction")."\";");
@@ -823,7 +827,7 @@
 			eval("\$posts .= \"".$templates->get("moderation_split_post")."\";");
 			$altbg = alt_trow();
 		}
-		$forumselect = build_forum_jump("", $fid, 1, '', 0, '', "moveto");
+		$forumselect = build_forum_jump("", $fid, 1, '', 0, true, '', "moveto");
 
 		$plugins->run_hooks("moderation_split");
 
@@ -1263,7 +1267,7 @@
 		{
 			clearinline($fid, 'forum');
 		}
-		$forumselect = build_forum_jump("", '', 1, '', 0, '', "moveto");
+		$forumselect = build_forum_jump("", '', 1, '', 0, true, '', "moveto");
 		$return_url = htmlspecialchars_uni($mybb->input['url']);
 		eval("\$movethread = \"".$templates->get("moderation_inline_movethreads")."\";");
 		output_page($movethread);
@@ -1353,6 +1357,19 @@
 		{
 			error_no_permission();
 		}
+		$postlist = array_map('intval', $postlist);
+		$pids = implode(',', $postlist);
+		
+		$tids = array();
+		if($pids)
+		{
+			$query = $db->simple_select("threads", "tid", "firstpost IN({$pids})");
+			while($tid = $db->fetch_field($query, "tid"))
+			{
+				$tids[] = $tid;
+			}
+		}
+		
 		$deletecount = 0;
 		foreach($postlist as $pid)
 		{
@@ -1361,6 +1378,20 @@
 			$plist[] = $pid;
 			$deletecount++;
 		}
+		
+		// If we have multiple threads, we must be coming from the search
+		if(!empty($tids))
+		{
+			foreach($tids as $tid)
+			{
+				$moderation->delete_thread($tid);
+				mark_reports($tid, "thread");
+				$url = get_forum_link($fid);
+			}
+		}
+		// Otherwise we're just deleting from showthread.php
+		else
+		{
 		$query = $db->simple_select("posts", "*", "tid='$tid'");
 		$numposts = $db->num_rows($query);
 		if(!$numposts)
@@ -1374,6 +1405,8 @@
 			mark_reports($plist, "posts");
 			$url = get_thread_link($thread['tid']);
 		}
+		}
+		
 		$lang->deleted_selective_posts = $lang->sprintf($lang->deleted_selective_posts, $deletecount);
 		log_moderator_action($modlogdata, $lang->deleted_selective_posts);
 		moderation_redirect($url, $lang->redirect_postsdeleted);
@@ -1463,15 +1496,16 @@
 		{
 			error_no_permission();
 		}
-		array_walk($posts, 'intval');
+		$posts = array_map('intval', $posts);
 		$pidin = implode(',', $posts);
 
 		// Make sure that we are not splitting a thread with one post
 		// Select number of posts in each thread that the splitted post is in
 		$query = $db->query("
 			SELECT DISTINCT p.tid, COUNT(q.pid) as count
-			FROM (".TABLE_PREFIX."posts p, ".TABLE_PREFIX."posts q)
-			WHERE p.tid=q.tid AND p.pid IN ($pidin)
+			FROM ".TABLE_PREFIX."posts p
+			LEFT JOIN ".TABLE_PREFIX."posts q ON (p.tid=q.tid)
+			WHERE p.pid IN ($pidin)
 			GROUP BY p.pid
 			");
 		$threads = $pcheck = array();
@@ -1516,7 +1550,7 @@
 		{
 			clearinline($tid, 'thread');
 		}
-		$forumselect = build_forum_jump("", $fid, 1, '', 0, '', "moveto");
+		$forumselect = build_forum_jump("", $fid, 1, '', 0, true, '', "moveto");
 		eval("\$splitposts = \"".$templates->get("moderation_inline_splitposts")."\";");
 		output_page($splitposts);
 		break;
@@ -1673,6 +1707,11 @@
 				{
 					error($lang->error_inline_nopostsselected);
 				}
+				if(!is_moderator_by_tids($tids))
+				{
+					error_no_permission();
+				}
+				
 				$custommod->execute(intval($mybb->input['action']), $tids);
  				$lang->custom_tool = $lang->sprintf($lang->custom_tool, $tool['name']);
 				log_moderator_action($modlogdata, $lang->custom_tool);
@@ -1680,7 +1719,8 @@
 				{
 					clearinline($mybb->input['searchid'], 'search');
 					$lang->redirect_customtool_search = $lang->sprintf($lang->redirect_customtool_search, $tool['name']);
-					redirect($mybb->input['url'], $lang->redirect_customtool_search);
+					$return_url = htmlspecialchars_uni($mybb->input['url']);
+					redirect($return_url, $lang->redirect_customtool_search);
 				}
 				else
 				{
@@ -1692,6 +1732,10 @@
 			}
 			elseif($tool['type'] == 't' && $mybb->input['modtype'] == 'thread')
 			{
+				if(!is_moderator_by_tids($tid))
+				{
+					error_no_permission();
+				}
 				$ret = $custommod->execute(intval($mybb->input['action']), $tid);
  				$lang->custom_tool = $lang->sprintf($lang->custom_tool, $tool['name']);
 				log_moderator_action($modlogdata, $lang->custom_tool);
@@ -1733,7 +1777,7 @@
 					'order_by' => 'dateline',
 					'order_dir' => 'asc'
 					);
-				$query = $db->simple_select("posts", "DISTINCT tid", "pid IN ($pids)", $options);
+				$query = $db->simple_select("posts", "DISTINCT tid", "pid IN (".implode(',',$pids).")", $options);
 				while($row = $db->fetch_array($query))
 				{
 					$tids[] = $row['tid'];
@@ -1746,7 +1790,8 @@
 				{
 					clearinline($mybb->input['searchid'], 'search');
 					$lang->redirect_customtool_search = $lang->sprintf($lang->redirect_customtool_search, $tool['name']);
-					redirect($mybb->input['url'], $lang->redirect_customtool_search);
+					$return_url = htmlspecialchars_uni($mybb->input['url']);
+					redirect($return_url, $lang->redirect_customtool_search);
 				}
 				else
 				{
@@ -1828,7 +1873,7 @@
 		$posts = array($posts);
 	}
 	// Validate input
-	array_walk($posts, 'intval');
+	$posts = array_map('intval', $posts);
 	$posts[] = 0;
 	// Get forums
 	$posts_string = implode(',', $posts);
@@ -1872,7 +1917,7 @@
 		$threads = array($threads);
 	}
 	// Validate input
-	array_walk($threads, 'intval');
+	$threads = array_map('intval', $threads);
 	$threads[] = 0;
 	// Get forums
 	$threads_string = implode(',', $threads);
@@ -1898,7 +1943,7 @@
 	global $mybb;
 	if(!empty($mybb->input['url']))
 	{
-		redirect($mybb->input['url'], $message, $title);
+		redirect(htmlentities($mybb->input['url']), $message, $title);
 	}
 	redirect($url, $message, $title);
 }
diff -rub mybb_1400/newreply.php mybb_1408/newreply.php
--- mybb_1400/newreply.php	2008-07-06 19:27:56.000000000 +0200
+++ mybb_1408/newreply.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: newreply.php 3992 2008-07-06 17:27:56Z Tikitiki $
+ * $Id: newreply.php 4322 2009-02-21 23:00:49Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'newreply.php');
 
 $templatelist = "newreply,previewpost,error_invalidforum,error_invalidthread,redirect_threadposted,loginbox,changeuserbox,posticons,newreply_threadreview,forumrules,attachments,newreply_threadreview_post";
 $templatelist .= ",smilieinsert,codebuttons,post_attachments_new,post_attachments,post_savedraftbutton,newreply_modoptions,newreply_threadreview_more,newreply_disablesmilies,postbit_online,postbit_find,postbit_pm,postbit_www,postbit_email,postbit_reputation,postbit_warninglevel,postbit_author_user,postbit_edit,postbit_quickdelete,postbit_inlinecheck,postbit_posturl,postbit_quote,postbit_multiquote,postbit_report,postbit_seperator,postbit,post_subscription_method";
@@ -131,11 +132,11 @@
 {
 	if(!$mybb->input['previewpost'] && $mybb->input['action'] != "do_newreply")
 	{
-		$username = $lang->guest;
+		$username = '';
 	}
 	elseif($mybb->input['previewpost'])
 	{
-		$username = $mybb->input['username'];
+		$username = htmlspecialchars_uni($mybb->input['username']);
 	}
 	eval("\$loginbox = \"".$templates->get("loginbox")."\";");
 }
@@ -168,17 +169,30 @@
 
 if(!$mybb->input['attachmentaid'] && ($mybb->input['newattachment'] || ($mybb->input['action'] == "do_newreply" && $mybb->input['submit'] && $_FILES['attachment'])))
 {
-	// If there's an attachment, check it and upload it.
-	if($_FILES['attachment']['size'] > 0 && $forumpermissions['canpostattachments'] != 0)
+	if($mybb->input['action'] == "editdraft" || ($mybb->input['tid'] && $mybb->input['pid']))
+	{
+		$attachwhere = "pid='{$pid}'";
+	}
+	else
+	{
+		$attachwhere = "posthash='".$db->escape_string($mybb->input['posthash'])."'";
+	}
+	$query = $db->simple_select("attachments", "COUNT(aid) as numattachs", $attachwhere);
+	$attachcount = $db->fetch_field($query, "numattachs");
+	
+	// If there's an attachment, check it and upload it
+	if($_FILES['attachment']['size'] > 0 && $forumpermissions['canpostattachments'] != 0 && ($mybb->settings['maxattachments'] == 0 ||  $attachcount < $mybb->settings['maxattachments']))
 	{
 		require_once MYBB_ROOT."inc/functions_upload.php";
 		$attachedfile = upload_attachment($_FILES['attachment']);
 	}
+	
 	if($attachedfile['error'])
 	{
 		eval("\$attacherror = \"".$templates->get("error_attacherror")."\";");
 		$mybb->input['action'] = "newreply";
 	}
+	
 	if(!$mybb->input['submit'])
 	{
 		$mybb->input['action'] = "newreply";
@@ -249,7 +263,7 @@
 			if(!$mybb->user['uid'])
 			{
 				my_setcookie('loginattempts', $logins + 1);
-				$db->write_query("UPDATE ".TABLE_PREFIX."sessions SET loginattempts=loginattempts+1 WHERE sid = '{$session->sid}'");
+				$db->write_query("UPDATE ".TABLE_PREFIX."users SET loginattempts=loginattempts+1 WHERE username = '".$db->escape_string($mybb->input['username'])."'");
 				if($mybb->settings['failedlogintext'] == 1)
 				{
 					$login_text = $lang->sprintf($lang->failed_login_again, $mybb->settings['failedlogincount'] - $logins);
@@ -265,10 +279,11 @@
 			// Update the session to contain their user ID
 			$updated_session = array(
 				"uid" => $mybb->user['uid'],
-				"loginattempts" => 0
 			);
 			$db->update_query("sessions", $updated_session, "sid='{$session->sid}'");
 
+			$db->update_query("users", array("loginattempts" => 1), "uid='{$mybb->user['uid']}'");
+
 			// Set uid and username
 			$uid = $mybb->user['uid'];
 			$username = $mybb->user['username'];
@@ -378,6 +393,11 @@
 		$post_errors = $posthandler->get_friendly_errors();
 	}
 
+	// Mark thread as read
+	require_once MYBB_ROOT."inc/functions_indicators.php";
+	mark_thread_read($tid, $fid);
+
+
 	// Check captcha image
 	if($mybb->settings['captchaimage'] == 1 && function_exists("imagepng") && !$mybb->user['uid'])
 	{
@@ -444,7 +464,7 @@
 		else
 		{
 			// Moderated post
-			$lang->redirect_newreply .= $lang->redirect_newreply_moderation;
+			$lang->redirect_newreply .= '<br />'.$lang->redirect_newreply_moderation;
 			$url = get_thread_link($tid);
 		}
 
@@ -486,10 +506,6 @@
 			}
 		}
 
-		// Mark thread as read
-		require_once MYBB_ROOT."inc/functions_indicators.php";
-		mark_thread_read($tid, $fid);
-
 		$plugins->run_hooks("newreply_do_newreply_end");
 		
 		// This was a post made via the ajax quick reply - we need to do some special things here
diff -rub mybb_1400/newthread.php mybb_1408/newthread.php
--- mybb_1400/newthread.php	2008-07-06 19:27:56.000000000 +0200
+++ mybb_1408/newthread.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: newthread.php 3992 2008-07-06 17:27:56Z Tikitiki $
+ * $Id: newthread.php 4352 2009-04-18 22:25:55Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'newthread.php');
 
 $templatelist = "newthread,previewpost,error_invalidforum,redirect_newthread,loginbox,changeuserbox,newthread_postpoll,posticons,attachment,newthread_postpoll,codebuttons,smilieinsert,error_nosubject";
 $templatelist .= "posticons,newthread_disablesmilies,newreply_modoptions,post_attachments_new,post_attachments,post_savedraftbutton,post_subscription_method";
@@ -97,7 +98,7 @@
 {
 	if(!$mybb->input['previewpost'] && $mybb->input['action'] != "do_newthread")
 	{
-		$username = $lang->guest;
+		$username = '';
 	}
 	else
 	{
@@ -126,8 +127,19 @@
 // Handle attachments if we've got any.
 if(!$mybb->input['attachmentaid'] && ($mybb->input['newattachment'] || ($mybb->input['action'] == "do_newthread" && $mybb->input['submit'] && $_FILES['attachment'])))
 {
+	if($mybb->input['action'] == "editdraft" || ($mybb->input['tid'] && $mybb->input['pid']))
+	{
+		$attachwhere = "pid='{$pid}'";
+	}
+	else
+	{
+		$attachwhere = "posthash='".$db->escape_string($mybb->input['posthash'])."'";
+	}
+	$query = $db->simple_select("attachments", "COUNT(aid) as numattachs", $attachwhere);
+	$attachcount = $db->fetch_field($query, "numattachs");
+	
 	// If there's an attachment, check it and upload it
-	if($_FILES['attachment']['size'] > 0 && $forumpermissions['canpostattachments'] != 0)
+	if($_FILES['attachment']['size'] > 0 && $forumpermissions['canpostattachments'] != 0 && ($mybb->settings['maxattachments'] == 0 || $attachcount < $mybb->settings['maxattachments']))
 	{
 		require_once MYBB_ROOT."inc/functions_upload.php";
 		$attachedfile = upload_attachment($_FILES['attachment']);
@@ -205,7 +217,7 @@
 			if(!$mybb->user['uid'])
 			{
 				my_setcookie('loginattempts', $logins + 1);
-				$db->write_query("UPDATE ".TABLE_PREFIX."sessions SET loginattempts=loginattempts+1 WHERE sid = '{$session->sid}'");
+				$db->write_query("UPDATE ".TABLE_PREFIX."users SET loginattempts=loginattempts+1 WHERE username = '".$db->escape_string($mybb->input['username'])."'");
 				if($mybb->settings['failedlogintext'] == 1)
 				{
 					$login_text = $lang->sprintf($lang->failed_login_again, $mybb->settings['failedlogincount'] - $logins);
@@ -221,10 +233,11 @@
 			// Update the session to contain their user ID
 			$updated_session = array(
 				"uid" => $mybb->user['uid'],
-				"loginattempts" => 0
 			);
 			$db->update_query("sessions", $updated_session, "sid='{$session->sid}'");
 			
+			$db->update_query("users", array("loginattempts" => 1), "uid='{$mybb->user['uid']}'");
+			
 			// Set uid and username
 			$uid = $mybb->user['uid'];
 			$username = $mybb->user['username'];
@@ -232,7 +245,7 @@
 			// Check if this user is allowed to post here
 			$mybb->usergroup = &$groupscache[$mybb->user['usergroup']];
 			$forumpermissions = forum_permissions($fid);
-			if($forumpermissions['canview'] == 0 || $forumpermissions['canpostreplys'] == 0 || $mybb->user['suspendposting'] == 1)
+			if($forumpermissions['canview'] == 0 || $forumpermissions['canpostthreads'] == 0 || $mybb->user['suspendposting'] == 1)
 			{
 				error_no_permission();
 			}
@@ -575,6 +588,7 @@
 			$postoptionschecked['disablesmilies'] = " checked=\"checked\"";
 		}
 		$icon = $post['icon'];
+		$posticons = get_post_icons();
 	}
 	
 	// Otherwise, this is our initial visit to this page.
@@ -872,9 +886,8 @@
 
 	$plugins->run_hooks("newthread_end");
 	
-	$lang->newthread_in = $lang->sprintf($lang->newthread_in, $forum['name']);
-	
 	$forum['name'] = strip_tags($forum['name']);
+	$lang->newthread_in = $lang->sprintf($lang->newthread_in, $forum['name']);
 
 	eval("\$newthread = \"".$templates->get("newthread")."\";");
 	output_page($newthread);
diff -rub mybb_1400/online.php mybb_1408/online.php
--- mybb_1400/online.php	2008-07-29 17:45:49.000000000 +0200
+++ mybb_1408/online.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: online.php 4052 2008-07-29 15:45:49Z Tikitiki $
+ * $Id: online.php 4341 2009-04-06 21:49:53Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'online.php');
 
 $templatelist = "online,online_row,online_row_ip,online_today,online_today_row,online_iplookup,mostonline";
 require_once "./global.php";
@@ -117,14 +118,21 @@
 	{
 		case "sqlite3":
 		case "sqlite2":	
-			$query = $db->simple_select("sessions", "COUNT(count_sid)", "(SELECT DISTINCT sid as count_sid FROM ".TABLE_PREFIX."sessions WHERE time > {$timesearch})");
+			$sessions = array();
+			$query = $db->simple_select("sessions", "sid", "time > {$timesearch}");
+			while($sid = $db->fetch_field($query, "sid"))
+			{
+				$sessions[$sid] = 1;
+			}
+			$online_count = count($sessions);
+			unset($sessions);
 			break;
 		case "pgsql":
 		default:
-			$query = $db->simple_select("sessions", "COUNT(DISTINCT sid) as online", "time > {$timesearch}");
+			$query = $db->simple_select("sessions", "COUNT(sid) as online", "time > {$timesearch}");
+			$online_count = $db->fetch_field($query, "online");
 			break;
 	}
-	$online_count = $db->fetch_field($query, "online");
 	
 	// How many pages are there?
 	$perpage = $mybb->settings['threadsperpage'];
@@ -167,7 +175,7 @@
 		$plugins->run_hooks("online_user");
 
 		// Fetch the WOL activity
-		$user['activity'] = fetch_wol_activity($user['location']);
+		$user['activity'] = fetch_wol_activity($user['location'], $user['nopermission']);
 
 		$botkey = my_strtolower(str_replace("bot=", '', $user['sid']));
 
diff -rub mybb_1400/polls.php mybb_1408/polls.php
--- mybb_1400/polls.php	2008-05-10 18:35:33.000000000 +0200
+++ mybb_1408/polls.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: polls.php 3825 2008-05-10 16:35:33Z Tikitiki $
+ * $Id: polls.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'polls.php');
 
 $templatelist = "poll_newpoll,redirect_pollposted,redirect_pollupdated,redirect_votethanks";
 require_once "./global.php";
@@ -161,12 +162,12 @@
 	}
 
 	$postoptions = $mybb->input['postoptions'];
-	if($postoptions['multiple'] != 1)
+	if($postoptions['multiple'] != '1')
 	{
 		$postoptions['multiple'] = 0;
 	}
 
-	if($postoptions['public'] != 1)
+	if($postoptions['public'] != '1')
 	{
 		$postoptions['public'] = 0;
 	}
@@ -460,17 +461,17 @@
 	}
 
 	$postoptions = $mybb->input['postoptions'];
-	if($postoptions['multiple'] != 1)
+	if($postoptions['multiple'] != '1')
 	{
 		$postoptions['multiple'] = 0;
 	}
 	
-	if($postoptions['public'] != 1)
+	if($postoptions['public'] != '1')
 	{
 		$postoptions['public'] = 0;
 	}
 	
-	if($postoptions['closed'] != 1)
+	if($postoptions['closed'] != '1')
 	{
 		$postoptions['closed'] = 0;
 	}
@@ -789,7 +790,7 @@
 				{
 					$votesql .= ",";
 				}
-				$votesql .= "('".$poll['pid']."','".$mybb->user['uid']."','$voteoption','$now')";
+				$votesql .= "('".$poll['pid']."','".$mybb->user['uid']."','".$db->escape_string($voteoption)."','$now')";
 				$votesarray[$voteoption-1]++;
 				$numvotes = $numvotes+1;
 			}
diff -rub mybb_1400/portal.php mybb_1408/portal.php
--- mybb_1400/portal.php	2008-07-31 06:56:19.000000000 +0200
+++ mybb_1408/portal.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,11 +6,12 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: portal.php 4053 2008-07-31 04:56:19Z Tikitiki $
+ * $Id: portal.php 4339 2009-04-04 18:26:37Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
 define("IN_PORTAL", 1);
+define('THIS_SCRIPT', 'portal.php');
 
 // set the path to your forums directory here (without trailing slash)
 $forumdir = "./";
@@ -59,19 +60,13 @@
 
 	if(!username_exists($mybb->input['username']))
 	{
-		my_setcookie('loginattempts', $logins + 1);
-		$db->write_query("UPDATE ".TABLE_PREFIX."sessions SET loginattempts=loginattempts+1 WHERE sid = '{$session->sid}'");
-		if($mybb->settings['failedlogintext'] == 1)
-		{
-			$login_text = $lang->sprintf($lang->failed_login_again, $mybb->settings['failedlogincount'] - $logins);
-		}
 		error($lang->error_invalidpworusername.$login_text);
 	}
 	$user = validate_password_from_username($mybb->input['username'], $mybb->input['password']);
 	if(!$user['uid'])
 	{
 		my_setcookie('loginattempts', $logins + 1);
-		$db->write_query("UPDATE ".TABLE_PREFIX."sessions SET loginattempts=loginattempts+1 WHERE sid = '{$session->sid}'");
+		$db->write_query("UPDATE ".TABLE_PREFIX."users SET loginattempts=loginattempts+1 WHERE username = '".$db->escape_string($mybb->input['username'])."'");
 		if($mybb->settings['failedlogintext'] == 1)
 		{
 			$login_text = $lang->sprintf($lang->failed_login_again, $mybb->settings['failedlogincount'] - $logins);
@@ -83,10 +78,11 @@
 	$db->delete_query("sessions", "ip='".$db->escape_string($session->ipaddress)."' AND sid != '".$session->sid."'");
 	$newsession = array(
 		"uid" => $user['uid'],
-		"loginattempts" => 1,
 	);
 	$db->update_query("sessions", $newsession, "sid='".$session->sid."'");
 
+	$db->update_query("users", array("loginattempts" => 1), "uid='{$mybb->user['uid']}'");
+
 	// Temporarily set the cookie remember option for the login cookies
 	$mybb->user['remember'] = $user['remember'];
 
@@ -196,7 +192,7 @@
 				$query = $db->simple_select("privatemessages", "COUNT(*) AS pms_total", "uid='".$mybb->user['uid']."'");
 				$messages['pms_total'] = $db->fetch_field($query, "pms_total");
 				
-				$query = $db->simple_select("privatemessages", "SUM(*) AS pms_unread", "uid='".$mybb->user['uid']."' AND IF(status='0' AND folder='1','1','0')");
+				$query = $db->simple_select("privatemessages", "COUNT(*) AS pms_unread", "uid='".$mybb->user['uid']."' AND CASE WHEN status = '0' AND folder = '0' THEN TRUE ELSE FALSE END");
 				$messages['pms_unread'] = $db->fetch_field($query, "pms_unread");
 				break;
 			default:
@@ -451,7 +447,16 @@
 	$announcement['message'] = $posts[$announcement['tid']]['message'];
 	$announcement['pid'] = $posts[$announcement['tid']]['pid'];
 	$announcement['threadlink'] = get_thread_link($announcement['tid']);
-	$announcement['profilelink'] = get_profile_link($announcement['uid']);
+	
+	if($announcement['uid'] == 0)
+	{
+		$profilelink = htmlspecialchars_uni($announcement['threadusername']);
+	}
+	else
+	{
+		$profilelink = build_profile_link($announcement['username'], $announcement['uid']);
+	}
+	
 	if(!$announcement['username'])
 	{
 		$announcement['username'] = $announcement['threadusername'];
diff -rub mybb_1400/printthread.php mybb_1408/printthread.php
--- mybb_1400/printthread.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/printthread.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: printthread.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: printthread.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'printthread.php');
 
 $templatelist = "printthread,printthread_post";
 
@@ -79,11 +80,19 @@
 $thread['threadlink'] = get_thread_link($tid);
 
 $postrows = '';
+if(is_moderator($forum['fid']))
+{
+    $visible = "AND (p.visible='0' OR p.visible='1')";
+}
+else
+{
+    $visible = "AND p.visible='1'";
+}
 $query = $db->query("
 	SELECT u.*, u.username AS userusername, p.*
 	FROM ".TABLE_PREFIX."posts p
 	LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=p.uid)
-	WHERE p.tid='$tid' AND p.visible=1
+    WHERE p.tid='$tid' {$visible}
 	ORDER BY p.dateline
 ");
 while($postrow = $db->fetch_array($query))
diff -rub mybb_1400/private.php mybb_1408/private.php
--- mybb_1400/private.php	2008-07-20 22:56:39.000000000 +0200
+++ mybb_1408/private.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: private.php 4031 2008-07-20 20:56:39Z Tikitiki $
+ * $Id: private.php 4330 2009-03-16 02:17:06Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'private.php');
 
 $templatelist = "private_send,private_send_buddyselect,private_read,private_tracking,private_tracking_readmessage,private_tracking_unreadmessage";
 $templatelist .= ",private_folders,private_folders_folder,private_folders_folder_unremovable,private,usercp_nav_changename,usercp_nav,private_empty_folder,private_empty,posticons";
@@ -60,7 +61,7 @@
 foreach($foldersexploded as $key => $folders)
 {
 	$folderinfo = explode("**", $folders, 2);
-	if($fid == $folderinfo[0])
+	if($mybb->input['fid'] == $folderinfo[0])
 	{
 		$sel = ' selected="selected"';
 	}
@@ -346,7 +347,6 @@
 			// Get list of recipients
 			$recipients = unserialize($pm['recipients']);
 			$comma = '';
-			$recipientids = $pm['fromid'];
 			if(isset($recipients['to']) && is_array($recipients['to']))
 			{
 				foreach($recipients['to'] as $recipient)
@@ -367,6 +367,8 @@
 				}	
 			}
 			
+			if(!empty($recipientids))
+			{
 			$query = $db->simple_select("users", "uid, username", "uid IN ({$recipientids})");
 			while($user = $db->fetch_array($query))
 			{
@@ -380,13 +382,14 @@
 				}
 			}
 		}
+		}
 		else
 		{ // forward/reply
 			$subject = preg_replace("#(FW|RE):( *)#is", '', $subject);
 			$postdate = my_date($mybb->settings['dateformat'], $pm['dateline']);
 			$posttime = my_date($mybb->settings['timeformat'], $pm['dateline']);
 			$message = "[quote={$pm['quotename']}]\n$message\n[/quote]";
-			$quoted['message'] = preg_replace('#^/me (.*)$#im', "* ".$pm['quotename']." \\1", $quoted['message']);
+			$message = preg_replace('#^/me (.*)$#im', "* ".$pm['quotename']." \\1", $message);
 
 			if($mybb->input['do'] == 'forward')
 			{
@@ -552,12 +555,12 @@
 		
 		if($reply_date == $lang->today || $reply_date == $lang->yesterday)
 		{
-			$reply_data .= ', '.my_date($mybb->settings['timeformat'], $pm['statustime']);
+			$reply_date .= ', '.my_date($mybb->settings['timeformat'], $pm['statustime']);
 			$actioned_on = $lang->sprintf($lang->you_replied, $reply_date);
 		}
 		else
 		{
-			$reply_data .= ', '.my_date($mybb->settings['timeformat'], $pm['statustime']);
+			$reply_date .= ', '.my_date($mybb->settings['timeformat'], $pm['statustime']);
 			$actioned_on = $lang->sprintf($lang->you_replied_on, $reply_date);
 		}
 		
@@ -567,7 +570,7 @@
 	{
 		$forward_date = my_date($mybb->settings['dateformat'], $pm['statustime']);
 		
-		if(strpos($forward_date, $lang->today) !== false || strpos($forward_date, $lang->yesturday) !== false)
+		if(strpos($forward_date, $lang->today) !== false || strpos($forward_date, $lang->yesterday) !== false)
 		{
 			$forward_date .= ', '.my_date($mybb->settings['timeformat'], $pm['statustime']);
 			$actioned_on = $lang->sprintf($lang->you_forwarded, $forward_date);
@@ -763,11 +766,11 @@
 				$pmuids[$pm['uid']] = $pm['uid'];
 			}
 			
-			$db->delete_query("privatemessages", "pmid IN ($pmids) AND fromid='".$mybb->user['uid']."'");
+			$db->delete_query("privatemessages", "pmid IN ($pmids) AND receipt='1' AND status='0' AND fromid='".$mybb->user['uid']."'");
 			foreach($pmuids as $uid)
 			{
 				// Message is canceled, update PM count for this user
-				update_pm_count($pm['uid']);
+				update_pm_count($uid);
 			}
 		}
 		$plugins->run_hooks("private_do_tracking_end");
@@ -1133,7 +1136,7 @@
 			{
 				$wsql .= "<=";
 			}
-			elseif($mybb->input['dayway'] == "newer")
+			else
 			{
 				$wsql .= ">=";
 			}
@@ -1274,6 +1277,7 @@
 			);
 
 			$message['message'] = $parser->parse_message($message['message'], $parser_options);
+			$message['subject'] = htmlspecialchars_uni($message['subject']);
 		}
 		
 		if($mybb->input['exporttype'] == "txt" || $mybb->input['exporttype'] == "csv")
@@ -1302,7 +1306,11 @@
 					$foldername = $folderinfo[1];
 					if($mybb->input['exporttype'] != "csv")
 					{
-						eval("\$pmsdownload .= \"".$templates->get("private_archive_".$nmybb->input['exporttype']."_folderhead", 1, 0)."\";");
+						if($mybb->input['exporttype'] != "html")
+						{
+							$mybb->input['exporttype'] == "txt";
+						}
+						eval("\$pmsdownload .= \"".$templates->get("private_archive_".$mybb->input['exporttype']."_folderhead", 1, 0)."\";");
 					}
 					else
 					{
@@ -1323,7 +1331,7 @@
 	eval("\$archived = \"".$templates->get("private_archive_".$mybb->input['exporttype'], 1, 0)."\";");
 	if($mybb->input['deletepms'] == 1)
 	{ // delete the archived pms
-		$db->delete_query("privatemessages", "pmid IN (''$ids)");
+		$db->delete_query("privatemessages", "pmid IN ('0'$ids)");
 		// Update PM count
 		update_pm_count();
 	}
@@ -1369,6 +1377,7 @@
 		$mybb->input['fid'] = 1;
 	}
 
+	$folder = '';
 	$foldersexploded = explode("$%%$", $mybb->user['pmfolders']);
 	foreach($foldersexploded as $key => $folders)
 	{
@@ -1430,7 +1439,7 @@
 	{		
 		// Get all recipients into an array
 		$cached_users = $get_users = array();
-		$users_query = $db->simple_select("privatemessages", "recipients", "folder='$folder' AND uid='{$mybb->user['uid']}'", array('limit_start' => $start, 'limit' => $per_page));
+		$users_query = $db->simple_select("privatemessages", "recipients", "folder='$folder' AND uid='{$mybb->user['uid']}'", array('limit_start' => $start, 'limit' => $perpage, 'order_by' => 'dateline', 'order_dir' => 'DESC'));
 		while($row = $db->fetch_array($users_query))
 		{
 			$recipients = unserialize($row['recipients']);
@@ -1544,10 +1553,7 @@
 				}
 			}
 			
-			if($tofromuid != 0)
-			{
 				$tofromusername = build_profile_link($tofromusername, $tofromuid);
-			}
 			
 			if($mybb->usergroup['cantrackpms'] == 1 && $mybb->usergroup['candenypmreceipts'] == 1 && $message['receipt'] == '1' && $message['folder'] != '3' && $message['folder'] != 2)
 			{
@@ -1561,11 +1567,11 @@
 			if($message['icon'] > 0 && $icon_cache[$message['icon']])
 			{
 				$icon = $icon_cache[$message['icon']];
-				$icon = "<img src=\"{$icon['path']}\" alt=\"{$icon['name']}\" valign=\"middle\" align=\"center\" />&nbsp;";
+				$icon = "<img src=\"{$icon['path']}\" alt=\"{$icon['name']}\" align=\"center\" valign=\"middle\" />";
 			}
 			else
 			{
-				$icon = '';
+				$icon = '&nbsp;';
 			}
 			
 			if(!trim($message['subject']))
diff -rub mybb_1400/ratethread.php mybb_1408/ratethread.php
--- mybb_1400/ratethread.php	2008-05-03 06:43:53.000000000 +0200
+++ mybb_1408/ratethread.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: ratethread.php 3809 2008-05-03 04:43:53Z Tikitiki $
+ * $Id: ratethread.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'ratethread.php');
 
 $templatelist = '';
 require_once "./global.php";
@@ -66,7 +67,7 @@
 $query = $db->simple_select("threadratings", "*", "{$whereclause} AND tid='{$tid}'");
 $ratecheck = $db->fetch_array($query);
 
-if($ratecheck['rid'] || $mybb->cookies['mybbthreadrate'][$tid])
+if($ratecheck['rid'] || $mybb->cookies['mybbratethread'][$tid])
 {
 	error($lang->error_alreadyratedthread);
 }
diff -rub mybb_1400/report.php mybb_1408/report.php
--- mybb_1400/report.php	2008-05-26 06:24:54.000000000 +0200
+++ mybb_1408/report.php	2009-06-26 07:26:29.000000000 +0200
@@ -1,15 +1,16 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: report.php 3865 2008-05-26 04:24:54Z ZiNgaBuRgA $
+ * $Id: report.php 4374 2009-05-19 12:10:25Z Tomm $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'report.php');
 
 $templatelist = "report,email_reportpost,emailsubject_reportpost,report_thanks";
 require_once "./global.php";
@@ -93,7 +94,7 @@
 					$query = $db->query("
 						SELECT u.username, u.email, u.receivepms, u.uid
 						FROM ".TABLE_PREFIX."users u
-						LEFT JOIN ".TABLE_PREFIX."usergroups g ON (((CONCAT(','|| u.additionalgroups|| ',') LIKE CONCAT('%,'|| g.gid|| ',%')) OR u.usergroup = g.gid))
+						LEFT JOIN ".TABLE_PREFIX."usergroups g ON (((','|| u.additionalgroups|| ',' LIKE '%,'|| g.gid|| ',%') OR u.usergroup = g.gid))
 						WHERE (g.cancp=1 OR g.issupermod=1)
 					");
 					break;
@@ -110,7 +111,7 @@
 		while($mod = $db->fetch_array($query))
 		{
 			$emailsubject = $lang->sprintf($lang->emailsubject_reportpost, $mybb->settings['bbname']);
-			$emailmessage = $lang->sprintf($lang->email_reportpost, $mybb->user['username'], $mybb->settings['bbname'], $post['subject'], $mybb->settings['bburl'], get_post_link($post['pid'], $thread['tid']), $thread['subject'], $mybb->input['reason']);
+			$emailmessage = $lang->sprintf($lang->email_reportpost, $mybb->user['username'], $mybb->settings['bbname'], $post['subject'], $mybb->settings['bburl'], str_replace('&amp;', '&', get_post_link($post['pid'], $thread['tid'])."#pid".$post['pid']), $thread['subject'], $mybb->input['reason']);
 			
 			if($mybb->settings['reportmethod'] == "pms" && $mod['receivepms'] != 0 && $mybb->settings['enablepms'] != 0)
 			{
@@ -125,7 +126,7 @@
 		if(count($pm_recipients) > 0)
 		{
 			$emailsubject = $lang->sprintf($lang->emailsubject_reportpost, $mybb->settings['bbname']);
-			$emailmessage = $lang->sprintf($lang->email_reportpost, $mybb->user['username'], $mybb->settings['bbname'], $post['subject'], $mybb->settings['bburl'], get_post_link($post['pid'], $thread['tid']), $thread['subject'], $mybb->input['reason']);
+			$emailmessage = $lang->sprintf($lang->email_reportpost, $mybb->user['username'], $mybb->settings['bbname'], $post['subject'], $mybb->settings['bburl'], str_replace('&amp;', '&', get_post_link($post['pid'], $thread['tid'])."#pid".$post['pid']), $thread['subject'], $mybb->input['reason']);
 
 			require_once MYBB_ROOT."inc/datahandlers/pm.php";
 			$pmhandler = new PMDataHandler();
@@ -134,7 +135,7 @@
 				"subject" => $emailsubject,
 				"message" => $emailmessage,
 				"icon" => 0,
-				"fromid" => 0,
+				"fromid" => $mybb->user['uid'],
 				"toid" => $pm_recipients
 			);
 
diff -rub mybb_1400/reputation.php mybb_1408/reputation.php
--- mybb_1400/reputation.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/reputation.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: reputation.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: reputation.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'reputation.php');
 
 $templatelist = '';
 require_once "./global.php";
@@ -520,10 +521,10 @@
 
 		// Parse smilies in the reputation vote
 		$reputation_parser = array(
-			"allow_html" => "no",
-			"allow_mycode" => "no",
-			"allow_smilies" => "yes",
-			"allow_imgcode" => "no"
+			"allow_html" => 0,
+			"allow_mycode" => 0,
+			"allow_smilies" => 1,
+			"allow_imgcode" => 0
 		);
 
 		$reputation_vote['comments'] = $parser->parse_message($reputation_vote['comments'], $reputation_parser);
@@ -536,8 +537,8 @@
 		eval("\$reputation_votes = \"".$templates->get("reputation_no_votes")."\";");
 	}
 
-	eval("\$reputation = \"".$templates->get("reputation")."\";");
 	$plugins->run_hooks("reputation_end");
+	eval("\$reputation = \"".$templates->get("reputation")."\";");
 	output_page($reputation);
 }
 ?>
\ No newline at end of file
diff -rub mybb_1400/rss.php mybb_1408/rss.php
--- mybb_1400/rss.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/rss.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: rss.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: rss.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 /* Redirect traffic using old URI to new URI. */
diff -rub mybb_1400/search.php mybb_1408/search.php
--- mybb_1400/search.php	2008-05-27 02:05:03.000000000 +0200
+++ mybb_1408/search.php	2009-06-26 17:17:46.000000000 +0200
@@ -1,21 +1,22 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: search.php 3869 2008-05-27 00:05:03Z Tikitiki $
+ * $Id: search.php 4375 2009-05-26 12:06:03Z Tomm $
  */
 
 
 define("IN_MYBB", 1);
 define("IGNORE_CLEAN_VARS", "sid");
+define('THIS_SCRIPT', 'search.php');
 
 $templatelist = "search,forumdisplay_thread_gotounread,search_results_threads_thread,search_results_threads,search_results_posts,search_results_posts_post";
 $templatelist .= ",multipage_nextpage,multipage_page_current,multipage_page,multipage_start,multipage_end,multipage,forumdisplay_thread_multipage_more,forumdisplay_thread_multipage_page,forumdisplay_thread_multipage";
-$templatelist .= ",search_results_posts_inlinecheck,search_results_posts_nocheck,search_results_threads_inlinecheck,search_results_threads_nocheck,search_results_inlinemodcol,search_results_posts_inlinemoderation_custom_tool,search_results_posts_inlinemoderation_custom,search_results_posts_inlinemoderation,search_results_threads_inlinemoderation_custom_tool,search_results_threads_inlinemoderation_custom,search_results_threads_inlinemoderation";
+$templatelist .= ",search_results_posts_inlinecheck,search_results_posts_nocheck,search_results_threads_inlinecheck,search_results_threads_nocheck,search_results_inlinemodcol,search_results_posts_inlinemoderation_custom_tool,search_results_posts_inlinemoderation_custom,search_results_posts_inlinemoderation,search_results_threads_inlinemoderation_custom_tool,search_results_threads_inlinemoderation_custom,search_results_threads_inlinemoderation,search_orderarrow";
 require_once "./global.php";
 require_once MYBB_ROOT."inc/functions_post.php";
 require_once MYBB_ROOT."inc/functions_search.php";
@@ -42,6 +43,13 @@
 }
 
 $now = TIME_NOW;
+$mybb->input['keywords'] = trim($mybb->input['keywords']);
+
+$limitsql = "";
+if(intval($mybb->settings['searchhardlimit']) > 0)
+{
+	$limitsql = "LIMIT ".intval($mybb->settings['searchhardlimit']);
+}
 
 if($mybb->input['action'] == "results")
 {
@@ -140,6 +148,7 @@
 	$upper = $end;
 	
 	// Work out if we have terms to highlight
+	$highlight = "";
 	if($search['keywords'])
 	{
 		if($mybb->settings['seourls'] == "yes" || ($mybb->settings['seourls'] == "auto" && $_SERVER['SEO_SUPPORT'] == 1))
@@ -164,12 +173,40 @@
 
 	$threads = array();
 	
-	$limitsql = "";
-	if(intval($mybb->settings['searchhardlimit']) > 0)
+	if($mybb->user['uid'] == 0)
 	{
-		$limitsql = "LIMIT ".intval($mybb->settings['searchhardlimit']);
-	}
+		// Build a forum cache.
+		$query = $db->query("
+			SELECT fid
+			FROM ".TABLE_PREFIX."forums
+			WHERE active != 0
+			ORDER BY pid, disporder
+		");
 
+		$forumsread = unserialize($mybb->cookies['mybb']['forumread']);
+	}
+	else
+	{
+		// Build a forum cache.
+		$query = $db->query("
+			SELECT f.fid, fr.dateline AS lastread
+			FROM ".TABLE_PREFIX."forums f
+			LEFT JOIN ".TABLE_PREFIX."forumsread fr ON (fr.fid=f.fid AND fr.uid='{$mybb->user['uid']}')
+			WHERE f.active != 0
+			ORDER BY pid, disporder
+		");
+	}
+	while($forum = $db->fetch_array($query))
+	{
+		if($mybb->user['uid'] == 0)
+		{
+			if($forumsread[$forum['fid']])
+			{
+				$forum['lastread'] = $forumsread[$forum['fid']];
+			}
+		}
+		$readforums[$forum['fid']] = $forum['lastread'];
+	}
 	$fpermissions = forum_permissions();
 	
 	// Inline Mod Column for moderators
@@ -277,7 +314,7 @@
 		// Fetch dot icons if enabled
 		if($mybb->settings['dotfolders'] != 0 && $mybb->user['uid'] && $thread_cache)
 		{
-			$query = $db->simple_select("posts", "DISTINCT tid,uid", "uid='".$mybb->user['uid']."' AND tid IN(".$thread_ids.")");
+			$query = $db->simple_select("posts", "DISTINCT tid,uid", "uid='".$mybb->user['uid']."' AND tid IN(".$thread_ids.")"); // Why are we querying the posts table?
 			while($post = $db->fetch_array($query))
 			{
 				$thread_cache[$post['tid']]['dot_icon'] = 1;
@@ -340,47 +377,50 @@
 			$gotounread = '';
 			$isnew = 0;
 			$donenew = 0;
-			$lastread = 0;
+			$last_read = 0;
 
-			if($mybb->settings['threadreadcut'] > 0 && $mybb->user['uid'] && $thread['lastpost'] > $forumread)
-			{
-				$cutoff = TIME_NOW-$mybb->settings['threadreadcut']*60*60*24;
-				if($thread['lastpost'] > $cutoff)
+			if($mybb->settings['threadreadcut'] > 0 && $mybb->user['uid'])
 				{
-					if($thread['lastread'])
+				$forum_read = $readforums[$thread['fid']];
+			
+				$read_cutoff = TIME_NOW-$mybb->settings['threadreadcut']*60*60*24;
+				if($forum_read == 0 || $forum_read < $read_cutoff)
 					{
-						$lastread = $thread['lastread'];
+					$forum_read = $read_cutoff;
+				}
 					}
 					else
 					{
-						$lastread = 1;
-					}
+				$forum_read = $forumsread[$thread['fid']];
 				}
-			}
-			$lastread = $thread['lastread'];
-			if(!$lastread)
+			
+			if($mybb->settings['threadreadcut'] > 0 && $mybb->user['uid'] && $thread['lastpost'] > $forum_read)
 			{
-				$readcookie = $threadread = my_get_array_cookie("threadread", $thread['tid']);
-				if($readcookie > $forumread)
+				if($thread['lastread'])
 				{
-					$lastread = $readcookie;
+					$last_read = $thread['lastread'];
 				}
-				elseif($forumread > $mybb->user['lastvisit'])
+				else
 				{
-					$lastread = $forumread;
+					$last_read = $read_cutoff;
+				}
 				}
 				else
 				{
-					$lastread = $mybb->user['lastvisit'];
+				$last_read = my_get_array_cookie("threadread", $thread['tid']);
 				}
+	
+			if($forum_read > $last_read)
+			{
+				$last_read = $forum_read;
 			}
 
-			if($thread['lastpost'] > $lastread && $lastread)
+			if($thread['lastpost'] > $last_read && $last_read)
 			{
 				$folder .= "new";
 				$new_class = "subject_new";
 				$folder_label .= $lang->icon_new;
-				$thread['newpostlink'] = get_thread_link($thread['tid'], 0, "newpost");
+				$thread['newpostlink'] = get_thread_link($thread['tid'], 0, "newpost").$highlight;
 				eval("\$gotounread = \"".$templates->get("forumdisplay_thread_gotounread")."\";");
 				$unreadpost = 1;
 			}
@@ -419,7 +459,7 @@
 				if($thread['pages'] > 4)
 				{
 					$pagesstop = 4;
-					$page_link = get_thread_link($thread['tid'], $thread['pages']);
+					$page_link = get_thread_link($thread['tid'], $thread['pages']).$highlight;
 					eval("\$morelink = \"".$templates->get("forumdisplay_thread_multipage_more")."\";");
 				}
 				else
@@ -428,10 +468,10 @@
 				}
 				for($i = 1; $i <= $pagesstop; ++$i)
 				{
-					$page_link = get_thread_link($thread['tid'], $i);
+					$page_link = get_thread_link($thread['tid'], $i).$highlight;
 					eval("\$threadpages .= \"".$templates->get("forumdisplay_thread_multipage_page")."\";");
 				}
-				eval("\$thread[multipage] = \"".$templates->get("forumdisplay_thread_multipage")."\";");
+				eval("\$thread['multipage'] = \"".$templates->get("forumdisplay_thread_multipage")."\";");
 			}
 			else
 			{
@@ -564,26 +604,20 @@
 	}
 	else // Displaying results as posts
 	{
-		$postcount = 0;
-		if($search['querycache'] != "")
-		{
-			$where_conditions = $search['querycache'];
-		}
-		else
-		{
 			if(!$search['posts'])
 			{
 				error($lang->error_nosearchresults);
 			}
-			$where_conditions = "p.pid IN (".$search['posts'].")";
-		}
+		
+		$postcount = 0;
 		
 		// Moderators can view unapproved threads
 		$query = $db->simple_select("moderators", "fid", "uid='{$mybb->user['uid']}'");
 		if($mybb->usergroup['issupermod'] == 1)
 		{
 			// Super moderators (and admins)
-			$unapproved_where = "t.visible>-1 AND p.visible>-1";
+			$p_unapproved_where = "visible >= 0";
+			$t_unapproved_where = "visible < 0";
 		}
 		elseif($db->num_rows($query))
 		{
@@ -592,49 +626,73 @@
 			while($forum = $db->fetch_array($query))
 			{
 				$moderated_forums .= ','.$forum['fid'];
+				$test_moderated_forums[$forum['fid']] = $forum['fid'];
 			}
-			$unapproved_where = "((t.visible>0 AND p.visible>0) OR ((p.visible=0 OR t.visible>-1) AND t.fid IN ({$moderated_forums})))";
+			$p_unapproved_where = "visible >= 0";
+			$t_unapproved_where = "visible < 0 AND fid NOT IN ({$moderated_forums})";
 		}
 		else
 		{
 			// Normal users
-			$unapproved_where = 't.visible>0 AND p.visible>0';
+			$p_unapproved_where = 'visible=1';
+			$t_unapproved_where = 'visible < 1';
 		}
 		
-		$query = $db->query("
-			SELECT COUNT(p.pid) AS resultcount
-			FROM ".TABLE_PREFIX."posts p
-			LEFT JOIN ".TABLE_PREFIX."threads t ON (t.tid=p.tid)
-			WHERE {$where_conditions} AND {$unapproved_where} AND t.closed NOT LIKE 'moved|%'
-			{$limitsql}
-		");
-		$count = $db->fetch_array($query);
-
-		if(!$count['resultcount'])
+		$post_cache_options = array('LIMIT' => intval($mybb->settings['searchhardlimit']));
+		if(strpos($sortfield, 'p.') !== false)
 		{
-			error($lang->error_nosearchresults);
+			$post_cache_options['order_by'] = str_replace('p.', '', $sortfield);
+			$post_cache_options['order_dir'] = $order;
 		}
-		$postcount = $count['resultcount'];
 
 		$tids = array();
-		$query = $db->query("
-			SELECT p.tid
-			FROM ".TABLE_PREFIX."posts p
-			LEFT JOIN ".TABLE_PREFIX."threads t ON (t.tid=p.tid)
-			WHERE {$where_conditions} AND {$unapproved_where} AND t.closed NOT LIKE 'moved|%' 
-			ORDER BY $sortfield $order
-			LIMIT $start, $perpage
-		");
+		$pids = array();
+		// Make sure the posts we're viewing we have permission to view.
+		$query = $db->simple_select("posts", "pid, tid", "pid IN(".$db->escape_string($search['posts']).") AND {$p_unapproved_where}", $post_cache_options);
 		while($post = $db->fetch_array($query))
 		{
-			$tids[$post['tid']] = $post['tid'];
+			$pids[$post['pid']] = $post['tid'];
+			$tids[$post['tid']][$post['pid']] = $post['pid'];
 		}
-		$tids = implode(",", $tids);
+		
+		if(!empty($pids))
+		{
+			$temp_pids = array();
+			
+			// Check the thread records as well. If we don't have permissions, remove them from the listing.
+			$query = $db->simple_select("threads", "tid", "tid IN(".$db->escape_string(implode(',', $pids)).") AND ({$t_unapproved_where} OR closed LIKE 'moved|%')");
+			while($thread = $db->fetch_array($query))
+			{
+				if(array_key_exists($thread['tid'], $tids) != false)
+				{
+					$temp_pids = $tids[$thread['tid']];
+					foreach($temp_pids as $pid)
+					{
+						unset($pids[$pid]);
+						unset($tids[$thread['tid']]);
+					}
+				}
+			}			
+			unset($temp_pids);
+		}
+		
+		// Declare our post count
+		$postcount = count($pids);
+		
+		if(!$postcount)
+		{
+			error($lang->error_nosearchresults);
+		}
+		
+		// And now we have our sanatized post list
+		$search['posts'] = implode(',', array_keys($pids));
+		
+		$tids = implode(",", array_keys($tids));
 
 		// Read threads
 		if($mybb->user['uid'] && $mybb->settings['threadreadcut'] > 0)
 		{
-			$query = $db->simple_select("threadsread", "tid, dateline", "uid='".$mybb->user['uid']."' AND tid IN(".$tids.")");
+			$query = $db->simple_select("threadsread", "tid, dateline", "uid='".$mybb->user['uid']."' AND tid IN(".$db->escape_string($tids).")");
 			while($readthread = $db->fetch_array($query))
 			{
 				$readthreads[$readthread['tid']] = $readthread['dateline'];
@@ -644,7 +702,7 @@
 		$dot_icon = array();
 		if($mybb->settings['dotfolders'] != 0 && $mybb->user['uid'] != 0)
 		{
-			$query = $db->simple_select("posts", "DISTINCT tid,uid", "uid='".$mybb->user['uid']."' AND tid IN(".$tids.")");
+			$query = $db->simple_select("posts", "DISTINCT tid,uid", "uid='".$mybb->user['uid']."' AND tid IN(".$db->escape_string($tids).")");
 			while($post = $db->fetch_array($query))
 			{
 				$dot_icon[$post['tid']] = true;
@@ -656,7 +714,7 @@
 			FROM ".TABLE_PREFIX."posts p
 			LEFT JOIN ".TABLE_PREFIX."threads t ON (t.tid=p.tid)
 			LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=p.uid)
-			WHERE $where_conditions AND {$unapproved_where} AND t.closed NOT LIKE 'moved|%'
+			WHERE p.pid IN (".$db->escape_string($search['posts']).")
 			ORDER BY $sortfield $order
 			LIMIT $start, $perpage
 		");
@@ -700,7 +758,7 @@
 			$gotounread = '';
 			$isnew = 0;
 			$donenew = 0;
-			$lastread = 0;
+			$last_read = 0;
 			$post['thread_lastread'] = $readthreads[$post['tid']];
 			if($mybb->settings['threadreadcut'] > 0 && $mybb->user['uid'] && $post['thread_lastpost'] > $forumread)
 			{
@@ -709,11 +767,11 @@
 				{
 					if($post['thread_lastread'])
 					{
-						$lastread = $post['thread_lastread'];
+						$last_read = $post['thread_lastread'];
 					}
 					else
 					{
-						$lastread = 1;
+						$last_read = 1;
 					}
 				}
 			}
@@ -724,24 +782,24 @@
 				$folder_label .= $lang->icon_dot;
 			}
 
-			if(!$lastread)
+			if(!$last_read)
 			{
 				$readcookie = $threadread = my_get_array_cookie("threadread", $post['tid']);
 				if($readcookie > $forumread)
 				{
-					$lastread = $readcookie;
+					$last_read = $readcookie;
 				}
 				elseif($forumread > $mybb->user['lastvisit'])
 				{
-					$lastread = $forumread;
+					$last_read = $forumread;
 				}
 				else
 				{
-					$lastread = $mybb->user['lastvisit'];
+					$last_read = $mybb->user['lastvisit'];
 				}
 			}
 
-			if($post['thread_lastpost'] > $lastread && $lastread)
+			if($post['thread_lastpost'] > $last_read && $last_read)
 			{
 				$folder .= "new";
 				$folder_label .= $lang->icon_new;
@@ -869,17 +927,41 @@
 }
 elseif($mybb->input['action'] == "findguest")
 {
-	$where_sql = "p.uid='0'";
+	$where_sql = "uid='0'";
 
 	$unsearchforums = get_unsearchable_forums();
 	if($unsearchforums)
 	{
-		$where_sql .= " AND t.fid NOT IN ($unsearchforums)";
+		$where_sql .= " AND fid NOT IN ($unsearchforums)";
 	}
 	$inactiveforums = get_inactive_forums();
 	if($inactiveforums)
 	{
-		$where_sql .= " AND t.fid NOT IN ($inactiveforums)";
+		$where_sql .= " AND fid NOT IN ($inactiveforums)";
+	}
+	
+	$options = array(
+		'LIMIT' => intval($mybb->settings['searchhardlimit']),
+		'order_by' => 'dateline',
+		'order_dir' => 'DESC'
+	);
+
+	$pids = '';
+	$comma = '';
+	$query = $db->simple_select("posts", "pid", "{$where_sql}", $options);
+	while($pid = $db->fetch_field($query, "pid"))
+	{
+			$pids .= $comma.$pid;
+			$comma = ',';
+	}
+	
+	$tids = '';
+	$comma = '';
+	$query = $db->simple_select("threads", "tid", $where_sql);
+	while($tid = $db->fetch_field($query, "tid"))
+	{
+			$tids .= $comma.$tid;
+			$comma = ',';
 	}
 
 	$sid = md5(uniqid(microtime(), 1));
@@ -888,10 +970,10 @@
 		"uid" => $mybb->user['uid'],
 		"dateline" => TIME_NOW,
 		"ipaddress" => $db->escape_string($session->ipaddress),
-		"threads" => '',
-		"posts" => '',
+		"threads" => $db->escape_string($tids),
+		"posts" => $db->escape_string($pids),
 		"resulttype" => "posts",
-		"querycache" => $db->escape_string($where_sql),
+		"querycache" => '',
 		"keywords" => ''
 	);
 	$plugins->run_hooks("search_do_search_process");
@@ -900,17 +982,41 @@
 }
 elseif($mybb->input['action'] == "finduser")
 {
-	$where_sql = "p.uid='".intval($mybb->input['uid'])."'";
+	$where_sql = "uid='".intval($mybb->input['uid'])."'";
 	
 	$unsearchforums = get_unsearchable_forums();
 	if($unsearchforums)
 	{
-		$where_sql .= " AND t.fid NOT IN ($unsearchforums)";
+		$where_sql .= " AND fid NOT IN ($unsearchforums)";
 	}
 	$inactiveforums = get_inactive_forums();
 	if($inactiveforums)
 	{
-		$where_sql .= " AND t.fid NOT IN ($inactiveforums)";
+		$where_sql .= " AND fid NOT IN ($inactiveforums)";
+	}
+
+	$options = array(
+		'LIMIT' => intval($mybb->settings['searchhardlimit']),
+		'order_by' => 'dateline',
+		'order_dir' => 'DESC'
+	);
+
+	$pids = '';
+	$comma = '';
+	$query = $db->simple_select("posts", "pid", "{$where_sql}", $options);
+	while($pid = $db->fetch_field($query, "pid"))
+	{
+			$pids .= $comma.$pid;
+			$comma = ',';
+	}
+	
+	$tids = '';
+	$comma = '';
+	$query = $db->simple_select("threads", "tid", $where_sql);
+	while($tid = $db->fetch_field($query, "tid"))
+	{
+			$tids .= $comma.$tid;
+			$comma = ',';
 	}
 
 	$sid = md5(uniqid(microtime(), 1));
@@ -919,10 +1025,10 @@
 		"uid" => $mybb->user['uid'],
 		"dateline" => TIME_NOW,
 		"ipaddress" => $db->escape_string($session->ipaddress),
-		"threads" => '',
-		"posts" => '',
+		"threads" => $db->escape_string($tids),
+		"posts" => $db->escape_string($pids),
 		"resulttype" => "posts",
-		"querycache" => $db->escape_string($where_sql),
+		"querycache" => '',
 		"keywords" => ''
 	);
 	$plugins->run_hooks("search_do_search_process");
@@ -1089,7 +1195,7 @@
 			$conditions = "uid='0' AND ipaddress='".$db->escape_string($session->ipaddress)."'";
 		}
 		$timecut = TIME_NOW-$mybb->settings['searchfloodtime'];
-		$query = $db->simple_select("searchlog", "*", "$conditions AND dateline >= '$timecut'", array('order_by' => "dateline", 'order_dir' => "DESC"));
+		$query = $db->simple_select("searchlog", "*", "$conditions AND dateline > '$timecut'", array('order_by' => "dateline", 'order_dir' => "DESC"));
 		$last_search = $db->fetch_array($query);
 		// Users last search was within the flood time, show the error
 		if($last_search['sid'])
@@ -1212,7 +1318,7 @@
 			$conditions = "uid='0' AND ipaddress='".$db->escape_string($session->ipaddress)."'";
 		}
 		$timecut = TIME_NOW-$mybb->settings['searchfloodtime'];
-		$query = $db->simple_select("searchlog", "*", "$conditions AND dateline >= '$timecut'", array('order_by' => "dateline", 'order_dir' => "DESC"));
+		$query = $db->simple_select("searchlog", "*", "$conditions AND dateline > '$timecut'", array('order_by' => "dateline", 'order_dir' => "DESC"));
 		$last_search = $db->fetch_array($query);
 
 		// We shouldn't show remaining time if time is 0 or under.
diff -rub mybb_1400/sendthread.php mybb_1408/sendthread.php
--- mybb_1400/sendthread.php	2008-06-16 19:38:23.000000000 +0200
+++ mybb_1408/sendthread.php	2009-06-26 07:26:34.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: sendthread.php 3925 2008-06-16 17:38:23Z Tikitiki $
+ * $Id: sendthread.php 4359 2009-04-23 18:50:06Z dennis $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'sendthread.php');
 
 $templatelist = "sendthread";
 
@@ -72,9 +73,9 @@
 // Check group limits
 if($mybb->usergroup['maxemails'] > 0)
 {
-	$query = $db->simple_select("maillogs", "COUNT(*) AS sent_count", "fromuid='{$mybb->user['uid']}'");
-	$sent_count = $db->fetch_field($query, "maillogs");
-	if($sent_count > $mybb->usergroup['maxemails'])
+	$query = $db->simple_select("maillogs", "COUNT(*) AS sent_count", "fromuid='{$mybb->user['uid']}' AND dateline >= '".(TIME_NOW - (60*60*24))."'");
+	$sent_count = $db->fetch_field($query, "sent_count");
+	if($sent_count >= $mybb->usergroup['maxemails'])
 	{
 		$lang->error_max_emails_day = $lang->sprintf($lang->error_max_emails_day, $mybb->usergroup['maxemails']);
 		error($lang->error_max_emails_day);
@@ -106,14 +107,21 @@
 	// No errors detected
 	if(count($errors) == 0)
 	{
+		if($mybb->settings['mail_handler'] == 'smtp')
+		{
+			$from = $mybb->user['email'];
+		}
+		else
+		{
 		$from = "{$mybb->user['username']} <{$mybb->user['email']}>";
+		}
 		
 		$threadlink = get_thread_link($thread['tid']);
 		
 		$message = $lang->sprintf($lang->email_sendtofriend, $mybb->user['username'], $mybb->settings['bbname'], $mybb->settings['bburl']."/".$threadlink, $mybb->input['message']);
 		
 		// Send the actual message
-		my_mail($mybb->input['email'], $mybb->input['subject'], $message, $from);
+		my_mail($mybb->input['email'], $mybb->input['subject'], $message, $from, "", "", false, "text", "", $mybb->user['email']);
 		
 		if($mybb->settings['mail_logging'] > 0)
 		{
diff -rub mybb_1400/showteam.php mybb_1408/showteam.php
--- mybb_1400/showteam.php	2008-07-07 09:35:33.000000000 +0200
+++ mybb_1408/showteam.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: showteam.php 3994 2008-07-07 07:35:33Z dennis $
+ * $Id: showteam.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'showteam.php');
 
 $templatelist = 'showteam,showteam_row,showteam_row_mod,postbit_email,postbit_pm';
 $templatelist .= ',showteam_usergroup_user,showteam_usergroup,showteam_moderators_mod';
@@ -88,7 +89,7 @@
 		$usergroups[6]['user_list'][$user['uid']] = $user;
 	}
 	
-	if($user['displaygroup'] == '6' || $user['displaygroup'] == '6')
+	if($user['displaygroup'] == '6' || $user['usergroup'] == '6')
 	{
 		$usergroups[6]['user_list'][$user['uid']] = $user;
 	}
diff -rub mybb_1400/showthread.php mybb_1408/showthread.php
--- mybb_1400/showthread.php	2008-07-25 10:50:26.000000000 +0200
+++ mybb_1408/showthread.php	2009-06-26 07:26:35.000000000 +0200
@@ -1,21 +1,22 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: showthread.php 4038 2008-07-25 08:50:26Z dennis $
+ * $Id: showthread.php 4375 2009-05-26 12:06:03Z Tomm $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'showthread.php');
 
 $templatelist = "showthread,postbit,postbit_author_user,postbit_author_guest,showthread_newthread,showthread_newreply,showthread_newreply_closed,postbit_sig,showthread_newpoll,postbit_avatar,postbit_profile,postbit_find,postbit_pm,postbit_www,postbit_email,postbit_edit,postbit_quote,postbit_report,postbit_signature, postbit_online,postbit_offline,postbit_away,postbit_gotopost,showthread_ratethread,showthread_inline_ratethread,showthread_moderationoptions";
 $templatelist .= ",multipage_prevpage,multipage_nextpage,multipage_page_current,multipage_page,multipage_start,multipage_end,multipage";
 $templatelist .= ",postbit_editedby,showthread_similarthreads,showthread_similarthreads_bit,postbit_iplogged_show,postbit_iplogged_hiden,showthread_quickreply";
 $templatelist .= ",forumjump_advanced,forumjump_special,forumjump_bit,showthread_multipage,postbit_reputation,postbit_quickdelete,postbit_attachments,thumbnails_thumbnail,postbit_attachments_attachment,postbit_attachments_thumbnails,postbit_attachments_images_image,postbit_attachments_images,postbit_posturl";
-$templatelist .= ",postbit_inlinecheck,showthread_inlinemoderation,postbit_attachments_thumbnails_thumbnail,postbit_quickquote,postbit_qqmessage,postbit_seperator,postbit_groupimage,postbit_multiquote,showthread_search,postbit_warn,postbit_warninglevel,showthread_moderationoptions_custom_tool,showthread_moderationoptions_custom,showthread_inlinemoderation_custom_tool,showthread_inlinemoderation_custom,postbit_classic,showthread_classic_header";
+$templatelist .= ",postbit_inlinecheck,showthread_inlinemoderation,postbit_attachments_thumbnails_thumbnail,postbit_quickquote,postbit_qqmessage,postbit_seperator,postbit_groupimage,postbit_multiquote,showthread_search,postbit_warn,postbit_warninglevel,showthread_moderationoptions_custom_tool,showthread_moderationoptions_custom,showthread_inlinemoderation_custom_tool,showthread_inlinemoderation_custom,postbit_classic,showthread_classic_header,showthread_poll_resultbit,showthread_poll_results";
 
 require_once "./global.php";
 require_once MYBB_ROOT."inc/functions_post.php";
@@ -47,10 +48,6 @@
 }
 
 // Get the thread details from the database.
-$options = array(
-	"limit" => 1
-);
-
 $thread = get_thread($mybb->input['tid']);
 
 if(substr($thread['closed'], 0, 6) == "moved|")
@@ -121,15 +118,23 @@
 	$query = $db->simple_select("threadsread", "dateline", "uid='{$mybb->user['uid']}' AND tid='{$thread['tid']}'");
 	$thread_read = $db->fetch_field($query, "dateline");
 
-	// Get forum read date
-	$forumread = my_get_array_cookie("forumread", $fid);
+	if($mybb->settings['threadreadcut'] > 0 && $mybb->user['uid'])
+	{
+		$query = $db->simple_select("forumsread", "dateline", "fid='{$fid}' AND uid='{$mybb->user['uid']}'");
+		$forum_read = $db->fetch_field($query, "dateline");
 
-	// If last visit is greater than forum read, change forum read date
-	if($mybb->user['lastvisit'] > $forumread)
+		$read_cutoff = TIME_NOW-$mybb->settings['threadreadcut']*60*60*24;
+		if($forum_read == 0 || $forum_read < $read_cutoff)
+		{
+			$forum_read = $read_cutoff;
+		}
+	}
+	else
 	{
-		$forumread = $mybb->user['lastvisit'];
+		$forum_read = my_get_array_cookie("forumread", $fid);
 	}
-	if($mybb->settings['threadreadcut'] > 0 && $mybb->user['uid'] && $thread['lastpost'] > $forumread)
+	
+	if($mybb->settings['threadreadcut'] > 0 && $mybb->user['uid'] && $thread['lastpost'] > $forum_read)
 	{
 		$cutoff = TIME_NOW-$mybb->settings['threadreadcut']*60*60*24;
 		if($thread['lastpost'] > $cutoff)
@@ -144,18 +149,20 @@
 			}
 		}
 	}
+	
 	if(!$lastread)
 	{
 		$readcookie = $threadread = my_get_array_cookie("threadread", $thread['tid']);
-		if($readcookie > $forumread)
+		if($readcookie > $forum_read)
 		{
 			$lastread = $readcookie;
 		}
 		else
 		{
-			$lastread = $forumread;
+			$lastread = $forum_read;
 		}
 	}
+	
 	// Next, find the proper pid to link to.
 	$options = array(
 		"limit_start" => 0,
@@ -167,7 +174,7 @@
 	$newpost = $db->fetch_array($query);
 	if($newpost['pid'])
 	{
-		header("Location:".htmlspecialchars_decode(get_post_link($newpost['pid'], $tid))."#pid{$newpost['pid']}");
+		header("Location: ".htmlspecialchars_decode(get_post_link($newpost['pid'], $tid))."#pid{$newpost['pid']}");
 	}
 	else
 	{
@@ -202,7 +209,7 @@
 		$query = $db->simple_select('posts', 'pid', "tid={$tid}", $options);
 		$pid = $db->fetch_field($query, "pid");
 	}
-	header("Location:".htmlspecialchars_decode(get_post_link($pid, $tid))."#pid{$pid}");
+	header("Location: ".htmlspecialchars_decode(get_post_link($pid, $tid))."#pid{$pid}");
 	exit;
 }
 
@@ -228,11 +235,11 @@
 		"order_by" => "dateline",
 		"order_dir" => "desc"
 	);
-	$query = $db->simple_select('posts', 'pid', "tid={$nextthread['tid']}");
+	$query = $db->simple_select('posts', 'pid', "tid='{$nextthread['tid']}'", $options);
 
 	// Redirect to the proper page.
 	$pid = $db->fetch_field($query, "pid");
-	header("Location:".htmlspecialchars_decode(get_post_link($pid, $nextthread['tid']))."#pid{$pid}");
+	header("Location: ".htmlspecialchars_decode(get_post_link($pid, $nextthread['tid']))."#pid{$pid}");
 }
 
 // Jump to the next oldest posts.
@@ -258,11 +265,11 @@
 		"order_by" => "dateline",
 		"order_dir" => "desc"
 	);
-	$query = $db->simple_select("posts", "pid", "tid=".$nextthread['tid']);
+	$query = $db->simple_select("posts", "pid", "tid='".$nextthread['tid']."'", $options);
 
 	// Redirect to the proper page.
 	$pid = $db->fetch_field($query, "pid");
-	header("Location:".htmlspecialchars_decode(get_post_link($pid, $nextthread['tid']))."#pid{$pid}");
+	header("Location: ".htmlspecialchars_decode(get_post_link($pid, $nextthread['tid']))."#pid{$pid}");
 }
 
 if($mybb->input['pid'])
@@ -400,7 +407,7 @@
 		}
 		else
 		{
-			$edit_poll = "| <a href=\"polls.php?action=editpoll&amp;pid={$poll['pid']}\">{$lang->edit_poll}</a>";
+			$edit_poll = " | <a href=\"polls.php?action=editpoll&amp;pid={$poll['pid']}\">{$lang->edit_poll}</a>";
 		}
 
 		// Decide what poll status to show depending on the status of the poll and whether or not the user voted already.
@@ -523,8 +530,8 @@
 		}
 		else
 		{
-			$thread['averagerating'] = intval(round($thread['totalratings']/$thread['numratings'], 2));
-			$thread['width'] = $thread['averagerating']*20;
+			$thread['averagerating'] = floatval(round($thread['totalratings']/$thread['numratings'], 2));
+			$thread['width'] = intval(round($thread['averagerating']))*20;
 			$thread['numratings'] = intval($thread['numratings']);
 		}
 
@@ -568,21 +575,24 @@
 		}
 	}
 	
-	// Which thread mode is our user using?
-	if(!isset($mybb->input['mode']))
-	{
-		if(!empty($mybb->user['threadmode'])) // Take user's default preference first (if there is one) and run with it
+	// Which thread mode is our user using by default?
+	if(!empty($mybb->user['threadmode']))
 		{
-			$mybb->input['mode'] = $mybb->user['threadmode'];
+		$defaultmode = $mybb->user['threadmode'];
 		}
 		else if($mybb->settings['threadusenetstyle'] == 1)
 		{
-			$mybb->input['mode'] = 'threaded';
+		$defaultmode = 'threaded';
 		}
 		else
 		{
-			$mybb->input['mode'] = 'linear';
+		$defaultmode = 'linear';
 		}
+	
+	// If mode is unset, set the default mode
+	if(!isset($mybb->input['mode']))
+	{
+		$mybb->input['mode'] = $defaultmode;
 	}
 
 	// Threaded or linear display?
@@ -721,7 +731,42 @@
 		}
 		$upper = $start+$perpage;
 
-		$multipage = multipage($postcount, $perpage, $page, str_replace("{tid}", $tid, THREAD_URL_PAGED));
+		// Work out if we have terms to highlight
+        $highlight = "";
+        $threadmode = "";
+        if($mybb->settings['seourls'] == "yes" || ($mybb->settings['seourls'] == "auto" && $_SERVER['SEO_SUPPORT'] == 1))
+        {
+            if($mybb->input['highlight'])
+            {
+                $highlight = "?highlight=".urlencode($mybb->input['highlight']);
+            }
+            
+			if($defaultmode != "linear")
+			{
+	            if($mybb->input['highlight'])
+	            {
+	                $threadmode = "&amp;mode=linear";
+	            }
+	            else 
+	            {
+	                $threadmode = "?mode=linear";
+	            }
+			}
+        }
+        else
+        {
+            if($mybb->input['highlight'])
+            {
+                $highlight = "&amp;highlight=".urlencode($mybb->input['highlight']);
+            }
+            
+            if($defaultmode != "linear")
+            {
+                $threadmode = "&amp;mode=linear";
+            }
+        }
+
+        $multipage = multipage($postcount, $perpage, $page, str_replace("{tid}", $tid, THREAD_URL_PAGED.$highlight.$threadmode)); 
 		if($postcount > $perpage)
 		{
 			eval("\$threadpages = \"".$templates->get("showthread_multipage")."\";");
@@ -791,7 +836,7 @@
 			case "sqlite2":
 			case "pgsql":
 			$query = $db->query("
-				SELECT t.*, t.username AS threadusername, u.username, MATCH (t.subject) AGAINST ('".$db->escape_string($thread['subject'])."' WITH QUERY EXPANSION) AS relevance
+				SELECT t.*, t.username AS threadusername, u.username, MATCH (t.subject) AGAINST ('".$db->escape_string($thread['subject'])."') AS relevance
 				FROM ".TABLE_PREFIX."threads t
 				LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid = t.uid)
 				WHERE t.fid='{$thread['fid']}' AND t.tid!='{$thread['tid']}' AND t.visible='1' AND t.closed NOT LIKE 'moved|%' AND MATCH (t.subject) AGAINST ('".$db->escape_string($thread['subject'])."') >= '{$mybb->settings['similarityrating']}'
@@ -801,10 +846,10 @@
 			break;
 			default:
 			$query = $db->query("
-				SELECT t.*, t.username AS threadusername, u.username, MATCH (t.subject) AGAINST ('".$db->escape_string($thread['subject'])."' WITH QUERY EXPANSION) AS relevance
+				SELECT t.*, t.username AS threadusername, u.username, MATCH (t.subject) AGAINST ('".$db->escape_string($thread['subject'])."') AS relevance
 				FROM ".TABLE_PREFIX."threads t
 				LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid = t.uid)
-				WHERE t.fid='{$thread['fid']}' AND t.tid!='{$thread['tid']}' AND t.visible='1' AND t.closed NOT LIKE 'moved|%' AND MATCH (t.subject) AGAINST ('".$db->escape_string($thread['subject'])."' WITH QUERY EXPANSION) >= '{$mybb->settings['similarityrating']}'
+				WHERE t.fid='{$thread['fid']}' AND t.tid!='{$thread['tid']}' AND t.visible='1' AND t.closed NOT LIKE 'moved|%' AND MATCH (t.subject) AGAINST ('".$db->escape_string($thread['subject'])."') >= '{$mybb->settings['similarityrating']}'
 				ORDER BY t.lastpost DESC
 				LIMIT 0, {$mybb->settings['similarlimit']}
 			");
diff -rub mybb_1400/stats.php mybb_1408/stats.php
--- mybb_1400/stats.php	2008-07-11 08:00:25.000000000 +0200
+++ mybb_1408/stats.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: stats.php 4006 2008-07-11 06:00:25Z Tikitiki $
+ * $Id: stats.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'stats.php');
 
 $templatelist = "stats,stats_thread";
 require_once "./global.php";
diff -rub mybb_1400/syndication.php mybb_1408/syndication.php
--- mybb_1400/syndication.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/syndication.php	2009-06-26 07:26:26.000000000 +0200
@@ -1,17 +1,18 @@
 <?php
 /**
  * MyBB 1.4
- * Copyright © 2008 MyBB Group, All Rights Reserved
+ * Copyright Â© 2008 MyBB Group, All Rights Reserved
  *
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: syndication.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: syndication.php 4383 2009-06-18 11:25:58Z Tomm $
  */
 
 define("IN_MYBB", 1);
 define("IGNORE_CLEAN_VARS", "fid");
 define("NO_ONLINE", 1);
+define('THIS_SCRIPT', 'syndication.php');
 
 require_once "./global.php";
 
@@ -32,7 +33,7 @@
 {
 	$thread_limit = 50;
 }
-else if(!$thread_limit)
+else if(!$thread_limit || $thread_limit < 0)
 {
 	$thread_limit = 20;
 }
@@ -57,12 +58,12 @@
 // If there are any, add SQL to exclude them.
 if($unviewableforums)
 {
-	$unviewable .= " AND f.fid NOT IN($unviewableforums)";
+	$unviewable .= " AND fid NOT IN($unviewableforums)";
 }
 
 if($inactiveforums)
 {
-	$unviewable .= " AND f.fid NOT IN($inactiveforums)";
+	$unviewable .= " AND fid NOT IN($inactiveforums)";
 }
 
 // If there are no forums to syndicate, syndicate all viewable.
@@ -73,7 +74,7 @@
 	{
 		$forum_ids .= ",'".intval($fid)."'";
 	}
-	$forumlist = "AND f.fid IN ($forum_ids) $unviewable";
+    $forumlist = "AND fid IN ($forum_ids) $unviewable";
 }
 else
 {
@@ -83,7 +84,7 @@
 
 // Find out which title to add to the feed.
 $title = $mybb->settings['bbname'];
-$query = $db->simple_select("forums f", "f.name, f.fid", "1=1 ".$forumlist);
+$query = $db->simple_select("forums", "name, fid, allowhtml, allowmycode, allowsmilies, allowimgcode", "1=1 ".$forumlist);
 $comma = " - ";
 while($forum = $db->fetch_array($query))
 {
@@ -98,19 +99,6 @@
 	$title = $mybb->settings['bbname']." - ".$lang->all_forums;
 }
 
-// Get the threads to syndicate.
-$query = $db->query("
-	SELECT t.tid, t.dateline, p.edittime, t.subject, f.allowhtml, f.allowmycode, f.allowsmilies, f.allowimgcode,
-	f.name, p.message, u.username, p.smilieoff, f.fid
-	FROM ".TABLE_PREFIX."threads t
-	LEFT JOIN ".TABLE_PREFIX."forums f ON (f.fid=t.fid)
-	LEFT JOIN ".TABLE_PREFIX."posts p ON (p.pid=t.firstpost)
-	LEFT JOIN ".TABLE_PREFIX."users u ON (u.uid=p.uid)
-	WHERE t.visible=1 AND t.closed NOT LIKE 'moved|%' ".$forumlist."
-	ORDER BY t.dateline DESC
-	LIMIT 0, ".$thread_limit
-);
-
 // Set the feed type.
 $feedgenerator->set_feed_format($mybb->input['type']);
 
@@ -118,44 +106,42 @@
 $channel = array(
 	"title" => $title,
 	"link" => $mybb->settings['bburl']."/",
-	"date" => TIME_NOW,
+    "date" => time(),
 	"description" => $mybb->settings['bbname']." - ".$mybb->settings['bburl']
 );
 $feedgenerator->set_channel($channel);
 
+// Get the threads to syndicate.
+$query = $db->simple_select("threads", "subject, tid, dateline, firstpost", "visible='1' AND closed NOT LIKE 'moved|%' ".$forumlist, array('order_by' => 'dateline', 'order_dir' => 'DESC', 'limit' => $thread_limit));
 // Loop through all the threads.
 while($thread = $db->fetch_array($query))
 {
-	$thread['link'] = $channel['link'].get_thread_link($thread['tid']);
-	if($forumcache[$thread['fid']])
-	{
-		if($thread['disablesmilies'])
-		{
-			$thread['allowsmilies'] = 0;
-		}
-		
-		// Set up the parser options.
-		$parser_options = array(
-			"allow_html" => $thread['allowhtml'],
-			"allow_mycode" => $thread['allowmycode'],
-			"allow_smilies" => $thread['allowsmilies'],
-			"allow_imgcode" => $thread['allowimgcode'],
-			"filter_badwords" => 1
+    $items[$thread['tid']] = array(
+        "title" => $thread['subject'],
+        "link" => $channel['link'].get_thread_link($thread['tid']),        
+        "date" => $thread['dateline'],
 		);
 		
-		$thread['message'] = $parser->parse_message($thread['message'], $parser_options);
+    $firstposts[] = $thread['firstpost'];
+}
 		
-		$item = array(
-			'updated' => $thread['edittime'],
-			'author' => $thread['username'],
-			'title' => $thread['subject'],
-			'name' => $thread['forumname'],
-			'description' => $thread['message'],
-			'date' => $thread['dateline'],
-			'link' => $thread['link']
+if(!empty($firstposts))
+{
+    $firstpostlist = "pid IN(".$db->escape_string(implode(',', $firstposts)).")";
+    $query = $db->simple_select("posts", "message, edittime, tid, fid", $firstpostlist, array('order_by' => 'dateline', 'order_dir' => 'desc'));    
+    while($post = $db->fetch_array($query))
+    {		
+		$parser_options = array(
+			"allow_html" => $forumcache[$post['fid']]['allowhtml'],
+			"allow_mycode" => $forumcache[$post['fid']]['allowmycode'],
+			"allow_smilies" => $forumcache[$post['fid']]['allowsmilies'],
+			"allow_imgcode" => $forumcache[$post['fid']]['allowimgcode'],
+			"filter_badwords" => 1
 		);
 		
-		$feedgenerator->add_item($item);
+        $items[$post['tid']]['description'] = $parser->parse_message($post['message'], $parser_options);
+        $items[$post['tid']]['updated'] = $post['edittime'];
+        $feedgenerator->add_item($items[$post['tid']]);
 	}
 }
 
diff -rub mybb_1400/task.php mybb_1408/task.php
--- mybb_1400/task.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/task.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,25 +6,29 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: task.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: task.php 4304 2009-01-02 01:11:56Z chris $
  */
  
 ignore_user_abort(true);
 @set_time_limit(0);
 
 define("IN_MYBB", 1);
-
 define("NO_ONLINE", 1);
-
 define("IN_TASK", 1);
+define('THIS_SCRIPT', 'task.php');
 
-require_once "./inc/init.php";
+require_once dirname(__FILE__)."/inc/init.php";
 
 // Load language
 $lang->set_language($mybb->settings['bblanguage']);
 $lang->load("global");
 $lang->load("messages");
 
+if(function_exists('mb_internal_encoding') && !empty($lang->settings['charset']))
+{
+	@mb_internal_encoding($lang->settings['charset']);
+}
+
 require_once MYBB_ROOT."inc/functions_task.php";
 
 // Are tasks set to run via cron instead & are we accessing this file via the CLI?
diff -rub mybb_1400/usercp.php mybb_1408/usercp.php
--- mybb_1400/usercp.php	2008-07-25 10:50:26.000000000 +0200
+++ mybb_1408/usercp.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: usercp.php 4038 2008-07-25 08:50:26Z dennis $
+ * $Id: usercp.php 4314 2009-01-31 00:43:26Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'usercp.php');
 
 $templatelist = "usercp,usercp_home,usercp_nav,usercp_profile,error_nopermission,buddy_online,buddy_offline,usercp_changename,usercp_nav_changename";
 $templatelist .= ",usercp_usergroups_memberof_usergroup,usercp_usergroups_memberof,usercp_usergroups_joinable_usergroup,usercp_usergroups_joinable,usercp_usergroups";
@@ -526,7 +527,12 @@
 		else
 		{
 			$value = htmlspecialchars_uni($userfield);
-			$code = "<input type=\"text\" name=\"profile_fields[$field]\" class=\"textbox\" size=\"{$profilefield['length']}\" maxlength=\"{$profilefield['maxlength']}\" value=\"$value\" />";
+			$maxlength = "";
+			if($profilefield['maxlength'] > 0)
+			{
+				$maxlength = " maxlength=\"{$profilefield['maxlength']}\"";
+			}
+			$code = "<input type=\"text\" name=\"profile_fields[$field]\" class=\"textbox\" size=\"{$profilefield['length']}\"{$maxlength} value=\"$value\" />";
 		}
 		if($profilefield['required'] == 1)
 		{
@@ -1135,7 +1141,7 @@
 	}
 
 	// Clean input - only accept integers thanks!
-	array_walk($mybb->input['check'], 'intval');
+	$mybb->input['check'] = array_map('intval', $mybb->input['check']);
 	$tids = implode(",", $mybb->input['check']);
 
 	// Deleting these subscriptions?
@@ -1236,6 +1242,41 @@
 	{
 		$tids = implode(",", array_keys($subscriptions));
 
+		if($mybb->user['uid'] == 0)
+		{
+			// Build a forum cache.
+			$query = $db->query("
+				SELECT fid
+				FROM ".TABLE_PREFIX."forums
+				WHERE active != 0
+				ORDER BY pid, disporder
+			");
+			
+			$forumsread = unserialize($mybb->cookies['mybb']['forumread']);
+		}
+		else
+		{
+			// Build a forum cache.
+			$query = $db->query("
+				SELECT f.fid, fr.dateline AS lastread
+				FROM ".TABLE_PREFIX."forums f
+				LEFT JOIN ".TABLE_PREFIX."forumsread fr ON (fr.fid=f.fid AND fr.uid='{$mybb->user['uid']}')
+				WHERE f.active != 0
+				ORDER BY pid, disporder
+			");
+		}
+		while($forum = $db->fetch_array($query))
+		{
+			if($mybb->user['uid'] == 0)
+			{
+				if($forumsread[$forum['fid']])
+				{
+					$forum['lastread'] = $forumsread[$forum['fid']];
+				}
+			}
+			$readforums[$forum['fid']] = $forum['lastread'];
+		}
+
 		// Check participation by the current user in any of these threads - for 'dot' folder icons
 		if($mybb->settings['dotfolders'] != 0)
 		{
@@ -1256,6 +1297,7 @@
 			}
 		}
 
+		$icon_cache = $cache->read("posticons");
 
 		// Now we can build our subscription list
 		foreach($subscriptions as $thread)
@@ -1299,13 +1341,22 @@
 			$donenew = 0;
 			$lastread = 0;
 
-			$forumread = my_get_array_cookie("forumread", $thread['fid']);
-			if($mybb->user['lastvisit'] > $forumread)
+			if($mybb->settings['threadreadcut'] > 0 && $mybb->user['uid'])
+			{
+				$forum_read = $readforums[$thread['fid']];
+			
+				$read_cutoff = TIME_NOW-$mybb->settings['threadreadcut']*60*60*24;
+				if($forum_read == 0 || $forum_read < $read_cutoff)
+				{
+					$forum_read = $read_cutoff;
+				}
+			}
+			else
 			{
-				$forumread = $mybb->user['lastvisit'];
+				$forum_read = $forumsread[$thread['fid']];
 			}
 
-			if($mybb->settings['threadreadcut'] > 0 && $thread['lastpost'] > $forumread)
+			if($mybb->settings['threadreadcut'] > 0 && $thread['lastpost'] > $forum_read)
 			{
 				$cutoff = TIME_NOW-$mybb->settings['threadreadcut']*60*60*24;
 			}
@@ -1328,13 +1379,13 @@
 			if(!$lastread)
 			{
 				$readcookie = $threadread = my_get_array_cookie("threadread", $thread['tid']);
-				if($readcookie > $forumread)
+				if($readcookie > $forum_read)
 				{
 					$lastread = $readcookie;
 				}
 				else
 				{
-					$lastread = $forumread;
+					$lastread = $forum_read;
 				}
 			}
 
@@ -1411,15 +1462,47 @@
 if($mybb->input['action'] == "forumsubscriptions")
 {
 	$plugins->run_hooks("usercp_forumsubscriptions_start");
-	$query = $db->query("
-		SELECT *
-		FROM ".TABLE_PREFIX."forumpermissions
-		WHERE gid='".$mybb->user['usergroup']."'
-	");
+	$query = $db->simple_select("forumpermissions", "*", "gid='".$db->escape_string($mybb->user['usergroup'])."'");
 	while($permissions = $db->fetch_array($query))
 	{
 		$permissioncache[$permissions['gid']][$permissions['fid']] = $permissions;
 	}
+	
+	if($mybb->user['uid'] == 0)
+	{
+		// Build a forum cache.
+		$query = $db->query("
+			SELECT fid
+			FROM ".TABLE_PREFIX."forums
+			WHERE active != 0
+			ORDER BY pid, disporder
+		");
+		
+		$forumsread = unserialize($mybb->cookies['mybb']['forumread']);
+	}
+	else
+	{
+		// Build a forum cache.
+		$query = $db->query("
+			SELECT f.fid, fr.dateline AS lastread
+			FROM ".TABLE_PREFIX."forums f
+			LEFT JOIN ".TABLE_PREFIX."forumsread fr ON (fr.fid=f.fid AND fr.uid='{$mybb->user['uid']}')
+			WHERE f.active != 0
+			ORDER BY pid, disporder
+		");
+	}
+	while($forum = $db->fetch_array($query))
+	{
+		if($mybb->user['uid'] == 0)
+		{
+			if($forumsread[$forum['fid']])
+			{
+				$forum['lastread'] = $forumsread[$forum['fid']];
+			}
+		}
+		$readforums[$forum['fid']] = $forum['lastread'];
+	}
+	
 	$fpermissions = forum_permissions();
 	$query = $db->query("
 		SELECT fs.*, f.*, t.subject AS lastpostsubject
@@ -1436,7 +1519,7 @@
 		$forumpermissions = $fpermissions[$forum['fid']];
 		if($forumpermissions['canview'] != 0)
 		{
-			if(($forum['lastpost'] > $mybb->user['lastvisit'] || $mybbforumread[$forum['fid']] > $mybb->user['lastvisit']) && $forum['lastpost'] != 0)
+			if(($forum['lastpost'] > $mybb->user['lastvisit'] || $readforums[$forum['fid']] > $mybb->user['lastvisit']) && $forum['lastpost'] != 0)
 			{
 				$folder = "on";
 			}
@@ -1527,6 +1610,7 @@
 	else if($error)
 	{
 		$sig = $mybb->input['signature'];
+		$template = false;
 	}
 
 	if($sig && $template)
@@ -1701,7 +1785,7 @@
 		{
 			if($width && $height && $mybb->settings['maxavatardims'] != "")
 			{
-				list($maxwidth, $maxheight) = explode("x", $mybb->settings['maxavatardims']);
+				list($maxwidth, $maxheight) = explode("x", my_strtolower($mybb->settings['maxavatardims']));
 				if(($maxwidth && $width > $maxwidth) || ($maxheight && $height > $maxheight))
 				{
 					$lang->error_avatartoobig = $lang->sprintf($lang->error_avatartoobig, $maxwidth, $maxheight);
@@ -1860,7 +1944,7 @@
 		}
 		if($mybb->settings['maxavatardims'] != "")
 		{
-			list($maxwidth, $maxheight) = explode("x", $mybb->settings['maxavatardims']);
+			list($maxwidth, $maxheight) = explode("x", my_strtolower($mybb->settings['maxavatardims']));
 			$lang->avatar_note .= "<br />".$lang->sprintf($lang->avatar_note_dimensions, $maxwidth, $maxheight);
 		}
 		if($mybb->settings['avatarsize'])
@@ -2447,7 +2531,7 @@
 				LEFT JOIN ".TABLE_PREFIX."users u ON(((','|| u.additionalgroups|| ',' LIKE '%,'|| g.gid|| ',%') OR u.usergroup = g.gid))
 				LEFT JOIN ".TABLE_PREFIX."joinrequests j ON(j.gid=g.gid)
 				WHERE l.uid='".$mybb->user['uid']."'
-				GROUP BY l.gid
+				GROUP BY g.gid, g.title, g.type, l.canmanagerequests, l.canmanagemembers
 			");
 			break;
 		default:
@@ -2730,7 +2814,7 @@
 	{
 		error($lang->no_attachments_selected);
 	}
-	$aids = $db->escape_string(implode(",", $mybb->input['attachments']));
+	$aids = implode(',', array_map('intval', $mybb->input['attachments']));
 	$query = $db->simple_select("attachments", "*", "aid IN ($aids) AND uid='".$mybb->user['uid']."'");
 	while($attachment = $db->fetch_array($query))
 	{
diff -rub mybb_1400/usercp2.php mybb_1408/usercp2.php
--- mybb_1400/usercp2.php	2008-04-24 00:50:33.000000000 +0200
+++ mybb_1408/usercp2.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: usercp2.php 3790 2008-04-23 22:50:33Z Tikitiki $
+ * $Id: usercp2.php 4304 2009-01-02 01:11:56Z chris $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'usercp2.php');
 
 $templatelist = 'usercp_nav_messenger,usercp_nav_changename,usercp_nav_profile,usercp_nav_misc,usercp_nav';
 
@@ -44,7 +45,7 @@
 		add_subscribed_thread($thread['tid'], $mybb->input['notification']);
 		if($mybb->input['referrer'])
 		{
-			$url = $mybb->input['referrer'];
+			$url = htmlspecialchars_uni(addslashes($mybb->input['referrer']));
 		}
 		else
 		{
@@ -159,6 +160,9 @@
 }
 elseif($mybb->input['action'] == "removesubscriptions")
 {
+	// Verify incoming POST request
+	verify_post_check($mybb->input['my_post_key']);
+	
 	if($mybb->input['type'] == "forum")
 	{
 		$db->delete_query("forumsubscriptions", "uid='".$mybb->user['uid']."'");
diff -rub mybb_1400/warnings.php mybb_1408/warnings.php
--- mybb_1400/warnings.php	2008-07-20 22:56:39.000000000 +0200
+++ mybb_1408/warnings.php	2009-06-26 06:22:11.000000000 +0200
@@ -6,10 +6,11 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: warnings.php 4031 2008-07-20 20:56:39Z Tikitiki $
+ * $Id: warnings.php 4324 2009-03-05 21:23:18Z Tikitiki $
  */
 
 define("IN_MYBB", 1);
+define('THIS_SCRIPT', 'warnings.php');
 
 $templatelist = '';
 require_once "./global.php";
@@ -233,14 +234,15 @@
 
 		$new_warning = array(
 			"uid" => $user['uid'],
-			"tid" => $warning_type['tid'],
-			"pid" => $post['pid'],
+			"tid" => intval($warning_type['tid']),
+			"pid" => intval($post['pid']),
 			"title" => $db->escape_string($warning_title),
 			"points" => intval($points),
 			"dateline" => TIME_NOW,
 			"issuedby" => $mybb->user['uid'],
 			"expires" => $warning_expires,
 			"expired" => 0,
+			"revokereason" => '',
 			"notes" => $db->escape_string($mybb->input['notes'])
 		);
 		$db->insert_query("warnings", $new_warning);
@@ -306,7 +308,7 @@
 								
 								if($year > 0)
 								{
-									$time += 60*60*24*265*$year;
+									$time += 60*60*24*365*$year;
 								}
 								
 								if($time == $action['length'])
@@ -565,7 +567,7 @@
 		$notes = htmlspecialchars_uni($mybb->input['notes']);
 		$type_checked[$mybb->input['type']] = "checked=\"checked\"";
 		$pm_subject = htmlspecialchars_uni($mybb->input['pm_subject']);
-		$pm_message = htmlspecialchars_uni($mybb->input['pm_message']);
+		$message = htmlspecialchars_uni($mybb->input['pm_message']);
 		if($mybb->input['send_pm'])
 		{
 			$send_pm_checked = "checked=\"checked\"";
@@ -581,7 +583,7 @@
 		$expires = 1;
 		$custom_points = 2;
 		$pm_subject = $lang->warning_pm_subject;
-		$pm_message = $lang->warning_pm_message;
+		$message = $lang->sprintf($lang->warning_pm_message, $user['username'], $mybb->settings['bbname']);
 	}
 
 	$lang->nav_profile = $lang->sprintf($lang->nav_profile, $user['username']);
@@ -745,10 +747,105 @@
 				$new_warning_points = 0;
 			}
 
-			// Update user
 			$updated_user = array(
 				"warningpoints" => $new_warning_points
 			);
+			
+			
+			// check if we need to revoke any consequences with this warning
+			$current_level = round($user['warningpoints']/$mybb->settings['maxwarningpoints']*100);
+			$new_warning_level = round($new_warning_points/$mybb->settings['maxwarningpoints']*100);
+			$query = $db->simple_select("warninglevels", "action", "percentage>$new_warning_level AND percentage<=$current_level");
+			if($db->num_rows($query))
+			{
+				// we have some warning levels we need to revoke
+				$max_expiration_times = $check_levels = array();
+				find_warnlevels_to_check($query, $max_expiration_times, $check_levels);
+				
+				// now check warning levels already applied to this user to see if we need to lower any expiration times
+				$query = $db->simple_select("warninglevels", "action", "percentage<=$new_warning_level");
+				$lower_expiration_times = $lower_levels = array();
+				find_warnlevels_to_check($query, $lower_expiration_times, $lower_levels);
+				
+				// now that we've got all the info, do necessary stuff
+				for($i = 1; $i <= 3; ++$i)
+				{
+					if($check_levels[$i])
+					{
+						switch($i)
+						{
+							case 1: // Ban
+								// we'll have to resort to letting the admin/mod remove the ban manually, since there's an issue if stacked bans are in force...
+								continue;
+							case 2: // Revoke posting
+								$current_expiry_field = 'suspensiontime';
+								$current_inforce_field = 'suspendposting';
+								break;
+							case 3:
+								$current_expiry_field = 'moderationtime';
+								$current_inforce_field = 'moderateposts';
+								break;
+						}
+						
+						// if the thing isn't in force, don't bother with trying to update anything
+						if(!$user[$current_inforce_field])
+						{
+							continue;
+						}
+						
+						if($lower_levels[$i])
+						{
+							// lessen the expiration time if necessary
+							
+							if(!$lower_expiration_times[$i])
+							{
+								// doesn't expire - enforce this
+								$updated_user[$current_expiry_field] = 0;
+								continue;
+							}
+							
+							if($max_expiration_times[$i])
+							{
+								// if the old level did have an expiry time...
+								if($max_expiration_times[$i] <= $lower_expiration_times[$i])
+								{
+									// if the lower expiration time is actually higher than the upper expiration time -> skip
+									continue;
+								}
+								// both new and old max expiry times aren't infinite, so we can take a difference
+								$expire_offset = ($lower_expiration_times[$i] - $max_expiration_times[$i]);
+							}
+							else
+							{
+								// the old level never expired, not much we can do but try to estimate a new expiry time... which will just happen to be starting from today...
+								$expire_offset = TIME_NOW + $lower_expiration_times[$i];
+								// if the user's expiry time is already less than what we're going to set it to, skip
+								if($user[$current_expiry_field] <= $expire_offset)
+								{
+									continue;
+								}
+							}
+							
+							$updated_user[$current_expiry_field] = $user[$current_expiry_field] + $expire_offset;
+							// double-check if it's expired already
+							if($updated_user[$current_expiry_field] < TIME_NOW)
+							{
+								$updated_user[$current_expiry_field] = 0;
+								$updated_user[$current_inforce_field] = 0;
+							}
+						}
+						else
+						{
+							// there's no lower level for this type - remove the consequence entirely
+							$updated_user[$current_expiry_field] = 0;
+							$updated_user[$current_inforce_field] = 0;
+						}
+					}
+				}
+			}
+			
+			
+			// Update user
 			$db->update_query("users", $updated_user, "uid='{$warning['uid']}'");
 		}
 
@@ -822,7 +919,7 @@
 	{
 		$warning['post_subject'] = $parser->parse_badwords($warning['post_subject']);
 		$warning['post_subject'] = htmlspecialchars_uni($warning['post_subject']);
-		$post_link = get_post_link($warning['pid']);
+		$post_link = get_post_link($warning['pid'])."#pid{$warning['pid']}";
 		eval("\$warning_info = \"".$templates->get("warnings_view_post")."\";");
 	}
 	else
@@ -1057,4 +1154,47 @@
 	output_page($warnings);
 }
 
+
+
+function find_warnlevels_to_check(&$query, &$max_expiration_times, &$check_levels)
+{
+	global $db;
+	// we have some warning levels we need to revoke
+	$max_expiration_times = array(
+		1 => -1,	// Ban
+		2 => -1,	// Revoke posting
+		3 => -1		// Moderate posting
+	);
+	$check_levels = array(
+		1 => false,	// Ban
+		2 => false,	// Revoke posting
+		3 => false	// Moderate posting
+	);
+	while($warn_level = $db->fetch_array($query))
+	{
+		// revoke actions taken at this warning level
+		$action = unserialize($warn_level['action']);
+		if($action['type'] < 1 || $action['type'] > 3)	// prevent any freak-ish cases
+		{
+			continue;
+		}
+		
+		$check_levels[$action['type']] = true;
+		
+		$max_exp_time = &$max_expiration_times[$action['type']];
+		if($action['length'] && $max_exp_time != 0)
+		{
+			$expiration = $action['length'];
+			if($expiration > $max_exp_time)
+			{
+				$max_exp_time = $expiration;
+			}
+		}
+		else
+		{
+			$max_exp_time = 0;
+		}
+	}
+}
+
 ?>
\ No newline at end of file
diff -rub mybb_1400/xmlhttp.php mybb_1408/xmlhttp.php
--- mybb_1400/xmlhttp.php	2008-07-25 20:52:06.000000000 +0200
+++ mybb_1408/xmlhttp.php	2009-06-26 07:26:33.000000000 +0200
@@ -6,7 +6,7 @@
  * Website: http://www.mybboard.net
  * License: http://www.mybboard.net/about/license
  *
- * $Id: xmlhttp.php 4039 2008-07-25 18:52:06Z Tikitiki $
+ * $Id: xmlhttp.php 4379 2009-06-10 10:13:44Z Tomm $
  */
 
 /**
@@ -23,6 +23,7 @@
 
 // We don't want visits here showing up on the Who's Online
 define("NO_ONLINE", 1);
+define('THIS_SCRIPT', 'xmlhttp.php');
 
 // Load MyBB core files
 require_once dirname(__FILE__)."/inc/init.php";
@@ -40,7 +41,7 @@
 
 // Send no cache headers
 header("Expires: Sat, 1 Jan 2000 01:00:00 GMT");
-header("Last-Modified: " . gmdate("D, d M Y H:i:s") . "GMT");
+header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
 header("Cache-Control: no-cache, must-revalidate");
 header("Pragma: no-cache");
 
@@ -226,7 +227,7 @@
 	{
 		if(function_exists("iconv"))
 		{
-			$subject = iconv("UTF-8", $charset, $subject);
+			$subject = iconv($charset, "UTF-8//IGNORE", $subject);
 		}
 		else if(function_exists("mb_convert_encoding"))
 		{
@@ -323,7 +324,7 @@
 			xmlhttp_error($lang->thread_closed_edit_message);
 		}
 		// Forum is not open, user doesn't have permission to edit, or author doesn't match this user - don't allow editing.
-		else if($forum['open'] == 0 || $forumpermissions['caneditposts'] == 0 || $mybb->user['uid'] != $post['uid'] || $mybb->user['uid'] == 0)
+		else if($forum['open'] == 0 || $forumpermissions['caneditposts'] == 0 || $mybb->user['uid'] != $post['uid'] || $mybb->user['uid'] == 0 || $mybb->user['suspendposting'] == 1)
 		{
 			xmlhttp_error($lang->no_permission_edit_post);
 		}
@@ -334,6 +335,13 @@
 			xmlhttp_error($lang->edit_time_limit);
 		}
 	}
+
+	// Forum is closed - no editing allowed (for anyone)
+	if($forum['open'] == 0)
+	{
+		xmlhttp_error($lang->no_permission_edit_post);
+	}
+
 	if($mybb->input['do'] == "get_post")
 	{
 		// Send our headers.
@@ -360,7 +368,7 @@
 		{
 			if(function_exists("iconv"))
 			{
-				$message = iconv("UTF-8", $charset, $message);
+				$message = iconv($charset, "UTF-8//IGNORE", $message);
 			}
 			else if(function_exists("mb_convert_encoding"))
 			{
@@ -595,6 +603,12 @@
 	// Remove multiple spaces from the username
 	$username = preg_replace("#\s{2,}#", " ", $username);
 
+	if(empty($username))
+	{
+		echo "<fail>{$lang->banned_characters_username}</fail>";
+		exit;
+	}
+
 	header("Content-type: text/xml; charset={$charset}");
 
 	// Check if the username belongs to the list of banned usernames.
@@ -672,7 +686,8 @@
 		);
 		$timecut = TIME_NOW - $mybb->settings['wolcutoff'];		
 		$query = $db->simple_select("users", "uid, username, usergroup, displaygroup, lastactive, lastvisit, invisible", "uid IN ({$mybb->user['buddylist']})", $query_options);
-		$buddy_array = array();
+		$online = array();
+		$offline = array();
 		while($buddy = $db->fetch_array($query))
 		{
 			$buddy_name = format_name($buddy['username'], $buddy['usergroup'], $buddy['displaygroup']);
